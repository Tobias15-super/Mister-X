import{F as gt}from"./vendor_leaflet-CAQ_TIzs.js";import{i as so,g as Ln,a as ro,b as ct,c as co,u as H,r as p,d as A,s as $,e as Ot,f as An,h as Pe,p as lt,j as z,k as lo,l as me,o as uo,m as X,q as Ye,n as Qe,t as mo,v as Bt,w as fo,x as Bn,y as ce,R as go}from"./vendor_firebase-2T6qncot.js";import{a as po}from"./vendor-Cj_BHRrm.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();const ho={apiKey:"AIzaSyC-jTMiDjHNTC6cvSKUU44mVbWwT-ToLxQ",authDomain:"mister-x-d6b59.firebaseapp.com",databaseURL:"https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app",projectId:"mister-x-d6b59",storageBucket:"mister-x-d6b59.firebasestorage.app",messagingSenderId:"616391598963",appId:"1:616391598963:web:da07882b0f481d3000db06",measurementId:"G-W66SK677NG"},ge=so(ho),y=Ln(ge);ro(ge);ct(ge);var Tn,In,xn;typeof L<"u"&&gt&&((Tn=L.Control)!=null&&Tn.FullScreen||(L.Control.FullScreen=gt),(In=L.control)!=null&&In.fullscreen||(L.control.fullscreen=function(e){return new gt(e)}),console.debug("leaflet.fullscreen registered:",!!((xn=L.control)!=null&&xn.fullscreen)));let le,Kt=!1,pt=!1,v,ht=null,Ue=null,yo=[],ne;const ie={};let be=null;const et=new Set;let F=localStorage.getItem("deviceId")||null;const K="https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app";let Ne=null,Q=null,ee=null,Pn=!1,$e=null,ye=null;const bo=3e4;let Cn=null,Re=0,Fe=null,Xt=null,yt=!1;const bt="showNotifHeader",Mn="currentTeamId";let M=null,O={},qe={deviceTeam:null,teams:null},Rn=null,Te=[];const Fn="showAgentLocations",wt="lastPromptedAgentReqId",J="lastRespondedAgentReqId";let Xe=(localStorage.getItem(Fn)??"1")==="1";const vt=new Set;let q,ae,Ge;const Zt="agentReqEnabled";let Jt="messageToggleEnabled";const Yt="settings/agentReqEnabled",Qt="settings/messages",Pt="settings/uBahnEinstieg",wo="uBahnEnabled";L.icon({iconUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});typeof L<"u"&&L.Icon&&L.Icon.Default&&typeof L.Icon.Default.mergeOptions=="function"&&L.Icon.Default.mergeOptions({imagePath:"https://unpkg.com/leaflet@1/dist/images/",iconUrl:"marker-icon.png",iconRetinaUrl:"marker-icon-2x.png",shadowUrl:"marker-shadow.png"});const vo=[[48.21778257924239,16.37016154994435],[48.217247563322225,16.37076456217454],[48.21741142779978,16.371253762059183],[48.216865105563464,16.37191529883514],[48.21581506144457,16.37290646405736],[48.21417125610604,16.373948000332064],[48.21430769576697,16.3745721914746],[48.21333498613118,16.37539386682008],[48.2122964590416,16.377294652276152],[48.211699711347876,16.38092342451245],[48.211941642178076,16.38467493512273],[48.20913524997675,16.384032997995277],[48.20434428995476,16.380677464805487],[48.20267440663029,16.378771628716105],[48.202516949057625,16.378787036085683],[48.2021791301039,16.378713275337773],[48.20032081399359,16.37673193693543],[48.20046567888107,16.376081501249317],[48.19987161819025,16.37355423682974],[48.19981183801774,16.372899054744835],[48.200631534154375,16.369653382537916],[48.20071916193201,16.369103424638855],[48.200163223194544,16.368756078571426],[48.19948213275357,16.368406050294983],[48.19950721778074,16.3679406870309],[48.1998469538764,16.366987161726104],[48.19976119600531,16.366945587486374],[48.199786280895815,16.366662614435302],[48.199852484835134,16.36658080706035],[48.199605825841886,16.366136901468384],[48.199689907919776,16.365894161552536],[48.199997462783195,16.365407340616333],[48.20007450484762,16.36539258846675],[48.200780727683785,16.364471249670135],[48.20235733493688,16.36143133067089],[48.202316181915776,16.361391179971125],[48.20252539808658,16.36095263879719],[48.20263271531552,16.36073672097149],[48.20274853131339,16.36083590228765],[48.20475579365605,16.35819251441422],[48.20494354858451,16.357837121719747],[48.205074099582546,16.357685576910406],[48.20502589015989,16.357555489773183],[48.20506169808996,16.357492457861333],[48.205261965068914,16.357456248039632],[48.20626549207577,16.356030140071557],[48.20666774752276,16.35550308600013],[48.20697347295606,16.355354223399804],[48.20918910891197,16.354601648098285],[48.20921597664341,16.35491948986655],[48.20929110567211,16.354928877598102],[48.20938410911258,16.354983862882907],[48.212403444290665,16.35518085630021],[48.212634067324394,16.355560388875816],[48.214753862701514,16.35585677297196],[48.21482540908184,16.356370415998313],[48.21454632473899,16.35850592710254],[48.21435355993972,16.36025556372129],[48.21477999581608,16.361298310706765],[48.21461086605676,16.3615351876565],[48.214799725889385,16.361933238614775],[48.21476774885914,16.362013013827934],[48.214317217645544,16.362474541146735],[48.21554996828477,16.365200001058092],[48.21618181295601,16.36659154989541],[48.21691897070536,16.368248676490595],[48.21768157297474,16.36988155904141],[48.21778257924239,16.37016154994435]],So=[[-90,-180],[-90,180],[90,180],[90,-180]],St=L.polygon([So,vo],{color:"red",weight:3,fillColor:"rgba(255, 0, 0, 0.3)",fillOpacity:.35,interactive:!1,pane:"maskPane",dashArray:"5, 5"}),ko={blau:"#1E90FF",gruen:"#2ECC71",rot:"#FF5252",gelb:"#F4D03F",orange:"#FF8C00",lila:"#8E44AD",schwarz:"#333333",grau:"#7F8C8D"};co(ge,{provider:new go("6LcVXbQrAAAAAI5Wgi8DenjAM4cz-ubrfcwIRPVJ"),isTokenAutoRefreshEnabled:!0});window.onerror=function(e,t,n,o,i){alert("JS-Fehler: "+e+" in "+t+" Zeile "+n)};const we=po("https://axirbthvnznvhfagduyj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4aXJidGh2bnpudmhmYWdkdXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMDI2MTcsImV4cCI6MjA2ODg3ODYxN30.wfJm9e10_iNuYm_r3es_FmKuXBePsxSjIJcVqmSuYjc");function te(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()==="";)e=prompt("Bitte gib deinen Namen ein"),e===null&&alert("Du musst einen Namen eingeben, um fortzufahren.");return localStorage.setItem("deviceId",e.trim()),e.trim()}try{localStorage.setItem("test","1")}catch{alert("‚ö†Ô∏è Dein Browser blockiert lokalen Speicher. Bitte verlasse den privaten Modus oder √§ndere die Einstellungen.")}async function Eo(){try{if(!await Ot()){alert("‚ùå Push-Benachrichtigungen werden in diesem Browser/Modus nicht unterst√ºtzt.");return}if(!("Notification"in window)){alert("‚ùå Notification API nicht verf√ºgbar.");return}const t=await Notification.requestPermission();if(t!=="granted"){r("Benachrichtigungen nicht erlaubt:",t),alert("‚ö†Ô∏è Benachrichtigungen wurden abgelehnt.");return}const n=await Ui();r("Service Worker registriert mit Scope:",n.scope),localStorage.setItem("serviceWorkerRegistered","true"),ne||(ne=ct(ge));const o=await An(ne,{serviceWorkerRegistration:n,vapidKey:"BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE"});if(!o){r("Kein Token erhalten."),alert("‚ö†Ô∏è Kein Token erhalten. Bitte erneut versuchen.");return}localStorage.setItem("fcmToken",o),r("Token:",o),await $(p(y,`tokens/${F}`),o),await H(p(y,`roles/${F}`),{role:"start"}),localStorage.setItem("nachrichtAktiv","true");const i=document.getElementById("permissionButton");i&&(i.style.display="none"),To(F).then(()=>{alert("‚úÖ Benachrichtigungen aktiviert!")})}catch(e){r("Fehler bei Berechtigung/Registrierung/Token:",e),alert("‚ùå Fehler: "+((e==null?void 0:e.message)??String(e)))}}async function To(e){const t=await Lo("app-db","settings");return new Promise((n,o)=>{const i=t.transaction("settings","readwrite");i.objectStore("settings").put(e,"deviceName"),i.oncomplete=()=>{t.close(),n(!0)},i.onerror=()=>{t.close(),o(i.error)}})}async function Io(e){const t=await new Promise((n,o)=>{const i=indexedDB.open("app-db");i.onupgradeneeded=()=>{const a=i.result;a.objectStoreNames.contains("sw-flags")||a.createObjectStore("sw-flags")},i.onsuccess=()=>n(i.result),i.onerror=()=>o(i.error)});try{return await new Promise(n=>{const a=t.transaction("sw-flags","readonly").objectStore("sw-flags").get(e);a.onsuccess=()=>{t.close(),n(a.result||null)},a.onerror=()=>{t.close(),n(null)}})}catch{return null}}async function xo(e){const t=await new Promise((n,o)=>{const i=indexedDB.open("app-db");i.onupgradeneeded=()=>{const a=i.result;a.objectStoreNames.contains("sw-flags")||a.createObjectStore("sw-flags")},i.onsuccess=()=>n(i.result),i.onerror=()=>o(i.error)});await new Promise(n=>{const o=t.transaction("sw-flags","readwrite");o.objectStore("sw-flags").delete(e),o.oncomplete=()=>{t.close(),n()},o.onerror=()=>{t.close(),n()}})}async function kt(e={}){const{force:t=!1,vapidKey:n="BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE",touchWhenUnchanged:o=!0}=e;if(typeof Notification>"u"||Notification.permission!=="granted"||localStorage.getItem("serviceWorkerRegistered")!=="true")return r("üîï Token-Refresh √ºbersprungen: Keine Berechtigung oder kein SW."),null;try{const i=await navigator.serviceWorker.ready;let a=null;try{a=await An(ne,{serviceWorkerRegistration:i,vapidKey:n})}catch(c){return r("‚ùå Fehler bei getToken:",c),null}if(!a)return r("‚ö†Ô∏è Kein Token beim Refresh erhalten."),null;const s=localStorage.getItem("fcmToken");return t||a!==s?(r("üîÑ Token aktualisiert:",a),await $(p(y,"tokens/"+F),a),r("‚úÖ Token in RTDB gesetzt f√ºr",F),localStorage.setItem("fcmToken",a),localStorage.setItem("nachrichtAktiv","true"),a):(r("‚ÑπÔ∏è Token ist unver√§ndert."),a)}catch(i){return r("‚ùå Fehler beim Token-Refresh:",i),null}}async function Lo(e,t){return new Promise((n,o)=>{const i=indexedDB.open(e);i.onupgradeneeded=()=>{const a=i.result;a.objectStoreNames.contains(t)||a.createObjectStore(t)},i.onsuccess=()=>{const a=i.result;if(a.objectStoreNames.contains(t))return n(a);const s=a.version+1;a.close();const c=indexedDB.open(e,s);c.onupgradeneeded=()=>{const u=c.result;u.objectStoreNames.contains(t)||u.createObjectStore(t)},c.onsuccess=()=>n(c.result),c.onerror=()=>o(c.error)},i.onerror=()=>o(i.error)})}async function Ao(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()===""||!en(e.trim());)e=prompt("Bitte gib deinen Namen ein (mind. 2 Zeichen, keine Sonderzeichen wie . # $ [ ] /)"),e===null&&alert("Du musst einen g√ºltigen Namen eingeben, um fortzufahren."),e&&!en(e.trim())&&(alert("Ung√ºltiger Name. Bitte verwende mindestens 2 Zeichen und keine . # $ [ ] /"),e="");e=e.trim(),localStorage.setItem("deviceId",e),F=e;try{const t=await $o(e);r("[askForDeviceIdAndPhone] remote prefs",t);let n=!1;if(t.allowSmsFallback===null?n=!0:t.allowSmsFallback===!1?n=!1:t.allowSmsFallback===!0&&t.exists===!1&&(n=!0),n){let o=null;try{for(;!o||!tn(o);){let a;try{a=prompt(`Bitte gib deine Telefonnummer f√ºr SMS-Fallback ein (+43‚Ä¶ oder 0664‚Ä¶)
Du kannst auch leer lassen, wenn du keine SMS m√∂chtest.`)}catch(s){a=null,r("[askForDeviceIdAndPhone] prompt blocked, falling back",s)}if(a===null||a.trim()===""){o=null;break}o=Ct(a.trim()),o||alert("Ung√ºltige Nummer. Bitte im Format +43‚Ä¶ oder 0664‚Ä¶ eingeben.")}}catch(a){r("[askForDeviceIdAndPhone] prompt loop failed",a),o=null}if(!o||!tn(o)){r("[askForDeviceIdAndPhone] prompt produced no value or was blocked - falling back to inline input");try{o=await Bo()}catch(a){r("[askForDeviceIdAndPhone] inline fallback failed",a),o=null}}await Oo(e,o,!!o)}}catch(t){r("[askForDeviceIdAndPhone] could not fetch remote prefs",t)}}function en(e){return typeof e=="string"&&e.length>=2&&!/[.#$/\[\]/]/.test(e)}function Bo(){return new Promise(e=>{const t=document.getElementById("phone-entry-input-wrapper");if(t){r("[showPhoneEntryModal] re-using existing inline input");const d=t.querySelector("#phone-entry-input"),f=t.querySelector("#phone-entry-save"),b=t.querySelector("#phone-entry-skip");d&&d.focus();const g=()=>{const w=d.value.trim();if(w==="")return e(null);const S=Ct(w);if(!S){const k=t.querySelector("#phone-entry-error");k&&(k.textContent="Ung√ºltige Nummer. Bitte im Format +43‚Ä¶ oder 0664‚Ä¶ eingeben.",k.style.display="block");return}e(S)},h=()=>{e(null)};f&&f.addEventListener("click",g,{once:!0}),b&&b.addEventListener("click",h,{once:!0}),d&&d.addEventListener("keydown",function(S){S.key==="Enter"&&g(),S.key==="Escape"&&h()},{once:!1});return}const n=document.createElement("div");n.id="phone-entry-input-wrapper",n.style.position="fixed",n.style.top="8px",n.style.left="50%",n.style.transform="translateX(-50%)",n.style.background="#fff",n.style.padding="8px",n.style.borderRadius="6px",n.style.boxShadow="0 6px 18px rgba(0,0,0,0.12)",n.style.zIndex="99999",n.style.display="flex",n.style.alignItems="center",n.style.gap="8px",n.innerHTML=`
      <input id="phone-entry-input" type="tel" placeholder="+43..." style="width:220px;padding:6px;border:1px solid #ccc;border-radius:4px">
      <button id="phone-entry-save">Speichern</button>
      <button id="phone-entry-skip" class="ghost">Leer lassen</button>
      <div id="phone-entry-error" style="color:#900;display:none;margin-left:8px;font-size:0.9rem"></div>
    `,n.style.border="2px solid #007AFF",document.body.appendChild(n),r("[showPhoneEntryModal] appended inline input to DOM");const o=document.getElementById("phone-entry-input"),i=document.getElementById("phone-entry-error"),a=document.getElementById("phone-entry-save"),s=document.getElementById("phone-entry-skip");o.focus(),r("[showPhoneEntryModal] input focused; wrapper visible=",!!document.getElementById("phone-entry-input-wrapper"));function c(){a.removeEventListener("click",u),s.removeEventListener("click",l),o.removeEventListener("keydown",m),n.remove()}function u(){const d=o.value.trim();if(r("[showPhoneEntryModal] onSave clicked, value=",d),d==="")return c(),e(null);const f=Ct(d);if(!f){i.textContent="Ung√ºltige Nummer. Bitte im Format +43‚Ä¶ oder 0664‚Ä¶ eingeben.",i.style.display="block";return}return c(),r("[showPhoneEntryModal] resolved normalized value=",f),e(f)}function l(){return c(),e(null)}function m(d){d.key==="Enter"&&u(),d.key==="Escape"&&l()}a.addEventListener("click",u),s.addEventListener("click",l),o.addEventListener("keydown",m)})}async function Po(){try{const e=await Ot().catch(()=>!1);ne||(ne=ct(ge));const t=localStorage.getItem("fcmToken");if(e)try{await lo(ne),r("‚úÖ deleteToken: lokaler FCM-Token invalidiert")}catch(n){r("‚ö†Ô∏è deleteToken fehlgeschlagen:",n)}try{await z(p(y,`tokens/${F}`)),r("‚úÖ RTDB-Token entfernt f√ºr",F)}catch(n){r("‚ö†Ô∏è RTDB-Remove fehlgeschlagen:",n)}if("serviceWorker"in navigator){const n=await navigator.serviceWorker.getRegistrations();for(const o of n)try{const i=await o.pushManager.getSubscription();i&&(await i.unsubscribe(),r("‚úÖ Push-Subscription gek√ºndigt f√ºr",o.scope))}catch(i){r("‚ö†Ô∏è unsubscribe warn:",i)}await Promise.all(n.map(o=>o.unregister())),r("‚úÖ Alle Service Worker unregistriert")}try{if(window.caches){const n=await caches.keys();await Promise.all(n.map(o=>caches.delete(o))),r("‚úÖ Alle Caches gel√∂scht:",n)}}catch(n){r("‚ö†Ô∏è Cache cleanup warn:",n)}try{indexedDB.deleteDatabase("app-db"),r('‚úÖ IndexedDB "app-db" gel√∂scht')}catch(n){r("‚ö†Ô∏è IndexedDB delete warn:",n)}localStorage.removeItem("fcmToken"),localStorage.removeItem("nachrichtAktiv"),localStorage.removeItem("serviceWorkerRegistered");try{const n=document.getElementById("permissionButton"),o=document.getElementById("permissionButton2");n&&(n.style.display=""),o&&(o.style.display="none")}catch{}setTimeout(()=>{alert("üîï Benachrichtigungen deaktiviert. Die Seite wird neu geladen‚Ä¶"),location.reload()},150)}catch(e){r(e),alert("‚ùå Deaktivieren fehlgeschlagen: "+((e==null?void 0:e.message)??String(e)))}}function Co(e,t=[],n,o=15,{rtdbBase:i=K,rolesPath:a="roles",recipientsPath:s="notifications",idempotencyFlag:c="smsTriggered",secret:u=typeof SMS_FALLBACK_SECRET<"u"?SMS_FALLBACK_SECRET:"",rtdbAuth:l}={}){if(!e)throw new Error("[Fallback] messageId fehlt");if(!Array.isArray(t)||t.length===0)return r("[Fallback] keine Empf√§nger - Fallback nicht geplant"),Promise.resolve({ok:!0,skipped:"no_recipients"});if(!i)throw new Error("[Fallback] rtdbBase fehlt");const m={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),waitSec:o,rtdbBase:i,rolesPath:a,recipientsPath:s,idempotencyFlag:c,...l?{rtdbAuth:l}:{}},d={};return u&&(d["x-sms-secret"]=u),we.functions.invoke("sms-fallback",{body:m,headers:d}).then(({data:f,error:b})=>b?(r("[Fallback] Edge call failed",b),{ok:!1,error:b.message||"invoke failed"}):(r("[Fallback] scheduled:",f),f)).catch(f=>(r("[Fallback] Konnte SMS-Fallback nicht planen:",f),{ok:!1,error:(f==null?void 0:f.message)||String(f)}))}function dt(e,t=[],n,{rtdbBase:o=K,rolesPath:i="roles",recipientsPath:a="notifications",rtdbAuth:s,requireConsent:c=!0,maxRecipientsPerCall:u,writeDeliveredTimestamp:l=!0}={}){if(!e)return Promise.resolve({ok:!1,error:"Missing messageId"});if(!Array.isArray(t)||t.length===0)return r==null||r("[sms-direct] keine Empf√§nger - nichts zu senden"),Promise.resolve({ok:!0,skipped:"no_recipients"});const m={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),...o?{rtdbBase:o}:{},rolesPath:i,recipientsPath:a,...s?{rtdbAuth:s}:{},requireConsent:c,...Number.isFinite(u)?{maxRecipientsPerCall:u}:{},writeDeliveredTimestamp:l};return we.functions.invoke("sms-direct",{body:m}).then(({data:d,error:f})=>f?(r==null||r("[sms-direct] Edge call failed",f),{ok:!1,error:f.message||"invoke failed"}):(r==null||r("[sms-direct] sent:",d),d)).catch(d=>(r==null||r("[sms-direct] Fehler beim Senden:",d),{ok:!1,error:(d==null?void 0:d.message)||String(d)}))}function de(){try{const e=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:void 0,t=e&&e.crypto;if(t&&typeof t.randomUUID=="function")return t.randomUUID();if(t&&typeof t.getRandomValues=="function"){const n=new Uint8Array(16);t.getRandomValues(n),n[6]=n[6]&15|64,n[8]=n[8]&63|128;const o=a=>a.toString(16).padStart(2,"0"),i=Array.from(n,o).join("");return`${i.slice(0,8)}-${i.slice(8,12)}-${i.slice(12,16)}-${i.slice(16,20)}-${i.slice(20)}`}}catch{}return`${Date.now()}-${Math.random().toString(36).slice(2,10)}`}async function ut(e,t,n=[],o={}){const{recipientDeviceNames:i=[],link:a="/Mister-X/",attempt:s=1,maxAttempts:c=1,waitSec:u=15,sendEndpoint:l="https://axirbthvnznvhfagduyj.supabase.co/functions/v1/send-to-all",rtdbBase:m=K,messageId:d,instantSMSDevices:f=[]}=o,b=d??de(),g=(typeof te=="function"?te():null)||"unknown",h=s===1,w={title:e,body:t,tokens:n,senderName:g,link:a,messageId:b,rtdbBase:m,recipientDeviceNames:h?i:[],setRecipientsMode:h?"set_once":"none",attempt:s};r(`üì§ Sende an send-to-all: ${n.length} tokens, attempt ${s}`);const S=Date.now(),k=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)}),P=Date.now()-S;let E={};try{E=await k.json()}catch{}r(`üì¶ Versuch ${s}: status=${k.status}, fetch took ${P}ms`,E);const T=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);h&&i.length>0&&Co(b,i,T,15,{rtdbBase:K}),h&&f.length>0&&dt(b,f,T,{rtdbBase:K});const B=Array.isArray(E==null?void 0:E.failedTokens)?E.failedTokens:[];return B.length>0&&s<c?(r(`üîÅ Wiederhole f√ºr ${B.length} fehlgeschlagene Tokens in 10s...`),setTimeout(()=>{ut(e,t,B,{recipientDeviceNames:i,link:a,attempt:s+1,maxAttempts:c,waitSec:u,sendEndpoint:l,rtdbBase:m,messageId:b}).catch(r)},1e4)):s>=c>=2?r("‚è±Ô∏è Max. Anzahl an Versuchen erreicht."):r("‚úÖ Alle Benachrichtigungen verarbeitet."),E}async function ue(e,t,n,o={}){const i=o.rtdbBase??K,a=o.messageId??de(),s=(typeof te=="function"?te():null)||"unknown";try{const T=await A(p(y,"settings/messages"));if(!(T.exists()?!!T.val():!0)){const N={title:String(e??""),body:String(t??""),link:o.link||"/Mister-X/",sender:s,timestamp:Date.now(),messageId:a,recipients:{}};return await $(p(y,`notifications/${a}`),N),r('[sendNotificationToRoles] Global setting "settings/messages" = false, wrote notification without recipients',N),{ok:!0,skipped:"messages_disabled",messageId:a}}}catch(T){r("[sendNotificationToRoles] Could not read settings/messages, proceeding as enabled:",T)}const[c,u]=await Promise.all([A(p(y,"roles")),A(p(y,"tokens"))]),l=c.exists()?c.val():{},m=u.exists()?u.val():{},d=Array.isArray(n)?n:[n],f=d.length===1&&d[0]==="all",b=[],g=[],h=[],w=Array.from(new Set([...Object.keys(l||{}),...Object.keys(m||{})]));for(const T of w){const B=l[T]||{},N=B.role,C=B.notification!==!1,U=B.instantSMS===!0;if(!(f||N&&d.includes(N))||!C)continue;if(U){h.push(T),g.push(T);continue}const Z=He(m[T]);Z.length>0&&(b.push(...Z),g.push(T))}const S=se(b),k=se(g),P=se(h),E=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);if(S.length>0)return ut(e,t,S,{recipientDeviceNames:k,link:o.link||"/Mister-X/",waitSec:typeof o.waitSec=="number"?o.waitSec:45,sendEndpoint:o.sendEndpoint,rtdbBase:i,messageId:a,instantSMSDevices:P});if(P.length>0){const T=Date.now(),B={};P.forEach(C=>{B[C]=!1});const N={title:String(e??""),body:String(t??""),link:o.link||"/Mister-X/",sender:s,timestamp:T,recipients:B,attempts:{1:{at:T,count:0}},lastAttemptAt:T};try{await $(p(y,`notifications/${a}`),N),r(`[sendNotificationToRoles] Notification for instant SMS recorded: ${a}`)}catch(C){r(`[sendNotificationToRoles] Failed to write notification: ${C.message}`)}return await dt(a,P,E,{rtdbBase:i}),{ok:!0,onlySms:!0,smsCount:P.length,messageId:a}}return r(`‚ö†Ô∏è Keine passenden Empf√§nger f√ºr Rollen "${Array.isArray(n)?n.join(","):n}".`),{ok:!0,skipped:"no_recipients"}}async function Mo(e){const t=Array.isArray(e)?e:[e],[n,o]=await Promise.all([A(p(y,"roles")),A(p(y,"tokens"))]),i=n.exists()?n.val():{},a=o.exists()?o.val():{},s=t.length===1&&t[0]==="all",c=[],u=[],l=[];for(const m in a){if(!Object.prototype.hasOwnProperty.call(a,m))continue;const d=i[m]||{},f=d.role,b=d.notification!==!1,g=d.instantSMS===!0;if(!(s||f&&t.includes(f))||!b)continue;if(g){l.push(m),u.push(m);continue}const w=He(a[m]);w.length!==0&&(c.push(...w),u.push(m))}return{tokens:se(c),deviceNames:se(u),instantSMSDevices:se(l)}}async function Ro(e){const t=Array.isArray(e)?e:[e],[n,o,i]=await Promise.all([A(p(y,"teams")),A(p(y,"roles")),A(p(y,"tokens"))]),a=n.exists()?n.val():{},s=o.exists()?o.val():{},c=i.exists()?i.val():{},u=[],l=[],m=[],d=new Set;for(const f of t){const b=a==null?void 0:a[f];if(!(!b||!b.members))for(const g of Object.keys(b.members||{})){if(d.has(g))continue;d.add(g);const h=s[g]||{},w=h.notification!==!1,S=h.instantSMS===!0;if(!w)continue;if(S){m.push(g),l.push(g);continue}const k=He(c[g]);k.length>0&&(u.push(...k),l.push(g))}}return{tokens:se(u),deviceNames:se(l),instantSMSDevices:se(m)}}function Fo(e,t,n){const o="Misterx-upload",i=new FormData;i.append("file",e),i.append("upload_preset",o),fetch("https://api.cloudinary.com/v1_1/ddvf141hb/image/upload",{method:"POST",body:i}).then(a=>a.json()).then(a=>{a.secure_url&&a.public_id?t({url:a.secure_url}):typeof n=="function"&&n(new Error("Fehler beim Hochladen zu Cloudinary."))}).catch(a=>{r("Upload-Fehler:",a),typeof n=="function"&&n(a)})}async function Do(){const e=document.getElementById("photoInput").files[0],t=document.getElementById("manualLocationDescription").value.trim(),n=document.getElementById("manualLocationContainer"),o=document.getElementById("status"),i=ca();if(!i){I("Bitte zuerst einen Posten ausw√§hlen.",{type:"error"});return}if(!e){I("Bitte ein Foto ausw√§hlen.",{type:"error"});return}const a=Date.now();let s={lat:null,lon:null,accuracy:null};if(n&&n.style.display!=="none"&&t!=="")r("sendLocationWithPhoto: Manuelle Beschreibung wird verwendet");else if(navigator.geolocation)try{r("sendLocationWithPhoto: Starte Standortabfrage...");const g=await Ht({enableHighAccuracy:!0,timeout:15e3,maximumAge:5e3}),{latitude:h,longitude:w,accuracy:S}=g.coords;if(r(`sendLocationWithPhoto: Standort erhalten - lat: ${h}, lon: ${w}, accuracy: ${S}m`),S>100){o.innerText=`‚ö†Ô∏è Standort ungenau (¬±${Math.round(S)} m). Bitte erneut versuchen oder Standortbeschreibung eingeben.`,n.style.display="block",r("sendLocationWithPhoto: Standort zu ungenau, abgebrochen");return}s={lat:h,lon:w,accuracy:S},r("sendLocationWithPhoto: Standort akzeptiert")}catch(g){r("sendLocationWithPhoto: Fehler bei Standortabfrage (Versuch 1):",g);try{r("sendLocationWithPhoto: Starte zweiten Versuch (Watch-Once)...");const h=await fi({enableHighAccuracy:!0,timeout:2e4,maximumAge:0}),{latitude:w,longitude:S,accuracy:k}=h.coords;if(r(`sendLocationWithPhoto: Standort erhalten (Versuch 2) - lat: ${w}, lon: ${S}, accuracy: ${k}m`),k>100){o.innerText=`‚ö†Ô∏è Standort ungenau (¬±${Math.round(k)} m). Bitte erneut versuchen oder Standortbeschreibung eingeben.`,n.style.display="block",r("sendLocationWithPhoto: Standort zu ungenau (Versuch 2), abgebrochen");return}s={lat:w,lon:S,accuracy:k},r("sendLocationWithPhoto: Standort akzeptiert (Versuch 2)")}catch(h){r("sendLocationWithPhoto: Fehler bei Standortabfrage (Versuch 2):",h),Et==null||Et(h),n.style.display="block";return}}else r("sendLocationWithPhoto: Geolocation nicht unterst√ºtzt"),o.innerText="Geolocation wird nicht unterst√ºtzt.",n.style.display="block";const{color:c,postId:u,title:l}=i,m=p(y,`posten/${c}/active`);o.innerText="‚è≥ Reserviere Farbe‚Ä¶";try{const g=await Pe(m,h=>h===!0?!1:h);if(!g.committed||g.snapshot.val()!==!1){o.innerText="‚ùå Diese Farbe ist bereits inaktiv. Liste wird aktualisiert.";return}}catch(g){o.innerText="‚ùå Konnte Farbe nicht reservieren.",r(g);return}try{await H(p(y),{[`posten/${c}/${u}/visited`]:!0})}catch(g){o.innerText="‚ùå Konnte Posten nicht auf 'visited' setzen.",r(g);return}const d={color:c,postId:u,title:l,timestamp:a,description:t||null,lat:s.lat,lon:s.lon};r("sendLocationWithPhoto: Schreibe Location-Daten:",d);const f=lt(p(y,"locations"),d),b=`${l} (${c.toUpperCase()})`;ue==null||ue("Mister X hat sich gezeigt!",b,["agent","settings","start"]),Ie(),Fo(e,async({url:g})=>{try{await H(f,{photoURL:g}),o.innerText="‚úÖ Foto hochgeladen"}catch(h){o.innerText="‚ùå Foto-URL konnte nicht gesetzt werden",r("Foto-URL konnte nicht gesetzt werden",h)}},g=>{o.innerText="‚ùå Foto konnte nicht hochgeladen werden",r("Upload-Fehler:",g)}),document.getElementById("photoInput").value="",document.getElementById("manualLocationDescription").value="",n.style.display="none",document.getElementById("postenSearch").value="",oo(null),j(),o.innerText="üîÑÔ∏è Posten/Farbe gemeldet & Foto wird hochgeladen.",Ie==null||Ie()}function Et(e){let t="‚ùå Fehler beim Abrufen des Standorts.";switch(e.code){case e.PERMISSION_DENIED:t+=" Zugriff verweigert.";break;case e.POSITION_UNAVAILABLE:t+=" Standortinformationen nicht verf√ºgbar.";break;case e.TIMEOUT:t+=" Zeit√ºberschreitung bei der Standortabfrage.";break}t+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=t}function tn(e){return typeof e=="string"&&/^\+43\d{4,13}$/.test(e)}function oe(e){return e.replace(/[.#$/\[\]\/]/g,"_")}function se(e){return Array.from(new Set(e))}function He(e){return e?typeof e=="string"?[e]:Array.isArray(e)?e.filter(Boolean):typeof e=="object"?Object.keys(e).filter(Boolean):[]:[]}function No(e){const t=String(e).trim();return t.startsWith("+")?"+"+t.slice(1).replace(/\D/g,""):t.replace(/\D/g,"")}async function $o(e){var t;try{const n=await we.functions.invoke("ask-tel",{body:{deviceIds:[e]}});if(n.error)throw n.error;const o=((t=n.data)==null?void 0:t.results)||{},i=oe(e),a=o[i]||{exists:!1,allowSmsFallback:null};return{exists:!!a.exists,allowSmsFallback:a.allowSmsFallback===null?null:!!a.allowSmsFallback}}catch(n){return r("[fetchRemoteSmsPrefs] Edge call failed",n),{exists:!1,allowSmsFallback:null}}}async function _o(e=[]){var t;if(!Array.isArray(e)||e.length===0)return{};try{const n=await we.functions.invoke("ask-tel",{body:{deviceIds:e}});if(n.error)throw n.error;const o=((t=n.data)==null?void 0:t.results)||{},i={};for(const a of e){const s=o[a]||o[oe(a)]||{exists:!1,allowSmsFallback:null};i[a]={exists:!!s.exists,allowSmsFallback:s.allowSmsFallback===null?null:!!s.allowSmsFallback}}return i}catch(n){return r("[checkDevicesTelPresence] Edge call failed",n),Object.fromEntries(e.map(o=>[o,{exists:!1,allowSmsFallback:null}]))}}function Ct(e){if(!e)return null;let t=No(e);if(t.startsWith("+43"))return/^\+43\d{4,13}$/.test(t)?t:null;if(t.startsWith("0")){const n="+43"+t.slice(1);return/^\+43\d{4,13}$/.test(n)?n:null}if(t.startsWith("43")){const n="+"+t;return/^\+43\d{4,13}$/.test(n)?n:null}if(/^\d{5,}$/.test(t)&&t[0]!=="0"){const n="+43"+t;return/^\+43\d{4,13}$/.test(n)?n:null}return null}async function Oo(e,t,n){const o=oe(e);Ln(ge);const i={allowSmsFallback:!!n};await H(p(y,`roles/${o}`),i);const a=t?{tel:t,telUpdatedAt:Date.now()}:null;await $(p(y,`tels/${o}`),a)}const W=e=>document.getElementById(e),Dn=e=>e&&(e.style.display=""),Nn=e=>e&&(e.style.display="none"),mt=e=>{try{localStorage.setItem(Mn,e||"")}catch{}},zo=()=>{try{return localStorage.getItem(Mn)||""}catch{return""}};function jo(){let e=document.getElementById("toastContainer");if(e)return e;e=document.createElement("div"),e.id="toastContainer",e.setAttribute("aria-live","polite"),e.style.position="fixed",e.style.left="16px",e.style.bottom="16px",e.style.zIndex=2147483647,e.style.display="flex",e.style.flexDirection="column",e.style.gap="8px",e.style.maxWidth="calc(100vw - 32px)",document.body.appendChild(e);const t=document.createElement("style");return t.innerHTML=`#toastContainer .toast{background:#222;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.2);opacity:0;transform:translateY(6px);transition:opacity .22s,transform .22s;font-size:15px;max-width:380px;word-break:break-word}
#toastContainer .toast.show{opacity:1;transform:translateY(0)}
#toastContainer .toast.info{background:#333}
#toastContainer .toast.success{background:#2ECC71}
#toastContainer .toast.warn{background:#FF8C00}
#toastContainer .toast.error{background:#FF5252}
`,document.head.appendChild(t),e}function I(e,{timeout:t=6500,type:n="info"}={}){try{const o=jo(),i=document.createElement("div");i.className=`toast ${n}`,i.textContent=e,o.appendChild(i),requestAnimationFrame(()=>i.classList.add("show"));const a=setTimeout(()=>{i.classList.remove("show"),i.addEventListener("transitionend",()=>{try{i.remove()}catch{}})},t);return i.addEventListener("click",()=>{clearTimeout(a),i.classList.remove("show"),i.addEventListener("transitionend",()=>{try{i.remove()}catch{}})}),i}catch{try{alert(e)}catch{}}}function tt(e){return typeof e=="number"?e:e&&typeof e=="object"&&typeof e.seconds=="number"?e.seconds*1e3:0}function nn(e){if(!e)return"‚Äî";try{return new Date(e).toLocaleString("de-DE",{dateStyle:"short",timeStyle:"short"})}catch{return new Date(e).toString()}}function $n(e){return e?`${String(e)}`:"Unbekannt"}function Wo(e){const t=(e||"").trim();if(t.length<2)throw new Error("Der Teamname muss mindestens 2 Zeichen lang sein.");if(t.length>24)throw new Error("Der Teamname darf maximal 24 Zeichen lang sein.");return t}function G(e){return(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function _e(e=""){return G(e).replace(/`/g,"&#096;")}function Mt(e){const t=(e==null?void 0:e.members)||{};return Object.keys(t).length}function Ho(e,t=F){return!!(e!=null&&e.members)&&!!e.members[t]}function Uo(){zo()?(W("teamStatusName").textContent="(l√§dt‚Ä¶)",W("teamStatusCount").textContent="-"):(W("teamStatusName").textContent="Kein Team",W("teamStatusCount").textContent="-"),zt()}document.addEventListener("DOMContentLoaded",Uo);function qo(){if(document.getElementById("teamSettings").style.display!=="none")return _n();document.getElementById("startView").style.display="none",document.getElementById("startView2").style.display="none",document.querySelectorAll(".view").forEach(e=>e.style.display="none"),Dn(W("teamSettings")),zt()}function _n(){let e=localStorage.getItem("activeView")||"start";Nn(W("teamSettings")),qt(e)}function zt(){if(!qe.deviceTeam){const e=p(y,`deviceTeams/${F}`),t=n=>{M=n.val()||null,mt(M||""),on(),an(),sn()};X(e,t),qe.deviceTeam={ref:e,handler:t}}if(!qe.teams){const e=p(y,"teams"),t=n=>{O=n.val()||{},on(),an(),sn()};X(e,t),qe.teams={ref:e,handler:t}}}function on(){const e=W("currentTeamName"),t=W("currentTeamMembers"),n=W("leaveTeamBtn"),o=M?O[M]:null;if(!o){e.textContent="Kein Team",t&&(t.innerHTML="‚Äî Mitglieder"),n&&(n.disabled=!0);return}e.textContent=o.name||"(ohne Namen)";const i=Object.entries(o.members||{}).map(([s,c])=>({id:s,joinedAt:tt(c==null?void 0:c.joinedAt)})).sort((s,c)=>s.joinedAt!==c.joinedAt?s.joinedAt-c.joinedAt:s.id.localeCompare(c.id)),a=i.map(s=>{const c=s.id===F,u=$n(s.id)+(c?" (Du)":"");return`<li class="ts-member ${c?"me":""}" title="${G(s.id)}">${G(u)}</li>`}).join("");t&&(t.innerHTML=`
      <div class="muted">${i.length} Mitglied(er)</div>
      ${i.length>0?`<ul class="ts-member-list">${a}</ul>`:'<div class="muted">Noch keine Mitglieder</div>'}
    `),n&&(n.disabled=!Ho(o))}function an(){const e=W("teamList"),t=W("teamsEmpty");if(!e)return;e.innerHTML="";const n=Object.entries(O||{}).filter(([,o])=>o&&typeof o=="object");if(n.length===0){t&&Dn(t);return}t&&Nn(t),n.sort((o,i)=>{const a=Mt(o[1]),s=Mt(i[1]);return a!==s?s-a:(o[1].name||"").localeCompare(i[1].name||"")});for(const[o,i]of n){const a=Object.entries(i.members||{}).map(([u,l])=>({id:u,joinedAt:tt(l==null?void 0:l.joinedAt)})).sort((u,l)=>u.joinedAt!==l.joinedAt?u.joinedAt-l.joinedAt:u.id.localeCompare(l.id)),s=a.map(u=>{const l=u.id===F,m=$n(u.id)+(l?" (Du)":"");return`<li class="ts-member ${l?"me":""}" title="${G(u.id)}">${G(m)}</li>`}).join(""),c=document.createElement("div");c.className="ts-team",c.innerHTML=`
      <div>
        <div style="font-weight:600">${G(i.name||"(ohne Namen)")}</div>
        <div class="muted">${a.length} Mitglied(er)</div>
        <ul class="ts-member-list">
          ${s||""}
        </ul>
      </div>
      <div>
        ${M===o?'<button class="danger" onclick="leaveTeam()">Verlassen</button>':`<button onclick="joinTeam('${o}', this)">Beitreten</button>`}
      </div>
    `,e.appendChild(c)}}function sn(){const e=W("teamStatusName"),t=W("teamStatusCount"),n=M?O[M]:null;if(!n){e.textContent="Kein Team",t.textContent="-";return}e.textContent=n.name||"(ohne Namen)",t.textContent=`${Mt(n)} Mitglied(er)`}async function Go(){const e=W("createTeamBtn"),t=W("createTeamInput");try{e.disabled=!0;const n=Wo(t.value);M&&await jt(M);const i=lt(p(y,"teams")).key,a={};a[`teams/${i}`]={name:n,createdAt:me(),createdBy:F,members:{[F]:{joinedAt:me()}}},a[`deviceTeams/${F}`]=i,await H(p(y),a),mt(i),t.value=""}catch(n){alert((n==null?void 0:n.message)||"Team konnte nicht erstellt werden."),r(n)}finally{e.disabled=!1}}async function Vo(e,t){if(!e)return;if(!O[e]){I("Team existiert nicht (mehr).",{type:"error"});return}t&&(t.disabled=!0);try{M&&M!==e&&await jt(M);const o={};o[`teams/${e}/members/${F}`]={joinedAt:me()},o[`deviceTeams/${F}`]=e,await H(p(y),o),mt(e)}catch(o){I((o==null?void 0:o.message)||"Beitritt nicht m√∂glich.",{type:"error"}),r(o)}finally{t&&(t.disabled=!1)}}async function jt(e=null){const t=e||M;if(!t)return;const n=p(y,`teams/${t}`);await Pe(n,o=>o&&(o.members&&o.members[F]&&(delete o.members[F],Object.keys(o.members).length===0)?null:o)),await $(p(y,`deviceTeams/${F}`),null),mt("")}function Ko(){const e=document.getElementById("map");e.style.display=""}function Rt(e,t){var n,o;if(Ko(),v)v.setView([e,t],15),v.invalidateSize(),Ft(),Dt();else{if(v=L.map("map",{fullscreenControl:!0,fullscreenControlOptions:{position:"topleft"},maxBounds:[[-90,-180],[90,180]],doubleTouchDragZoom:!0,doubleTouchDragZoomScaleFactor:150}).setView([e,t],15),console.debug("createOrReuseMap: L.control.fullscreen=",typeof((n=L.control)==null?void 0:n.fullscreen),"map.options.fullscreenControl=",v&&v.options&&v.options.fullscreenControl),typeof((o=L.control)==null?void 0:o.fullscreen)=="function")try{v.fullscreenControl||L.control.fullscreen({position:"topleft",title:"Vollbild",titleCancel:"Vollbild verlassen",forceSeparateButton:!0}).addTo(v)}catch(d){r("leaflet.fullscreen: failed to add control programmatically",d)}try{window.__map=v}catch{}const i=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"¬© OpenStreetMap"}),a=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"¬© CartoDB"}),s=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles ¬© Esri"}),c=L.tileLayer("http://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web/default/WEBMERCATOR/{z}/{y}/{x}.png",{maxZoom:18,attribution:"TopPlus Open ¬© GeoBasis-DE / BKG"}),u=L.tileLayer("https://mapsneu.wien.gv.at/basemap/bmaporthofoto30cm/{type}/google3857/{z}/{y}/{x}.{format}",{maxZoom:20,attribution:'Datenquelle: <a href="https://www.basemap.at">basemap.at</a>',type:"normal",format:"jpeg",bounds:[[46.35877,8.782379],[49.037872,17.189532]]}),l=L.tileLayer("https://mapsneu.wien.gv.at/basemap/bmaphidpi/{type}/google3857/{z}/{y}/{x}.{format}",{maxZoom:19,attribution:'Datenquelle: <a href="https://www.basemap.at">basemap.at</a>',type:"normal",format:"jpeg",bounds:[[46.35877,8.782379],[49.037872,17.189532]]}),m={Standard:i,Reduziert:a,Satellit:s,"Satellit (AT)":u,Plan:c,"Plan (AT)":l};i.addTo(v),L.control.layers(m).addTo(v),setTimeout(()=>v.invalidateSize(),0),Ft(),Dt();try{let d=function(){const f=document.querySelector(".leaflet-control-scale");f&&(f.classList.add("visible"),Ue&&clearTimeout(Ue),Ue=setTimeout(()=>{f.classList.remove("visible"),Ue=null},5e3))};ht=L.control.scale({position:"bottomright",metric:!0,imperial:!1}).addTo(v),v.on("zoomend",()=>{try{ht._update&&ht._update()}catch{}d()})}catch(d){r("Scale control setup failed",d)}}Wt()}function Ft(){v&&(v.getPane("maskPane")||(v.createPane("maskPane"),v.getPane("maskPane").style.zIndex=300),v.getPane("historyPane")||(v.createPane("historyPane"),v.getPane("historyPane").style.zIndex=410),v.getPane("postenPane")||(v.createPane("postenPane"),v.getPane("postenPane").style.zIndex=400),v.getPane("agentenPane")||(v.createPane("agentenPane"),v.getPane("agentenPane").style.zIndex=420),v.getPane("userPane")||(v.createPane("userPane"),v.getPane("userPane").style.zIndex=450))}function Dt(){if(q||(q=L.layerGroup()),ae||(ae=L.layerGroup()),Ge||(Ge=L.layerGroup()),v){v.hasLayer(q)||q.addTo(v),v.hasLayer(ae)||ae.addTo(v),v.hasLayer(Ge)||Ge.addTo(v);try{typeof St<"u"&&!v.hasLayer(St)&&St.addTo(v)}catch{}}}function Xo(e){if(!v)return;Dt(),ae.clearLayers();const t=new L.Icon.Default;t.options.shadowSize=[0,0],e.forEach(o=>{L.marker([o.lat,o.lon],{pane:"historyPane",icon:t}).addTo(ae).bindPopup(`üìç ${new Date(o.timestamp).toLocaleTimeString()}`)});const n=e.map(o=>[o.lat,o.lon]);n.length>1&&L.polyline(n,{color:"blue",weight:3,opacity:.7,smoothFactor:1,pane:"historyPane"}).addTo(ae)}let Oe=null,ze=null,Nt=!1;function On(){const e=document.getElementById("locationFeed");if(!e)return;e.innerHTML="";let t=[];try{const i=(Oe==null?void 0:Oe.val())||null;t=i?Object.values(i).sort((a,s)=>s.timestamp-a.timestamp):[]}catch{t=[]}let n=[];try{const i=(ze==null?void 0:ze.val())||null;n=i?Object.values(i).sort((a,s)=>s.timestamp-a.timestamp):[]}catch{n=[]}const o=[...t.map(i=>({kind:"loc",data:i})),...n.map(i=>({kind:"ubahn",data:i}))].sort((i,a)=>(a.data.timestamp||0)-(i.data.timestamp||0));o.length!==0&&(o.forEach((i,a)=>{const s=document.createElement("div");if(s.style.marginBottom="1em",i.kind==="loc"){const c=i.data,u=c.title?c.title:"Automatischer Standort",l=c.timestamp?new Date(c.timestamp).toLocaleTimeString():"",m=c.photoURL?`<img src="${c.photoURL}" alt="Foto" class="zoomable-photo" style="max-width: 100%; max-height: 60vh; border: 1px solid #ccc; margin-top: 5px; cursor: zoom-in;" data-index="${a}">`:"";s.innerHTML=`
        <strong class="location-title" data-lat="${c.lat}" data-lon="${c.lon}" style="cursor: pointer;">${u} (${l})</strong><br>
        ${c.description?`<em>üìç ${c.description}</em><br>`:""}
        ${m}
      `}else{const c=i.data,u=c.timestamp?new Date(c.timestamp).toLocaleTimeString():"",l=c.message?c.message:"U-Bahn-Ereignis";s.innerHTML=`
        <strong class="location-title ubahn-event" data-lat="" data-lon="" style="cursor: default;">üöá ${G(String(l))} (${u})</strong><br>
      `}e.appendChild(s)}),document.querySelectorAll(".location-title").forEach(i=>{const a=parseFloat(i.dataset.lat),s=parseFloat(i.dataset.lon);!isNaN(a)&&!isNaN(s)&&(i.style.cursor="pointer",i.addEventListener("click",()=>{v&&!isNaN(a)&&!isNaN(s)&&v.setView([a,s],17)}))}),document.querySelectorAll(".zoomable-photo").forEach(i=>{i.addEventListener("click",()=>{const a=document.createElement("div");a.style.position="fixed",a.style.top="0",a.style.left="0",a.style.width="100vw",a.style.height="100vh",a.style.backgroundColor="rgba(0,0,0,0.8)",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.zIndex="9999",a.innerHTML=`<img src="${i.src}" style="max-width: 90%; max-height: 90%; border: 2px solid white;">`,a.addEventListener("click",()=>{document.body.removeChild(a)}),document.body.appendChild(a)})}))}function zn(){X(p(y,"locations"),e=>{Oe=e;const t=e.val()||null;let n=[],o=[],i=null;try{n=t?Object.values(t).sort((a,s)=>s.timestamp-a.timestamp):[],o=n.filter(a=>a.lat!=null&&a.lon!=null),i=o.length===0}catch{i=!0}if(i)Rt(48.208672092667435,16.372477270381918),r("Keine Locations");else if(o.length>0){const{lat:a,lon:s}=o[0];Rt(a,s)}Jo(),o.length>0?Xo(o):ae&&ae.clearLayers(),Wt(),nt({nonDestructive:!0}),On()}),Nt||Qn()}function Zo(){if(!navigator.geolocation){alert("‚ùå Geolocation wird nicht unterst√ºtzt.");return}Ne==null&&(Ne=navigator.geolocation.watchPosition(e=>{const{latitude:t,longitude:n,accuracy:o}=e.coords;if(!v)return;const i={radius:7,color:"#007AFF",fillColor:"#ffffffff",fillOpacity:.8,opacity:1,weight:2},a={radius:o,color:"#007AFF",fillColor:"#007AFF",interactive:!1,fillOpacity:.2,weight:1,opacity:.4};if(Q?(Q.setLatLng([t,n]),Q.getPopup()&&Q.getPopup().setContent(`<strong>Dein Standort</strong><br>Genauigkeit: ¬±${Math.round(o)} m`)):Q=L.circleMarker([t,n],{markerStyle:i,pane:"userPane"}).bindPopup(`<strong>Dein Standort</strong><br>Genauigkeit: ¬±${Math.round(o)} m`).addTo(v),ee?(ee.setLatLng([t,n]),ee.setRadius(o)):ee=L.circle([t,n],{...a,pane:"historyPane"}).addTo(v),Pn){const s=Math.max(v.getZoom(),16);v.setView([t,n],s,{animate:!0})}},e=>{r("Geolocation-Fehler:",e),jn(),alert("‚ö†Ô∏è Tracking gestoppt: "+e.message)},{enableHighAccuracy:!0,timeout:15e3,maximumAge:5e3}))}function jn(){Ne!=null&&(navigator.geolocation.clearWatch(Ne),Ne=null),v&&Q&&(v.removeLayer(Q),Q=null),v&&ee&&(v.removeLayer(ee),ee=null)}function Jo(){v&&(Q&&!v.hasLayer(Q)&&Q.addTo(v),ee&&!v.hasLayer(ee)&&ee.addTo(v))}function Yo(){const e=document.getElementById("refreshBtn");e&&e.addEventListener("click",async()=>{e.classList.add("updating");try{await Qo({timeoutMs:2500})}catch(t){r("[Refresh] Fehler im Update-Flow:",t),window.location.reload()}})}async function Qo({timeoutMs:e=2500}={}){if(!("serviceWorker"in navigator)){window.location.reload();return}const t=await navigator.serviceWorker.getRegistration();if(!t){r("[Refresh] Keine SW-Registration gefunden -> normaler Reload"),window.location.reload();return}r("[Refresh] Vor Update:",oi(t)),await t.update();let n=t.installing||t.waiting||null;n||(n=await ei(t,800)),n?(await ti(n),t.waiting&&(r("[Refresh] Sende SKIP_WAITING an Waiting-SW"),t.waiting.postMessage({type:"SKIP_WAITING"}))):r("[Refresh] Keine neue SW gefunden -> normaler Reload"),await ni(e),window.location.reload()}function ei(e,t){return new Promise(n=>{let o;const i=()=>{e.removeEventListener("updatefound",i),clearTimeout(o),n(e.installing||e.waiting||null)};e.addEventListener("updatefound",i),o=setTimeout(()=>{e.removeEventListener("updatefound",i),n(null)},t)})}function ti(e){return new Promise(t=>{if(e.state==="installed"||e.state==="activated")return t();e.addEventListener("statechange",()=>{(e.state==="installed"||e.state==="activated")&&t()})})}function ni(e){return new Promise(t=>{let n=!1;const o=()=>{n||(n=!0,navigator.serviceWorker.removeEventListener("controllerchange",i),t())},i=()=>{r("[Refresh] controllerchange empfangen"),o()};navigator.serviceWorker.addEventListener("controllerchange",i),setTimeout(()=>{r("[Refresh] controllerchange-Timeout, lade dennoch neu"),o()},e)})}function oi(e){const t=n=>n?n.state:"‚Äî";return{scope:e.scope,active:t(e.active),installing:t(e.installing),waiting:t(e.waiting),controlled:!!navigator.serviceWorker.controller}}function ii(){let e=0;const t=15e3,n=async()=>{const o=Date.now();if(!(o-e<t)){e=o;try{const i=await navigator.serviceWorker.getRegistration();if(!i)return;await i.update(),i.waiting&&i.waiting.postMessage({type:"SKIP_WAITING"})}catch{}}};document.addEventListener("visibilitychange",()=>{document.hidden||n()}),window.addEventListener("focus",n)}function ai(e,t,n){const o=ko[e]||"#666";return n?{radius:10,color:o,fillColor:o,fillOpacity:.9,opacity:1,weight:3}:t===!1?{radius:6,color:o,fillColor:o,fillOpacity:.25,opacity:.4,weight:1}:{radius:9,color:o,fillColor:o,fillOpacity:.7,opacity:.9,weight:2}}function rn(e,t,n,o){const i=n.title||t,a=!!n.visited,s=o?"aktiv":"inaktiv",c=a?"‚úÖ besucht":"üïí offen",u=n.imageUrl?`
      <div class="posten-preview" style="margin-top:6px">
        <img
          class="posten-preview-img"
          src="${_e(n.imageUrl)}"
          data-fullsrc="${_e(n.imageUrl)}"
          alt="${_e(i)}"
          loading="lazy"
          style="width:100%;height:auto;max-height:120px;object-fit:contain;border-radius:8px;cursor:zoom-in;display:block"
          referrerpolicy="no-referrer"
        />
      </div>
    `:"";return`
    <div class="posten-popup" style="min-width:200px">
      <strong>${G(i)}</strong><br>
      <small>Farbe: ${G(e)} (${s})</small><br>
      <small>Status: ${c}</small>
      ${u}
    </div>
  `}function si(e){const t=e.lat??e.latitude??null,n=e.lon??e.lng??e.longitude??null;return{lat:t,lon:n}}async function ri(){const e=p(y,"posten"),t=await A(e);be=t.exists()?t.val():null,nt(),X(e,n=>{be=n.exists()?n.val():null,nt()})}function ci(){const e=document.getElementById("img-lightbox"),t=document.getElementById("img-lightbox-close");if(!e||!t)return;const n=()=>e.style.display="none";t.addEventListener("click",n),e.addEventListener("click",o=>{o.target===e&&n()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&n()})}function li(){const e=t=>{const n=t.target.closest(".posten-preview-img");if(!n)return;t.preventDefault(),t.stopPropagation();const o=n.getAttribute("alt")||"Bild",i=n.getAttribute("data-fullsrc")||n.getAttribute("src");i&&di(i,o)};document.addEventListener("click",e,{capture:!0})}function di(e,t=""){const n=document.getElementById("img-lightbox"),o=document.getElementById("img-lightbox-img");!n||!o||(n.style.display="flex",o.onload=null,o.onerror=null,o.alt=t||"Bild",o.src===e&&(o.src=""),o.src=e)}function Wt(){q||(q=L.layerGroup()),v&&!v.hasLayer(q)&&q.addTo(v)}function nt(e={}){const{nonDestructive:t=!1}=e;if(!v||!be)return;Ft(),Wt();const n=new Set;let o=0;if(Object.entries(be).forEach(([i,a])=>{if(!a||typeof a!="object")return;const s=!!a.active,c=Object.fromEntries(Object.entries(a).filter(([u])=>u!=="active"));Object.entries(c).forEach(([u,l])=>{var g,h;if(!l||typeof l!="object")return;const{lat:m,lon:d}=si(l);if(m==null||d==null)return;o++;const f=`${i}/${u}`;n.add(f);const b=ai(i,s,!!l.visited);if(ie[f]){const w=ie[f];w.setLatLng([m,d]),w.setStyle(b),w._postenLoc=l,w._postenId=f,q&&!q.hasLayer(w)&&w.addTo(q),(g=w.bringToFront)==null||g.call(w),(h=w.getPopup())==null||h.setContent(rn(i,u,l,s))}else{const w=L.circleMarker([m,d],{...b,pane:"postenPane"}).bindPopup(rn(i,u,l,s));w._postenLoc=l,w._postenId=f,w.addTo(q),ie[f]=w}})}),!t){if(o===0){r("[posten] Kein g√ºltiger Posten geparst - Cleanup √ºbersprungen.");return}Object.keys(ie).forEach(i=>{n.has(i)||(q.removeLayer(ie[i]),delete ie[i])})}}Object.keys(ie).forEach(e=>{seen.has(e)||(q.removeLayer(ie[e]),delete ie[e])});async function ui(e=!0){const t=p(y,"posten"),n=await A(t);if(!n.exists())return;const o=n.val(),i={};Object.entries(o).forEach(([a,s])=>{!s||typeof s!="object"||(i[`posten/${a}/active`]=e,Object.entries(s).forEach(([c,u])=>{c==="active"||!u||typeof u!="object"||(i[`posten/${a}/${c}/visited`]=!1)}))}),await H(p(y),i)}const Ve=e=>e*Math.PI/180;function mi(e,t,n,o){const a=Ve(n-e),s=Ve(o-t),c=Math.sin(a/2)**2+Math.cos(Ve(e))*Math.cos(Ve(n))*Math.sin(s/2)**2;return 2*6371e3*Math.asin(Math.sqrt(c))}function Ht(e={enableHighAccuracy:!0,timeout:8e3,maximumAge:0}){return new Promise((t,n)=>{if(!navigator.geolocation)return n(new Error("Geolocation nicht unterst√ºtzt"));navigator.geolocation.getCurrentPosition(t,n,e)})}function fi(e={enableHighAccuracy:!0,timeout:15e3,maximumAge:0}){return new Promise((t,n)=>{if(!navigator.geolocation)return n(new Error("Geolocation nicht unterst√ºtzt"));let o=!1;const i=navigator.geolocation.watchPosition(a=>{o||(navigator.geolocation.clearWatch(i),o=!0),t(a)},a=>{o||(navigator.geolocation.clearWatch(i),o=!0),n(a)},e);e!=null&&e.timeout&&setTimeout(()=>{if(!o){try{navigator.geolocation.clearWatch(i)}catch{}o=!0;const a=new Error("Timeout");a.code=3,n(a)}},e.timeout)})}function Wn({excludeVisited:e=!0}={}){const t=[];for(const[n,o]of Object.entries(be))if(!(!o||o.active!==!0))for(const[i,a]of Object.entries(o.posts||{}))!a||typeof a!="object"||e&&a.visited===!0||t.push({color:n,postId:i,...a});return t}function Ze(e){const t=document.getElementById("postenSuggestions");if(!e||e.length===0){t.style.display="none",t.innerHTML="";return}t.innerHTML=e.map(n=>{const o=n.distance!=null?` - ${(n.distance/1).toFixed(0)} m`:"";return`<div class="item" data-color="${n.color}" data-postid="${n.postId}">
              ${n.title||"(ohne Titel)"}
              <span class="tag">${n.color}</span>${o}
            </div>`}).join(""),t.style.display="block",t.querySelectorAll(".item").forEach(n=>{n.addEventListener("click",()=>{var l,m;const o=n.getAttribute("data-color"),i=n.getAttribute("data-postid"),a=(m=(l=be[o])==null?void 0:l.posts)==null?void 0:m[i];if(!a){r("Ausgew√§hlter Posten nicht im Cache gefunden:",{color:o,postId:i}),document.getElementById("status").innerText="Dieser Posten ist nicht mehr verf√ºgbar.",t.style.display="none";return}const s={color:o,postId:i,title:a.title||i,lat:a.lat??null,lon:a.lon??null};oo(s);const c=document.getElementById("postenSearch");c&&(c.value=`${s.title} [${o}]`),t.style.display="none";const u=document.getElementById("status");u&&(u.innerText=`‚úÖ Posten ausgew√§hlt: ${s.title} (${o})`)})})}function Hn(e){const t=(e||"").trim().toLowerCase(),n=Wn();return t?n.filter(o=>{const i=String(o.postId).toLowerCase(),a=String(o.title||"").toLowerCase(),s=String(o.color).toLowerCase();return i.includes(t)||a.includes(t)||s.includes(t)}).slice(0,25):[]}async function gi(e=5){try{const t=await Ht(),{latitude:n,longitude:o,accuracy:i}=t.coords;i>100&&(document.getElementById("status").innerText=`‚ö†Ô∏è Standort ungenau (¬±${Math.round(i)}‚ÄØm). Ergebnisse evtl. ungenau.`);const a=Wn().map(s=>({...s,distance:s.lat!=null&&s.lon!=null?mi(n,o,s.lat,s.lon):Number.POSITIVE_INFINITY}));return a.sort((s,c)=>s.distance-c.distance),a.slice(0,e)}catch{return document.getElementById("status").innerText="üìç Konnte Standort nicht bestimmen. Du kannst trotzdem per Suche ausw√§hlen.",[]}}async function pi(){const e=p(y,"posten");X(e,t=>{const n=t.val()||{},o={};for(const[a,s]of Object.entries(n)){if(!s||typeof s!="object")continue;const{active:c,...u}=s,l={};for(const[m,d]of Object.entries(u))d&&typeof d=="object"&&(l[m]=d);o[a]={active:!!c,posts:l}}be=o;const i=document.getElementById("postenSearch").value;i&&Ze(Hn(i))})}function hi(){const e=document.getElementById("postenSearch"),t=document.getElementById("nearbyBtn");let n;e.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=Hn(e.value);Ze(o)},150)}),t.addEventListener("click",async()=>{const o=await gi(20);if(o.length===0){Ze(o),document.getElementById("status").innerText="Keine nahegelegenen Posten gefunden (oder Standort unbekannt).";return}Ze(o)}),document.addEventListener("click",o=>{const i=document.getElementById("postenSuggestions");i.contains(o.target)||e.contains(o.target)||t.contains(o.target)||(i.style.display="none")})}const ve=document.getElementById("notifHeader"),je=document.getElementById("notifHeaderToggle"),Tt=document.getElementById("notifSummary"),yi=document.getElementById("notifDetails"),cn=document.getElementById("notifStatusDot"),ln=document.getElementById("notifTimeShort"),dn=document.getElementById("notifTitle"),un=document.getElementById("notifBody"),mn=document.getElementById("notifSender"),fn=document.getElementById("notifTime"),gn=document.getElementById("notifId"),It=document.getElementById("recipientList"),Ke=document.getElementById("notifCount"),Me=document.getElementById("toggleNotifHeader");let he=null;function xt(e){ve.style.display=e?"block":"none",!e&&typeof he=="function"&&(he(),he=null)}function Ut(e){ve.classList.toggle("collapsed",e),ve.classList.toggle("expanded",!e),yi.hidden=e,je.setAttribute("aria-expanded",String(!e)),je.textContent=e?"‚ñæ":"‚ñ¥"}je==null||je.addEventListener("click",e=>{e.stopPropagation();const t=ve.classList.contains("collapsed");Ut(!t)});Tt==null||Tt.addEventListener("click",()=>{const e=ve.classList.contains("collapsed");Ut(!e)});function bi(e){return new Date(e).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}function $t(e){if(!e){dn.textContent="-",un.textContent="-",mn.textContent="-",fn.textContent="-",ln.textContent="[--:--]",gn.textContent="-",It.innerHTML="",cn.style.background="#bbb",Ke&&(Ke.textContent="-"),ve.classList.remove("sticky"),ve.style.position="";return}const t=typeof e.timestamp=="number"?e.timestamp:Date.now(),n=bi(t);dn.textContent=e.title||"Ohne Titel",un.textContent=e.body||"",mn.textContent=e.sender||"Unbekannt",fn.textContent=new Date(t).toLocaleString("de-DE"),ln.textContent=`[${n}]`,gn.textContent=e.id??"-";const o=e.recipients||{},i=Object.keys(o),a=i.filter(d=>o[d]===!0).length,s=i.length,c={};i.forEach(d=>{const f=oe(d);o[d]===!0?c[d]="green":e&&e.fallbackTargets&&e.fallbackTargets[f]?c[d]="orange":c[d]="red"});const u={};i.forEach(d=>{const f=(()=>{for(const[g,h]of Object.entries(O||{}))if(h.members&&h.members[d])return h;return null})();let b=c[d];b==="red"&&f&&Object.keys(f.members).filter(w=>w!==d).some(w=>c[w]==="green"||c[w]==="orange")&&(b="blue"),u[d]=b}),It.innerHTML="";const l=[];i.sort((d,f)=>d.localeCompare(f)).forEach(d=>{const f=u[d];l.push(f);const b=f==="green"?"ok":f==="orange"?"wait":f==="blue"?"teamblue":"red",g=f==="green"?"‚úÖ":f==="blue"?"üü¶":f==="orange"?"üì∞":"üî¥",h=document.createElement("div");h.className=`recipient-chip ${b}`,h.innerHTML=`<span class="dot"></span><span>${d}</span><span>${g}</span>`,It.appendChild(h)});let m="#FF5252";l.length>0&&(l.some(d=>d==="red")?m="#FF5252":l.some(d=>d==="blue")?m="#1E90FF":l.some(d=>d==="orange")?m="#FF8C00":m="#2ECC71"),cn.style.background=m,Ke&&(Ke.textContent=`${a}/${s} best√§tigt`)}function pn(){typeof he=="function"&&(he(),he=null);const e=Ye(p(y,"notifications"),Qe("timestamp"),Bt(1)),t=X(e,n=>{const o=n.val();if(!o){$t(null);return}const[i,a]=Object.entries(o)[0];$t({id:i,...a})});he=()=>t()}function wi(){const e=localStorage.getItem(bt)==="1";xt(e),e&&pn(),Me&&(Me.checked=e),Ut(!0),Me==null||Me.addEventListener("change",t=>{t.target.checked?(localStorage.setItem(bt,"1"),xt(!0),pn()):(localStorage.removeItem(bt),xt(!1),$t(null))})}async function vi(){if(confirm("M√∂chtest du wirklich die Standorte der Agenten anfragen?"))try{let e=O;(!e||Object.keys(e).length===0)&&(e=(await A(p(y,"teams"))).val()||{});const t={};for(const[a,s]of Object.entries(e)){if(a===M)continue;(s!=null&&s.members?Object.keys(s.members).length:0)>0&&(t[a]=!0)}if(Object.keys(t).length===0){r==null||r("[triggerAgentLocationRequest] Abbruch: keine adressierbaren Teams gefunden."),I("Keine Teams gefunden, die angefragt werden k√∂nnen.",{type:"error"});return}const n=String(Date.now()),o={id:n,createdAt:me(),createdBy:F,teamsAtRequest:t,responses:{}};await $(p(y,"agentLocationRequest"),o);const i=Object.keys(t);try{const{tokens:a,deviceNames:s,instantSMSDevices:c}=await Ro(i),u="Mister X hat deinen Standort angefragt",l="√ñffne die App, um deinen Standort freizugeben!";if(a&&a.length>0||c&&c.length>0){if(a&&a.length>0&&await ut(u,l,a,{recipientDeviceNames:s,link:"/Mister-X/",rtdbBase:K}),c&&c.length>0){const m=`${u}: ${l}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);await dt(de(),c,m,{rtdbBase:K})}}else r==null||r("[triggerAgentLocationRequest] Keine Empf√§nger in den ausgew√§hlten Teams gefunden.")}catch(a){r==null||r("[triggerAgentLocationRequest] Fehler beim Ermitteln der Empf√§nger",a)}return r==null||r("[triggerAgentLocationRequest] Anfrage ausgel√∂st",{reqId:n,totalTeams:Object.keys(t).length}),n}catch(e){throw r==null||r("[triggerAgentLocationRequest] Anfrage fehlgeschlagen",e),I("Konnte die Anfrage nicht ausl√∂sen.",{type:"error"}),e}}async function Un(e){var t,n;if(!(!e||!e.id)){if(vt.has(e.id)){r("shareTeamLocationForRequest: already in flight for "+e.id);return}try{if(localStorage.getItem(wt)===e.id){r("shareTeamLocationForRequest: already prompted (LS) for "+e.id);return}}catch{}vt.add(e.id);try{if(!M){I("Du bist in keinem Team. Standortfreigabe abgebrochen.",{type:"warn"});return}try{if(localStorage.getItem(J)===e.id){r("shareTeamLocationForRequest: already responded (LS) for "+e.id);return}}catch{}const o=p(y,`agentLocationRequest/responses/${M}`);if((await A(o)).exists()){try{localStorage.setItem(J,e.id)}catch{}return}const a=p(y,"agentLocationRequest"),s=await A(a);if(!s.exists()){I("Die Anfrage wurde zur√ºckgezogen ‚Äî Standort wird nicht gesendet.",{type:"warn"});try{localStorage.setItem(J,e.id)}catch{}return}const c=s.val();if(c!=null&&c.id&&c.id!==e.id){I("Es gibt inzwischen eine andere Anfrage ‚Äî Standort wird nicht gesendet.",{type:"warn"});try{localStorage.setItem(J,e.id)}catch{}return}try{localStorage.setItem(wt,e.id)}catch{}const u=await Ci("Dein Standort wird jetzt f√ºr Mister X freigegeben",e.id,{maxWaitMs:1e4,desiredAccuracy:30,autoConfirmMs:3e4});if(u===null){r("shareTeamLocationForRequest: confirm dialog auto-closed");try{localStorage.setItem(J,e.id)}catch{}try{localStorage.removeItem("pendingAgentResponse")}catch{}return}if(u==="cancel"){I("Standortfreigabe abgebrochen.",{type:"info"});try{localStorage.setItem(J,e.id)}catch{}try{localStorage.removeItem("pendingAgentResponse")}catch{}return}const l=u.position,m=l.coords.latitude,d=l.coords.longitude,f=typeof l.coords.accuracy=="number"?Math.round(l.coords.accuracy):null,b=((t=O==null?void 0:O[M])==null?void 0:t.name)||"Team";I("Standort freigegeben",{type:"success"});const g=await A(a);if(!g.exists()||(n=g.val())!=null&&n.id&&g.val().id!==e.id){I("Die Anfrage wurde zur√ºckgezogen oder ersetzt ‚Äî Standort wird nicht gesendet.",{type:"warn"});try{localStorage.setItem(J,e.id)}catch{}return}const h=await Pe(a,S=>{if(!S||S.id!==e.id)return;const k=S.responses||{};return k[M]||(k[M]={teamId:M,teamName:b,lat:m,lon:d,accuracy:typeof f=="number"?f:null,deviceId:F,timestamp:me()},S.responses=k),S},{applyLocally:!1});if(!!!(h!=null&&h.committed)){I("Standort nicht gesendet: die Anfrage wurde zur√ºckgezogen oder bereits beantwortet.",{type:"warn"});try{localStorage.setItem(J,e.id)}catch{}return}try{localStorage.setItem(J,e.id)}catch{}try{localStorage.removeItem("pendingAgentResponse")}catch{}r("Standortantwort erfolgreich gesetzt (agentLocationRequest.responses/"+M+")")}finally{try{vt.delete(e.id)}catch{}try{localStorage.removeItem(wt)}catch{}}}}async function qn(e){if(!e||!e.reqId||!e.teamId)return!1;const t=p(y,"agentLocationRequest");try{const n=await Pe(t,i=>{var s;if(!i||i.id!==e.reqId)return;const a=i.responses||{};return a[e.teamId]||(a[e.teamId]={teamId:e.teamId,teamName:e.teamName||((s=O==null?void 0:O[e.teamId])==null?void 0:s.name)||"Team",lat:e.lat,lon:e.lon,accuracy:typeof e.accuracy=="number"?e.accuracy:null,deviceId:F,timestamp:me()},i.responses=a),i},{applyLocally:!1});if(!!(n!=null&&n.committed)){try{localStorage.removeItem("pendingAgentResponse"),localStorage.setItem(J,e.reqId)}catch{}return I("Standort wurde im Hintergrund gesendet.",{type:"success"}),r("sendPendingAgentResponse: committed for "+e.reqId),!0}return r("sendPendingAgentResponse: transaction not committed"),!1}catch(n){return r("sendPendingAgentResponse error",n),!1}}async function hn(e){try{const t=localStorage.getItem("pendingAgentResponse");if(!t)return;const n=JSON.parse(t);if(!n||!n.reqId||!e||!e.id||e.id!==n.reqId||!M||n.teamId!==M)return;const o=p(y,`agentLocationRequest/responses/${M}`);if((await A(o)).exists()){try{localStorage.removeItem("pendingAgentResponse"),localStorage.setItem(J,n.reqId)}catch{}return}if(await qn(n))return;I("Dein Standort konnte nicht automatisch gesendet werden. Bitte best√§tige erneut.",{type:"warn"});try{await Un(e)}catch(s){r("checkAndDeliverPendingResponse share prompt failed",s)}}catch(t){r("checkAndDeliverPendingResponse error",t)}}function Si(){z(p(y,"agentLocationRequest")),Ei(),_t()}function _t(){Array.isArray(Te)&&Te.length&&window.map&&Te.forEach(e=>v.removeLayer(e)),Te=[]}function ki(){const e=p(y,"agentLocationRequest");X(e,n=>{const o=n.exists()?n.val():null;if(Rn=o,Gn(o),o&&o.createdBy!==F&&M){try{if(o.responses&&o.responses[M])return}catch{}try{hn(o).catch(i=>r("checkAndDeliverPendingResponse error",i))}catch{}Ti(o)}}),(async()=>{try{const n=await A(e);n&&n.exists()&&await hn(n.val())}catch{}})()}function Ei(){const e=document.getElementById("agentReqStatus");e&&(e.style.display="none")}async function Ti(e){try{await Un(e)}catch(t){r("Standortfreigabe fehlgeschlagen",t)}}function Gn(e=Rn){const t=document.getElementById("agentReqStatus"),n=document.getElementById("agentReqProgress");if(!t||!n)return;if(!e){t.style.display="none",_t();return}const o=typeof e.createdAt=="number"?new Date(e.createdAt).toLocaleTimeString():"Unbekannt",i=e.responses||{},a=Object.values(i),s=e.teamsAtRequest||{},c=Object.keys(s).length||a.length,u=a.length;if(n.textContent=`Standort von ${u}/${c} Teams ‚Äì ${o}`,t.style.display="block",_t(),!(!Xe||a.length===0)){Ii(a);for(const l of a){if(l.lat==null||l.lon==null)continue;const m=L.divIcon({className:`square-marker ${xi(l.teamId)}`,iconSize:[14,14]}),d=L.marker([l.lat,l.lon],{icon:m,pane:"agentenPane"}).addTo(v),f=typeof l.accuracy=="number"?` (¬±${Math.round(l.accuracy)} m)`:"";if(d.bindPopup(`<strong>${G(l.teamName||"Team")}${f}</strong>`),Te.push(d),typeof l.accuracy=="number")try{const b=L.circle([l.lat,l.lon],{radius:l.accuracy,color:"#888",weight:1,fillColor:"#888",fillOpacity:.08,pane:"agentenPane",interactive:!1}).addTo(v);Te.push(b)}catch(b){r("Konnte Genauigkeitskreis von Agentenstandort nicht erzeugen",b)}}}}function Ii(e){if(!window.map){const t=e.find(n=>n.lat!=null&&n.lon!=null);t&&Rt(t.lat,t.lon)}}function xi(e){const t=["","orange","green","purple","blue","red","yellow","cyan","pink","lime","teal","brown"],n=Math.abs(Li(String(e)))%t.length;return t[n]}function Li(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}function Ai(){A(p(y,"roles")).then(e=>{const t=e.val();for(const n in t)t[n].role==="misterx"&&$(p(y,"roles/"+n),{role:"start",timestamp:Date.now()});I("Alle Mister X Rollen wurden zur√ºckgesetzt.",{type:"info"})})}async function Bi(){const e=await A(p(y,"settings/max_Team_X")),t=e.exists()?e.val():1,o=(await A(p(y,"roles"))).val();let i=0;for(const a in o)o[a].role==="misterx"&&i++;return i<t}async function qt(e){if(e!==localStorage.getItem("activeView")){if(e==="misterx"&&!await Bi()){I("Es sind bereits die maximal erlaubten Mister X Spieler aktiv.",{type:"error"}),Je();return}if(e==="settings"&&prompt("Passwort eingeben!")!=="1001"){Je();return}}if(e==="start")return Je();document.getElementById("startView").style.display="none",document.getElementById("startView2").style.display="none",document.querySelectorAll(".view").forEach(t=>t.style.display="none"),e==="misterx"?(document.getElementById("misterxView").style.display="block",A(p(y,Pt)).then(t=>{const n=t.exists()?!!t.val():!1;We(n)}).catch(()=>{})):e==="agent"?(document.getElementById("agentView").style.display="block",We(!1)):e==="settings"&&(document.getElementById("settingsView").style.display="block",ji(),We(!1)),localStorage.setItem("activeView",e),H(p(y,"roles/"+F),{role:e,timestamp:Date.now()}),A(p(y,"timer")).then(t=>{const n=t.val();if(n){const{startTime:o,duration:i,durationInput:a,durationInput2:s}=n;i?(Vn(o,i),Se(!0)):Se(!1)}})}async function Je(){document.querySelectorAll(".view").forEach(e=>e.style.display="none"),document.getElementById("startView").style.display="block",document.getElementById("startView2").style.display="block",clearInterval(le),localStorage.setItem("activeView","start"),H(p(y,"roles/"+F),{role:"start",timestamp:Date.now()})}async function Ie(e){await z(p(y,"timer/duration")),await z(p(y,"timer/startTime")),await z(p(y,"timerMessage")),typeof le<"u"&&clearInterval(le);const n=(await A(p(y,"timer"))).val();let o=25*60;typeof(n==null?void 0:n.durationInput)=="number"&&n.durationInput>0&&(o=n.durationInput,(isNaN(o)||o<1)&&(o=60)),typeof e=="number"&&e>0&&(o=e);const i=Date.now(),a=i+o*1e3,s={title:"Deine Zeit l√§uft gleich ab",body:"Bitte √∂ffne deine App!"};await $(p(y,"timer"),{startTime:i,duration:o,durationInput:n==null?void 0:n.durationInput,durationInput2:(n==null?void 0:n.durationInput2)||0});try{await we.rpc("cancel_and_unschedule")}catch(d){r("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",d)}const{tokens:c,deviceNames:u}=await Mo("misterx"),l=o-60,m=(de==null?void 0:de())??void 0;await we.functions.invoke("arm-timer-cron",{body:{title:s.title,body:s.body,dueInSec:l,messageId:m,link:"/Mister-X/",roles:["misterx"],resolveRecipientsAtSendTime:!0,rtdbBase:K}}),r(`üïí Timer gestartet: ${o}s, f√§llt um ${new Date(a).toLocaleTimeString()}.`)}function Pi(){Kt||(Kt=!0,X(p(y,"timer"),e=>{const t=e.val()||{},{startTime:n=null,duration:o=null,durationInput:i=null,durationInput2:a=null}=t;if(n===null||o===null){clearInterval(le),Se(!1);const s=document.getElementById("timer"),c=document.getElementById("agentTimer"),u=document.getElementById("settingsTimer");s&&(s.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--",s.style.color="",s.style.animation=""),c&&(c.innerText="‚è≥ Mister X Timer: --:--",c.style.color="",c.style.animation=""),u&&(u.innerText="‚è≥ Aktueller Timer: --:--",u.style.color="",u.style.animation="");return}Vn(n,o),Se(!0)}))}function Vn(e,t){clearInterval(le);let n=!1;const o=re(e,t);Xt!==o&&(Xt=o,yt=!1),le=setInterval(async()=>{if(!n){n=!0;try{let i=function(f){f&&(c<=300?(f.style.color="red",f.style.animation="blinker 1s linear infinite"):(f.style.color="",f.style.animation=""))};const a=Date.now(),s=Math.floor((a-e)/1e3),c=t-s;let u;if(c<0)u="abgelaufen";else{const f=Math.floor(c/60),b=c%60;u=`${String(f).padStart(2,"0")}:${String(b).padStart(2,"0")}`}const l=document.getElementById("timer"),m=document.getElementById("agentTimer"),d=document.getElementById("settingsTimer");if(d&&(d.innerText=`‚è≥ Aktueller Timer: ${u}`,i(d)),l&&(l.innerText=`‚è≥ Zeit bis zum n√§chsten Posten: ${u}`,i(l)),m&&(m.innerText=`‚è≥ Mister X Timer: ${u}`,i(m)),!yt&&c>0&&c<=10&&localStorage.getItem("activeView")==="misterx"&&(yt=!0,at().catch(f=>r("Standort-Vorw√§rmung (Timer):",f))),c<=0&&([l,m,d].forEach(f=>{f&&(f.style.color="",f.style.animation="")}),localStorage.getItem("activeView")==="misterx"))try{const b=(await A(p(y,"timer"))).val()||{},{startTime:g,duration:h,durationInput:w,durationInput2:S}=b||{};if(typeof g!="number"||typeof h!="number")return;const k=re(g,h);if(Ri(k)||pt)return;if(h===w&&(S??0)>0){const E="Zeit abgelaufen, dein Standort wird einmalig geteilt.";pt=!0;const T=await Mi(E,{startTime:g,duration:h});if(pt=!1,T===null){I("Dialog geschlossen: Timer wurde verl√§ngert oder zur√ºckgesetzt",{type:"info"}),r("showLocationDialog: automatisch geschlossen, Timer wurde verl√§ngert, ersetzt oder zur√ºckgesetzt.");return}if(T==="desc")for(;;){const B=await Zn(re(g,h));if(B===null){Y();break}if(!B){try{if(await Le(g,h)){Y();break}}catch{}continue}const N=await it(y,async C=>{const U=C==null?void 0:C.durationInput,V=C==null?void 0:C.durationInput2;if(h===U&&(V??0)>0){try{const x=await Ht(),{latitude:D,longitude:pe,accuracy:Ce}=x.coords,Vt=Date.now();try{if(await ft()){r("showLocationDialog: timer no longer expired - abort write"),Y();return}}catch(ao){r("showLocationDialog: secondLookAbort failed - proceeding with write attempt",ao)}const io=Ce<=100?{title:"Automatischer Standort",lat:D,lon:pe,accuracy:Ce,description:B,timestamp:Vt}:{description:B,timestamp:Vt};await ot(C,io)||(r("showLocationDialog: write skipped because existing entry detected or claim lost"),Y())}catch{const D={description:B,timestamp:Date.now()};await ot(C,D)||(r("showLocationDialog: write skipped (exception path)"),Y())}Gt(V),j()}});xe(k),N||(Y(),j());break}else{const B=await Ni();xe(k),B||(Y(),j())}}else alert("Zeit abgelaufen, jetzt musst du deinen Live-Standort in der WhatsApp-Gruppe teilen."),await it(y,async()=>{await Promise.all([z(p(y,"timer/duration")),z(p(y,"timer/startTime")),z(p(y,"timerMessage"))]),clearInterval(le),Se(!1),l&&(l.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--"),m&&(m.innerText="‚è≥ Mister X Timer: --:--"),d&&(d.innerText="‚è≥ Aktueller Timer: --:--"),ue("Zeit abgelaufen!","Mister X muss sich per Live-Standort zeigen","all")})||Y()}catch(f){r("Fehler im Ablauf-Handling:",f)}}finally{n=!1}}},1e3)}async function Ci(e,t,{maxWaitMs:n=1e4,desiredAccuracy:o=30,autoConfirmMs:i=3e4}={}){return new Promise(a=>{var Z;const s=document.createElement("div");s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100vw",s.style.height="100vh",s.style.background="rgba(0,0,0,0.6)",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.zIndex="99999";const c=document.createElement("div");c.style.background="#fff",c.style.padding="1.2em",c.style.borderRadius="8px",c.style.width="min(520px, 92vw)",c.style.maxWidth="520px",c.style.textAlign="center",c.style.position="relative";const u=document.createElement("div");u.style.fontWeight="600",u.style.marginBottom="0.4em",u.textContent=e;const l=document.createElement("div");l.style.fontSize="14px",l.style.color="#333",l.style.marginBottom="0.6em";const m=((Z=O==null?void 0:O[M])==null?void 0:Z.name)||"";l.textContent=m?"Team: "+m:"Team: -";const d=document.createElement("div");d.style.position="absolute",d.style.top="8px",d.style.right="10px",d.style.fontSize="11px",d.style.color="#666",d.textContent="¬± ‚Äì m";const f=document.createElement("div");f.style.display="flex",f.style.justifyContent="center";const b=document.createElement("button");b.textContent="Standort teilen",b.className="small-button",b.disabled=!0,f.appendChild(b),c.appendChild(u),c.appendChild(l),c.appendChild(f),c.appendChild(d),b.style.padding="12px 22px",b.style.fontSize="16px",b.style.minWidth="200px",b.style.borderRadius="8px",s.appendChild(c),document.body.appendChild(s);let g=null,h=null;const w=p(y,"agentLocationRequest");let S=null;const k=async()=>{var x;try{if(!g)return;const D=g,pe=typeof D.coords.accuracy=="number"?Math.round(D.coords.accuracy):null,Ce={reqId:t,teamId:M||null,teamName:((x=O==null?void 0:O[M])==null?void 0:x.name)||null,lat:D.coords.latitude,lon:D.coords.longitude,accuracy:pe,timestamp:Date.now()};localStorage.setItem("pendingAgentResponse",JSON.stringify(Ce)),await qn(Ce)}catch(D){r("onPageHide: error trying to send pending response",D)}},P=()=>{document.hidden&&k()};window.addEventListener("pagehide",k),window.addEventListener("visibilitychange",P),window.addEventListener("beforeunload",k);const E=()=>{try{h!=null&&navigator.geolocation.clearWatch(h)}catch{}try{ce(w,"value",U)}catch{}try{s&&document.body.contains(s)&&document.body.removeChild(s)}catch{}try{S&&clearTimeout(S)}catch{}try{window.removeEventListener("pagehide",k)}catch{}try{window.removeEventListener("visibilitychange",P)}catch{}try{window.removeEventListener("beforeunload",k)}catch{}},T=x=>{if(!x)return;if(!g){g=x;return}const D=typeof x.coords.accuracy=="number"?x.coords.accuracy:1/0,pe=typeof g.coords.accuracy=="number"?g.coords.accuracy:1/0;D<pe&&(g=x)},B=x=>{if(!x)return;const D=typeof x.coords.accuracy=="number"?Math.round(x.coords.accuracy):null;d.textContent=D!=null?`Genauigkeit: ¬±${D} m`:"Genauigkeit: -",b.disabled=!1},N=x=>{T(x),B(x)},C=x=>{x&&x.code===x.PERMISSION_DENIED?(I("Standortzugriff verweigert. Freigabe nicht m√∂glich.",{type:"error"}),E(),a("cancel")):I("Fehler beim Ermitteln des Standorts.",{type:"warn"})};if(!("geolocation"in navigator)){I("Geolocation wird nicht unterst√ºtzt.",{type:"error"}),E(),a("cancel");return}try{h=navigator.geolocation.watchPosition(N,C,{enableHighAccuracy:!0,maximumAge:0,timeout:1e4})}catch{I("Fehler beim Starten der Standortabfrage.",{type:"error"}),E(),a("cancel");return}S=setTimeout(()=>{try{V()}catch(x){r("autoConfirm error",x)}},i);const U=x=>{const D=x.exists()?x.val():null;try{if(!D||D.id&&D.id!==t){E(),a(null);return}if(D.responses&&M&&D.responses[M]){E(),I("Standort wurde bereits von einem Ger√§t deines Teams geteilt.",{type:"info"}),a(null);return}}catch{}};X(w,U);const V=()=>{try{S&&(clearTimeout(S),S=null)}catch{}if(E(),g)return a({action:"confirm",position:g});navigator.geolocation.getCurrentPosition(x=>a({action:"confirm",position:x}),x=>{I("Kein Standort verf√ºgbar.",{type:"warn"}),a("cancel")},{enableHighAccuracy:!0,timeout:8e3})};b.onclick=()=>{V()},(async()=>{try{const x=await A(w),D=x.exists()?x.val():null;if(!D||D.id&&D.id!==t){E(),a(null);return}typeof m<"u"&&l&&(l.textContent="Team: "+m)}catch{}})()})}async function Mi(e,t=null){return new Promise(n=>{const o=document.createElement("div");o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100vw",o.style.height="100vh",o.style.background="rgba(0,0,0,0.7)",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.zIndex="9999";const i=document.createElement("div");i.style.background="#fff",i.style.padding="2em",i.style.borderRadius="10px",i.style.maxWidth="90vw",i.style.textAlign="center",i.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>${e}</strong><br>
        Du kannst optional eine Beschreibung hinzuf√ºgen (z.B. falls GPS ungenau ist oder du dich in der U-Bahn befindest).
      </div>
      <button id="loc-ok-btn" style="margin:0 1em 0 0;">OK</button>
      <button id="loc-desc-btn">Standort-Beschreibung hinzuf√ºgen</button>
    `,o.appendChild(i),document.body.appendChild(o);const a=p(y,"timer"),s=u=>{const l=u.exists()?u.val():null;try{if(l===null){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{ce(a,"value",s)}catch{}n(null);return}if(t&&(l.startTime!==t.startTime||l.duration!==t.duration)){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{ce(a,"value",s)}catch{}n(null);return}if(st(l)){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{ce(a,"value",s)}catch{}n(null);return}if(t){const m=re(t.startTime,t.duration);if(l.lastLocationFor===m){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{ce(a,"value",s)}catch{}I("Standort wurde bereits von einem anderen Ger√§t geteilt.",{type:"info"}),n(null);return}}}catch{}};X(a,s);const c=u=>{try{ce(a,"value",s)}catch{}if(document.body.contains(o))try{document.body.removeChild(o)}catch{}n(u)};document.getElementById("loc-ok-btn").onclick=()=>c("ok"),document.getElementById("loc-desc-btn").onclick=()=>c("desc"),(async()=>{try{const u=await A(a),l=u.exists()?u.val():null;if(l===null){c(null);return}if(t&&(l.startTime!==t.startTime||l.duration!==t.duration)){c(null);return}st(l)&&c(null)}catch{}})()})}function re(e,t){return`${e}_${t}`}function Ri(e){const t=`alertHandled_${e}`;return sessionStorage.getItem(t)==="1"}function xe(e){const t=`alertHandled_${e}`;sessionStorage.setItem(t,"1")}async function Le(e,t,n=6e4){try{const o=re(e,t);try{const c=await A(p(y,"timer")),u=c.exists()?c.val():null;if(u&&u.lastLocationFor===o)return!0}catch{}try{const c=Ye(p(y,"locations"),Qe("expKey"),mo(o),Bt(1));if((await A(c)).exists())return!0}catch{}const i=e+t*1e3,a=Ye(p(y,"locations"),Qe("timestamp"),fo(Math.max(0,e-5e3)),Bn(i+n),Bt(1));return(await A(a)).exists()}catch(o){return r("existingLocationForTimer failed",o),!1}}async function ot(e,t){var u;const{startTime:n,duration:o}=e||{};if(typeof n!="number"||typeof o!="number")return r("safePushLocationForExpiration: invalid timerData",e),!1;const i=re(n,o);if(await Le(n,o))return r("safePushLocationForExpiration: detected existing location for expKey",i),!1;const s=p(y,`locationClaims/${i}`),c=te();try{const l=await Pe(s,w=>w&&w.claimed?w:{claimed:!0,by:c,at:me()},{applyLocally:!1}),m=l==null?void 0:l.committed,d=(u=l==null?void 0:l.snapshot)==null?void 0:u.val();if(!(m&&d&&d.by===c))return r("safePushLocationForExpiration: lost claim for expKey",i),!1;if(await Le(n,o))return r("safePushLocationForExpiration: someone wrote meanwhile for expKey",i),!1;const g=t.timestamp||Date.now(),h={...t,expKey:i,claimedBy:c,timestamp:g};await lt(p(y,"locations"),h);try{await H(p(y,"timer"),{lastLocationFor:i})}catch{}return!0}catch(l){return r("safePushLocationForExpiration failed",l),!1}}async function Fi(e,t=48*60*60*1e3){let n=Date.now();try{const u=await A(p(e,".info/serverTimeOffset")),l=typeof u.val()=="number"?u.val():0;n+=l}catch{}const o=n-t,i=Ye(p(e,"timerClaims"),Qe("at"),Bn(o)),a=await A(i),s={};a.exists()&&a.forEach(u=>{const l=u.val();typeof(l==null?void 0:l.at)=="number"&&l.at<=o&&(s[`timerClaims/${u.key}`]=null)}),Object.keys(s).length&&await H(p(e),s)}async function it(e,t){var b;const o=(await A(p(e,"timer"))).val()||{},{startTime:i,duration:a}=o;if(typeof i!="number"||typeof a!="number")return!1;const s=re(i,a),c=p(e,`timerClaims/${s}`),u=te(),l=await Pe(c,g=>g&&g.claimed?g:{claimed:!0,by:u,at:me()},{applyLocally:!1}),m=l.committed,d=(b=l.snapshot)==null?void 0:b.val();if(!(m&&d&&d.by===u))return!1;try{if(await Le(i,a))return r("doOncePerExpiration: existing location detected for",s),!1}catch(g){r("doOncePerExpiration: existing-location check failed, proceeding with action",g)}try{if(await ft()){r("doOncePerExpiration: timer no longer expired - aborting action for",s);try{await $(c,null)}catch{}return!1}}catch(g){r("doOncePerExpiration: secondLookAbort failed - proceeding with action",g)}await t(o);try{if(!await Le(i,a))try{await $(c,null)}catch{}}catch{try{await $(c,null)}catch{}}try{await Fi(e,5*60*1e3)}catch(g){r("GC timerClaims fehlgeschlagen:",g)}return!0}function Y(){r("Bereits von anderem Ger√§t erledigt.");try{const e=document.getElementById("status");e&&(e.innerText="‚ÑπÔ∏è Der Standort wurde bereits von einem anderen Ger√§t geteilt.")}catch{}try{I("‚ÑπÔ∏è Jemand anderes hat bereits den Standort geteilt. Dein Eintrag wurde nicht hinzugef√ºgt.",{type:"info"})}catch{}}function Di(){A(p(y,"timer")).then(e=>{if(!e.exists())return;const t=e.val(),n=document.getElementById("timerDurationInput"),o=document.getElementById("timerDurationInput2");!n||!o||(t&&typeof t.durationInput=="number"?n.value=Math.floor(t.durationInput/60):n.value=25,t&&typeof t.durationInput2=="number"?o.value=Math.floor(t.durationInput2/60):o.value=5)})}const Kn=document.createElement("style");Kn.innerHTML=`
@keyframes blinker {
  50% { opacity: 0; }
}
`;document.head.appendChild(Kn);async function at(){try{if(!navigator.permissions||(await navigator.permissions.query({name:"geolocation"})).state!=="granted")return}catch{return}if($e!==null){clearTimeout(ye),yn();return}if(!navigator.geolocation)return;const e={enableHighAccuracy:!0,maximumAge:0,timeout:15e3};try{Re=0,Fe=null,$e=navigator.geolocation.watchPosition(t=>{const n=t.coords.accuracy,o=Date.now();Cn={ts:o,accuracy:n},(!Re||o-Re>=1e4||Fe!==null&&Math.abs(n-Fe)>=15)&&(Re=o,Fe=n,r(`Standort-Vorw√§rmung aktiv (¬±${Math.round(n)} m)`))},t=>{r(`Standort-Vorw√§rmung: ${t.message}`)},e),r("Standort-Vorw√§rmung gestartet (30s)"),yn()}catch(t){r("Standort-Vorw√§rmung: Fehler beim Starten -",t.message)}}function yn(){ye&&clearTimeout(ye),ye=setTimeout(()=>{j()},bo)}function j(){ye&&(clearTimeout(ye),ye=null),$e!==null&&(navigator.geolocation.clearWatch($e),$e=null,Cn=null,Fe=null,Re=0,r("Standort-Vorw√§rmung beendet"))}async function Xn(){return(await A(p(y,"timer"))).val()||{}}function st(e){const{startTime:t,duration:n}=e||{};return typeof t=="number"&&typeof n=="number"&&t+n*1e3>Date.now()}async function ft(){try{const e=await Xn();if(st(e))return r("Timer wurde in der Zwischenzeit verl√§ngert - Abbruch vor dem Schreiben."),!0}catch(e){return r("Zweiter Timer-Check fehlgeschlagen:",e),!0}return!1}function Gt(e){ue("Mister X hat sich gezeigt!","Automatische Standort-√úbermittlung",["agent","settings","start"]),zn(),e!=null?Ie(e):r("durationInput2 war nicht vorhanden - Timer wird nicht neu gestartet.")}async function Lt(e){const n=(await A(p(y,"timer"))).val()||{},o=re(n.startTime,n.duration);for(;;){const i=await Zn(o);if(i===null)return Y(),j(),!1;if(!i){try{if(await Le(n.startTime,n.duration))return Y(),xe(o),j(),!1}catch{}continue}const a=await it(y,async s=>{const c=s==null?void 0:s.durationInput2;if(!((n==null?void 0:n.duration)===(s==null?void 0:s.durationInput)&&(c??0)>0)||await ft())return;await ot(n,{description:i,timestamp:Date.now()})||r("askManualAndWrite: write skipped because existing entry detected or claim lost"),Gt(c),j()});return xe(o),a||(Y(),j()),a}}async function Ni({autoRetry:e=!0,maxRetries:t=3,retryDelayMs:n=1e4}={}){let o,i;try{if(i=await Xn(),o=i.durationInput2,st(i))return r("Timer wurde verl√§ngert ‚Äì Abbruch."),!1}catch(l){return r("Timer lesen fehlgeschlagen:",l),!1}const a=re(i.startTime,i.duration);if(!("geolocation"in navigator)){document.getElementById("status").innerText="Geolocation wird nicht unterst√ºtzt.";const l=await Lt();return xe(a),j(),!!l}let s=Math.max(0,t),c=!1;const u={enableHighAccuracy:!0,maximumAge:0,timeout:15e3};return await new Promise(l=>{const m=async b=>{if(await ft())return j(),l(!1);const{latitude:g,longitude:h,accuracy:w}=b.coords,S=Date.now();if(w>100){document.getElementById("status").innerText="‚ö†Ô∏è Standort ungenau (¬±"+Math.round(w)+" m). Bitte Standortbeschreibung manuell eingeben.";const P=await Lt();return l(!!P)}const k=await it(y,async P=>{const E=P==null?void 0:P.durationInput,T=P==null?void 0:P.durationInput2;if(!(i.duration===E&&(T??0)>0))return;await ot(P,{title:"Automatischer Standort",lat:g,lon:h,accuracy:w,timestamp:S})||r("getLocation: write skipped because existing entry detected or claim lost"),Gt(T),j()});xe(a),k||j(),l(!!k)},d=()=>{!e||s<=0||(s--,setTimeout(()=>{navigator.geolocation.getCurrentPosition(m,f,u)},n))},f=async b=>{let g="‚ùå Fehler beim Abrufen des Standorts.";switch(b.code){case b.PERMISSION_DENIED:g+=" Zugriff verweigert.";break;case b.POSITION_UNAVAILABLE:g+=" Standortinformationen nicht verf√ºgbar.";break;case b.TIMEOUT:g+=" Zeit√ºberschreitung bei der Standortabfrage.";break}if(g+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=g,!c){c=!0;const h=await Lt();return l(!!h)}b.code===b.TIMEOUT||b.code===b.POSITION_UNAVAILABLE?d():(j(),l(!1))};navigator.geolocation.getCurrentPosition(m,f,u)})}async function Zn(e=null){return new Promise(t=>{const n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100vw",n.style.height="100vh",n.style.background="rgba(0,0,0,0.7)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="9999";const o=document.createElement("div");o.style.background="#fff",o.style.padding="2em",o.style.borderRadius="10px",o.style.maxWidth="90vw",o.style.textAlign="center",o.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>Standort-Beschreibung hinzuf√ºgen</strong><br>
        Bitte gib eine Beschreibung deines Standorts ein.
      </div>
      <textarea id="desc-input" rows="3" style="width:90%;"></textarea><br>
      <div id="desc-error" style="color:#900;display:none;margin-top:0.5em;">Die Beschreibung darf nicht leer sein.</div>
      <button id="desc-ok-btn" style="margin-top:1em;" disabled>OK</button>
    `,n.appendChild(o),document.body.appendChild(n);const i=document.getElementById("desc-ok-btn"),a=document.getElementById("desc-input"),s=document.getElementById("desc-error"),c=()=>{a.value.trim().length===0?(i.disabled=!0,s&&(s.style.display="block")):(i.disabled=!1,s&&(s.style.display="none"))};a.addEventListener("input",c),c();let u=null;if(e){const l=p(y,"timer"),m=d=>{try{const f=d.exists()?d.val():null;if(f&&f.lastLocationFor===e){try{document.body.contains(n)&&document.body.removeChild(n)}catch{}if(u)try{ce(l,"value",m)}catch{}I("Standort wurde bereits von einem anderen Ger√§t geteilt.",{type:"info"}),t(null)}}catch{}};X(l,m),u=()=>ce(l,"value",m)}i.onclick=()=>{const l=a.value.trim();if(!l){c();return}if(document.body.removeChild(n),typeof u=="function")try{u()}catch{}t(l)}})}function Se(e){const t=document.getElementById("startTimerButton");t&&(t.disabled=e,t.style.opacity=e?"0.5":"1",t.style.pointerEvents=e?"none":"auto",t.style.cursor=e?"default":"pointer")}function $i(){localStorage.getItem("nachrichtAktiv")?(document.getElementById("permissionButton").style.display="none",document.getElementById("permissionButton2").style.display="block"):(document.getElementById("permissionButton").style.display="block",document.getElementById("permissionButton2").style.display="none")}async function _i(){if(confirm("M√∂chtest du wirklich alle gespeicherten Standorte und Eintr√§ge l√∂schen?"))try{await z(p(y,"locations")),await z(p(y,"events/ubahn")),I("Alle Standorte und Eintr√§ge wurden gel√∂scht.",{type:"info"}),yo=[];const e=document.getElementById("status");e&&(e.innerText=""),ze=null,Oe=null;const t=document.getElementById("locationFeed");t&&(t.innerHTML=""),await ui(!0),nt()}catch(e){r(e),I("Fehler beim L√∂schen der Standorte und Eintr√§ge.",{type:"error"})}}async function Oi(){await z(p(y,"timer/duration")),await z(p(y,"timer/startTime")),await z(p(y,"timerMessage")),clearInterval(le),Se(!1);try{await we.rpc("cancel_and_unschedule")}catch(o){r("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",o)}const e=document.getElementById("timer"),t=document.getElementById("agentTimer"),n=document.getElementById("settingsTimer");e&&(e.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--"),t&&(t.innerText="‚è≥ Mister X Timer: --:--"),n&&(n.innerText="‚è≥ Aktueller Timer: --:--"),ue("Timer zur√ºckgesetzt","Der Timer wurde zur√ºckgesetzt!","all")}function zi(){const e=document.getElementById("max_Team_X").value;z(p(y,"settings/max_Team_X")).then(()=>$(p(y,"settings/max_Team_X"),Number(e))).then(()=>{r("max_Team_X erfolgreich gespeichert:",e)}).catch(t=>{r("Fehler beim Speichern von max_Team_X:",t)})}function ji(){const e=document.getElementById("max_Team_X");A(p(y,"settings/max_Team_X")).then(t=>{t.exists()?(e.value=t.val(),r("max_Team_X geladen:",t.val())):r("Kein max_Team_X-Wert gefunden.")}).catch(t=>{r("Fehler beim Laden von max_Team_X:",t)})}function Wi(){const t=document.getElementById("timerDurationInput").value*60;z(p(y,"timer/durationInput")).then(()=>$(p(y,"timer/durationInput"),Number(t))).then(()=>{r("Duration_input:",t)}).catch(n=>{r("Fehler beim Speichern von DurationInput:",n)})}function Hi(){const t=document.getElementById("timerDurationInput2").value*60;z(p(y,"timer/durationInput2")).then(()=>$(p(y,"timer/durationInput2"),Number(t))).then(()=>{r("Duration_input2:",t)}).catch(n=>{r("Fehler beim Speichern von DurationInput2:",n)})}async function Ui(){if(!("serviceWorker"in navigator))throw new Error("Service Worker wird vom Browser nicht unterst√ºtzt.");const e="/Mister-X/",t=await navigator.serviceWorker.getRegistration(e);if(t)return t;const n=`${e}firebase-messaging-sw.js`;return navigator.serviceWorker.register(n,{scope:e,type:"module"})}function qi(){var e,t;return((e=window.matchMedia)==null?void 0:e.call(window,"(display-mode: standalone)").matches)||((t=window.navigator)==null?void 0:t.standalone)===!0}async function Gi(){const e={notificationsAPI:"Notification"in window,serviceWorker:"serviceWorker"in navigator,pushManager:"PushManager"in window,standalone:qi(),fcm:!1};try{e.fcm=await Ot()}catch{e.fcm=!1}return e}async function bn(e){!e||!F||await $(p(y,`notifications/${e}/recipients/${F}`),!0)}function wn(e){try{const t=e&&e.messageId;if(t){if(et.has(t))return;et.add(t)}if(t&&typeof bn=="function"&&bn(t).catch(n=>r("Markieren fehlgeschlagen:",n)),document.visibilityState==="visible"){const n=e&&e.title?e.title:"Nachricht",o=e&&e.body?e.body:"";setTimeout(()=>{alert(`${n}
${o}`)},1e3)}}catch(t){r("handleInAppMessage error:",t)}}setInterval(()=>{et.size>5e3&&et.clear()},60*1e3);async function Vi(){if(!("serviceWorker"in navigator))return;const e=await navigator.serviceWorker.ready;if(!e.active)return;const t=5e3;return await new Promise(n=>{const o=new MessageChannel,i=setTimeout(()=>{o.port1.onmessage=null,r("[SW-Log] PING -> Timeout (wir versuchen GET_SW_LOGS trotzdem)"),n()},t);o.port1.onmessage=a=>{a.data&&a.data.type==="PONG"&&(clearTimeout(i),r("[SW-Log] PONG empfangen"),n())},e.active.postMessage({type:"PING"},[o.port2])}),new Promise(n=>{const o=new MessageChannel,i=setTimeout(()=>{n()},t);o.port1.onmessage=a=>{a.data&&a.data.type==="SW_LOGS"&&(clearTimeout(i),Array.isArray(a.data.logs)&&a.data.logs.forEach(s=>{s&&s.msg&&r("[SW-Log]",new Date(s.ts).toLocaleTimeString(),s.msg)}),e.active.postMessage({type:"CLEAR_SW_LOGS"}),n())},e.active.postMessage({type:"GET_SW_LOGS"},[o.port2])})}function Ki(){const e=document.getElementById("agentReqEnabledCheckbox");e&&(A(p(y,Yt)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,localStorage.setItem(Zt,n?"1":"0"),vn(n)}),e.addEventListener("change",async()=>{const t=e.checked;await $(p(y,Yt),t),localStorage.setItem(Zt,t?"1":"0"),vn(t)}))}function vn(e){const t=document.getElementById("btnRequestAgents");t&&(t.style.display=e?"":"none")}function Xi(){const e=document.getElementById("messageToggle");e&&(A(p(y,Qt)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,localStorage.setItem(Jt,n?"1":"0")}),e.addEventListener("change",async()=>{const t=e.checked;await $(p(y,Qt),t),localStorage.setItem(Jt,t?"1":"0")}))}function Zi(){const e=document.getElementById("uBahnEnabledCheckbox");e&&(A(p(y,Pt)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,We(n)}).catch(()=>{}),e.addEventListener("change",async()=>{const t=e.checked;await $(p(y,Pt),t);try{localStorage.setItem(wo,t?"1":"0")}catch{}We(t)}))}function We(e){var o,i;const t=document.getElementById("uBahnButton");if(!t)return;const n=((i=(o=document.getElementById("misterxView"))==null?void 0:o.style)==null?void 0:i.display)!=="none";t.style.display=e&&n?"":"none"}let R=null,De=!1,_=new Set;function Ji(){De=!De,document.getElementById("membersHiddenList").style.display=De?"":"none",document.getElementById("membersShowHiddenBtn").textContent=De?"Ausgeblendete verbergen":"Ausgeblendete anzeigen",fe()}async function Sn(e,t){try{const n=oe(e);await H(p(y,`roles/${n}`),{hidden:!!t}),I(t?"Spieler ausgeblendet":"Spieler wieder eingeblendet",{timeout:1500,type:"info"}),await Ee()}catch(n){r("setMemberHidden err",n),I("Fehler beim Aktualisieren")}}async function Yi(){if(confirm("Alle ausgeblendeten Spieler wirklich wieder einblenden?"))try{const t={};for(const n of Object.values(R||{}))n.hidden&&(t[`roles/${oe(n.name)}/hidden`]=null);Object.keys(t).length>0&&(await H(p(y),t),I("Alle ausgeblendeten Spieler wieder sichtbar",{timeout:1500,type:"info"})),await Ee()}catch(t){r(t),I("Fehler beim R√ºckg√§ngig machen")}}function Qi(){const e=document.getElementById("membersModal");if(!e)return;e.style.display="flex",e.focus&&e.focus();const t=document.getElementById("membersSearch");t&&(t.value="");const n=document.getElementById("membersSort");n&&(n.value=localStorage.getItem("membersSort")||"name",n.onchange=()=>{localStorage.setItem("membersSort",n.value),fe()}),De=!1,document.getElementById("membersHiddenList").style.display="none",document.getElementById("membersShowHiddenBtn").textContent="Ausgeblendete anzeigen";const o=document.getElementById("membersSearch");o&&o.addEventListener("input",()=>fe()),document.addEventListener("keydown",Yn),Ee()}function Jn(){const e=document.getElementById("membersModal");e&&(e.style.display="none"),document.removeEventListener("keydown",Yn)}function Yn(e){e.key==="Escape"&&Jn()}async function Ee(){R={};try{const[e,t]=await Promise.all([A(p(y,"roles")),A(p(y,"tokens"))]),n=e.exists()?e.val():{},o=t.exists()?t.val():{};for(const i of Object.keys(n||{})){const a=n[i]||{},s=a.lastUpdated||a.timestamp||a.joinedAt||0;let c=!1;try{const u=o[i]||{},l=He(u);c=Array.isArray(l)&&l.length>0}catch{c=!1}R[i]={id:i,name:i,role:a.role||"-",allowSmsFallback:a.allowSmsFallback===void 0?null:!!a.allowSmsFallback,instantSMS:a.instantSMS===!0,notification:a.notification!==!1,telPresent:null,lastActivity:s,hidden:!!a.hidden,tokensPresent:c,raw:a}}}catch(e){r("Fehler beim Laden der Rollen:",e),I("Fehler beim Laden der Mitglieder.")}fe(),(async()=>{var e;try{const t=Object.keys(R||{});if(t.length===0)return;const n=await _o(t);for(const o of t)R[o].telPresent=!!((e=n[o])!=null&&e.exists),n[o]&&n[o].allowSmsFallback!==null&&(R[o].allowSmsFallback=!!n[o].allowSmsFallback);fe()}catch(t){r("[loadAndRenderMembers] background checkDevicesTelPresence failed",t)}})()}function fe(){var l,m;const e=document.getElementById("membersList"),t=document.getElementById("membersHiddenInner");if(!e)return;const n=(((l=document.getElementById("membersSearch"))==null?void 0:l.value)||"").trim().toLowerCase(),o=((m=document.getElementById("membersSort"))==null?void 0:m.value)||"name";let a=Object.values(R||{}).filter(d=>d.name.toLowerCase().includes(n)||(d.role||"").toLowerCase().includes(n));const s={name:(d,f)=>d.name.localeCompare(f.name),role:(d,f)=>(d.role||"").localeCompare(f.role||""),lastActivity:(d,f)=>(f.lastActivity||0)-(d.lastActivity||0),hasTel:(d,f)=>(f.telPresent?1:0)-(d.telPresent?1:0),allowSmsFallback:(d,f)=>(f.allowSmsFallback?1:0)-(d.allowSmsFallback?1:0)};a=s[o]?a.sort(s[o]):a.sort(s.name);const c=a.filter(d=>!d.hidden),u=a.filter(d=>!!d.hidden);e.innerHTML="";for(const d of c){const f=document.createElement("div");f.className="member-row";const b=document.createElement("div");b.className="member-left";const g=document.createElement("div");g.className="member-name",g.innerHTML=G(d.name);const h=document.createElement("div");h.className="member-meta";const w=d.lastActivity?nn(tt(d.lastActivity)):"‚Äî",S=d.telPresent===!0?"Tel ‚úì":d.telPresent===null?"Tel ‚Ä¶":"Tel x";h.innerHTML=`${G(d.role)} ¬∑ ${w} ¬∑ ${S}`,b.appendChild(g),b.appendChild(h);const k=document.createElement("div");k.className="member-actions";const P=document.createElement("label");P.className="member-meta small-muted",P.style.display="inline-flex",P.style.alignItems="center",P.style.gap="6px";const E=document.createElement("input");E.type="checkbox",E.checked=!!d.allowSmsFallback,E.className="member-toggle",E.addEventListener("change",()=>At(d.name,{allowSmsFallback:E.checked})),P.appendChild(E),P.appendChild(document.createTextNode("SMS-Fallback")),k.appendChild(P);const T=document.createElement("label");T.className="member-meta small-muted",T.style.display="inline-flex",T.style.alignItems="center",T.style.gap="6px";const B=document.createElement("input");B.type="checkbox",B.checked=!!d.instantSMS,B.className="member-toggle",d.telPresent||(T.classList.add("disabled"),B.title="Keine Telefonnummer hinterlegt ‚Äì Instant-SMS funktioniert nicht."),B.addEventListener("change",()=>At(d.name,{instantSMS:B.checked})),T.appendChild(B),T.appendChild(document.createTextNode("Instant-SMS")),k.appendChild(T);const N=document.createElement("label");N.className="member-meta small-muted",N.style.display="inline-flex",N.style.alignItems="center",N.style.gap="6px";const C=document.createElement("input");C.type="checkbox",C.checked=!!d.notification,C.className="member-toggle",d.tokensPresent||(N.classList.add("disabled"),C.title="Kein Push-Token vorhanden ‚Äì Push-Benachrichtigungen nicht m√∂glich."),C.addEventListener("change",()=>At(d.name,{notification:C.checked})),N.appendChild(C),N.appendChild(document.createTextNode("Benachr.")),k.appendChild(N);const U=document.createElement("button");U.className="small-button ghost",U.textContent="Ausblenden",U.setAttribute("title","Spieler in der App ausblenden (gespeichert)"),U.addEventListener("click",()=>Sn(d.name,!0)),k.appendChild(U);const V=document.createElement("button");V.className="small-button ghost",V.textContent="Nummer l√∂schen",V.addEventListener("click",()=>ea(d.name)),k.appendChild(V);const Z=document.createElement("button");Z.className="small-button danger-ghost",Z.textContent="Spieler l√∂schen",Z.addEventListener("click",()=>kn(d.name)),k.appendChild(Z),f.appendChild(b),f.appendChild(k),e.appendChild(f)}t.innerHTML="";for(const d of u){const f=document.createElement("div");f.className="member-row hidden";const b=d.lastActivity?nn(tt(d.lastActivity)):"‚Äî";f.innerHTML=`<div class="member-left"><div class="member-name">${G(d.name)}</div><div class="member-meta">${G(d.role)} ¬∑ ${b}</div></div>`;const g=document.createElement("div");g.className="member-actions";const h=document.createElement("button");h.className="small-button ghost",h.textContent="Wieder einblenden",h.addEventListener("click",()=>Sn(d.name,!1)),g.appendChild(h);const w=document.createElement("button");w.className="small-button danger-ghost",w.textContent="Spieler l√∂schen",w.addEventListener("click",()=>kn(d.name)),g.appendChild(w),f.appendChild(g),t.appendChild(f)}}async function At(e,t){try{const n=oe(e);await H(p(y,`roles/${n}`),t),I("√Ñnderung gespeichert",{timeout:1500,type:"info"}),typeof R<"u"&&R&&R[e]?(Object.assign(R[e],t),fe()):Ee()}catch(n){r(n),I("Fehler beim Speichern")}}async function kn(e){if(confirm(`Spieler ${e} wirklich l√∂schen? Diese Aktion entfernt alle Rollen-/Tel-Daten.`))try{const n=oe(e);await z(p(y,`roles/${n}`)),await z(p(y,`tels/${n}`)),I("Spieler gel√∂scht",{timeout:2e3,type:"info"}),typeof R<"u"&&R&&R[e]?(delete R[e],fe()):Ee()}catch(n){r(n),I("Fehler beim L√∂schen")}}async function ea(e){if(confirm(`Nummer von ${e} wirklich l√∂schen?`))try{const n=oe(e);await H(p(y,`roles/${n}`),{allowSmsFallback:!1}),await z(p(y,`tels/${n}`)),I("Nummer entfernt",{timeout:1500,type:"info"}),typeof R<"u"&&R&&R[e]?(R[e].telPresent=!1,R[e].allowSmsFallback=!1,fe()):Ee()}catch(n){r(n),I("Fehler beim Entfernen")}}window.openMembersManagement=Qi;window.closeMembersManagement=Jn;window.toggleShowHidden=Ji;window.unhideAllMembers=Yi;async function ta(){if(!confirm("Best√§tige, dass du in eine U-Bahn eingestiegen bist."))return;const t="Mister X ist in eine U-Bahn eingestiegen",n={message:t,timestamp:Date.now(),device:F||null};try{await lt(p(y,"events/ubahn"),n)}catch(o){r("Fehler beim Schreiben des U-Bahn-Events:",o)}try{await ue("Mister X ist in eine U-Bahn eingestiegen",t,["agent","settings","start"])}catch(o){r("Fehler beim Versenden der U-Bahn-Benachrichtigung:",o)}I(t,{type:"info"})}function Qn(){if(Nt)return;const e=p(y,"events/ubahn");X(e,t=>{ze=t,On()}),Nt=!0}async function na(){var t,n;const e=document.getElementById("customNotifModal");if(e){try{await Ee()}catch(o){r("Fehler beim Laden der Mitglieder:",o)}aa(),En(),window.__customNotifListenersAdded||((t=document.getElementById("customNotifSearch"))==null||t.addEventListener("input",()=>En()),(n=document.getElementById("customNotifSelectAll"))==null||n.addEventListener("change",o=>{const i=o.target.checked;document.querySelectorAll('#notifRecipientsList input[type="checkbox"][data-name]').forEach(s=>{if(s.disabled)return;s.checked=i;const c=s.dataset.name;i?_.add(c):_.delete(c)}),Be(),Ae()}),window.__customNotifListenersAdded=!0),e.style.display="flex",document.addEventListener("keydown",eo)}}function rt(){const e=document.getElementById("customNotifModal");e&&(e.style.display="none",document.removeEventListener("keydown",eo))}function eo(e){e.key==="Escape"&&rt()}function ke(e){return!e||e.notification===!1?!1:!!(e&&(e.tokensPresent||e.telPresent&&(e.instantSMS===!0||e.allowSmsFallback===!0)))}function to(){const e=[];for(const t of Array.from(_)){const n=(R||{})[t];(!n||!ke(n))&&(_.delete(t),e.push(t))}e.length>0&&I(`${e.length} Ger√§t(e) wurden entfernt, da sie nicht empfangsf√§hig sind.`,{type:"warning"})}function En(){var u;const e=document.getElementById("notifRecipientsList");if(!e)return;const t=(((u=document.getElementById("customNotifSearch"))==null?void 0:u.value)||"").trim().toLowerCase();e.innerHTML="";const o=Object.values(R||{}).filter(l=>l.name.toLowerCase().includes(t)||(l.role||"").toLowerCase().includes(t));o.sort((l,m)=>l.name.localeCompare(m.name));const i=o.filter(l=>!l.hidden),a=o.filter(l=>!!l.hidden),s=l=>{for(const m of l){const d=document.createElement("div");d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="space-between",d.style.padding=".25rem 0";const f=document.createElement("div");f.style.display="flex",f.style.alignItems="center",f.style.gap="8px";const b=document.createElement("input");b.type="checkbox",b.dataset.name=m.name,b.id=`notif-rec-${m.name}`;const g=ke(m);b.disabled=!g,g||(b.checked=!1),g&&(b.checked=_.has(m.name)),b.addEventListener("change",k=>{k.target.checked?_.add(m.name):_.delete(m.name),Be(),Ae()});const h=document.createElement("label");h.htmlFor=b.id,h.textContent=m.name+(m.role?` (${m.role})`:""),m.notification===!1?(h.style.color="#999",d.style.opacity="0.5",h.style.cursor="not-allowed",h.title="Benachrichtigungen f√ºr dieses Ger√§t sind deaktiviert."):(m.tokensPresent||(h.style.color="#999",d.style.opacity="0.7"),g||(h.style.cursor="not-allowed",h.title="Dieses Ger√§t kann keine Nachrichten empfangen."));const w=document.createElement("span");w.style.color="#666",w.style.fontSize="0.9rem";const S=[];if(m.notification===!1)S.push("(Benachrichtigungen deaktiviert)");else if(m.tokensPresent||S.push("(kein Token)"),m.telPresent&&(m.instantSMS===!0||m.allowSmsFallback===!0)){const k=[];m.instantSMS&&k.push("instant-SMS"),m.allowSmsFallback&&k.push("SMS-Fallback"),S.push(`(Telefon${k.length?" ‚Ä¢ "+k.join(", "):""})`)}w.textContent=S.join(" "),f.appendChild(b),f.appendChild(h),d.appendChild(f),d.appendChild(w),e.appendChild(d)}};if(s(i),a.length>0){const l=document.createElement("div");l.style.borderTop="1px dashed #ddd",l.style.margin="8px 0",l.textContent="Ausgeblendete Ger√§te",l.style.color="#666",l.style.fontSize="0.9rem",l.style.paddingTop="6px",e.appendChild(l),s(a)}const c=document.getElementById("customNotifSelectAll");if(c){const l=Array.from(document.querySelectorAll('#notifRecipientsList input[type="checkbox"][data-name]')),m=l.length>0&&l.every(d=>_.has(d.dataset.name)||d.disabled);c.checked=m}Be(),Ae()}function oa(e){const t=Object.values(R||{}).filter(o=>o.role===e&&ke(o)).map(o=>o.name);if(!t.length){I(`Keine empfangsf√§higen Ger√§te mit Rolle ${e} gefunden.`,{type:"warning"});return}t.every(o=>_.has(o))?t.forEach(o=>_.delete(o)):t.forEach(o=>_.add(o)),no(),Be(),Ae()}function ia(){const e=Object.values(R||{}).filter(n=>ke(n)).map(n=>n.name);if(!e.length)return;e.every(n=>_.has(n))?e.forEach(n=>_.delete(n)):e.forEach(n=>_.add(n)),no(),Be(),Ae()}function no(){to();const e=Array.from(document.querySelectorAll('#notifRecipientsList input[type="checkbox"][data-name]'));e.forEach(n=>{n.checked=_.has(n.dataset.name)});const t=document.getElementById("customNotifSelectAll");if(t){const n=e;t.checked=n.length>0&&n.every(o=>_.has(o.dataset.name)||o.disabled)}Ae()}function Ae(){to();const e=_.size,t=document.getElementById("notifSelectedCount");t&&(t.textContent=`${e} ausgew√§hlt`,t.setAttribute("title",`${e} Ger√§t(e) ausgew√§hlt`))}function Be(){const e=["misterx","agent","settings","start"];for(const n of e){const o=document.getElementById(`notif-role-btn-${_e(n)}`);if(!o)continue;const i=Object.values(R||{}).filter(s=>s.role===n&&ke(s)).map(s=>s.name);i.length>0&&i.every(s=>_.has(s))?(o.classList.add("active"),o.style.backgroundColor="#e0f0ff"):(o.classList.remove("active"),o.style.backgroundColor="")}const t=document.getElementById("notifRoleAllBtn");if(t){const n=Object.values(R||{}).filter(i=>ke(i)).map(i=>i.name);n.length>0&&n.every(i=>_.has(i))?(t.classList.add("active"),t.style.backgroundColor="#e0f0ff"):(t.classList.remove("active"),t.style.backgroundColor="")}}function aa(){const e=document.getElementById("notifRolesList");if(!e)return;e.innerHTML="";const t=["misterx","agent","settings","start"];for(const o of t){const i=document.createElement("button");i.type="button",i.id=`notif-role-btn-${_e(o)}`,i.className="small-button notif-role-btn",i.style.marginRight="8px",i.textContent=o,i.addEventListener("click",()=>{oa(o)}),e.appendChild(i)}const n=document.getElementById("notifRoleAllBtn");n&&!window.__notifRoleAllListenerAdded&&(n.addEventListener("click",()=>{ia()}),window.__notifRoleAllListenerAdded=!0),Be()}async function sa(){var c,u,l;const e=(((c=document.getElementById("customNotifTitle"))==null?void 0:c.value)||"").trim(),t=(((u=document.getElementById("customNotifBody"))==null?void 0:u.value)||"").trim();if(!e)return I("Bitte Titel eingeben.",{type:"warning"});if(!t)return I("Bitte Nachrichtentext eingeben.",{type:"warning"});const n=Array.from(_).filter(m=>{const d=(R||{})[m];return!!d&&ke(d)}),o=Array.from(document.querySelectorAll("#notifRolesList .notif-role-btn.active")).map(m=>m.textContent);if(((l=document.getElementById("notifRoleAllBtn"))==null?void 0:l.classList.contains("active"))&&o.push("all"),n.length===0&&o.length===0)return I("Bitte mindestens ein Ger√§t oder eine Rolle ausw√§hlen.",{type:"warning"});let a={};try{const m=await A(p(y,"tokens"));a=m.exists()?m.val():{}}catch(m){r("Fehler beim Laden der Tokens:",m)}let s=!1;try{try{const E=await A(p(y,"settings/messages"));if(!(E.exists()?!!E.val():!0)){const B=de(),N=(typeof te=="function"?te():null)||"unknown",C=Date.now(),U={sender:N,title:e,body:t,link:"/Mister-X/",timestamp:C,messageId:B,recipients:{},attempts:{1:{at:C,count:0}},lastAttemptAt:C};try{await $(p(y,`notifications/${B}`),U),I("Benachrichtigungen sind deaktiviert. Nachricht wurde in Firebase protokolliert.",{type:"info"})}catch(V){r("[sendCustomNotification] Failed to write notification when messages disabled:",V),I("Fehler beim Protokollieren der Nachricht.",{type:"error"})}rt();return}}catch(E){r("Konnte settings/messages nicht lesen, fahre fort:",E)}I("Benachrichtigung wird gesendet.",{type:"info"}),rt();const m=de(),d=(typeof te=="function"?te():null)||"unknown",f=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);try{if(o.length>0){const E=o.includes("all")?["all"]:o;ue(e,t,E,{messageId:m,rtdbBase:K}).catch(T=>{r("Fehler beim Senden an Rollen:",T)}),s=!0}}catch(E){r("Fehler beim Senden an Rollen (sync check):",E)}const b=new Set;if(o.length>0&&!o.includes("all"))for(const E of Object.values(R||{}))E.role&&o.includes(E.role)&&b.add(E.name);const g=[],h=[],w=[];if(o.includes("all"))n.length>0&&I("Hinweis: ‚ÄûAlle‚Äú ausgew√§hlt ‚Äî individuelle Ger√§te werden nicht zus√§tzlich adressiert.",{type:"info"});else for(const E of n){if(b.has(E))continue;const T=R==null?void 0:R[E];if((T==null?void 0:T.instantSMS)===!0){h.push(E);continue}w.push(E);try{const B=He(a[E]||[]);Array.isArray(B)&&B.length&&g.push(...B)}catch{}}const k=Array.from(new Set(g)),P=Array.from(new Set([...w,...h]));(async()=>{const E=Date.now();if(P.length>0)try{const T={sender:d,title:e,body:t,recipients:{},timestamp:E,attempts:{1:{at:E,count:k.length}},lastAttemptAt:E};for(const B of P)T.recipients[oe(B)]=!1;await $(p(y,`notifications/${m}`),T)}catch(T){r("Warn: could not write initial notification to RTDB:",T)}if(k.length>0)try{const T=Array.from(new Set([...w,...h]));await ut(e,t,k,{recipientDeviceNames:T,instantSMSDevices:h,messageId:m,rtdbBase:K}),r("sendCustomNotification tokens result (bg)")}catch(T){r("Fehler beim Senden der Nachricht (bg):",T)}else if(h.length>0)try{await dt(m,h,f,{rtdbBase:K}),r("SMS an Instant-SMS-Ger√§te gesendet (bg)")}catch(T){r("Fehler beim direkten SMS-Versand (bg):",T)}else s||I("Keine Tokens f√ºr ausgew√§hlte Ger√§te gefunden.",{type:"warning"})})()}catch(m){r("sendCustomNotification preparation error",m)}}window.openCustomNotifModal=na;window.closeCustomNotifModal=rt;window.sendCustomNotification=sa;async function ra(){var e,t,n,o,i,a;Ao();try{const s=await Gi();if(s&&s.fcm){ne||(ne=ct(ge)),window.__swMsgListenerAdded||(navigator.serviceWorker.addEventListener("message",h=>{var w;if(h&&h.data&&h.data.type==="PUSH"){const S=h.data.payload||{};(w=navigator.serviceWorker.controller)==null||w.postMessage({type:"PUSH",payload:S,userAgent:navigator.userAgent}),wn(S),r("[Page] SW-Message empfangen",S)}}),window.__swMsgListenerAdded=!0);let g=null;uo(ne,h=>{var S;const w=h&&h.data?h.data:{};w.messageId&&w.messageId===g||(g=w.messageId||null,(S=navigator.serviceWorker.controller)==null||S.postMessage({type:"PUSH",payload:h,userAgent:navigator.userAgent}),wn(w),r("[Page] FCM onMessage empfangen",h))})}navigator.serviceWorker.addEventListener("message",g=>{var h;((h=g==null?void 0:g.data)==null?void 0:h.type)==="PUSH_SUBSCRIPTION_CHANGED"&&kt({force:!0}).catch(r)}),(async()=>await Io("pushSubscriptionChangedAt")&&(await kt({force:!0}).catch(r),await xo("pushSubscriptionChangedAt")))();const c=document.getElementById("enablePush"),u=document.getElementById("pushHint");c&&(!s.fcm&&/iPhone|iPad|iPod/i.test(navigator.userAgent)&&!s.standalone?(c.style.display="none",u&&(u.textContent="Installiere die App zum Home-Bildschirm, um Benachrichtigungen zu aktivieren.",u.style.display="block")):!s.fcm||!s.notificationsAPI||!s.serviceWorker||!s.pushManager?(c.style.display="none",u&&(u.textContent="Benachrichtigungen werden von diesem Browser/Modus nicht unterst√ºtzt.",u.style.display="block")):Notification.permission==="granted"?(c.textContent="Benachrichtigungen sind aktiv",c.disabled=!0):(c.addEventListener("click",enablePush,{once:!0}),c.style.display="inline-flex")),Se(!0),document.getElementById("btnRequestAgents").style.display="none";const l=localStorage.getItem("activeView")||"start";l!=="start"&&qt(l),zn(),await ri(),Pi(),Di(),$i(),kt(),wi(),Yo(),ii(),zt(),ki(),await pi(),hi(),li(),ci(),Vi().catch(()=>{}),Ki(),Xi(),Zi(),Qn();const m=document.getElementById("toggleAgentLocations");m&&(m.checked=Xe,m.addEventListener("change",()=>{Xe=!!m.checked;try{localStorage.setItem(Fn,Xe?"1":"0")}catch{}Gn()})),(e=document.getElementById("toggleTracking"))==null||e.addEventListener("change",g=>{g.target.checked?Zo():jn()}),(t=document.getElementById("toggleFollow"))==null||t.addEventListener("change",g=>{Pn=g.target.checked});const d=document.getElementById("clearLocalStorageBtn");d&&d.addEventListener("click",()=>{confirm("M√∂chtest du wirklich alle gespeicherten Daten (localStorage) l√∂schen?")&&(localStorage.clear(),sessionStorage.clear(),alert("Alle lokalen Daten wurden gel√∂scht. Die Seite wird neu geladen."),location.reload())});const f=document.getElementById("photoInput");f&&f.addEventListener("change",async function(){var h;if((h=this.files)==null?void 0:h[0]){window.fotoHochgeladen=!0;const w=document.getElementById("status");w&&(w.innerText="üì∏ Foto ausgew√§hlt!");try{navigator.permissions&&(await navigator.permissions.query({name:"geolocation"})).state==="granted"&&at().catch(k=>r("Fehler beim GPS-Warmup:",k))}catch{r("Permissions API nicht verf√ºgbar, √ºberspringe GPS-Warmup")}}});const b=document.getElementById("postenSearch");b&&b.addEventListener("input",async function(){if(this.value.trim().length>0)try{navigator.permissions&&(await navigator.permissions.query({name:"geolocation"})).state==="granted"&&at().catch(w=>r("Fehler beim GPS-Warmup:",w))}catch{r("Permissions API nicht verf√ºgbar, √ºberspringe GPS-Warmup")}})}catch(s){alert("Fehler in startScript: "+((s==null?void 0:s.message)??String(s))),(o=(n=document.getElementById("startView"))==null?void 0:n.style)==null||o.setProperty("display","block"),(a=(i=document.getElementById("startView2"))==null?void 0:i.style)==null||a.setProperty("display","block")}}function r(...e){console.log(...e);const t=document.getElementById("settingsLog");if(!t)return;const n=new Date().toLocaleTimeString(),o=document.createElement("div");o.innerHTML=`<strong>[${n}]</strong>`,e.forEach(i=>{if(typeof i=="object"){const a=document.createElement("details"),s=document.createElement("summary");s.textContent="Objekt anzeigen",a.appendChild(s);const c=document.createElement("pre");c.textContent=JSON.stringify(i,null,2),a.appendChild(c),o.appendChild(a)}else o.innerHTML+=` ${i}`}),t.appendChild(o),t.scrollTop=t.scrollHeight}window.switchView=qt;window.requestPermission=Eo;window.sendLocationWithPhoto=Do;window.startTimer=Ie;window.goBack=Je;window.save_timer_duration=Wi;window.save_timer_duration2=Hi;window.save_max_mister_x=zi;window.resetTimer=Oi;window.deleteAllLocations=_i;window.warmUpLocationTracking=at;window.stopLocationWarmUp=j;window.resetAllMisterXRollen=Ai;window.removeNotificationSetup=Po;window.mxState=window.mxState||{};window.mxState.selectedPost=null;window.openCloseTeamSettings=qo;window.closeTeamSettings=_n;window.leaveTeam=jt;window.createTeam=Go;window.joinTeam=Vo;window.triggerAgentLocationRequest=vi;window.resetAgentLocations=Si;window.announceUBahn=ta;function oo(e){window.mxState.selectedPost=e}function ca(){return window.mxState.selectedPost}document.addEventListener("DOMContentLoaded",ra);
