import{F as Je}from"./vendor_leaflet-CAQ_TIzs.js";import{i as On,g as dn,a as zn,b as Ge,c as jn,u as $,r as f,d as I,e as St,f as un,s as j,h as be,p as Ke,j as D,k as Hn,l as oe,o as Wn,m as G,q as kt,n as Un,t as Tt,v as ke,w as mn,R as qn}from"./vendor_firebase-Drpl5kvo.js";import{a as Gn}from"./vendor-Cj_BHRrm.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();const Kn={apiKey:"AIzaSyC-jTMiDjHNTC6cvSKUU44mVbWwT-ToLxQ",authDomain:"mister-x-d6b59.firebaseapp.com",databaseURL:"https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app",projectId:"mister-x-d6b59",storageBucket:"mister-x-d6b59.firebasestorage.app",messagingSenderId:"616391598963",appId:"1:616391598963:web:da07882b0f481d3000db06",measurementId:"G-W66SK677NG"},ae=On(Kn),g=dn(ae);zn(ae);Ge(ae);var rn,cn,ln;typeof L<"u"&&Je&&((rn=L.Control)!=null&&rn.FullScreen||(L.Control.FullScreen=Je),(cn=L.control)!=null&&cn.fullscreen||(L.control.fullscreen=function(e){return new Je(e)}),console.debug("leaflet.fullscreen registered:",!!((ln=L.control)!=null&&ln.fullscreen)));let te,Ft=!1,Ye=!1,w,Qe=null,Ce=null,Vn=[],X;const J={};let ue=null;const $e=new Set;let E=localStorage.getItem("deviceId")||null;const Q="https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app";let Ie=null,q=null,V=null,fn=!1;const et="showNotifHeader",gn="currentTeamId";let A=null,R={},Pe={deviceTeam:null,teams:null},pn=null,ge=[];const hn="showAgentLocations",tt="lastPromptedAgentReqId",U="lastRespondedAgentReqId";let _e=(localStorage.getItem(hn)??"1")==="1";const nt=new Set;let O,Y,Me;const Rt="agentReqEnabled";let _t="messageToggleEnabled";const Dt="settings/agentReqEnabled",Nt="settings/messages",mt="settings/uBahnEinstieg",Xn="uBahnEnabled";L.icon({iconUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});typeof L<"u"&&L.Icon&&L.Icon.Default&&typeof L.Icon.Default.mergeOptions=="function"&&L.Icon.Default.mergeOptions({imagePath:"https://unpkg.com/leaflet@1/dist/images/",iconUrl:"marker-icon.png",iconRetinaUrl:"marker-icon-2x.png",shadowUrl:"marker-shadow.png"});const Zn=[[48.21778257924239,16.37016154994435],[48.217247563322225,16.37076456217454],[48.21741142779978,16.371253762059183],[48.216865105563464,16.37191529883514],[48.21581506144457,16.37290646405736],[48.21417125610604,16.373948000332064],[48.21430769576697,16.3745721914746],[48.21333498613118,16.37539386682008],[48.2122964590416,16.377294652276152],[48.211699711347876,16.38092342451245],[48.211941642178076,16.38467493512273],[48.20913524997675,16.384032997995277],[48.20434428995476,16.380677464805487],[48.20267440663029,16.378771628716105],[48.202516949057625,16.378787036085683],[48.2021791301039,16.378713275337773],[48.20032081399359,16.37673193693543],[48.20046567888107,16.376081501249317],[48.19987161819025,16.37355423682974],[48.19981183801774,16.372899054744835],[48.200631534154375,16.369653382537916],[48.20071916193201,16.369103424638855],[48.200163223194544,16.368756078571426],[48.19948213275357,16.368406050294983],[48.19950721778074,16.3679406870309],[48.1998469538764,16.366987161726104],[48.19976119600531,16.366945587486374],[48.199786280895815,16.366662614435302],[48.199852484835134,16.36658080706035],[48.199605825841886,16.366136901468384],[48.199689907919776,16.365894161552536],[48.199997462783195,16.365407340616333],[48.20007450484762,16.36539258846675],[48.200780727683785,16.364471249670135],[48.20235733493688,16.36143133067089],[48.202316181915776,16.361391179971125],[48.20252539808658,16.36095263879719],[48.20263271531552,16.36073672097149],[48.20274853131339,16.36083590228765],[48.20475579365605,16.35819251441422],[48.20494354858451,16.357837121719747],[48.205074099582546,16.357685576910406],[48.20502589015989,16.357555489773183],[48.20506169808996,16.357492457861333],[48.205261965068914,16.357456248039632],[48.20626549207577,16.356030140071557],[48.20666774752276,16.35550308600013],[48.20697347295606,16.355354223399804],[48.20918910891197,16.354601648098285],[48.20921597664341,16.35491948986655],[48.20929110567211,16.354928877598102],[48.20938410911258,16.354983862882907],[48.212403444290665,16.35518085630021],[48.212634067324394,16.355560388875816],[48.214753862701514,16.35585677297196],[48.21482540908184,16.356370415998313],[48.21454632473899,16.35850592710254],[48.21435355993972,16.36025556372129],[48.21477999581608,16.361298310706765],[48.21461086605676,16.3615351876565],[48.214799725889385,16.361933238614775],[48.21476774885914,16.362013013827934],[48.214317217645544,16.362474541146735],[48.21554996828477,16.365200001058092],[48.21618181295601,16.36659154989541],[48.21691897070536,16.368248676490595],[48.21768157297474,16.36988155904141],[48.21778257924239,16.37016154994435]],Jn=[[-90,-180],[-90,180],[90,180],[90,-180]],ot=L.polygon([Jn,Zn],{color:"red",weight:3,fillColor:"rgba(255, 0, 0, 0.3)",fillOpacity:.35,interactive:!1,pane:"maskPane",dashArray:"5, 5"}),Yn={blau:"#1E90FF",gruen:"#2ECC71",rot:"#FF5252",gelb:"#F4D03F",orange:"#FF8C00",lila:"#8E44AD",schwarz:"#333333",grau:"#7F8C8D"};jn(ae,{provider:new qn("6LcVXbQrAAAAAI5Wgi8DenjAM4cz-ubrfcwIRPVJ"),isTokenAutoRefreshEnabled:!0});window.onerror=function(e,t,n,o,a){alert("JS-Fehler: "+e+" in "+t+" Zeile "+n)};const K=Gn("https://axirbthvnznvhfagduyj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4aXJidGh2bnpudmhmYWdkdXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMDI2MTcsImV4cCI6MjA2ODg3ODYxN30.wfJm9e10_iNuYm_r3es_FmKuXBePsxSjIJcVqmSuYjc");async function Qn(e){const t=localStorage.getItem("role")||"start";try{const{error:n}=await K.from("fcm_tokens").delete().eq("device_name",E);n?c("‚ùå Fehler beim L√∂schen aus Supabase:",n):c("‚úÖ Alter Token aus Supabase gel√∂scht.");const{error:o}=await K.from("fcm_tokens").upsert({token:e,device_name:E,role:t});o?c("‚ùå Fehler beim Speichern des Tokens:",o):c("‚úÖ Token erfolgreich gespeichert.")}catch(n){c("‚ùå Supabase Exception:",n)}}function ye(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()==="";)e=prompt("Bitte gib deinen Namen ein"),e===null&&alert("Du musst einen Namen eingeben, um fortzufahren.");return localStorage.setItem("deviceId",e.trim()),e.trim()}try{localStorage.setItem("test","1")}catch{alert("‚ö†Ô∏è Dein Browser blockiert lokalen Speicher. Bitte verlasse den privaten Modus oder √§ndere die Einstellungen.")}async function eo(){try{if(!await St()){alert("‚ùå Push-Benachrichtigungen werden in diesem Browser/Modus nicht unterst√ºtzt.");return}if(!("Notification"in window)){alert("‚ùå Notification API nicht verf√ºgbar.");return}const t=await Notification.requestPermission();if(t!=="granted"){c("Benachrichtigungen nicht erlaubt:",t),alert("‚ö†Ô∏è Benachrichtigungen wurden abgelehnt.");return}const n=await Sa();c("Service Worker registriert mit Scope:",n.scope),localStorage.setItem("serviceWorkerRegistered","true"),X||(X=Ge(ae));const o=await un(X,{serviceWorkerRegistration:n,vapidKey:"BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE"});if(!o){c("Kein Token erhalten."),alert("‚ö†Ô∏è Kein Token erhalten. Bitte erneut versuchen.");return}localStorage.setItem("fcmToken",o),c("Token:",o),await j(f(g,`tokens/${E}`),o),await $(f(g,`roles/${E}`),{role:"start"}),await Qn(o),localStorage.setItem("nachrichtAktiv","true");const a=document.getElementById("permissionButton");a&&(a.style.display="none"),to(E).then(()=>{alert("‚úÖ Benachrichtigungen aktiviert!")})}catch(e){c("Fehler bei Berechtigung/Registrierung/Token:",e),alert("‚ùå Fehler: "+((e==null?void 0:e.message)??String(e)))}}async function to(e){const t=await ao("app-db","settings");return new Promise((n,o)=>{const a=t.transaction("settings","readwrite");a.objectStore("settings").put(e,"deviceName"),a.oncomplete=()=>{t.close(),n(!0)},a.onerror=()=>{t.close(),o(a.error)}})}async function no(e){const t=await new Promise((n,o)=>{const a=indexedDB.open("app-db");a.onupgradeneeded=()=>{const i=a.result;i.objectStoreNames.contains("sw-flags")||i.createObjectStore("sw-flags")},a.onsuccess=()=>n(a.result),a.onerror=()=>o(a.error)});try{return await new Promise(n=>{const i=t.transaction("sw-flags","readonly").objectStore("sw-flags").get(e);i.onsuccess=()=>{t.close(),n(i.result||null)},i.onerror=()=>{t.close(),n(null)}})}catch{return null}}async function oo(e){const t=await new Promise((n,o)=>{const a=indexedDB.open("app-db");a.onupgradeneeded=()=>{const i=a.result;i.objectStoreNames.contains("sw-flags")||i.createObjectStore("sw-flags")},a.onsuccess=()=>n(a.result),a.onerror=()=>o(a.error)});await new Promise(n=>{const o=t.transaction("sw-flags","readwrite");o.objectStore("sw-flags").delete(e),o.oncomplete=()=>{t.close(),n()},o.onerror=()=>{t.close(),n()}})}async function at(e={}){const{force:t=!1,vapidKey:n="BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE",touchWhenUnchanged:o=!0}=e;if(typeof Notification>"u"||Notification.permission!=="granted"||localStorage.getItem("serviceWorkerRegistered")!=="true")return c("üîï Token-Refresh √ºbersprungen: Keine Berechtigung oder kein SW."),null;try{const a=await navigator.serviceWorker.ready;let i=null;try{i=await un(X,{serviceWorkerRegistration:a,vapidKey:n})}catch(r){return c("‚ùå Fehler bei getToken:",r),null}if(!i)return c("‚ö†Ô∏è Kein Token beim Refresh erhalten."),null;const s=localStorage.getItem("fcmToken");if(t||i!==s){c("üîÑ Token aktualisiert:",i),await j(f(g,"tokens/"+E),i);try{const{error:r}=await K.from("fcm_tokens").upsert({token:i,device_name:E},{onConflict:"device_name"});r?c("‚ùå Fehler beim Upsert in Supabase:",r):c("‚úÖ Token in Supabase upserted.")}catch(r){c("‚ùå Supabase Upsert Exception:",r)}return localStorage.setItem("fcmToken",i),localStorage.setItem("nachrichtAktiv","true"),i}else return c("‚ÑπÔ∏è Token ist unver√§ndert."),i}catch(a){return c("‚ùå Fehler beim Token-Refresh:",a),null}}async function ao(e,t){return new Promise((n,o)=>{const a=indexedDB.open(e);a.onupgradeneeded=()=>{const i=a.result;i.objectStoreNames.contains(t)||i.createObjectStore(t)},a.onsuccess=()=>{const i=a.result;if(i.objectStoreNames.contains(t))return n(i);const s=i.version+1;i.close();const r=indexedDB.open(e,s);r.onupgradeneeded=()=>{const u=r.result;u.objectStoreNames.contains(t)||u.createObjectStore(t)},r.onsuccess=()=>n(r.result),r.onerror=()=>o(r.error)},a.onerror=()=>o(a.error)})}async function io(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()===""||!$t(e.trim());)e=prompt("Bitte gib deinen Namen ein (mind. 2 Zeichen, keine Sonderzeichen wie . # $ [ ] /)"),e===null&&alert("Du musst einen g√ºltigen Namen eingeben, um fortzufahren."),e&&!$t(e.trim())&&(alert("Ung√ºltiger Name. Bitte verwende mindestens 2 Zeichen und keine . # $ [ ] /"),e="");e=e.trim(),localStorage.setItem("deviceId",e),E=e;let t=yn(),n=t.tel||null,o=!!t.noTel,a;try{a=await po(e)}catch(r){c("[askForDeviceIdAndPhone] Konnte Remote-Status nicht laden:",r),a={exists:!1,allowSmsFallback:null,tel:null}}let i=!1;if(a.allowSmsFallback===null?(i=!0,o=!1):a.allowSmsFallback===!1?i=!1:a.allowSmsFallback===!0&&!a.tel&&(i=!0),a.allowSmsFallback===!0&&a.tel){Ot({tel:a.tel,allowSmsFallback:!0,noTel:!1}),await zt(e,a.tel,!0);return}if(i&&!o||i&&a.allowSmsFallback===null)for(;!n||!fo(n);){let r=prompt(`Bitte gib deine Telefonnummer f√ºr SMS-Fallback ein (+43‚Ä¶ oder 0664‚Ä¶)
Du kannst auch leer lassen, wenn du keine SMS m√∂chtest.`);if(r===null||r.trim()===""){n=null,o=!0;break}n=ho(r.trim()),n||alert("Ung√ºltige Nummer. Bitte im Format +43‚Ä¶ oder 0664‚Ä¶ eingeben.")}const s=!!n;Ot({tel:n,allowSmsFallback:s,noTel:o}),await zt(e,n,s)}function $t(e){return typeof e=="string"&&e.length>=2&&!/[.#$/\[\]/]/.test(e)}async function so(){try{const e=await St().catch(()=>!1);X||(X=Ge(ae));const t=localStorage.getItem("fcmToken");if(e)try{await Hn(X),c("‚úÖ deleteToken: lokaler FCM-Token invalidiert")}catch(n){c("‚ö†Ô∏è deleteToken fehlgeschlagen:",n)}try{await D(f(g,`tokens/${E}`)),c("‚úÖ RTDB-Token entfernt f√ºr",E)}catch(n){c("‚ö†Ô∏è RTDB-Remove fehlgeschlagen:",n)}try{const{error:n}=await K.from("fcm_tokens").delete().or(`device_name.eq.${E}${t?`,token.eq.${t}`:""}`);n?c("‚ö†Ô∏è Supabase-Delete Fehler:",n):c("‚úÖ Supabase-Eintr√§ge entfernt")}catch(n){c("‚ö†Ô∏è Supabase-Delete (catch):",n)}if("serviceWorker"in navigator){const n=await navigator.serviceWorker.getRegistrations();for(const o of n)try{const a=await o.pushManager.getSubscription();a&&(await a.unsubscribe(),c("‚úÖ Push-Subscription gek√ºndigt f√ºr",o.scope))}catch(a){c("‚ö†Ô∏è unsubscribe warn:",a)}await Promise.all(n.map(o=>o.unregister())),c("‚úÖ Alle Service Worker unregistriert")}try{if(window.caches){const n=await caches.keys();await Promise.all(n.map(o=>caches.delete(o))),c("‚úÖ Alle Caches gel√∂scht:",n)}}catch(n){c("‚ö†Ô∏è Cache cleanup warn:",n)}try{indexedDB.deleteDatabase("app-db"),c('‚úÖ IndexedDB "app-db" gel√∂scht')}catch(n){c("‚ö†Ô∏è IndexedDB delete warn:",n)}localStorage.removeItem("fcmToken"),localStorage.removeItem("nachrichtAktiv"),localStorage.removeItem("serviceWorkerRegistered");try{const n=document.getElementById("permissionButton"),o=document.getElementById("permissionButton2");n&&(n.style.display=""),o&&(o.style.display="none")}catch{}setTimeout(()=>{alert("üîï Benachrichtigungen deaktiviert. Die Seite wird neu geladen‚Ä¶"),location.reload()},150)}catch(e){c(e),alert("‚ùå Deaktivieren fehlgeschlagen: "+((e==null?void 0:e.message)??String(e)))}}function ro(e,t=[],n,o=15,{rtdbBase:a=Q,rolesPath:i="roles",recipientsPath:s="notifications",idempotencyFlag:r="smsTriggered",secret:u=typeof SMS_FALLBACK_SECRET<"u"?SMS_FALLBACK_SECRET:"",rtdbAuth:l}={}){if(!e)throw new Error("[Fallback] messageId fehlt");if(!Array.isArray(t)||t.length===0)return c("[Fallback] keine Empf√§nger - Fallback nicht geplant"),Promise.resolve({ok:!0,skipped:"no_recipients"});if(!a)throw new Error("[Fallback] rtdbBase fehlt");const y={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),waitSec:o,rtdbBase:a,rolesPath:i,recipientsPath:s,idempotencyFlag:r,...l?{rtdbAuth:l}:{}},d={};return u&&(d["x-sms-secret"]=u),K.functions.invoke("sms-fallback",{body:y,headers:d}).then(({data:p,error:h})=>h?(c("[Fallback] Edge call failed",h),{ok:!1,error:h.message||"invoke failed"}):(c("[Fallback] scheduled:",p),p)).catch(p=>(c("[Fallback] Konnte SMS-Fallback nicht planen:",p),{ok:!1,error:(p==null?void 0:p.message)||String(p)}))}function It(e,t=[],n,{rtdbBase:o=Q,rolesPath:a="roles",recipientsPath:i="notifications",rtdbAuth:s,requireConsent:r=!0,maxRecipientsPerCall:u,writeDeliveredTimestamp:l=!0}={}){if(!e)return Promise.resolve({ok:!1,error:"Missing messageId"});if(!Array.isArray(t)||t.length===0)return c==null||c("[sms-direct] keine Empf√§nger - nichts zu senden"),Promise.resolve({ok:!0,skipped:"no_recipients"});const y={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),...o?{rtdbBase:o}:{},rolesPath:a,recipientsPath:i,...s?{rtdbAuth:s}:{},requireConsent:r,...Number.isFinite(u)?{maxRecipientsPerCall:u}:{},writeDeliveredTimestamp:l};return K.functions.invoke("sms-direct",{body:y}).then(({data:d,error:p})=>p?(c==null||c("[sms-direct] Edge call failed",p),{ok:!1,error:p.message||"invoke failed"}):(c==null||c("[sms-direct] sent:",d),d)).catch(d=>(c==null||c("[sms-direct] Fehler beim Senden:",d),{ok:!1,error:(d==null?void 0:d.message)||String(d)}))}function he(){try{const e=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:void 0,t=e&&e.crypto;if(t&&typeof t.randomUUID=="function")return t.randomUUID();if(t&&typeof t.getRandomValues=="function"){const n=new Uint8Array(16);t.getRandomValues(n),n[6]=n[6]&15|64,n[8]=n[8]&63|128;const o=i=>i.toString(16).padStart(2,"0"),a=Array.from(n,o).join("");return`${a.slice(0,8)}-${a.slice(8,12)}-${a.slice(12,16)}-${a.slice(16,20)}-${a.slice(20)}`}}catch{}return`${Date.now()}-${Math.random().toString(36).slice(2,10)}`}async function Et(e,t,n=[],o={}){const{recipientDeviceNames:a=[],link:i="/Mister-X/",attempt:s=1,maxAttempts:r=1,waitSec:u=15,sendEndpoint:l="https://axirbthvnznvhfagduyj.supabase.co/functions/v1/send-to-all",rtdbBase:y=Q,messageId:d,instantSMSDevices:p=[]}=o,h=d??he(),m=(typeof ye=="function"?ye():null)||"unknown",b=s===1,S=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,body:t,tokens:n,senderName:m,link:i,messageId:h,rtdbBase:y,recipientDeviceNames:b?a:[],setRecipientsMode:b?"set_once":"none",attempt:s})});let x={};try{x=await S.json()}catch{}c(`üì¶ Versuch ${s}: status=${S.status}`,x);const B=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);b&&a.length>0&&ro(h,a,B,15,{rtdbBase:Q}),b&&p.length>0&&It(h,p,B,{rtdbBase:Q});const P=Array.isArray(x==null?void 0:x.failedTokens)?x.failedTokens:[];return P.length>0&&s<r?(c(`üîÅ Wiederhole f√ºr ${P.length} fehlgeschlagene Tokens in 10s...`),setTimeout(()=>{Et(e,t,P,{recipientDeviceNames:a,link:i,attempt:s+1,maxAttempts:r,waitSec:u,sendEndpoint:l,rtdbBase:y,messageId:h}).catch(c)},1e4)):s>=r?c("‚è±Ô∏è Max. Anzahl an Versuchen erreicht."):c("‚úÖ Alle Benachrichtigungen verarbeitet."),x}async function de(e,t,n,o={}){const a=o.rtdbBase??Q,i=o.messageId??he(),s=(typeof ye=="function"?ye():null)||"unknown";try{const C=await I(f(g,"settings/messages"));if(!(C.exists()?!!C.val():!0)){const M={title:String(e??""),body:String(t??""),link:o.link||"/Mister-X/",sender:s,timestamp:Date.now(),messageId:i,recipients:{}};return await j(f(g,`notifications/${i}`),M),c('[sendNotificationToRoles] Global setting "settings/messages" = false, wrote notification without recipients',M),{ok:!0,skipped:"messages_disabled",messageId:i}}}catch(C){c("[sendNotificationToRoles] Could not read settings/messages, proceeding as enabled:",C)}const[r,u]=await Promise.all([I(f(g,"roles")),I(f(g,"tokens"))]),l=r.exists()?r.val():{},y=u.exists()?u.val():{},d=Array.isArray(n)?n:[n],p=d.length===1&&d[0]==="all",h=[],m=[],b=[],v=Array.from(new Set([...Object.keys(l||{}),...Object.keys(y||{})]));for(const C of v){const _=l[C]||{},M=_.role,H=_.notification!==!1,W=_.instantSMS===!0;if(!(p||M&&d.includes(M))||!H)continue;if(W){b.push(C),m.push(C);continue}const ee=Ve(y[C]);ee.length>0&&(h.push(...ee),m.push(C))}const S=ne(h),x=ne(m),B=ne(b),P=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);return S.length>0?Et(e,t,S,{recipientDeviceNames:x,link:o.link||"/Mister-X/",waitSec:typeof o.waitSec=="number"?o.waitSec:45,sendEndpoint:o.sendEndpoint,rtdbBase:a,messageId:i,instantSMSDevices:B}):B.length>0?(await It(i,B,P,{rtdbBase:a}),{ok:!0,onlySms:!0,smsCount:B.length,messageId:i}):(c(`‚ö†Ô∏è Keine passenden Empf√§nger f√ºr Rollen "${Array.isArray(n)?n.join(","):n}".`),{ok:!0,skipped:"no_recipients"})}async function co(e){const t=Array.isArray(e)?e:[e],[n,o]=await Promise.all([I(f(g,"roles")),I(f(g,"tokens"))]),a=n.exists()?n.val():{},i=o.exists()?o.val():{},s=t.length===1&&t[0]==="all",r=[],u=[];for(const l in i){if(!Object.prototype.hasOwnProperty.call(i,l))continue;const y=a[l]||{},d=y.role,p=y.notification!==!1;if(!(s||d&&t.includes(d))||!p)continue;const m=Ve(i[l]);m.length!==0&&(r.push(...m),u.push(l))}return{tokens:ne(r),deviceNames:ne(u)}}async function lo(e){const t=Array.isArray(e)?e:[e],[n,o,a]=await Promise.all([I(f(g,"teams")),I(f(g,"roles")),I(f(g,"tokens"))]),i=n.exists()?n.val():{},s=o.exists()?o.val():{},r=a.exists()?a.val():{},u=[],l=[],y=[],d=new Set;for(const p of t){const h=i==null?void 0:i[p];if(!(!h||!h.members))for(const m of Object.keys(h.members||{})){if(d.has(m))continue;d.add(m);const b=s[m]||{},v=b.notification!==!1,S=b.instantSMS===!0;if(!v)continue;const x=Ve(r[m]);if(x.length>0){u.push(...x),l.push(m);continue}S&&(y.push(m),l.push(m))}}return{tokens:ne(u),deviceNames:ne(l),instantSMSDevices:ne(y)}}function uo(e,t,n){const o="Misterx-upload",a=new FormData;a.append("file",e),a.append("upload_preset",o),fetch("https://api.cloudinary.com/v1_1/ddvf141hb/image/upload",{method:"POST",body:a}).then(i=>i.json()).then(i=>{i.secure_url&&i.public_id?t({url:i.secure_url}):typeof n=="function"&&n(new Error("Fehler beim Hochladen zu Cloudinary."))}).catch(i=>{c("Upload-Fehler:",i),typeof n=="function"&&n(i)})}async function mo(){const e=document.getElementById("photoInput").files[0],t=document.getElementById("manualLocationDescription").value.trim(),n=document.getElementById("manualLocationContainer"),o=document.getElementById("status"),a=Ra();if(!a){T("Bitte zuerst einen Posten ausw√§hlen.",{type:"error"});return}if(!e){T("Bitte ein Foto ausw√§hlen.",{type:"error"});return}const i=Date.now();let s={lat:null,lon:null,accuracy:null};if(!(n&&n.style.display!=="none"&&t!==""))if(navigator.geolocation)try{const m=await Bt(),{latitude:b,longitude:v,accuracy:S}=m.coords;if(S>100){o.innerText=`‚ö†Ô∏è Standort ungenau (¬±${Math.round(S)} m). Bitte erneut versuchen oder Standortbeschreibung eingeben.`,n.style.display="block";return}s={lat:b,lon:v,accuracy:S}}catch(m){it==null||it(m),n.style.display="block"}else o.innerText="Geolocation wird nicht unterst√ºtzt.",n.style.display="block";const{color:r,postId:u,title:l}=a,y=f(g,`posten/${r}/active`);o.innerText="‚è≥ Reserviere Farbe‚Ä¶";try{const m=await be(y,b=>b===!0?!1:b);if(!m.committed||m.snapshot.val()!==!1){o.innerText="‚ùå Diese Farbe ist bereits inaktiv. Liste wird aktualisiert.";return}}catch(m){o.innerText="‚ùå Konnte Farbe nicht reservieren.",c(m);return}try{await $(f(g),{[`posten/${r}/${u}/visited`]:!0})}catch(m){o.innerText="‚ùå Konnte Posten nicht auf 'visited' setzen.",c(m);return}const d={color:r,postId:u,title:l,timestamp:i,description:t||null,lat:s.lat,lon:s.lon},p=Ke(f(g,"locations"),d),h=`${l} (${r.toUpperCase()})`;de==null||de("Mister X hat sich gezeigt!",h,["agent","settings","start"]),pe(),uo(e,async({url:m})=>{try{await $(p,{photoURL:m}),o.innerText="‚úÖ Foto hochgeladen"}catch(b){o.innerText="‚ùå Foto-URL konnte nicht gesetzt werden",c("Foto-URL konnte nicht gesetzt werden",b)}},m=>{o.innerText="‚ùå Foto konnte nicht hochgeladen werden",c("Upload-Fehler:",m)}),document.getElementById("photoInput").value="",document.getElementById("manualLocationDescription").value="",n.style.display="none",document.getElementById("postenSearch").value="",Dn(null),o.innerText="üîÑÔ∏è Posten/Farbe gemeldet & Foto wird hochgeladen.",pe==null||pe()}function it(e){let t="‚ùå Fehler beim Abrufen des Standorts.";switch(e.code){case e.PERMISSION_DENIED:t+=" Zugriff verweigert.";break;case e.POSITION_UNAVAILABLE:t+=" Standortinformationen nicht verf√ºgbar.";break;case e.TIMEOUT:t+=" Zeit√ºberschreitung bei der Standortabfrage.";break}t+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=t}function fo(e){return typeof e=="string"&&/^\+43\d{4,13}$/.test(e)}function ie(e){return e.replace(/[.#$/\[\]\/]/g,"_")}function ne(e){return Array.from(new Set(e))}function Ve(e){return e?typeof e=="string"?[e]:Array.isArray(e)?e.filter(Boolean):typeof e=="object"?Object.keys(e).filter(Boolean):[]:[]}function go(e){const t=String(e).trim();return t.startsWith("+")?"+"+t.slice(1).replace(/\D/g,""):t.replace(/\D/g,"")}function yn(){try{return JSON.parse(localStorage.getItem("mrx_sms_prefs_v1"))??{allowSmsFallback:!1,tel:null,noTel:!1,lastUpdated:0}}catch{return{allowSmsFallback:!1,tel:null,noTel:!1,lastUpdated:0}}}function Ot(e){const t=yn(),n={allowSmsFallback:!!(e.allowSmsFallback??t.allowSmsFallback),tel:e.tel===void 0?t.tel:e.tel,noTel:e.noTel===void 0?t.noTel:e.noTel,lastUpdated:Date.now()};return localStorage.setItem("mrx_sms_prefs_v1",JSON.stringify(n)),n}async function po(e){const t=ie(e),n=await I(f(g,`roles/${t}`));if(!n.exists())return{exists:!1,allowSmsFallback:null,tel:null};const o=n.val()||{};return{exists:!0,allowSmsFallback:o.allowSmsFallback!==void 0?!!o.allowSmsFallback:null,tel:o.tel??null}}function ho(e){if(!e)return null;let t=go(e);if(t.startsWith("+43"))return/^\+43\d{4,13}$/.test(t)?t:null;if(t.startsWith("0")){const n="+43"+t.slice(1);return/^\+43\d{4,13}$/.test(n)?n:null}if(t.startsWith("43")){const n="+"+t;return/^\+43\d{4,13}$/.test(n)?n:null}if(/^\d{5,}$/.test(t)&&t[0]!=="0"){const n="+43"+t;return/^\+43\d{4,13}$/.test(n)?n:null}return null}async function zt(e,t,n){const o=ie(e);dn(ae);const a={tel:t??null,allowSmsFallback:!!n,...t?{telUpdatedAt:Date.now()}:{}};await $(f(g,`roles/${o}`),a)}const N=e=>document.getElementById(e),bn=e=>e&&(e.style.display=""),wn=e=>e&&(e.style.display="none"),Xe=e=>{try{localStorage.setItem(gn,e||"")}catch{}},yo=()=>{try{return localStorage.getItem(gn)||""}catch{return""}};function bo(){let e=document.getElementById("toastContainer");if(e)return e;e=document.createElement("div"),e.id="toastContainer",e.setAttribute("aria-live","polite"),e.style.position="fixed",e.style.left="16px",e.style.bottom="16px",e.style.zIndex=2147483647,e.style.display="flex",e.style.flexDirection="column",e.style.gap="8px",e.style.maxWidth="calc(100vw - 32px)",document.body.appendChild(e);const t=document.createElement("style");return t.innerHTML=`#toastContainer .toast{background:#222;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.2);opacity:0;transform:translateY(6px);transition:opacity .22s,transform .22s;font-size:15px;max-width:380px;word-break:break-word}
#toastContainer .toast.show{opacity:1;transform:translateY(0)}
#toastContainer .toast.info{background:#333}
#toastContainer .toast.success{background:#2ECC71}
#toastContainer .toast.warn{background:#FF8C00}
#toastContainer .toast.error{background:#FF5252}
`,document.head.appendChild(t),e}function T(e,{timeout:t=6500,type:n="info"}={}){try{const o=bo(),a=document.createElement("div");a.className=`toast ${n}`,a.textContent=e,o.appendChild(a),requestAnimationFrame(()=>a.classList.add("show"));const i=setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>{try{a.remove()}catch{}})},t);return a.addEventListener("click",()=>{clearTimeout(i),a.classList.remove("show"),a.addEventListener("transitionend",()=>{try{a.remove()}catch{}})}),a}catch{try{alert(e)}catch{}}}function Oe(e){return typeof e=="number"?e:e&&typeof e=="object"&&typeof e.seconds=="number"?e.seconds*1e3:0}function jt(e){if(!e)return"‚Äî";try{return new Date(e).toLocaleString("de-DE",{dateStyle:"short",timeStyle:"short"})}catch{return new Date(e).toString()}}function vn(e){return e?`${String(e)}`:"Unbekannt"}function wo(e){const t=(e||"").trim();if(t.length<2)throw new Error("Der Teamname muss mindestens 2 Zeichen lang sein.");if(t.length>24)throw new Error("Der Teamname darf maximal 24 Zeichen lang sein.");return t}function z(e){return(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function st(e=""){return z(e).replace(/`/g,"&#096;")}function ft(e){const t=(e==null?void 0:e.members)||{};return Object.keys(t).length}function vo(e,t=E){return!!(e!=null&&e.members)&&!!e.members[t]}function So(){yo()?(N("teamStatusName").textContent="(l√§dt‚Ä¶)",N("teamStatusCount").textContent="-"):(N("teamStatusName").textContent="Kein Team",N("teamStatusCount").textContent="-"),xt()}document.addEventListener("DOMContentLoaded",So);function ko(){if(document.getElementById("teamSettings").style.display!=="none")return Sn();document.getElementById("startView").style.display="none",document.getElementById("startView2").style.display="none",document.querySelectorAll(".view").forEach(e=>e.style.display="none"),bn(N("teamSettings")),xt()}function Sn(){let e=localStorage.getItem("activeView")||"start";wn(N("teamSettings")),Pt(e)}function xt(){if(!Pe.deviceTeam){const e=f(g,`deviceTeams/${E}`),t=n=>{A=n.val()||null,Xe(A||""),Ht(),Wt(),Ut()};G(e,t),Pe.deviceTeam={ref:e,handler:t}}if(!Pe.teams){const e=f(g,"teams"),t=n=>{R=n.val()||{},Ht(),Wt(),Ut()};G(e,t),Pe.teams={ref:e,handler:t}}}function Ht(){const e=N("currentTeamName"),t=N("currentTeamMembers"),n=N("leaveTeamBtn"),o=A?R[A]:null;if(!o){e.textContent="Kein Team",t&&(t.innerHTML="‚Äî Mitglieder"),n&&(n.disabled=!0);return}e.textContent=o.name||"(ohne Namen)";const a=Object.entries(o.members||{}).map(([s,r])=>({id:s,joinedAt:Oe(r==null?void 0:r.joinedAt)})).sort((s,r)=>s.joinedAt!==r.joinedAt?s.joinedAt-r.joinedAt:s.id.localeCompare(r.id)),i=a.map(s=>{const r=s.id===E,u=vn(s.id)+(r?" (Du)":"");return`<li class="ts-member ${r?"me":""}" title="${z(s.id)}">${z(u)}</li>`}).join("");t&&(t.innerHTML=`
      <div class="muted">${a.length} Mitglied(er)</div>
      ${a.length>0?`<ul class="ts-member-list">${i}</ul>`:'<div class="muted">Noch keine Mitglieder</div>'}
    `),n&&(n.disabled=!vo(o))}function Wt(){const e=N("teamList"),t=N("teamsEmpty");if(!e)return;e.innerHTML="";const n=Object.entries(R||{}).filter(([,o])=>o&&typeof o=="object");if(n.length===0){t&&bn(t);return}t&&wn(t),n.sort((o,a)=>{const i=ft(o[1]),s=ft(a[1]);return i!==s?s-i:(o[1].name||"").localeCompare(a[1].name||"")});for(const[o,a]of n){const i=Object.entries(a.members||{}).map(([u,l])=>({id:u,joinedAt:Oe(l==null?void 0:l.joinedAt)})).sort((u,l)=>u.joinedAt!==l.joinedAt?u.joinedAt-l.joinedAt:u.id.localeCompare(l.id)),s=i.map(u=>{const l=u.id===E,y=vn(u.id)+(l?" (Du)":"");return`<li class="ts-member ${l?"me":""}" title="${z(u.id)}">${z(y)}</li>`}).join(""),r=document.createElement("div");r.className="ts-team",r.innerHTML=`
      <div>
        <div style="font-weight:600">${z(a.name||"(ohne Namen)")}</div>
        <div class="muted">${i.length} Mitglied(er)</div>
        <ul class="ts-member-list">
          ${s||""}
        </ul>
      </div>
      <div>
        ${A===o?'<button class="danger" onclick="leaveTeam()">Verlassen</button>':`<button onclick="joinTeam('${o}', this)">Beitreten</button>`}
      </div>
    `,e.appendChild(r)}}function Ut(){const e=N("teamStatusName"),t=N("teamStatusCount"),n=A?R[A]:null;if(!n){e.textContent="Kein Team",t.textContent="-";return}e.textContent=n.name||"(ohne Namen)",t.textContent=`${ft(n)} Mitglied(er)`}async function To(){const e=N("createTeamBtn"),t=N("createTeamInput");try{e.disabled=!0;const n=wo(t.value);A&&await Lt(A);const a=Ke(f(g,"teams")).key,i={};i[`teams/${a}`]={name:n,createdAt:oe(),createdBy:E,members:{[E]:{joinedAt:oe()}}},i[`deviceTeams/${E}`]=a,await $(f(g),i),Xe(a),t.value=""}catch(n){alert((n==null?void 0:n.message)||"Team konnte nicht erstellt werden."),c(n)}finally{e.disabled=!1}}async function Io(e,t){if(!e)return;if(!R[e]){T("Team existiert nicht (mehr).",{type:"error"});return}t&&(t.disabled=!0);try{A&&A!==e&&await Lt(A);const o={};o[`teams/${e}/members/${E}`]={joinedAt:oe()},o[`deviceTeams/${E}`]=e,await $(f(g),o),Xe(e)}catch(o){T((o==null?void 0:o.message)||"Beitritt nicht m√∂glich.",{type:"error"}),c(o)}finally{t&&(t.disabled=!1)}}async function Lt(e=null){const t=e||A;if(!t)return;const n=f(g,`teams/${t}`);await be(n,o=>o&&(o.members&&o.members[E]&&(delete o.members[E],Object.keys(o.members).length===0)?null:o)),await j(f(g,`deviceTeams/${E}`),null),Xe("")}function Eo(){const e=document.getElementById("map");e.style.display=""}function gt(e,t){var n,o;if(Eo(),w)w.setView([e,t],15),w.invalidateSize(),pt(),ht();else{if(w=L.map("map",{fullscreenControl:!0,fullscreenControlOptions:{position:"topleft"},maxBounds:[[-90,-180],[90,180]],doubleTouchDragZoom:!0}).setView([e,t],15),console.debug("createOrReuseMap: L.control.fullscreen=",typeof((n=L.control)==null?void 0:n.fullscreen),"map.options.fullscreenControl=",w&&w.options&&w.options.fullscreenControl),typeof((o=L.control)==null?void 0:o.fullscreen)=="function")try{w.fullscreenControl||L.control.fullscreen({position:"topleft",title:"Vollbild",titleCancel:"Vollbild verlassen",forceSeparateButton:!0}).addTo(w)}catch(d){c("leaflet.fullscreen: failed to add control programmatically",d)}try{window.__map=w}catch{}const a=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"¬© OpenStreetMap"}),i=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"¬© CartoDB"}),s=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles ¬© Esri"}),r=L.tileLayer("http://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web/default/WEBMERCATOR/{z}/{y}/{x}.png",{maxZoom:18,attribution:"TopPlus Open ¬© GeoBasis-DE / BKG"}),u=L.tileLayer("https://mapsneu.wien.gv.at/basemap/bmaporthofoto30cm/{type}/google3857/{z}/{y}/{x}.{format}",{maxZoom:20,attribution:'Datenquelle: <a href="https://www.basemap.at">basemap.at</a>',type:"normal",format:"jpeg",bounds:[[46.35877,8.782379],[49.037872,17.189532]]}),l=L.tileLayer("https://mapsneu.wien.gv.at/basemap/bmaphidpi/{type}/google3857/{z}/{y}/{x}.{format}",{maxZoom:19,attribution:'Datenquelle: <a href="https://www.basemap.at">basemap.at</a>',type:"normal",format:"jpeg",bounds:[[46.35877,8.782379],[49.037872,17.189532]]}),y={Standard:a,Reduziert:i,Satellit:s,"Satellit (AT)":u,Plan:r,"Plan (AT)":l};a.addTo(w),L.control.layers(y).addTo(w),setTimeout(()=>w.invalidateSize(),0),pt(),ht();try{let d=function(){const p=document.querySelector(".leaflet-control-scale");p&&(p.classList.add("visible"),Ce&&clearTimeout(Ce),Ce=setTimeout(()=>{p.classList.remove("visible"),Ce=null},5e3))};Qe=L.control.scale({position:"bottomright",metric:!0,imperial:!1}).addTo(w),w.on("zoomend",()=>{try{Qe._update&&Qe._update()}catch{}d()})}catch(d){c("Scale control setup failed",d)}}At()}function pt(){w&&(w.getPane("maskPane")||(w.createPane("maskPane"),w.getPane("maskPane").style.zIndex=300),w.getPane("historyPane")||(w.createPane("historyPane"),w.getPane("historyPane").style.zIndex=410),w.getPane("postenPane")||(w.createPane("postenPane"),w.getPane("postenPane").style.zIndex=400),w.getPane("agentenPane")||(w.createPane("agentenPane"),w.getPane("agentenPane").style.zIndex=420),w.getPane("userPane")||(w.createPane("userPane"),w.getPane("userPane").style.zIndex=450))}function ht(){if(O||(O=L.layerGroup()),Y||(Y=L.layerGroup()),Me||(Me=L.layerGroup()),w){w.hasLayer(O)||O.addTo(w),w.hasLayer(Y)||Y.addTo(w),w.hasLayer(Me)||Me.addTo(w);try{typeof ot<"u"&&!w.hasLayer(ot)&&ot.addTo(w)}catch{}}}function xo(e){if(!w)return;ht(),Y.clearLayers();const t=new L.Icon.Default;t.options.shadowSize=[0,0],e.forEach(o=>{L.marker([o.lat,o.lon],{pane:"historyPane",icon:t}).addTo(Y).bindPopup(`üìç ${new Date(o.timestamp).toLocaleTimeString()}`)});const n=e.map(o=>[o.lat,o.lon]);n.length>1&&L.polyline(n,{color:"blue",weight:3,opacity:.7,smoothFactor:1,pane:"historyPane"}).addTo(Y)}let Ee=null,xe=null,yt=!1;function kn(){const e=document.getElementById("locationFeed");if(!e)return;e.innerHTML="";let t=[];try{const a=(Ee==null?void 0:Ee.val())||null;t=a?Object.values(a).sort((i,s)=>s.timestamp-i.timestamp):[]}catch{t=[]}let n=[];try{const a=(xe==null?void 0:xe.val())||null;n=a?Object.values(a).sort((i,s)=>s.timestamp-i.timestamp):[]}catch{n=[]}const o=[...t.map(a=>({kind:"loc",data:a})),...n.map(a=>({kind:"ubahn",data:a}))].sort((a,i)=>(i.data.timestamp||0)-(a.data.timestamp||0));o.length!==0&&(o.forEach((a,i)=>{const s=document.createElement("div");if(s.style.marginBottom="1em",a.kind==="loc"){const r=a.data,u=r.title?r.title:"Automatischer Standort",l=r.timestamp?new Date(r.timestamp).toLocaleTimeString():"",y=r.photoURL?`<img src="${r.photoURL}" alt="Foto" class="zoomable-photo" style="max-width: 100%; max-height: 60vh; border: 1px solid #ccc; margin-top: 5px; cursor: zoom-in;" data-index="${i}">`:"";s.innerHTML=`
        <strong class="location-title" data-lat="${r.lat}" data-lon="${r.lon}" style="cursor: pointer;">${u} (${l})</strong><br>
        ${r.description?`<em>üìç ${r.description}</em><br>`:""}
        ${y}
      `}else{const r=a.data,u=r.timestamp?new Date(r.timestamp).toLocaleTimeString():"",l=r.message?r.message:"U-Bahn-Ereignis";s.innerHTML=`
        <strong class="location-title ubahn-event" data-lat="" data-lon="" style="cursor: default;">üöá ${z(String(l))} (${u})</strong><br>
      `}e.appendChild(s)}),document.querySelectorAll(".location-title").forEach(a=>{const i=parseFloat(a.dataset.lat),s=parseFloat(a.dataset.lon);!isNaN(i)&&!isNaN(s)&&(a.style.cursor="pointer",a.addEventListener("click",()=>{w&&!isNaN(i)&&!isNaN(s)&&w.setView([i,s],17)}))}),document.querySelectorAll(".zoomable-photo").forEach(a=>{a.addEventListener("click",()=>{const i=document.createElement("div");i.style.position="fixed",i.style.top="0",i.style.left="0",i.style.width="100vw",i.style.height="100vh",i.style.backgroundColor="rgba(0,0,0,0.8)",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.zIndex="9999",i.innerHTML=`<img src="${a.src}" style="max-width: 90%; max-height: 90%; border: 2px solid white;">`,i.addEventListener("click",()=>{document.body.removeChild(i)}),document.body.appendChild(i)})}))}function Tn(){G(f(g,"locations"),e=>{Ee=e;const t=e.val()||null;let n=[],o=[],a=null;try{n=t?Object.values(t).sort((i,s)=>s.timestamp-i.timestamp):[],o=n.filter(i=>i.lat!=null&&i.lon!=null),a=o.length===0}catch{a=!0}if(a)gt(48.208672092667435,16.372477270381918),c("Keine Locations");else if(o.length>0){const{lat:i,lon:s}=o[0];gt(i,s)}Ao(),o.length>0?xo(o):Y&&Y.clearLayers(),At(),ze({nonDestructive:!0}),kn()}),yt||_n()}function Lo(){if(!navigator.geolocation){alert("‚ùå Geolocation wird nicht unterst√ºtzt.");return}Ie==null&&(Ie=navigator.geolocation.watchPosition(e=>{const{latitude:t,longitude:n,accuracy:o}=e.coords;if(!w)return;const a={radius:7,color:"#007AFF",fillColor:"#ffffffff",fillOpacity:.8,opacity:1,weight:2},i={radius:o,color:"#007AFF",fillColor:"#007AFF",interactive:!1,fillOpacity:.2,weight:1,opacity:.4};if(q?(q.setLatLng([t,n]),q.getPopup()&&q.getPopup().setContent(`<strong>Dein Standort</strong><br>Genauigkeit: ¬±${Math.round(o)} m`)):q=L.circleMarker([t,n],{markerStyle:a,pane:"userPane"}).bindPopup(`<strong>Dein Standort</strong><br>Genauigkeit: ¬±${Math.round(o)} m`).addTo(w),V?(V.setLatLng([t,n]),V.setRadius(o)):V=L.circle([t,n],{...i,pane:"historyPane"}).addTo(w),fn){const s=Math.max(w.getZoom(),16);w.setView([t,n],s,{animate:!0})}},e=>{c("Geolocation-Fehler:",e),In(),alert("‚ö†Ô∏è Tracking gestoppt: "+e.message)},{enableHighAccuracy:!0,timeout:15e3,maximumAge:5e3}))}function In(){Ie!=null&&(navigator.geolocation.clearWatch(Ie),Ie=null),w&&q&&(w.removeLayer(q),q=null),w&&V&&(w.removeLayer(V),V=null)}function Ao(){w&&(q&&!w.hasLayer(q)&&q.addTo(w),V&&!w.hasLayer(V)&&V.addTo(w))}function Bo(){const e=document.getElementById("refreshBtn");e&&e.addEventListener("click",async()=>{e.classList.add("updating");try{await Co({timeoutMs:2500})}catch(t){c("[Refresh] Fehler im Update-Flow:",t),window.location.reload()}})}async function Co({timeoutMs:e=2500}={}){if(!("serviceWorker"in navigator)){window.location.reload();return}const t=await navigator.serviceWorker.getRegistration();if(!t){c("[Refresh] Keine SW-Registration gefunden -> normaler Reload"),window.location.reload();return}c("[Refresh] Vor Update:",Ro(t)),await t.update();let n=t.installing||t.waiting||null;n||(n=await Po(t,800)),n?(await Mo(n),t.waiting&&(c("[Refresh] Sende SKIP_WAITING an Waiting-SW"),t.waiting.postMessage({type:"SKIP_WAITING"}))):c("[Refresh] Keine neue SW gefunden -> normaler Reload"),await Fo(e),window.location.reload()}function Po(e,t){return new Promise(n=>{let o;const a=()=>{e.removeEventListener("updatefound",a),clearTimeout(o),n(e.installing||e.waiting||null)};e.addEventListener("updatefound",a),o=setTimeout(()=>{e.removeEventListener("updatefound",a),n(null)},t)})}function Mo(e){return new Promise(t=>{if(e.state==="installed"||e.state==="activated")return t();e.addEventListener("statechange",()=>{(e.state==="installed"||e.state==="activated")&&t()})})}function Fo(e){return new Promise(t=>{let n=!1;const o=()=>{n||(n=!0,navigator.serviceWorker.removeEventListener("controllerchange",a),t())},a=()=>{c("[Refresh] controllerchange empfangen"),o()};navigator.serviceWorker.addEventListener("controllerchange",a),setTimeout(()=>{c("[Refresh] controllerchange-Timeout, lade dennoch neu"),o()},e)})}function Ro(e){const t=n=>n?n.state:"‚Äî";return{scope:e.scope,active:t(e.active),installing:t(e.installing),waiting:t(e.waiting),controlled:!!navigator.serviceWorker.controller}}function _o(){let e=0;const t=15e3,n=async()=>{const o=Date.now();if(!(o-e<t)){e=o;try{const a=await navigator.serviceWorker.getRegistration();if(!a)return;await a.update(),a.waiting&&a.waiting.postMessage({type:"SKIP_WAITING"})}catch{}}};document.addEventListener("visibilitychange",()=>{document.hidden||n()}),window.addEventListener("focus",n)}function Do(e,t,n){const o=Yn[e]||"#666";return n?{radius:10,color:o,fillColor:o,fillOpacity:.9,opacity:1,weight:3}:t===!1?{radius:6,color:o,fillColor:o,fillOpacity:.25,opacity:.4,weight:1}:{radius:9,color:o,fillColor:o,fillOpacity:.7,opacity:.9,weight:2}}function qt(e,t,n,o){const a=n.title||t,i=!!n.visited,s=o?"aktiv":"inaktiv",r=i?"‚úÖ besucht":"üïí offen",u=n.imageUrl?`
      <div class="posten-preview" style="margin-top:6px">
        <img
          class="posten-preview-img"
          src="${st(n.imageUrl)}"
          data-fullsrc="${st(n.imageUrl)}"
          alt="${st(a)}"
          loading="lazy"
          style="width:100%;height:auto;max-height:120px;object-fit:contain;border-radius:8px;cursor:zoom-in;display:block"
          referrerpolicy="no-referrer"
        />
      </div>
    `:"";return`
    <div class="posten-popup" style="min-width:200px">
      <strong>${z(a)}</strong><br>
      <small>Farbe: ${z(e)} (${s})</small><br>
      <small>Status: ${r}</small>
      ${u}
    </div>
  `}function No(e){const t=e.lat??e.latitude??null,n=e.lon??e.lng??e.longitude??null;return{lat:t,lon:n}}async function $o(){const e=f(g,"posten"),t=await I(e);ue=t.exists()?t.val():null,ze(),G(e,n=>{ue=n.exists()?n.val():null,ze()})}function Oo(){const e=document.getElementById("img-lightbox"),t=document.getElementById("img-lightbox-close");if(!e||!t)return;const n=()=>e.style.display="none";t.addEventListener("click",n),e.addEventListener("click",o=>{o.target===e&&n()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&n()})}function zo(){const e=t=>{const n=t.target.closest(".posten-preview-img");if(!n)return;t.preventDefault(),t.stopPropagation();const o=n.getAttribute("alt")||"Bild",a=n.getAttribute("data-fullsrc")||n.getAttribute("src");a&&jo(a,o)};document.addEventListener("click",e,{capture:!0})}function jo(e,t=""){const n=document.getElementById("img-lightbox"),o=document.getElementById("img-lightbox-img");!n||!o||(n.style.display="flex",o.onload=null,o.onerror=null,o.alt=t||"Bild",o.src===e&&(o.src=""),o.src=e)}function At(){O||(O=L.layerGroup()),w&&!w.hasLayer(O)&&O.addTo(w)}function ze(e={}){const{nonDestructive:t=!1}=e;if(!w||!ue)return;pt(),At();const n=new Set;let o=0;if(Object.entries(ue).forEach(([a,i])=>{if(!i||typeof i!="object")return;const s=!!i.active,r=Object.fromEntries(Object.entries(i).filter(([u])=>u!=="active"));Object.entries(r).forEach(([u,l])=>{var m,b;if(!l||typeof l!="object")return;const{lat:y,lon:d}=No(l);if(y==null||d==null)return;o++;const p=`${a}/${u}`;n.add(p);const h=Do(a,s,!!l.visited);if(J[p]){const v=J[p];v.setLatLng([y,d]),v.setStyle(h),v._postenLoc=l,v._postenId=p,O&&!O.hasLayer(v)&&v.addTo(O),(m=v.bringToFront)==null||m.call(v),(b=v.getPopup())==null||b.setContent(qt(a,u,l,s))}else{const v=L.circleMarker([y,d],{...h,pane:"postenPane"}).bindPopup(qt(a,u,l,s));v._postenLoc=l,v._postenId=p,v.addTo(O),J[p]=v}})}),!t){if(o===0){c("[posten] Kein g√ºltiger Posten geparst - Cleanup √ºbersprungen.");return}Object.keys(J).forEach(a=>{n.has(a)||(O.removeLayer(J[a]),delete J[a])})}}Object.keys(J).forEach(e=>{seen.has(e)||(O.removeLayer(J[e]),delete J[e])});async function Ho(e=!0){const t=f(g,"posten"),n=await I(t);if(!n.exists())return;const o=n.val(),a={};Object.entries(o).forEach(([i,s])=>{!s||typeof s!="object"||(a[`posten/${i}/active`]=e,Object.entries(s).forEach(([r,u])=>{r==="active"||!u||typeof u!="object"||(a[`posten/${i}/${r}/visited`]=!1)}))}),await $(f(g),a)}const Fe=e=>e*Math.PI/180;function Wo(e,t,n,o){const i=Fe(n-e),s=Fe(o-t),r=Math.sin(i/2)**2+Math.cos(Fe(e))*Math.cos(Fe(n))*Math.sin(s/2)**2;return 2*6371e3*Math.asin(Math.sqrt(r))}function Bt(e={enableHighAccuracy:!0,timeout:8e3,maximumAge:0}){return new Promise((t,n)=>{if(!navigator.geolocation)return n(new Error("Geolocation nicht unterst√ºtzt"));navigator.geolocation.getCurrentPosition(t,n,e)})}function En({excludeVisited:e=!0}={}){const t=[];for(const[n,o]of Object.entries(ue))if(!(!o||o.active!==!0))for(const[a,i]of Object.entries(o.posts||{}))!i||typeof i!="object"||e&&i.visited===!0||t.push({color:n,postId:a,...i});return t}function De(e){const t=document.getElementById("postenSuggestions");if(!e||e.length===0){t.style.display="none",t.innerHTML="";return}t.innerHTML=e.map(n=>{const o=n.distance!=null?` - ${(n.distance/1).toFixed(0)} m`:"";return`<div class="item" data-color="${n.color}" data-postid="${n.postId}">
              ${n.title||"(ohne Titel)"}
              <span class="tag">${n.color}</span>${o}
            </div>`}).join(""),t.style.display="block",t.querySelectorAll(".item").forEach(n=>{n.addEventListener("click",()=>{var l,y;const o=n.getAttribute("data-color"),a=n.getAttribute("data-postid"),i=(y=(l=ue[o])==null?void 0:l.posts)==null?void 0:y[a];if(!i){c("Ausgew√§hlter Posten nicht im Cache gefunden:",{color:o,postId:a}),document.getElementById("status").innerText="Dieser Posten ist nicht mehr verf√ºgbar.",t.style.display="none";return}const s={color:o,postId:a,title:i.title||a,lat:i.lat??null,lon:i.lon??null};Dn(s);const r=document.getElementById("postenSearch");r&&(r.value=`${s.title} [${o}]`),t.style.display="none";const u=document.getElementById("status");u&&(u.innerText=`‚úÖ Posten ausgew√§hlt: ${s.title} (${o})`)})})}function xn(e){const t=(e||"").trim().toLowerCase(),n=En();return t?n.filter(o=>{const a=String(o.postId).toLowerCase(),i=String(o.title||"").toLowerCase(),s=String(o.color).toLowerCase();return a.includes(t)||i.includes(t)||s.includes(t)}).slice(0,25):[]}async function Uo(e=5){try{const t=await Bt(),{latitude:n,longitude:o,accuracy:a}=t.coords;a>100&&(document.getElementById("status").innerText=`‚ö†Ô∏è Standort ungenau (¬±${Math.round(a)}‚ÄØm). Ergebnisse evtl. ungenau.`);const i=En().map(s=>({...s,distance:s.lat!=null&&s.lon!=null?Wo(n,o,s.lat,s.lon):Number.POSITIVE_INFINITY}));return i.sort((s,r)=>s.distance-r.distance),i.slice(0,e)}catch{return document.getElementById("status").innerText="üìç Konnte Standort nicht bestimmen. Du kannst trotzdem per Suche ausw√§hlen.",[]}}async function qo(){const e=f(g,"posten");G(e,t=>{const n=t.val()||{},o={};for(const[i,s]of Object.entries(n)){if(!s||typeof s!="object")continue;const{active:r,...u}=s,l={};for(const[y,d]of Object.entries(u))d&&typeof d=="object"&&(l[y]=d);o[i]={active:!!r,posts:l}}ue=o;const a=document.getElementById("postenSearch").value;a&&De(xn(a))})}function Go(){const e=document.getElementById("postenSearch"),t=document.getElementById("nearbyBtn");let n;e.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=xn(e.value);De(o)},150)}),t.addEventListener("click",async()=>{const o=await Uo(20);if(o.length===0){De(o),document.getElementById("status").innerText="Keine nahegelegenen Posten gefunden (oder Standort unbekannt).";return}De(o)}),document.addEventListener("click",o=>{const a=document.getElementById("postenSuggestions");a.contains(o.target)||e.contains(o.target)||t.contains(o.target)||(a.style.display="none")})}const me=document.getElementById("notifHeader"),Le=document.getElementById("notifHeaderToggle"),rt=document.getElementById("notifSummary"),Ko=document.getElementById("notifDetails"),Gt=document.getElementById("notifStatusDot"),Kt=document.getElementById("notifTimeShort"),Vt=document.getElementById("notifTitle"),Xt=document.getElementById("notifBody"),Zt=document.getElementById("notifSender"),Jt=document.getElementById("notifTime"),Yt=document.getElementById("notifId"),ct=document.getElementById("recipientList"),Re=document.getElementById("notifCount"),Se=document.getElementById("toggleNotifHeader");let ce=null;function lt(e){me.style.display=e?"block":"none",!e&&typeof ce=="function"&&(ce(),ce=null)}function Ct(e){me.classList.toggle("collapsed",e),me.classList.toggle("expanded",!e),Ko.hidden=e,Le.setAttribute("aria-expanded",String(!e)),Le.textContent=e?"‚ñæ":"‚ñ¥"}Le==null||Le.addEventListener("click",e=>{e.stopPropagation();const t=me.classList.contains("collapsed");Ct(!t)});rt==null||rt.addEventListener("click",()=>{const e=me.classList.contains("collapsed");Ct(!e)});function Vo(e){return new Date(e).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}function bt(e){if(!e){Vt.textContent="-",Xt.textContent="-",Zt.textContent="-",Jt.textContent="-",Kt.textContent="[--:--]",Yt.textContent="-",ct.innerHTML="",Gt.style.background="#bbb",Re&&(Re.textContent="-"),me.classList.remove("sticky"),me.style.position="";return}const t=typeof e.timestamp=="number"?e.timestamp:Date.now(),n=Vo(t);Vt.textContent=e.title||"Ohne Titel",Xt.textContent=e.body||"",Zt.textContent=e.sender||"Unbekannt",Jt.textContent=new Date(t).toLocaleString("de-DE"),Kt.textContent=`[${n}]`,Yt.textContent=e.id??"-";const o=e.recipients||{},a=Object.keys(o),i=a.filter(d=>o[d]===!0).length,s=a.length,r={};a.forEach(d=>{const p=ie(d);o[d]===!0?r[d]="green":e&&e.fallbackTargets&&e.fallbackTargets[p]?r[d]="orange":r[d]="red"});const u={};a.forEach(d=>{const p=(()=>{for(const[m,b]of Object.entries(R||{}))if(b.members&&b.members[d])return b;return null})();let h=r[d];h==="red"&&p&&Object.keys(p.members).filter(v=>v!==d).some(v=>r[v]==="green"||r[v]==="orange")&&(h="blue"),u[d]=h}),ct.innerHTML="";const l=[];a.sort((d,p)=>d.localeCompare(p)).forEach(d=>{const p=u[d];l.push(p);const h=p==="green"?"ok":p==="orange"?"wait":p==="blue"?"teamblue":"red",m=p==="green"?"‚úÖ":p==="blue"?"üü¶":p==="orange"?"üì∞":"üî¥",b=document.createElement("div");b.className=`recipient-chip ${h}`,b.innerHTML=`<span class="dot"></span><span>${d}</span><span>${m}</span>`,ct.appendChild(b)});let y="#FF5252";l.length>0&&(l.some(d=>d==="red")?y="#FF5252":l.some(d=>d==="blue")?y="#1E90FF":l.some(d=>d==="orange")?y="#FF8C00":y="#2ECC71"),Gt.style.background=y,Re&&(Re.textContent=`${i}/${s} best√§tigt`)}function Qt(){typeof ce=="function"&&(ce(),ce=null);const e=kt(f(g,"notifications"),Tt("timestamp"),Un(1)),t=G(e,n=>{const o=n.val();if(!o){bt(null);return}const[a,i]=Object.entries(o)[0];bt({id:a,...i})});ce=()=>t()}function Xo(){const e=localStorage.getItem(et)==="1";lt(e),e&&Qt(),Se&&(Se.checked=e),Ct(!0),Se==null||Se.addEventListener("change",t=>{t.target.checked?(localStorage.setItem(et,"1"),lt(!0),Qt()):(localStorage.removeItem(et),lt(!1),bt(null))})}async function Zo(){if(confirm("M√∂chtest du wirklich die Standorte der Agenten anfragen?"))try{let e=R;(!e||Object.keys(e).length===0)&&(e=(await I(f(g,"teams"))).val()||{});const t={};for(const[i,s]of Object.entries(e)){if(i===A)continue;(s!=null&&s.members?Object.keys(s.members).length:0)>0&&(t[i]=!0)}if(Object.keys(t).length===0){c==null||c("[triggerAgentLocationRequest] Abbruch: keine adressierbaren Teams gefunden."),T("Keine Teams gefunden, die angefragt werden k√∂nnen.",{type:"error"});return}const n=String(Date.now()),o={id:n,createdAt:oe(),createdBy:E,teamsAtRequest:t,responses:{}};await j(f(g,"agentLocationRequest"),o);const a=Object.keys(t);try{const{tokens:i,deviceNames:s,instantSMSDevices:r}=await lo(a),u="Mister X hat deinen Standort angefragt",l="√ñffne die App, um deinen Standort freizugeben!";if(i&&i.length>0||r&&r.length>0){if(i&&i.length>0&&await Et(u,l,i,{recipientDeviceNames:s,link:"/Mister-X/",rtdbBase:Q}),r&&r.length>0&&(!i||i.length===0)){const y=`${u}: ${l}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);await It(he(),r,y,{rtdbBase:Q})}}else c==null||c("[triggerAgentLocationRequest] Keine Empf√§nger in den ausgew√§hlten Teams gefunden.")}catch(i){c==null||c("[triggerAgentLocationRequest] Fehler beim Ermitteln der Empf√§nger",i)}return c==null||c("[triggerAgentLocationRequest] Anfrage ausgel√∂st",{reqId:n,totalTeams:Object.keys(t).length}),n}catch(e){throw c==null||c("[triggerAgentLocationRequest] Anfrage fehlgeschlagen",e),T("Konnte die Anfrage nicht ausl√∂sen.",{type:"error"}),e}}async function Ln(e){var t,n;if(!(!e||!e.id)){if(nt.has(e.id)){c("shareTeamLocationForRequest: already in flight for "+e.id);return}try{if(localStorage.getItem(tt)===e.id){c("shareTeamLocationForRequest: already prompted (LS) for "+e.id);return}}catch{}nt.add(e.id);try{if(!A){T("Du bist in keinem Team. Standortfreigabe abgebrochen.",{type:"warn"});return}try{if(localStorage.getItem(U)===e.id){c("shareTeamLocationForRequest: already responded (LS) for "+e.id);return}}catch{}const o=f(g,`agentLocationRequest/responses/${A}`);if((await I(o)).exists()){try{localStorage.setItem(U,e.id)}catch{}return}const i=f(g,"agentLocationRequest"),s=await I(i);if(!s.exists()){T("Die Anfrage wurde zur√ºckgezogen ‚Äî Standort wird nicht gesendet.",{type:"warn"});try{localStorage.setItem(U,e.id)}catch{}return}const r=s.val();if(r!=null&&r.id&&r.id!==e.id){T("Es gibt inzwischen eine andere Anfrage ‚Äî Standort wird nicht gesendet.",{type:"warn"});try{localStorage.setItem(U,e.id)}catch{}return}try{localStorage.setItem(tt,e.id)}catch{}const u=await ra("Dein Standort wird jetzt f√ºr Mister X freigegeben",e.id,{maxWaitMs:1e4,desiredAccuracy:30,autoConfirmMs:3e4});if(u===null){c("shareTeamLocationForRequest: confirm dialog auto-closed");try{localStorage.setItem(U,e.id)}catch{}try{localStorage.removeItem("pendingAgentResponse")}catch{}return}if(u==="cancel"){T("Standortfreigabe abgebrochen.",{type:"info"});try{localStorage.setItem(U,e.id)}catch{}try{localStorage.removeItem("pendingAgentResponse")}catch{}return}const l=u.position,y=l.coords.latitude,d=l.coords.longitude,p=typeof l.coords.accuracy=="number"?Math.round(l.coords.accuracy):null,h=((t=R==null?void 0:R[A])==null?void 0:t.name)||"Team";T("Standort freigegeben",{type:"success"});const m=await I(i);if(!m.exists()||(n=m.val())!=null&&n.id&&m.val().id!==e.id){T("Die Anfrage wurde zur√ºckgezogen oder ersetzt ‚Äî Standort wird nicht gesendet.",{type:"warn"});try{localStorage.setItem(U,e.id)}catch{}return}const b=await be(i,S=>{if(!S||S.id!==e.id)return;const x=S.responses||{};return x[A]||(x[A]={teamId:A,teamName:h,lat:y,lon:d,accuracy:typeof p=="number"?p:null,deviceId:E,timestamp:oe()},S.responses=x),S},{applyLocally:!1});if(!!!(b!=null&&b.committed)){T("Standort nicht gesendet: die Anfrage wurde zur√ºckgezogen oder bereits beantwortet.",{type:"warn"});try{localStorage.setItem(U,e.id)}catch{}return}try{localStorage.setItem(U,e.id)}catch{}try{localStorage.removeItem("pendingAgentResponse")}catch{}c("Standortantwort erfolgreich gesetzt (agentLocationRequest.responses/"+A+")")}finally{try{nt.delete(e.id)}catch{}try{localStorage.removeItem(tt)}catch{}}}}async function An(e){if(!e||!e.reqId||!e.teamId)return!1;const t=f(g,"agentLocationRequest");try{const n=await be(t,a=>{var s;if(!a||a.id!==e.reqId)return;const i=a.responses||{};return i[e.teamId]||(i[e.teamId]={teamId:e.teamId,teamName:e.teamName||((s=R==null?void 0:R[e.teamId])==null?void 0:s.name)||"Team",lat:e.lat,lon:e.lon,accuracy:typeof e.accuracy=="number"?e.accuracy:null,deviceId:E,timestamp:oe()},a.responses=i),a},{applyLocally:!1});if(!!(n!=null&&n.committed)){try{localStorage.removeItem("pendingAgentResponse"),localStorage.setItem(U,e.reqId)}catch{}return T("Standort wurde im Hintergrund gesendet.",{type:"success"}),c("sendPendingAgentResponse: committed for "+e.reqId),!0}return c("sendPendingAgentResponse: transaction not committed"),!1}catch(n){return c("sendPendingAgentResponse error",n),!1}}async function en(e){try{const t=localStorage.getItem("pendingAgentResponse");if(!t)return;const n=JSON.parse(t);if(!n||!n.reqId||!e||!e.id||e.id!==n.reqId||!A||n.teamId!==A)return;const o=f(g,`agentLocationRequest/responses/${A}`);if((await I(o)).exists()){try{localStorage.removeItem("pendingAgentResponse"),localStorage.setItem(U,n.reqId)}catch{}return}if(await An(n))return;T("Dein Standort konnte nicht automatisch gesendet werden. Bitte best√§tige erneut.",{type:"warn"});try{await Ln(e)}catch(s){c("checkAndDeliverPendingResponse share prompt failed",s)}}catch(t){c("checkAndDeliverPendingResponse error",t)}}function Jo(){D(f(g,"agentLocationRequest")),Qo(),wt()}function wt(){Array.isArray(ge)&&ge.length&&window.map&&ge.forEach(e=>w.removeLayer(e)),ge=[]}function Yo(){const e=f(g,"agentLocationRequest");G(e,n=>{const o=n.exists()?n.val():null;if(pn=o,Bn(o),o&&o.createdBy!==E&&A){try{if(o.responses&&o.responses[A])return}catch{}try{en(o).catch(a=>c("checkAndDeliverPendingResponse error",a))}catch{}ea(o)}}),(async()=>{try{const n=await I(e);n&&n.exists()&&await en(n.val())}catch{}})()}function Qo(){const e=document.getElementById("agentReqStatus");e&&(e.style.display="none")}async function ea(e){try{await Ln(e)}catch(t){c("Standortfreigabe fehlgeschlagen",t)}}function Bn(e=pn){const t=document.getElementById("agentReqStatus"),n=document.getElementById("agentReqProgress");if(!t||!n)return;if(!e){t.style.display="none",wt();return}const o=typeof e.createdAt=="number"?new Date(e.createdAt).toLocaleTimeString():"Unbekannt",a=e.responses||{},i=Object.values(a),s=e.teamsAtRequest||{},r=Object.keys(s).length||i.length,u=i.length;if(n.textContent=`Standort von ${u}/${r} Teams ‚Äì ${o}`,t.style.display="block",wt(),!(!_e||i.length===0)){ta(i);for(const l of i){if(l.lat==null||l.lon==null)continue;const y=L.divIcon({className:`square-marker ${na(l.teamId)}`,iconSize:[14,14]}),d=L.marker([l.lat,l.lon],{icon:y,pane:"agentenPane"}).addTo(w),p=typeof l.accuracy=="number"?` (¬±${Math.round(l.accuracy)} m)`:"";if(d.bindPopup(`<strong>${z(l.teamName||"Team")}${p}</strong>`),ge.push(d),typeof l.accuracy=="number")try{const h=L.circle([l.lat,l.lon],{radius:l.accuracy,color:"#888",weight:1,fillColor:"#888",fillOpacity:.08,pane:"agentenPane",interactive:!1}).addTo(w);ge.push(h)}catch(h){c("Konnte Genauigkeitskreis von Agentenstandort nicht erzeugen",h)}}}}function ta(e){if(!window.map){const t=e.find(n=>n.lat!=null&&n.lon!=null);t&&gt(t.lat,t.lon)}}function na(e){const t=["","orange","green","purple","blue","red","yellow","cyan","pink","lime","teal","brown"],n=Math.abs(oa(String(e)))%t.length;return t[n]}function oa(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}function aa(){I(f(g,"roles")).then(e=>{const t=e.val();for(const n in t)t[n].role==="misterx"&&j(f(g,"roles/"+n),{role:"start",timestamp:Date.now()});T("Alle Mister X Rollen wurden zur√ºckgesetzt.",{type:"info"})})}async function ia(){const e=await I(f(g,"settings/max_Team_X")),t=e.exists()?e.val():1,o=(await I(f(g,"roles"))).val();let a=0;for(const i in o)o[i].role==="misterx"&&a++;return a<t}async function Pt(e){if(e!==localStorage.getItem("activeView")){if(e==="misterx"&&!await ia()){T("Es sind bereits die maximal erlaubten Mister X Spieler aktiv.",{type:"error"}),Ne();return}if(e==="settings"&&prompt("Passwort eingeben!")!=="1001"){Ne();return}}if(e==="start")return Ne();document.getElementById("startView").style.display="none",document.getElementById("startView2").style.display="none",document.querySelectorAll(".view").forEach(n=>n.style.display="none"),e==="misterx"?(document.getElementById("misterxView").style.display="block",I(f(g,mt)).then(n=>{const o=n.exists()?!!n.val():!1;Ae(o)}).catch(()=>{})):e==="agent"?(document.getElementById("agentView").style.display="block",Ae(!1)):e==="settings"&&(document.getElementById("settingsView").style.display="block",ba(),Ae(!1)),localStorage.setItem("activeView",e),$(f(g,"roles/"+E),{role:e,timestamp:Date.now()});const t=e;await K.from("fcm_tokens").update({role:t}).eq("device_name",E),I(f(g,"timer")).then(n=>{const o=n.val();if(o){const{startTime:a,duration:i,durationInput:s,durationInput2:r}=o;i?(Cn(a,i),fe(!0)):fe(!1)}})}async function Ne(){document.querySelectorAll(".view").forEach(t=>t.style.display="none"),document.getElementById("startView").style.display="block",document.getElementById("startView2").style.display="block",clearInterval(te),localStorage.setItem("activeView","start"),$(f(g,"roles/"+E),{role:"start",timestamp:Date.now()}),await K.from("fcm_tokens").update({role:"start"}).eq("device_name",E)}async function pe(e){await D(f(g,"timer/duration")),await D(f(g,"timer/startTime")),await D(f(g,"timerMessage")),typeof te<"u"&&clearInterval(te);const n=(await I(f(g,"timer"))).val();let o=25*60;typeof(n==null?void 0:n.durationInput)=="number"&&n.durationInput>0&&(o=n.durationInput,(isNaN(o)||o<1)&&(o=60)),typeof e=="number"&&e>0&&(o=e);const a=Date.now(),i=a+o*1e3,s={title:"Deine Zeit l√§uft gleich ab",body:"Bitte √∂ffne deine App!"};await j(f(g,"timer"),{startTime:a,duration:o,durationInput:n==null?void 0:n.durationInput,durationInput2:(n==null?void 0:n.durationInput2)||0});try{await K.rpc("cancel_and_unschedule")}catch(d){c("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",d)}const{tokens:r,deviceNames:u}=await co("misterx"),l=o-60,y=(he==null?void 0:he())??void 0;await K.functions.invoke("arm-timer-cron",{body:{title:s.title,body:s.body,dueInSec:l,messageId:y,link:"/Mister-X/",roles:["misterx"],resolveRecipientsAtSendTime:!0,rtdbBase:Q}}),c(`üïí Timer gestartet: ${o}s, f√§llt um ${new Date(i).toLocaleTimeString()}.`)}function sa(){Ft||(Ft=!0,G(f(g,"timer"),e=>{const t=e.val()||{},{startTime:n=null,duration:o=null,durationInput:a=null,durationInput2:i=null}=t;if(n===null||o===null){clearInterval(te),fe(!1);const s=document.getElementById("timer"),r=document.getElementById("agentTimer"),u=document.getElementById("settingsTimer");s&&(s.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--",s.style.color="",s.style.animation=""),r&&(r.innerText="‚è≥ Mister X Timer: --:--",r.style.color="",r.style.animation=""),u&&(u.innerText="‚è≥ Aktueller Timer: --:--",u.style.color="",u.style.animation="");return}Cn(n,o),fe(!0)}))}function Cn(e,t){clearInterval(te);let n=!1;te=setInterval(async()=>{if(!n){n=!0;try{let o=function(d){d&&(s<=300?(d.style.color="red",d.style.animation="blinker 1s linear infinite"):(d.style.color="",d.style.animation=""))};const a=Date.now(),i=Math.floor((a-e)/1e3),s=t-i;let r;if(s<0)r="abgelaufen";else{const d=Math.floor(s/60),p=s%60;r=`${String(d).padStart(2,"0")}:${String(p).padStart(2,"0")}`}const u=document.getElementById("timer"),l=document.getElementById("agentTimer"),y=document.getElementById("settingsTimer");if(y&&(y.innerText=`‚è≥ Aktueller Timer: ${r}`,o(y)),u&&(u.innerText=`‚è≥ Zeit bis zum n√§chsten Posten: ${r}`,o(u)),l&&(l.innerText=`‚è≥ Mister X Timer: ${r}`,o(l)),s<=0&&([u,l,y].forEach(d=>{d&&(d.style.color="",d.style.animation="")}),localStorage.getItem("activeView")==="misterx"))try{const p=(await I(f(g,"timer"))).val()||{},{startTime:h,duration:m,durationInput:b,durationInput2:v}=p||{};if(typeof h!="number"||typeof m!="number")return;const S=Be(h,m);if(la(S)||Ye)return;if(m===b&&(v??0)>0){const B="Zeit abgelaufen, dein Standort wird einmalig geteilt.";Ye=!0;const P=await ca(B,{startTime:h,duration:m});if(Ye=!1,P===null){T("Dialog geschlossen: Timer wurde verl√§ngert oder zur√ºckgesetzt",{type:"info"}),c("showLocationDialog: automatisch geschlossen, Timer wurde verl√§ngert, ersetzt oder zur√ºckgesetzt.");return}if(P==="desc"){const C=await fa();if(C){const _=await He(g,async M=>{const H=M==null?void 0:M.durationInput,W=M==null?void 0:M.durationInput2;if(m===H&&(W??0)>0){try{const ee=await Bt(),{latitude:k,longitude:F,accuracy:se}=ee.coords,ve=Date.now();try{if(await Ze()){c("showLocationDialog: timer no longer expired - abort write"),re();return}}catch($n){c("showLocationDialog: secondLookAbort failed - proceeding with write attempt",$n)}const Nn=se<=100?{title:"Automatischer Standort",lat:k,lon:F,accuracy:se,description:C,timestamp:ve}:{description:C,timestamp:ve};await je(M,Nn)||(c("showLocationDialog: write skipped because existing entry detected or claim lost"),re())}catch{const k={description:C,timestamp:Date.now()};await je(M,k)||(c("showLocationDialog: write skipped (exception path)"),re())}Mt(W)}});le(S),_||re()}}else{const C=await ma();le(S),C||re()}}else alert("Zeit abgelaufen, jetzt musst du deinen Live-Standort in der WhatsApp-Gruppe teilen."),await He(g,async()=>{await Promise.all([D(f(g,"timer/duration")),D(f(g,"timer/startTime")),D(f(g,"timerMessage"))]),clearInterval(te),fe(!1),u&&(u.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--"),l&&(l.innerText="‚è≥ Mister X Timer: --:--"),y&&(y.innerText="‚è≥ Aktueller Timer: --:--"),de("Zeit abgelaufen!","Mister X muss sich per Live-Standort zeigen","all")})||re()}catch(d){c("Fehler im Ablauf-Handling:",d)}}finally{n=!1}}},1e3)}async function ra(e,t,{maxWaitMs:n=1e4,desiredAccuracy:o=30,autoConfirmMs:a=3e4}={}){return new Promise(i=>{var ee;const s=document.createElement("div");s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100vw",s.style.height="100vh",s.style.background="rgba(0,0,0,0.6)",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.zIndex="99999";const r=document.createElement("div");r.style.background="#fff",r.style.padding="1.2em",r.style.borderRadius="8px",r.style.width="min(520px, 92vw)",r.style.maxWidth="520px",r.style.textAlign="center",r.style.position="relative";const u=document.createElement("div");u.style.fontWeight="600",u.style.marginBottom="0.4em",u.textContent=e;const l=document.createElement("div");l.style.fontSize="14px",l.style.color="#333",l.style.marginBottom="0.6em";const y=((ee=R==null?void 0:R[A])==null?void 0:ee.name)||"";l.textContent=y?"Team: "+y:"Team: -";const d=document.createElement("div");d.style.position="absolute",d.style.top="8px",d.style.right="10px",d.style.fontSize="11px",d.style.color="#666",d.textContent="¬± ‚Äì m";const p=document.createElement("div");p.style.display="flex",p.style.justifyContent="center";const h=document.createElement("button");h.textContent="Standort teilen",h.className="small-button",h.disabled=!0,p.appendChild(h),r.appendChild(u),r.appendChild(l),r.appendChild(p),r.appendChild(d),h.style.padding="12px 22px",h.style.fontSize="16px",h.style.minWidth="200px",h.style.borderRadius="8px",s.appendChild(r),document.body.appendChild(s);let m=null,b=null;const v=f(g,"agentLocationRequest");let S=null;const x=async()=>{var k;try{if(!m)return;const F=m,se=typeof F.coords.accuracy=="number"?Math.round(F.coords.accuracy):null,ve={reqId:t,teamId:A||null,teamName:((k=R==null?void 0:R[A])==null?void 0:k.name)||null,lat:F.coords.latitude,lon:F.coords.longitude,accuracy:se,timestamp:Date.now()};localStorage.setItem("pendingAgentResponse",JSON.stringify(ve)),await An(ve)}catch(F){c("onPageHide: error trying to send pending response",F)}},B=()=>{document.hidden&&x()};window.addEventListener("pagehide",x),window.addEventListener("visibilitychange",B),window.addEventListener("beforeunload",x);const P=()=>{try{b!=null&&navigator.geolocation.clearWatch(b)}catch{}try{ke(v,"value",W)}catch{}try{s&&document.body.contains(s)&&document.body.removeChild(s)}catch{}try{S&&clearTimeout(S)}catch{}try{window.removeEventListener("pagehide",x)}catch{}try{window.removeEventListener("visibilitychange",B)}catch{}try{window.removeEventListener("beforeunload",x)}catch{}},C=k=>{if(!k)return;if(!m){m=k;return}const F=typeof k.coords.accuracy=="number"?k.coords.accuracy:1/0,se=typeof m.coords.accuracy=="number"?m.coords.accuracy:1/0;F<se&&(m=k)},_=k=>{if(!k)return;const F=typeof k.coords.accuracy=="number"?Math.round(k.coords.accuracy):null;d.textContent=F!=null?`Genauigkeit: ¬±${F} m`:"Genauigkeit: -",h.disabled=!1},M=k=>{C(k),_(k)},H=k=>{k&&k.code===k.PERMISSION_DENIED?(T("Standortzugriff verweigert. Freigabe nicht m√∂glich.",{type:"error"}),P(),i("cancel")):T("Fehler beim Ermitteln des Standorts.",{type:"warn"})};if(!("geolocation"in navigator)){T("Geolocation wird nicht unterst√ºtzt.",{type:"error"}),P(),i("cancel");return}try{b=navigator.geolocation.watchPosition(M,H,{enableHighAccuracy:!0,maximumAge:0,timeout:1e4})}catch{T("Fehler beim Starten der Standortabfrage.",{type:"error"}),P(),i("cancel");return}S=setTimeout(()=>{try{Z()}catch(k){c("autoConfirm error",k)}},a);const W=k=>{const F=k.exists()?k.val():null;try{if(!F||F.id&&F.id!==t){P(),i(null);return}if(F.responses&&A&&F.responses[A]){P(),T("Standort wurde bereits von einem Ger√§t deines Teams geteilt.",{type:"info"}),i(null);return}}catch{}};G(v,W);const Z=()=>{try{S&&(clearTimeout(S),S=null)}catch{}if(P(),m)return i({action:"confirm",position:m});navigator.geolocation.getCurrentPosition(k=>i({action:"confirm",position:k}),k=>{T("Kein Standort verf√ºgbar.",{type:"warn"}),i("cancel")},{enableHighAccuracy:!0,timeout:8e3})};h.onclick=()=>{Z()},(async()=>{try{const k=await I(v),F=k.exists()?k.val():null;if(!F||F.id&&F.id!==t){P(),i(null);return}typeof y<"u"&&l&&(l.textContent="Team: "+y)}catch{}})()})}async function ca(e,t=null){return new Promise(n=>{const o=document.createElement("div");o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100vw",o.style.height="100vh",o.style.background="rgba(0,0,0,0.7)",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.zIndex="9999";const a=document.createElement("div");a.style.background="#fff",a.style.padding="2em",a.style.borderRadius="10px",a.style.maxWidth="90vw",a.style.textAlign="center",a.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>${e}</strong><br>
        Du kannst optional eine Beschreibung hinzuf√ºgen (z.B. falls GPS ungenau ist oder du dich in der U-Bahn befindest).
      </div>
      <button id="loc-ok-btn" style="margin:0 1em 0 0;">OK</button>
      <button id="loc-desc-btn">Standort-Beschreibung hinzuf√ºgen</button>
    `,o.appendChild(a),document.body.appendChild(o);const i=f(g,"timer"),s=u=>{const l=u.exists()?u.val():null;try{if(l===null){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{ke(i,"value",s)}catch{}n(null);return}if(t&&(l.startTime!==t.startTime||l.duration!==t.duration)){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{ke(i,"value",s)}catch{}n(null);return}if(We(l)){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{ke(i,"value",s)}catch{}n(null)}}catch{}};G(i,s);const r=u=>{try{ke(i,"value",s)}catch{}if(document.body.contains(o))try{document.body.removeChild(o)}catch{}n(u)};document.getElementById("loc-ok-btn").onclick=()=>r("ok"),document.getElementById("loc-desc-btn").onclick=()=>r("desc"),(async()=>{try{const u=await I(i),l=u.exists()?u.val():null;if(l===null){r(null);return}if(t&&(l.startTime!==t.startTime||l.duration!==t.duration)){r(null);return}We(l)&&r(null)}catch{}})()})}function Be(e,t){return`${e}_${t}`}function la(e){const t=`alertHandled_${e}`;return sessionStorage.getItem(t)==="1"}function le(e){const t=`alertHandled_${e}`;sessionStorage.setItem(t,"1")}async function vt(e,t,n=6e4){try{const o=e+t*1e3,a=kt(f(g,"locations"),Tt("timestamp"),startAt(Math.max(0,e-5e3)),mn(o+n)),i=await I(a);if(!i.exists())return!1;const s=i.val();return Object.keys(s||{}).length>0}catch(o){return c("existingLocationForTimer failed",o),!1}}async function je(e,t){var u;const{startTime:n,duration:o}=e||{};if(typeof n!="number"||typeof o!="number")return c("safePushLocationForExpiration: invalid timerData",e),!1;const a=Be(n,o);if(await vt(n,o))return c("safePushLocationForExpiration: detected existing location for expKey",a),!1;const s=f(g,`locationClaims/${a}`),r=ye();try{const l=await be(s,v=>v&&v.claimed?v:{claimed:!0,by:r,at:oe()},{applyLocally:!1}),y=l==null?void 0:l.committed,d=(u=l==null?void 0:l.snapshot)==null?void 0:u.val();if(!(y&&d&&d.by===r))return c("safePushLocationForExpiration: lost claim for expKey",a),!1;if(await vt(n,o))return c("safePushLocationForExpiration: someone wrote meanwhile for expKey",a),!1;const m=t.timestamp||Date.now(),b={...t,expKey:a,claimedBy:r,timestamp:m};await Ke(f(g,"locations"),b);try{await $(f(g,"timer"),{lastLocationFor:a})}catch{}return!0}catch(l){return c("safePushLocationForExpiration failed",l),!1}}async function da(e,t=48*60*60*1e3){let n=Date.now();try{const u=await I(f(e,".info/serverTimeOffset")),l=typeof u.val()=="number"?u.val():0;n+=l}catch{}const o=n-t,a=kt(f(e,"timerClaims"),Tt("at"),mn(o)),i=await I(a),s={};i.exists()&&i.forEach(u=>{const l=u.val();typeof(l==null?void 0:l.at)=="number"&&l.at<=o&&(s[`timerClaims/${u.key}`]=null)}),Object.keys(s).length&&await $(f(e),s)}async function He(e,t){var h;const o=(await I(f(e,"timer"))).val()||{},{startTime:a,duration:i}=o;if(typeof a!="number"||typeof i!="number")return!1;const s=Be(a,i),r=f(e,`timerClaims/${s}`),u=ye(),l=await be(r,m=>m&&m.claimed?m:{claimed:!0,by:u,at:oe()},{applyLocally:!1}),y=l.committed,d=(h=l.snapshot)==null?void 0:h.val();if(!(y&&d&&d.by===u))return!1;try{if(await vt(a,i))return c("doOncePerExpiration: existing location detected for",s),!1}catch(m){c("doOncePerExpiration: existing-location check failed, proceeding with action",m)}try{if(await Ze())return c("doOncePerExpiration: timer no longer expired - aborting action for",s),!1}catch(m){c("doOncePerExpiration: secondLookAbort failed - proceeding with action",m)}await t(o);try{await da(e,5*60*1e3)}catch(m){c("GC timerClaims fehlgeschlagen:",m)}return!0}function re(){c("Bereits von anderem Ger√§t erledigt.");try{const e=document.getElementById("status");e&&(e.innerText="‚ÑπÔ∏è Der Standort wurde bereits von einem anderen Ger√§t geteilt.")}catch{}try{T("‚ÑπÔ∏è Jemand anderes hat bereits den Standort geteilt. Dein Eintrag wurde nicht hinzugef√ºgt.",{type:"info"})}catch{}}function ua(){I(f(g,"timer")).then(e=>{if(!e.exists())return;const t=e.val(),n=document.getElementById("timerDurationInput"),o=document.getElementById("timerDurationInput2");!n||!o||(t&&typeof t.durationInput=="number"?n.value=Math.floor(t.durationInput/60):n.value=25,t&&typeof t.durationInput2=="number"?o.value=Math.floor(t.durationInput2/60):o.value=5)})}const Pn=document.createElement("style");Pn.innerHTML=`
@keyframes blinker {
  50% { opacity: 0; }
}
`;document.head.appendChild(Pn);async function Mn(){return(await I(f(g,"timer"))).val()||{}}function We(e){const{startTime:t,duration:n}=e||{};return typeof t=="number"&&typeof n=="number"&&t+n*1e3>Date.now()}async function Ze(){try{const e=await Mn();if(We(e))return c("Timer wurde in der Zwischenzeit verl√§ngert - Abbruch vor dem Schreiben."),!0}catch(e){return c("Zweiter Timer-Check fehlgeschlagen:",e),!0}return!1}function Mt(e){de("Mister X hat sich gezeigt!","Automatische Standort-√úbermittlung",["agent","settings","start"]),Tn(),e!=null?pe(e):c("durationInput2 war nicht vorhanden - Timer wird nicht neu gestartet.")}async function dt(e){const n=(prompt("Bitte den Standort beschreiben (bzw. wenn U-Bahn, dann gem√§√ü Regelwerk angeben):")||"").trim();if(!n)return!1;const a=(await I(f(g,"timer"))).val()||{},i=Be(a.startTime,a.duration),s=await He(g,async r=>{const u=r==null?void 0:r.durationInput2;if(!((a==null?void 0:a.duration)===(r==null?void 0:r.durationInput)&&(u??0)>0)||await Ze())return;await je(a,{description:n,timestamp:Date.now()})||c("askManualAndWrite: write skipped because existing entry detected or claim lost"),Mt(u)});return le(i),s||re(),s}async function ma({autoRetry:e=!0,maxRetries:t=3,retryDelayMs:n=1e4}={}){let o,a;try{if(a=await Mn(),o=a.durationInput2,We(a))return c("Timer wurde verl√§ngert ‚Äì Abbruch."),!1}catch(l){return c("Timer lesen fehlgeschlagen:",l),!1}const i=Be(a.startTime,a.duration);if(!("geolocation"in navigator)){document.getElementById("status").innerText="Geolocation wird nicht unterst√ºtzt.";const l=await dt();return le(i),!!l}let s=Math.max(0,t),r=!1;const u={enableHighAccuracy:!0,maximumAge:0,timeout:15e3};return await new Promise(l=>{const y=async h=>{if(await Ze())return l(!1);const{latitude:m,longitude:b,accuracy:v}=h.coords,S=Date.now();if(v>100){document.getElementById("status").innerText="‚ö†Ô∏è Standort ungenau (¬±"+Math.round(v)+" m). Bitte Standortbeschreibung manuell eingeben.";const B=await dt();return le(i),l(!!B)}const x=await He(g,async B=>{const P=B==null?void 0:B.durationInput,C=B==null?void 0:B.durationInput2;if(!(a.duration===P&&(C??0)>0))return;await je(B,{title:"Automatischer Standort",lat:m,lon:b,accuracy:v,timestamp:S})||c("getLocation: write skipped because existing entry detected or claim lost"),Mt(C)});le(i),l(!!x)},d=()=>{!e||s<=0||(s--,setTimeout(()=>{navigator.geolocation.getCurrentPosition(y,p,u)},n))},p=async h=>{let m="‚ùå Fehler beim Abrufen des Standorts.";switch(h.code){case h.PERMISSION_DENIED:m+=" Zugriff verweigert.";break;case h.POSITION_UNAVAILABLE:m+=" Standortinformationen nicht verf√ºgbar.";break;case h.TIMEOUT:m+=" Zeit√ºberschreitung bei der Standortabfrage.";break}if(m+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=m,!r){r=!0;const b=await dt();return le(i),l(!!b)}h.code===h.TIMEOUT||h.code===h.POSITION_UNAVAILABLE?d():l(!1)};navigator.geolocation.getCurrentPosition(y,p,u)})}async function fa(){return new Promise(e=>{const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0,0,0,0.7)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="9999";const n=document.createElement("div");n.style.background="#fff",n.style.padding="2em",n.style.borderRadius="10px",n.style.maxWidth="90vw",n.style.textAlign="center",n.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>Standort-Beschreibung hinzuf√ºgen</strong><br>
        Bitte gib eine Beschreibung deines Standorts ein.
      </div>
      <textarea id="desc-input" rows="3" style="width:90%;"></textarea><br>
      <button id="desc-cancel-btn" style="margin-top:1em;">Abbrechen</button>
      <button id="desc-ok-btn" style="margin-top:1em; margin-left:1em;">OK</button>
    `,t.appendChild(n),document.body.appendChild(t),document.getElementById("desc-ok-btn").onclick=()=>{const o=document.getElementById("desc-input").value.trim();document.body.removeChild(t),e(o||null)},document.getElementById("desc-cancel-btn").onclick=()=>{document.body.removeChild(t),e(null)}})}function fe(e){const t=document.getElementById("startTimerButton");t&&(t.disabled=e,t.style.opacity=e?"0.5":"1",t.style.pointerEvents=e?"none":"auto",t.style.cursor=e?"default":"pointer")}function ga(){localStorage.getItem("nachrichtAktiv")?(document.getElementById("permissionButton").style.display="none",document.getElementById("permissionButton2").style.display="block"):(document.getElementById("permissionButton").style.display="block",document.getElementById("permissionButton2").style.display="none")}async function pa(){if(confirm("M√∂chtest du wirklich alle gespeicherten Standorte und Eintr√§ge l√∂schen?"))try{await D(f(g,"locations")),await D(f(g,"events/ubahn")),T("Alle Standorte und Eintr√§ge wurden gel√∂scht.",{type:"info"}),Vn=[];const e=document.getElementById("status");e&&(e.innerText=""),xe=null,Ee=null;const t=document.getElementById("locationFeed");t&&(t.innerHTML=""),await Ho(!0),ze()}catch(e){c(e),T("Fehler beim L√∂schen der Standorte und Eintr√§ge.",{type:"error"})}}async function ha(){await D(f(g,"timer/duration")),await D(f(g,"timer/startTime")),await D(f(g,"timerMessage")),clearInterval(te),fe(!1);try{await K.rpc("cancel_and_unschedule")}catch(o){c("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",o)}const e=document.getElementById("timer"),t=document.getElementById("agentTimer"),n=document.getElementById("settingsTimer");e&&(e.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--"),t&&(t.innerText="‚è≥ Mister X Timer: --:--"),n&&(n.innerText="‚è≥ Aktueller Timer: --:--"),de("Timer zur√ºckgesetzt","Der Timer wurde zur√ºckgesetzt!","all")}function ya(){const e=document.getElementById("max_Team_X").value;D(f(g,"settings/max_Team_X")).then(()=>j(f(g,"settings/max_Team_X"),Number(e))).then(()=>{c("max_Team_X erfolgreich gespeichert:",e)}).catch(t=>{c("Fehler beim Speichern von max_Team_X:",t)})}function ba(){const e=document.getElementById("max_Team_X");I(f(g,"settings/max_Team_X")).then(t=>{t.exists()?(e.value=t.val(),c("max_Team_X geladen:",t.val())):c("Kein max_Team_X-Wert gefunden.")}).catch(t=>{c("Fehler beim Laden von max_Team_X:",t)})}function wa(){const t=document.getElementById("timerDurationInput").value*60;D(f(g,"timer/durationInput")).then(()=>j(f(g,"timer/durationInput"),Number(t))).then(()=>{c("Duration_input:",t)}).catch(n=>{c("Fehler beim Speichern von DurationInput:",n)})}function va(){const t=document.getElementById("timerDurationInput2").value*60;D(f(g,"timer/durationInput2")).then(()=>j(f(g,"timer/durationInput2"),Number(t))).then(()=>{c("Duration_input2:",t)}).catch(n=>{c("Fehler beim Speichern von DurationInput2:",n)})}async function Sa(){if(!("serviceWorker"in navigator))throw new Error("Service Worker wird vom Browser nicht unterst√ºtzt.");const e="/Mister-X/",t=await navigator.serviceWorker.getRegistration(e);if(t)return t;const n=`${e}firebase-messaging-sw.js`;return navigator.serviceWorker.register(n,{scope:e,type:"module"})}function ka(){var e,t;return((e=window.matchMedia)==null?void 0:e.call(window,"(display-mode: standalone)").matches)||((t=window.navigator)==null?void 0:t.standalone)===!0}async function Ta(){const e={notificationsAPI:"Notification"in window,serviceWorker:"serviceWorker"in navigator,pushManager:"PushManager"in window,standalone:ka(),fcm:!1};try{e.fcm=await St()}catch{e.fcm=!1}return e}async function tn(e){!e||!E||await j(f(g,`notifications/${e}/recipients/${E}`),!0)}function nn(e){try{const t=e&&e.messageId;if(t){if($e.has(t))return;$e.add(t)}if(t&&typeof tn=="function"&&tn(t).catch(n=>c("Markieren fehlgeschlagen:",n)),document.visibilityState==="visible"){const n=e&&e.title?e.title:"Nachricht",o=e&&e.body?e.body:"";setTimeout(()=>{alert(`${n}
${o}`)},1e3)}}catch(t){c("handleInAppMessage error:",t)}}setInterval(()=>{$e.size>5e3&&$e.clear()},60*1e3);async function Ia(){if(!("serviceWorker"in navigator))return;const e=await navigator.serviceWorker.ready;if(!e.active)return;const t=5e3;return await new Promise(n=>{const o=new MessageChannel,a=setTimeout(()=>{o.port1.onmessage=null,c("[SW-Log] PING -> Timeout (wir versuchen GET_SW_LOGS trotzdem)"),n()},t);o.port1.onmessage=i=>{i.data&&i.data.type==="PONG"&&(clearTimeout(a),c("[SW-Log] PONG empfangen"),n())},e.active.postMessage({type:"PING"},[o.port2])}),new Promise(n=>{const o=new MessageChannel,a=setTimeout(()=>{n()},t);o.port1.onmessage=i=>{i.data&&i.data.type==="SW_LOGS"&&(clearTimeout(a),Array.isArray(i.data.logs)&&i.data.logs.forEach(s=>{s&&s.msg&&c("[SW-Log]",new Date(s.ts).toLocaleTimeString(),s.msg)}),e.active.postMessage({type:"CLEAR_SW_LOGS"}),n())},e.active.postMessage({type:"GET_SW_LOGS"},[o.port2])})}function Ea(){const e=document.getElementById("agentReqEnabledCheckbox");e&&(I(f(g,Dt)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,localStorage.setItem(Rt,n?"1":"0"),on(n)}),e.addEventListener("change",async()=>{const t=e.checked;await j(f(g,Dt),t),localStorage.setItem(Rt,t?"1":"0"),on(t)}))}function on(e){const t=document.getElementById("btnRequestAgents");t&&(t.style.display=e?"":"none")}function xa(){const e=document.getElementById("messageToggle");e&&(I(f(g,Nt)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,localStorage.setItem(_t,n?"1":"0")}),e.addEventListener("change",async()=>{const t=e.checked;await j(f(g,Nt),t),localStorage.setItem(_t,t?"1":"0")}))}function La(){const e=document.getElementById("uBahnEnabledCheckbox");e&&(I(f(g,mt)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,Ae(n)}).catch(()=>{}),e.addEventListener("change",async()=>{const t=e.checked;await j(f(g,mt),t);try{localStorage.setItem(Xn,t?"1":"0")}catch{}Ae(t)}))}function Ae(e){var o,a;const t=document.getElementById("uBahnButton");if(!t)return;const n=((a=(o=document.getElementById("misterxView"))==null?void 0:o.style)==null?void 0:a.display)!=="none";t.style.display=e&&n?"":"none"}let Ue=null,Te=!1;function Aa(){Te=!Te,document.getElementById("membersHiddenList").style.display=Te?"":"none",document.getElementById("membersShowHiddenBtn").textContent=Te?"Ausgeblendete verbergen":"Ausgeblendete anzeigen",qe()}async function an(e,t){try{const n=ie(e);await $(f(g,`roles/${n}`),{hidden:!!t}),T(t?"Spieler ausgeblendet":"Spieler wieder eingeblendet",{timeout:1500,type:"info"}),await we()}catch(n){console.error("setMemberHidden err",n),T("Fehler beim Aktualisieren")}}async function Ba(){if(confirm("Alle ausgeblendeten Spieler wirklich wieder einblenden?"))try{const t={};for(const n of Object.values(Ue||{}))n.hidden&&(t[`roles/${ie(n.name)}/hidden`]=null);Object.keys(t).length>0&&(await $(f(g),t),T("Alle ausgeblendeten Spieler wieder sichtbar",{timeout:1500,type:"info"})),await we()}catch(t){console.error(t),T("Fehler beim R√ºckg√§ngig machen")}}function Ca(){const e=document.getElementById("membersModal");if(!e)return;e.style.display="flex",e.focus&&e.focus();const t=document.getElementById("membersSearch");t&&(t.value="");const n=document.getElementById("membersSort");n&&(n.value=localStorage.getItem("membersSort")||"name",n.onchange=()=>{localStorage.setItem("membersSort",n.value),qe()}),Te=!1,document.getElementById("membersHiddenList").style.display="none",document.getElementById("membersShowHiddenBtn").textContent="Ausgeblendete anzeigen";const o=document.getElementById("membersSearch");o&&o.addEventListener("input",()=>qe()),document.addEventListener("keydown",Rn),we()}function Fn(){const e=document.getElementById("membersModal");e&&(e.style.display="none"),document.removeEventListener("keydown",Rn)}function Rn(e){e.key==="Escape"&&Fn()}async function we(){Ue={};try{const[e,t]=await Promise.all([I(f(g,"roles")),I(f(g,"tokens"))]),n=e.exists()?e.val():{},o=t.exists()?t.val():{};for(const a of Object.keys(n||{})){const i=n[a]||{},s=i.lastUpdated||i.timestamp||i.joinedAt||0;let r=!1;try{const u=o[a]||{},l=Ve(u);r=Array.isArray(l)&&l.length>0}catch{r=!1}Ue[a]={id:a,name:a,role:i.role||"-",allowSmsFallback:!!i.allowSmsFallback,instantSMS:i.instantSMS===!0,notification:i.notification!==!1,telPresent:!!i.tel,lastActivity:s,hidden:!!i.hidden,tokensPresent:r,raw:i}}}catch(e){console.error("Fehler beim Laden der Rollen:",e),T("Fehler beim Laden der Mitglieder.")}qe()}function qe(){var l,y;const e=document.getElementById("membersList"),t=document.getElementById("membersHiddenInner");if(!e)return;const n=(((l=document.getElementById("membersSearch"))==null?void 0:l.value)||"").trim().toLowerCase(),o=((y=document.getElementById("membersSort"))==null?void 0:y.value)||"name";let i=Object.values(Ue||{}).filter(d=>d.name.toLowerCase().includes(n)||(d.role||"").toLowerCase().includes(n));const s={name:(d,p)=>d.name.localeCompare(p.name),role:(d,p)=>(d.role||"").localeCompare(p.role||""),lastActivity:(d,p)=>(p.lastActivity||0)-(d.lastActivity||0),hasTel:(d,p)=>(p.telPresent?1:0)-(d.telPresent?1:0),allowSmsFallback:(d,p)=>(p.allowSmsFallback?1:0)-(d.allowSmsFallback?1:0)};i=s[o]?i.sort(s[o]):i.sort(s.name);const r=i.filter(d=>!d.hidden),u=i.filter(d=>!!d.hidden);e.innerHTML="";for(const d of r){const p=document.createElement("div");p.className="member-row";const h=document.createElement("div");h.className="member-left";const m=document.createElement("div");m.className="member-name",m.innerHTML=z(d.name);const b=document.createElement("div");b.className="member-meta";const v=d.lastActivity?jt(Oe(d.lastActivity)):"‚Äî";b.innerHTML=`${z(d.role)} ¬∑ ${v} ¬∑ ${d.telPresent?"Tel ‚úì":"‚Äî"}`,h.appendChild(m),h.appendChild(b);const S=document.createElement("div");S.className="member-actions";const x=document.createElement("label");x.className="member-meta small-muted",x.style.display="inline-flex",x.style.alignItems="center",x.style.gap="6px";const B=document.createElement("input");B.type="checkbox",B.checked=!!d.allowSmsFallback,B.className="member-toggle",B.addEventListener("change",()=>ut(d.name,{allowSmsFallback:B.checked})),x.appendChild(B),x.appendChild(document.createTextNode("SMS-Fallback")),S.appendChild(x);const P=document.createElement("label");P.className="member-meta small-muted",P.style.display="inline-flex",P.style.alignItems="center",P.style.gap="6px";const C=document.createElement("input");C.type="checkbox",C.checked=!!d.instantSMS,C.className="member-toggle",d.telPresent||(P.classList.add("disabled"),C.title="Keine Telefonnummer hinterlegt ‚Äì Instant-SMS funktioniert nicht."),C.addEventListener("change",()=>ut(d.name,{instantSMS:C.checked})),P.appendChild(C),P.appendChild(document.createTextNode("Instant-SMS")),S.appendChild(P);const _=document.createElement("label");_.className="member-meta small-muted",_.style.display="inline-flex",_.style.alignItems="center",_.style.gap="6px";const M=document.createElement("input");M.type="checkbox",M.checked=!!d.notification,M.className="member-toggle",d.tokensPresent||(_.classList.add("disabled"),M.title="Kein Push-Token vorhanden ‚Äì Push-Benachrichtigungen nicht m√∂glich."),M.addEventListener("change",()=>ut(d.name,{notification:M.checked})),_.appendChild(M),_.appendChild(document.createTextNode("Benachr.")),S.appendChild(_);const H=document.createElement("button");H.className="small-button ghost",H.textContent="Ausblenden",H.setAttribute("title","Spieler in der App ausblenden (gespeichert)"),H.addEventListener("click",()=>an(d.name,!0)),S.appendChild(H);const W=document.createElement("button");W.className="small-button ghost",W.textContent="Nummer l√∂schen",W.addEventListener("click",()=>Pa(d.name)),S.appendChild(W);const Z=document.createElement("button");Z.className="small-button danger-ghost",Z.textContent="Spieler l√∂schen",Z.addEventListener("click",()=>sn(d.name)),S.appendChild(Z),p.appendChild(h),p.appendChild(S),e.appendChild(p)}t.innerHTML="";for(const d of u){const p=document.createElement("div");p.className="member-row hidden";const h=d.lastActivity?jt(Oe(d.lastActivity)):"‚Äî";p.innerHTML=`<div class="member-left"><div class="member-name">${z(d.name)}</div><div class="member-meta">${z(d.role)} ¬∑ ${h}</div></div>`;const m=document.createElement("div");m.className="member-actions";const b=document.createElement("button");b.className="small-button ghost",b.textContent="Wieder einblenden",b.addEventListener("click",()=>an(d.name,!1)),m.appendChild(b);const v=document.createElement("button");v.className="small-button danger-ghost",v.textContent="Spieler l√∂schen",v.addEventListener("click",()=>sn(d.name)),m.appendChild(v),p.appendChild(m),t.appendChild(p)}}async function ut(e,t){try{const n=ie(e);await $(f(g,`roles/${n}`),t),T("√Ñnderung gespeichert",{timeout:1500,type:"info"}),we()}catch(n){console.error(n),T("Fehler beim Speichern")}}async function sn(e){if(confirm(`Spieler ${e} wirklich l√∂schen? Diese Aktion entfernt alle Rollen-/Tel-Daten.`))try{await D(f(g,`roles/${ie(e)}`)),T("Spieler gel√∂scht",{timeout:2e3,type:"info"}),we()}catch(n){console.error(n),T("Fehler beim L√∂schen")}}async function Pa(e){if(confirm(`Nummer von ${e} wirklich l√∂schen?`))try{await $(f(g,`roles/${ie(e)}`),{tel:null,allowSmsFallback:!1}),T("Nummer entfernt",{timeout:1500,type:"info"}),we()}catch(n){console.error(n),T("Fehler beim Entfernen")}}window.openMembersManagement=Ca;window.closeMembersManagement=Fn;window.toggleShowHidden=Aa;window.unhideAllMembers=Ba;async function Ma(){if(!confirm("Best√§tige, dass du in eine U-Bahn eingestiegen bist."))return;const t="Mister X ist in eine U-Bahn eingestiegen",n={message:t,timestamp:Date.now(),device:E||null};try{await Ke(f(g,"events/ubahn"),n)}catch(o){c("Fehler beim Schreiben des U-Bahn-Events:",o)}try{await de("Mister X ist in eine U-Bahn eingestiegen",t,["agent","settings","start"])}catch(o){c("Fehler beim Versenden der U-Bahn-Benachrichtigung:",o)}T(t,{type:"info"})}function _n(){if(yt)return;const e=f(g,"events/ubahn");G(e,t=>{xe=t,kn()}),yt=!0}async function Fa(){var e,t,n,o,a,i;io();try{const s=await Ta();if(s&&s.fcm){X||(X=Ge(ae)),window.__swMsgListenerAdded||(navigator.serviceWorker.addEventListener("message",m=>{var b;if(m&&m.data&&m.data.type==="PUSH"){const v=m.data.payload||{};(b=navigator.serviceWorker.controller)==null||b.postMessage({type:"PUSH",payload:v,userAgent:navigator.userAgent}),nn(v),c("[Page] SW-Message empfangen",v)}}),window.__swMsgListenerAdded=!0);let h=null;Wn(X,m=>{var v;const b=m&&m.data?m.data:{};b.messageId&&b.messageId===h||(h=b.messageId||null,(v=navigator.serviceWorker.controller)==null||v.postMessage({type:"PUSH",payload:m,userAgent:navigator.userAgent}),nn(b),c("[Page] FCM onMessage empfangen",m))})}navigator.serviceWorker.addEventListener("message",h=>{var m;((m=h==null?void 0:h.data)==null?void 0:m.type)==="PUSH_SUBSCRIPTION_CHANGED"&&at({force:!0}).catch(c)}),(async()=>await no("pushSubscriptionChangedAt")&&(await at({force:!0}).catch(c),await oo("pushSubscriptionChangedAt")))();const r=document.getElementById("enablePush"),u=document.getElementById("pushHint");r&&(!s.fcm&&/iPhone|iPad|iPod/i.test(navigator.userAgent)&&!s.standalone?(r.style.display="none",u&&(u.textContent="Installiere die App zum Home-Bildschirm, um Benachrichtigungen zu aktivieren.",u.style.display="block")):!s.fcm||!s.notificationsAPI||!s.serviceWorker||!s.pushManager?(r.style.display="none",u&&(u.textContent="Benachrichtigungen werden von diesem Browser/Modus nicht unterst√ºtzt.",u.style.display="block")):Notification.permission==="granted"?(r.textContent="Benachrichtigungen sind aktiv",r.disabled=!0):(r.addEventListener("click",enablePush,{once:!0}),r.style.display="inline-flex")),fe(!0),document.getElementById("btnRequestAgents").style.display="none";const l=localStorage.getItem("activeView")||"start";l!=="start"&&Pt(l),Tn(),await $o(),sa(),ua(),ga(),at(),Xo(),Bo(),_o(),xt(),Yo(),await qo(),Go(),zo(),Oo(),Ia().catch(()=>{}),Ea(),xa(),La(),_n();const y=document.getElementById("toggleAgentLocations");y&&(y.checked=_e,y.addEventListener("change",()=>{_e=!!y.checked;try{localStorage.setItem(hn,_e?"1":"0")}catch{}Bn()})),(e=document.getElementById("toggleTracking"))==null||e.addEventListener("change",h=>{h.target.checked?Lo():In()}),(t=document.getElementById("toggleFollow"))==null||t.addEventListener("change",h=>{fn=h.target.checked});const d=document.getElementById("clearLocalStorageBtn");d&&d.addEventListener("click",()=>{confirm("M√∂chtest du wirklich alle gespeicherten Daten (localStorage) l√∂schen?")&&(localStorage.clear(),sessionStorage.clear(),alert("Alle lokalen Daten wurden gel√∂scht. Die Seite wird neu geladen."),location.reload())});const p=document.getElementById("photoInput");p&&p.addEventListener("change",function(){var m;if((m=this.files)==null?void 0:m[0]){window.fotoHochgeladen=!0;const b=document.getElementById("status");b&&(b.innerText="üì∏ Foto ausgew√§hlt!")}})}catch(s){alert("Fehler in startScript: "+((s==null?void 0:s.message)??String(s))),(o=(n=document.getElementById("startView"))==null?void 0:n.style)==null||o.setProperty("display","block"),(i=(a=document.getElementById("startView2"))==null?void 0:a.style)==null||i.setProperty("display","block")}}function c(...e){console.log(...e);const t=document.getElementById("settingsLog");if(!t)return;const n=new Date().toLocaleTimeString(),o=document.createElement("div");o.innerHTML=`<strong>[${n}]</strong>`,e.forEach(a=>{if(typeof a=="object"){const i=document.createElement("details"),s=document.createElement("summary");s.textContent="Objekt anzeigen",i.appendChild(s);const r=document.createElement("pre");r.textContent=JSON.stringify(a,null,2),i.appendChild(r),o.appendChild(i)}else o.innerHTML+=` ${a}`}),t.appendChild(o),t.scrollTop=t.scrollHeight}window.switchView=Pt;window.requestPermission=eo;window.sendLocationWithPhoto=mo;window.startTimer=pe;window.goBack=Ne;window.save_timer_duration=wa;window.save_timer_duration2=va;window.save_max_mister_x=ya;window.resetTimer=ha;window.deleteAllLocations=pa;window.resetAllMisterXRollen=aa;window.removeNotificationSetup=so;window.mxState=window.mxState||{};window.mxState.selectedPost=null;window.openCloseTeamSettings=ko;window.closeTeamSettings=Sn;window.leaveTeam=Lt;window.createTeam=To;window.joinTeam=Io;window.triggerAgentLocationRequest=Zo;window.resetAgentLocations=Jo;window.announceUBahn=Ma;function Dn(e){window.mxState.selectedPost=e}function Ra(){return window.mxState.selectedPost}document.addEventListener("DOMContentLoaded",Fa);
