import{F as Ee}from"./vendor_leaflet-CAQ_TIzs.js";import{i as an,g as Mt,a as rn,b as Te,c as cn,u as N,r as f,d as T,e as ze,f as Ct,s as P,h as ke,p as J,j as A,k as ln,l as ie,o as un,m as G,q as _t,n as dn,t as Dt,v as mn,R as fn}from"./vendor_firebase-DLvP6gZ0.js";import{a as gn}from"./vendor-Cj_BHRrm.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const pn={apiKey:"AIzaSyC-jTMiDjHNTC6cvSKUU44mVbWwT-ToLxQ",authDomain:"mister-x-d6b59.firebaseapp.com",databaseURL:"https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app",projectId:"mister-x-d6b59",storageBucket:"mister-x-d6b59.firebasestorage.app",messagingSenderId:"616391598963",appId:"1:616391598963:web:da07882b0f481d3000db06",measurementId:"G-W66SK677NG"},V=an(pn),p=Mt(V);rn(V);Te(V);var At,Bt,Pt;typeof L<"u"&&Ee&&((At=L.Control)!=null&&At.FullScreen||(L.Control.FullScreen=Ee),(Bt=L.control)!=null&&Bt.fullscreen||(L.control.fullscreen=function(e){return new Ee(e)}),console.debug("leaflet.fullscreen registered:",!!((Pt=L.control)!=null&&Pt.fullscreen)));let U,nt=!1,g,hn=[],$;const F={};let Y=null;const ve=new Set;let S=localStorage.getItem("deviceId")||null;const W="https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app";let le=null,_=null,R=null,Ft=!1;const xe="showNotifHeader",Rt="currentTeamId";let k=null,O={},fe={deviceTeam:null,teams:null},$t=null,ce=[];const Ot="showAgentLocations",ot="lastRespondedAgentReqId";let ye=(localStorage.getItem(Ot)??"1")==="1",E,z,ge;const it="agentReqEnabled";let st="messageToggleEnabled";const at="settings/agentReqEnabled",rt="settings/messages";L.icon({iconUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});const yn=[[48.21778257924239,16.37016154994435],[48.217247563322225,16.37076456217454],[48.21741142779978,16.371253762059183],[48.216865105563464,16.37191529883514],[48.21581506144457,16.37290646405736],[48.21417125610604,16.373948000332064],[48.21430769576697,16.3745721914746],[48.21333498613118,16.37539386682008],[48.2122964590416,16.377294652276152],[48.211699711347876,16.38092342451245],[48.211941642178076,16.38467493512273],[48.20913524997675,16.384032997995277],[48.20434428995476,16.380677464805487],[48.20267440663029,16.378771628716105],[48.202516949057625,16.378787036085683],[48.2021791301039,16.378713275337773],[48.20032081399359,16.37673193693543],[48.20046567888107,16.376081501249317],[48.19987161819025,16.37355423682974],[48.19981183801774,16.372899054744835],[48.200631534154375,16.369653382537916],[48.20071916193201,16.369103424638855],[48.200163223194544,16.368756078571426],[48.19948213275357,16.368406050294983],[48.19950721778074,16.3679406870309],[48.1998469538764,16.366987161726104],[48.19976119600531,16.366945587486374],[48.199786280895815,16.366662614435302],[48.199852484835134,16.36658080706035],[48.199605825841886,16.366136901468384],[48.199689907919776,16.365894161552536],[48.199997462783195,16.365407340616333],[48.20007450484762,16.36539258846675],[48.200780727683785,16.364471249670135],[48.20235733493688,16.36143133067089],[48.202316181915776,16.361391179971125],[48.20252539808658,16.36095263879719],[48.20263271531552,16.36073672097149],[48.20274853131339,16.36083590228765],[48.20475579365605,16.35819251441422],[48.20494354858451,16.357837121719747],[48.205074099582546,16.357685576910406],[48.20502589015989,16.357555489773183],[48.20506169808996,16.357492457861333],[48.205261965068914,16.357456248039632],[48.20626549207577,16.356030140071557],[48.20666774752276,16.35550308600013],[48.20697347295606,16.355354223399804],[48.20918910891197,16.354601648098285],[48.20921597664341,16.35491948986655],[48.20929110567211,16.354928877598102],[48.20938410911258,16.354983862882907],[48.212403444290665,16.35518085630021],[48.212634067324394,16.355560388875816],[48.214753862701514,16.35585677297196],[48.21482540908184,16.356370415998313],[48.21454632473899,16.35850592710254],[48.21435355993972,16.36025556372129],[48.21477999581608,16.361298310706765],[48.21461086605676,16.3615351876565],[48.214799725889385,16.361933238614775],[48.21476774885914,16.362013013827934],[48.214317217645544,16.362474541146735],[48.21554996828477,16.365200001058092],[48.21618181295601,16.36659154989541],[48.21691897070536,16.368248676490595],[48.21768157297474,16.36988155904141],[48.21778257924239,16.37016154994435]],bn=[[-90,-180],[-90,180],[90,180],[90,-180]],Le=L.polygon([bn,yn],{color:"red",weight:3,fillColor:"rgba(255, 0, 0, 0.3)",fillOpacity:.35,interactive:!1,pane:"maskPane",dashArray:"5, 5"}),wn={blau:"#1E90FF",gruen:"#2ECC71",rot:"#FF5252",gelb:"#F4D03F",orange:"#FF8C00",lila:"#8E44AD",schwarz:"#333333",grau:"#7F8C8D"};cn(V,{provider:new fn("6LcVXbQrAAAAAI5Wgi8DenjAM4cz-ubrfcwIRPVJ"),isTokenAutoRefreshEnabled:!0});window.onerror=function(e,t,n,o,i){alert("JS-Fehler: "+e+" in "+t+" Zeile "+n)};const D=gn("https://axirbthvnznvhfagduyj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4aXJidGh2bnpudmhmYWdkdXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMDI2MTcsImV4cCI6MjA2ODg3ODYxN30.wfJm9e10_iNuYm_r3es_FmKuXBePsxSjIJcVqmSuYjc");async function vn(e){const t=localStorage.getItem("role")||"start";try{const{error:n}=await D.from("fcm_tokens").delete().eq("device_name",S);n?c("‚ùå Fehler beim L√∂schen aus Supabase:",n):c("‚úÖ Alter Token aus Supabase gel√∂scht.");const{error:o}=await D.from("fcm_tokens").upsert({token:e,device_name:S,role:t});o?c("‚ùå Fehler beim Speichern des Tokens:",o):c("‚úÖ Token erfolgreich gespeichert.")}catch(n){c("‚ùå Supabase Exception:",n)}}function de(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()==="";)e=prompt("Bitte gib deinen Namen ein"),e===null&&alert("Du musst einen Namen eingeben, um fortzufahren.");return localStorage.setItem("deviceId",e.trim()),e.trim()}try{localStorage.setItem("test","1")}catch{alert("‚ö†Ô∏è Dein Browser blockiert lokalen Speicher. Bitte verlasse den privaten Modus oder √§ndere die Einstellungen.")}async function Sn(){try{if(!await ze()){alert("‚ùå Push-Benachrichtigungen werden in diesem Browser/Modus nicht unterst√ºtzt.");return}if(!("Notification"in window)){alert("‚ùå Notification API nicht verf√ºgbar.");return}const t=await Notification.requestPermission();if(t!=="granted"){c("Benachrichtigungen nicht erlaubt:",t),alert("‚ö†Ô∏è Benachrichtigungen wurden abgelehnt.");return}const n=await zo();c("Service Worker registriert mit Scope:",n.scope),localStorage.setItem("serviceWorkerRegistered","true"),$||($=Te(V));const o=await Ct($,{serviceWorkerRegistration:n,vapidKey:"BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE"});if(!o){c("Kein Token erhalten."),alert("‚ö†Ô∏è Kein Token erhalten. Bitte erneut versuchen.");return}localStorage.setItem("fcmToken",o),c("Token:",o),await P(f(p,`tokens/${S}`),o),await N(f(p,`roles/${S}`),{role:"start"}),await vn(o),localStorage.setItem("nachrichtAktiv","true");const i=document.getElementById("permissionButton");i&&(i.style.display="none"),Tn(S).then(()=>{alert("‚úÖ Benachrichtigungen aktiviert!")})}catch(e){c("Fehler bei Berechtigung/Registrierung/Token:",e),alert("‚ùå Fehler: "+((e==null?void 0:e.message)??String(e)))}}async function Tn(e){const t=await En("app-db","settings");return new Promise((n,o)=>{const i=t.transaction("settings","readwrite");i.objectStore("settings").put(e,"deviceName"),i.oncomplete=()=>{t.close(),n(!0)},i.onerror=()=>{t.close(),o(i.error)}})}async function kn(e){const t=await new Promise((n,o)=>{const i=indexedDB.open("app-db");i.onupgradeneeded=()=>{const s=i.result;s.objectStoreNames.contains("sw-flags")||s.createObjectStore("sw-flags")},i.onsuccess=()=>n(i.result),i.onerror=()=>o(i.error)});try{return await new Promise(n=>{const s=t.transaction("sw-flags","readonly").objectStore("sw-flags").get(e);s.onsuccess=()=>{t.close(),n(s.result||null)},s.onerror=()=>{t.close(),n(null)}})}catch{return null}}async function In(e){const t=await new Promise((n,o)=>{const i=indexedDB.open("app-db");i.onupgradeneeded=()=>{const s=i.result;s.objectStoreNames.contains("sw-flags")||s.createObjectStore("sw-flags")},i.onsuccess=()=>n(i.result),i.onerror=()=>o(i.error)});await new Promise(n=>{const o=t.transaction("sw-flags","readwrite");o.objectStore("sw-flags").delete(e),o.oncomplete=()=>{t.close(),n()},o.onerror=()=>{t.close(),n()}})}async function Ae(e={}){const{force:t=!1,vapidKey:n="BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE",touchWhenUnchanged:o=!0}=e;if(typeof Notification>"u"||Notification.permission!=="granted"||localStorage.getItem("serviceWorkerRegistered")!=="true")return c("üîï Token-Refresh √ºbersprungen: Keine Berechtigung oder kein SW."),null;try{const i=await navigator.serviceWorker.ready;let s=null;try{s=await Ct($,{serviceWorkerRegistration:i,vapidKey:n})}catch(r){return c("‚ùå Fehler bei getToken:",r),null}if(!s)return c("‚ö†Ô∏è Kein Token beim Refresh erhalten."),null;const a=localStorage.getItem("fcmToken");if(t||s!==a){c("üîÑ Token aktualisiert:",s),await P(f(p,"tokens/"+S),s);try{const{error:r}=await D.from("fcm_tokens").upsert({token:s,device_name:S},{onConflict:"device_name"});r?c("‚ùå Fehler beim Upsert in Supabase:",r):c("‚úÖ Token in Supabase upserted.")}catch(r){c("‚ùå Supabase Upsert Exception:",r)}return localStorage.setItem("fcmToken",s),localStorage.setItem("nachrichtAktiv","true"),s}else return c("‚ÑπÔ∏è Token ist unver√§ndert."),s}catch(i){return c("‚ùå Fehler beim Token-Refresh:",i),null}}async function En(e,t){return new Promise((n,o)=>{const i=indexedDB.open(e);i.onupgradeneeded=()=>{const s=i.result;s.objectStoreNames.contains(t)||s.createObjectStore(t)},i.onsuccess=()=>{const s=i.result;if(s.objectStoreNames.contains(t))return n(s);const a=s.version+1;s.close();const r=indexedDB.open(e,a);r.onupgradeneeded=()=>{const l=r.result;l.objectStoreNames.contains(t)||l.createObjectStore(t)},r.onsuccess=()=>n(r.result),r.onerror=()=>o(r.error)},i.onerror=()=>o(i.error)})}async function xn(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()===""||!ct(e.trim());)e=prompt("Bitte gib deinen Namen ein (mind. 2 Zeichen, keine Sonderzeichen wie . # $ [ ] /)"),e===null&&alert("Du musst einen g√ºltigen Namen eingeben, um fortzufahren."),e&&!ct(e.trim())&&(alert("Ung√ºltiger Name. Bitte verwende mindestens 2 Zeichen und keine . # $ [ ] /"),e="");e=e.trim(),localStorage.setItem("deviceId",e),S=e;let t=Nt(),n=t.tel||null,o=!!t.noTel,i;try{i=await Fn(e)}catch(r){c("[askForDeviceIdAndPhone] Konnte Remote-Status nicht laden:",r),i={exists:!1,allowSmsFallback:null,tel:null}}let s=!1;if(i.allowSmsFallback===null?(s=!0,o=!1):i.allowSmsFallback===!1?s=!1:i.allowSmsFallback===!0&&!i.tel&&(s=!0),i.allowSmsFallback===!0&&i.tel){lt({tel:i.tel,allowSmsFallback:!0,noTel:!1}),await ut(e,i.tel,!0);return}if(s&&!o||s&&i.allowSmsFallback===null)for(;!n||!_n(n);){let r=prompt(`Bitte gib deine Telefonnummer f√ºr SMS-Fallback ein (+43‚Ä¶ oder 0664‚Ä¶)
Du kannst auch leer lassen, wenn du keine SMS m√∂chtest.`);if(r===null||r.trim()===""){n=null,o=!0;break}n=Rn(r.trim()),n||alert("Ung√ºltige Nummer. Bitte im Format +43‚Ä¶ oder 0664‚Ä¶ eingeben.")}const a=!!n;lt({tel:n,allowSmsFallback:a,noTel:o}),await ut(e,n,a)}function ct(e){return typeof e=="string"&&e.length>=2&&!/[.#$/\[\]/]/.test(e)}async function Ln(){try{const e=await ze().catch(()=>!1);$||($=Te(V));const t=localStorage.getItem("fcmToken");if(e)try{await ln($),c("‚úÖ deleteToken: lokaler FCM-Token invalidiert")}catch(n){c("‚ö†Ô∏è deleteToken fehlgeschlagen:",n)}try{await A(f(p,`tokens/${S}`)),c("‚úÖ RTDB-Token entfernt f√ºr",S)}catch(n){c("‚ö†Ô∏è RTDB-Remove fehlgeschlagen:",n)}try{const{error:n}=await D.from("fcm_tokens").delete().or(`device_name.eq.${S}${t?`,token.eq.${t}`:""}`);n?c("‚ö†Ô∏è Supabase-Delete Fehler:",n):c("‚úÖ Supabase-Eintr√§ge entfernt")}catch(n){c("‚ö†Ô∏è Supabase-Delete (catch):",n)}if("serviceWorker"in navigator){const n=await navigator.serviceWorker.getRegistrations();for(const o of n)try{const i=await o.pushManager.getSubscription();i&&(await i.unsubscribe(),c("‚úÖ Push-Subscription gek√ºndigt f√ºr",o.scope))}catch(i){c("‚ö†Ô∏è unsubscribe warn:",i)}await Promise.all(n.map(o=>o.unregister())),c("‚úÖ Alle Service Worker unregistriert")}try{if(window.caches){const n=await caches.keys();await Promise.all(n.map(o=>caches.delete(o))),c("‚úÖ Alle Caches gel√∂scht:",n)}}catch(n){c("‚ö†Ô∏è Cache cleanup warn:",n)}try{indexedDB.deleteDatabase("app-db"),c('‚úÖ IndexedDB "app-db" gel√∂scht')}catch(n){c("‚ö†Ô∏è IndexedDB delete warn:",n)}localStorage.removeItem("fcmToken"),localStorage.removeItem("nachrichtAktiv"),localStorage.removeItem("serviceWorkerRegistered");try{const n=document.getElementById("permissionButton"),o=document.getElementById("permissionButton2");n&&(n.style.display=""),o&&(o.style.display="none")}catch{}setTimeout(()=>{alert("üîï Benachrichtigungen deaktiviert. Die Seite wird neu geladen‚Ä¶"),location.reload()},150)}catch(e){c(e),alert("‚ùå Deaktivieren fehlgeschlagen: "+((e==null?void 0:e.message)??String(e)))}}function An(e,t=[],n,o=15,{rtdbBase:i=W,rolesPath:s="roles",recipientsPath:a="notifications",idempotencyFlag:r="smsTriggered",secret:l=typeof SMS_FALLBACK_SECRET<"u"?SMS_FALLBACK_SECRET:"",rtdbAuth:u}={}){if(!e)throw new Error("[Fallback] messageId fehlt");if(!Array.isArray(t)||t.length===0)return c("[Fallback] keine Empf√§nger - Fallback nicht geplant"),Promise.resolve({ok:!0,skipped:"no_recipients"});if(!i)throw new Error("[Fallback] rtdbBase fehlt");const h={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),waitSec:o,rtdbBase:i,rolesPath:s,recipientsPath:a,idempotencyFlag:r,...u?{rtdbAuth:u}:{}},d={};return l&&(d["x-sms-secret"]=l),D.functions.invoke("sms-fallback",{body:h,headers:d}).then(({data:m,error:y})=>y?(c("[Fallback] Edge call failed",y),{ok:!1,error:y.message||"invoke failed"}):(c("[Fallback] scheduled:",m),m)).catch(m=>(c("[Fallback] Konnte SMS-Fallback nicht planen:",m),{ok:!1,error:(m==null?void 0:m.message)||String(m)}))}function We(e,t=[],n,{rtdbBase:o=W,rolesPath:i="roles",recipientsPath:s="notifications",rtdbAuth:a,requireConsent:r=!0,maxRecipientsPerCall:l,writeDeliveredTimestamp:u=!0}={}){if(!e)return Promise.resolve({ok:!1,error:"Missing messageId"});if(!Array.isArray(t)||t.length===0)return c==null||c("[sms-direct] keine Empf√§nger - nichts zu senden"),Promise.resolve({ok:!0,skipped:"no_recipients"});const h={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),...o?{rtdbBase:o}:{},rolesPath:i,recipientsPath:s,...a?{rtdbAuth:a}:{},requireConsent:r,...Number.isFinite(l)?{maxRecipientsPerCall:l}:{},writeDeliveredTimestamp:u};return D.functions.invoke("sms-direct",{body:h}).then(({data:d,error:m})=>m?(c==null||c("[sms-direct] Edge call failed",m),{ok:!1,error:m.message||"invoke failed"}):(c==null||c("[sms-direct] sent:",d),d)).catch(d=>(c==null||c("[sms-direct] Fehler beim Senden:",d),{ok:!1,error:(d==null?void 0:d.message)||String(d)}))}function ne(){try{const e=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:void 0,t=e&&e.crypto;if(t&&typeof t.randomUUID=="function")return t.randomUUID();if(t&&typeof t.getRandomValues=="function"){const n=new Uint8Array(16);t.getRandomValues(n),n[6]=n[6]&15|64,n[8]=n[8]&63|128;const o=s=>s.toString(16).padStart(2,"0"),i=Array.from(n,o).join("");return`${i.slice(0,8)}-${i.slice(8,12)}-${i.slice(12,16)}-${i.slice(16,20)}-${i.slice(20)}`}}catch{}return`${Date.now()}-${Math.random().toString(36).slice(2,10)}`}async function qe(e,t,n=[],o={}){const{recipientDeviceNames:i=[],link:s="/Mister-X/",attempt:a=1,maxAttempts:r=5,waitSec:l=15,sendEndpoint:u="https://axirbthvnznvhfagduyj.supabase.co/functions/v1/send-to-all",rtdbBase:h=W,messageId:d,instantSMSDevices:m=[]}=o,y=d??ne(),b=(typeof de=="function"?de():null)||"unknown",w=a===1,I=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,body:t,tokens:n,senderName:b,link:s,messageId:y,rtdbBase:h,recipientDeviceNames:w?i:[],setRecipientsMode:w?"set_once":"none",attempt:a})});let B={};try{B=await I.json()}catch{}c(`üì¶ Versuch ${a}: status=${I.status}`,B);const j=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);w&&i.length>0&&An(y,i,j,15,{rtdbBase:W}),w&&m.length>0&&We(y,m,j,{rtdbBase:W});const K=Array.isArray(B==null?void 0:B.failedTokens)?B.failedTokens:[];return K.length>0&&a<r?(c(`üîÅ Wiederhole f√ºr ${K.length} fehlgeschlagene Tokens in 10s...`),setTimeout(()=>{qe(e,t,K,{recipientDeviceNames:i,link:s,attempt:a+1,maxAttempts:r,waitSec:l,sendEndpoint:u,rtdbBase:h,messageId:y}).catch(c)},1e4)):a>=r?c("‚è±Ô∏è Max. Anzahl an Versuchen erreicht."):c("‚úÖ Alle Benachrichtigungen verarbeitet."),B}async function oe(e,t,n,o={}){const i=o.rtdbBase??W,s=o.messageId??ne(),a=(typeof de=="function"?de():null)||"unknown";try{const M=await T(f(p,"settings/messages"));if(!(M.exists()?!!M.val():!0)){const X={title:String(e??""),body:String(t??""),link:o.link||"/Mister-X/",sender:a,timestamp:Date.now(),messageId:s,recipients:{}};return await P(f(p,`notifications/${s}`),X),c('[sendNotificationToRoles] Global setting "settings/messages" = false, wrote notification without recipients',X),{ok:!0,skipped:"messages_disabled",messageId:s}}}catch(M){c("[sendNotificationToRoles] Could not read settings/messages, proceeding as enabled:",M)}const[r,l]=await Promise.all([T(f(p,"roles")),T(f(p,"tokens"))]),u=r.exists()?r.val():{},h=l.exists()?l.val():{},d=Array.isArray(n)?n:[n],m=d.length===1&&d[0]==="all",y=[],b=[],w=[],v=Array.from(new Set([...Object.keys(u||{}),...Object.keys(h||{})]));for(const M of v){const C=u[M]||{},X=C.role,me=C.notification!==!1,Qe=C.instantSMS===!0;if(!(m||X&&d.includes(X))||!me)continue;if(Qe){w.push(M),b.push(M);continue}const ae=He(h[M]);ae.length>0&&(y.push(...ae),b.push(M))}const I=H(y),B=H(b),j=H(w),K=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);return I.length>0?qe(e,t,I,{recipientDeviceNames:B,link:o.link||"/Mister-X/",waitSec:typeof o.waitSec=="number"?o.waitSec:45,sendEndpoint:o.sendEndpoint,rtdbBase:i,messageId:s,instantSMSDevices:j}):j.length>0?(await We(s,j,K,{rtdbBase:i}),{ok:!0,onlySms:!0,smsCount:j.length,messageId:s}):(c(`‚ö†Ô∏è Keine passenden Empf√§nger f√ºr Rollen "${Array.isArray(n)?n.join(","):n}".`),{ok:!0,skipped:"no_recipients"})}async function Bn(e){const t=Array.isArray(e)?e:[e],[n,o]=await Promise.all([T(f(p,"roles")),T(f(p,"tokens"))]),i=n.exists()?n.val():{},s=o.exists()?o.val():{},a=t.length===1&&t[0]==="all",r=[],l=[];for(const u in s){if(!Object.prototype.hasOwnProperty.call(s,u))continue;const h=i[u]||{},d=h.role,m=h.notification!==!1;if(!(a||d&&t.includes(d))||!m)continue;const b=He(s[u]);b.length!==0&&(r.push(...b),l.push(u))}return{tokens:H(r),deviceNames:H(l)}}async function Pn(e){const t=Array.isArray(e)?e:[e],[n,o,i]=await Promise.all([T(f(p,"teams")),T(f(p,"roles")),T(f(p,"tokens"))]),s=n.exists()?n.val():{},a=o.exists()?o.val():{},r=i.exists()?i.val():{},l=[],u=[],h=[],d=new Set;for(const m of t){const y=s==null?void 0:s[m];if(!(!y||!y.members))for(const b of Object.keys(y.members||{})){if(d.has(b))continue;d.add(b);const w=a[b]||{},v=w.notification!==!1,I=w.instantSMS===!0;if(!v)continue;const B=He(r[b]);if(B.length>0){l.push(...B),u.push(b);continue}I&&(h.push(b),u.push(b))}}return{tokens:H(l),deviceNames:H(u),instantSMSDevices:H(h)}}function Mn(e,t,n){const o="Misterx-upload",i=new FormData;i.append("file",e),i.append("upload_preset",o),fetch("https://api.cloudinary.com/v1_1/ddvf141hb/image/upload",{method:"POST",body:i}).then(s=>s.json()).then(s=>{s.secure_url&&s.public_id?t({url:s.secure_url}):typeof n=="function"&&n(new Error("Fehler beim Hochladen zu Cloudinary."))}).catch(s=>{c("Upload-Fehler:",s),typeof n=="function"&&n(s)})}async function Cn(){const e=document.getElementById("photoInput").files[0],t=document.getElementById("manualLocationDescription").value.trim(),n=document.getElementById("manualLocationContainer"),o=document.getElementById("status"),i=Ko();if(!i){alert("Bitte zuerst einen Posten ausw√§hlen.");return}if(!e){alert("Bitte ein Foto ausw√§hlen.");return}const s=Date.now();let a={lat:null,lon:null,accuracy:null};if(!(n&&n.style.display!=="none"&&t!==""))if(navigator.geolocation)try{const b=await Xe(),{latitude:w,longitude:v,accuracy:I}=b.coords;if(I>100){o.innerText=`‚ö†Ô∏è Standort ungenau (¬±${Math.round(I)} m). Bitte erneut versuchen oder Standortbeschreibung eingeben.`,n.style.display="block";return}a={lat:w,lon:v,accuracy:I}}catch(b){Be==null||Be(b),n.style.display="block"}else o.innerText="Geolocation wird nicht unterst√ºtzt.",n.style.display="block";const{color:r,postId:l,title:u}=i,h=f(p,`posten/${r}/active`);o.innerText="‚è≥ Reserviere Farbe‚Ä¶";try{const b=await ke(h,w=>w===!0?!1:w);if(!b.committed||b.snapshot.val()!==!1){o.innerText="‚ùå Diese Farbe ist bereits inaktiv. Liste wird aktualisiert.";return}}catch(b){o.innerText="‚ùå Konnte Farbe nicht reservieren.",c(b);return}try{await N(f(p),{[`posten/${r}/${l}/visited`]:!0})}catch(b){o.innerText="‚ùå Konnte Posten nicht auf 'visited' setzen.",c(b);return}const d={color:r,postId:l,title:u,timestamp:s,description:t||null,lat:a.lat,lon:a.lon},m=J(f(p,"locations"),d),y=`${u} (${r.toUpperCase()})`;oe==null||oe("Mister X hat sich gezeigt!",y,["agent","settings","start"]),te(),Mn(e,async({url:b})=>{try{await N(m,{photoURL:b}),o.innerText="‚úÖ Foto hochgeladen"}catch(w){o.innerText="‚ùå Foto-URL konnte nicht gesetzt werden",c("Foto-URL konnte nicht gesetzt werden",w)}},b=>{o.innerText="‚ùå Foto konnte nicht hochgeladen werden",c("Upload-Fehler:",b)}),document.getElementById("photoInput").value="",document.getElementById("manualLocationDescription").value="",n.style.display="none",document.getElementById("postenSearch").value="",nn(null),o.innerText="üîÑÔ∏è Posten/Farbe gemeldet & Foto wird hochgeladen.",te==null||te()}function Be(e){let t="‚ùå Fehler beim Abrufen des Standorts.";switch(e.code){case e.PERMISSION_DENIED:t+=" Zugriff verweigert.";break;case e.POSITION_UNAVAILABLE:t+=" Standortinformationen nicht verf√ºgbar.";break;case e.TIMEOUT:t+=" Zeit√ºberschreitung bei der Standortabfrage.";break}t+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=t}function _n(e){return typeof e=="string"&&/^\+43\d{4,13}$/.test(e)}function Ue(e){return e.replace(/[.#$/\[\]\/]/g,"_")}function H(e){return Array.from(new Set(e))}function He(e){return e?typeof e=="string"?[e]:Array.isArray(e)?e.filter(Boolean):typeof e=="object"?Object.keys(e).filter(Boolean):[]:[]}function Dn(e){const t=String(e).trim();return t.startsWith("+")?"+"+t.slice(1).replace(/\D/g,""):t.replace(/\D/g,"")}function Nt(){try{return JSON.parse(localStorage.getItem("mrx_sms_prefs_v1"))??{allowSmsFallback:!1,tel:null,noTel:!1,lastUpdated:0}}catch{return{allowSmsFallback:!1,tel:null,noTel:!1,lastUpdated:0}}}function lt(e){const t=Nt(),n={allowSmsFallback:!!(e.allowSmsFallback??t.allowSmsFallback),tel:e.tel===void 0?t.tel:e.tel,noTel:e.noTel===void 0?t.noTel:e.noTel,lastUpdated:Date.now()};return localStorage.setItem("mrx_sms_prefs_v1",JSON.stringify(n)),n}async function Fn(e){const t=Ue(e),n=await T(f(p,`roles/${t}`));if(!n.exists())return{exists:!1,allowSmsFallback:null,tel:null};const o=n.val()||{};return{exists:!0,allowSmsFallback:o.allowSmsFallback!==void 0?!!o.allowSmsFallback:null,tel:o.tel??null}}function Rn(e){if(!e)return null;let t=Dn(e);if(t.startsWith("+43"))return/^\+43\d{4,13}$/.test(t)?t:null;if(t.startsWith("0")){const n="+43"+t.slice(1);return/^\+43\d{4,13}$/.test(n)?n:null}if(t.startsWith("43")){const n="+"+t;return/^\+43\d{4,13}$/.test(n)?n:null}if(/^\d{5,}$/.test(t)&&t[0]!=="0"){const n="+43"+t;return/^\+43\d{4,13}$/.test(n)?n:null}return null}async function ut(e,t,n){const o=Ue(e);Mt(V);const i={tel:t??null,allowSmsFallback:!!n,...t?{telUpdatedAt:Date.now()}:{}};await N(f(p,`roles/${o}`),i)}const x=e=>document.getElementById(e),jt=e=>e&&(e.style.display=""),zt=e=>e&&(e.style.display="none"),Ie=e=>{try{localStorage.setItem(Rt,e||"")}catch{}},$n=()=>{try{return localStorage.getItem(Rt)||""}catch{return""}};function Wt(e){return typeof e=="number"?e:e&&typeof e=="object"&&typeof e.seconds=="number"?e.seconds*1e3:0}function qt(e){return e?`${String(e)}`:"Unbekannt"}function On(e){const t=(e||"").trim();if(t.length<2)throw new Error("Der Teamname muss mindestens 2 Zeichen lang sein.");if(t.length>24)throw new Error("Der Teamname darf maximal 24 Zeichen lang sein.");return t}function q(e){return(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Pe(e=""){return q(e).replace(/`/g,"&#096;")}function Fe(e){const t=(e==null?void 0:e.members)||{};return Object.keys(t).length}function Nn(e,t=S){return!!(e!=null&&e.members)&&!!e.members[t]}function jn(){$n()?(x("teamStatusName").textContent="(l√§dt‚Ä¶)",x("teamStatusCount").textContent="-"):(x("teamStatusName").textContent="Kein Team",x("teamStatusCount").textContent="-"),Ge()}document.addEventListener("DOMContentLoaded",jn);function zn(){if(document.getElementById("teamSettings").style.display!=="none")return Ut();document.getElementById("startView").style.display="none",document.getElementById("startView2").style.display="none",document.querySelectorAll(".view").forEach(e=>e.style.display="none"),jt(x("teamSettings")),Ge()}function Ut(){let e=localStorage.getItem("activeView")||"start";zt(x("teamSettings")),Je(e)}function Ge(){if(!fe.deviceTeam){const e=f(p,`deviceTeams/${S}`),t=n=>{k=n.val()||null,Ie(k||""),dt(),mt(),ft()};G(e,t),fe.deviceTeam={ref:e,handler:t}}if(!fe.teams){const e=f(p,"teams"),t=n=>{O=n.val()||{},dt(),mt(),ft()};G(e,t),fe.teams={ref:e,handler:t}}}function dt(){const e=x("currentTeamName"),t=x("currentTeamMembers"),n=x("leaveTeamBtn"),o=k?O[k]:null;if(!o){e.textContent="Kein Team",t&&(t.innerHTML="‚Äî Mitglieder"),n&&(n.disabled=!0);return}e.textContent=o.name||"(ohne Namen)";const i=Object.entries(o.members||{}).map(([a,r])=>({id:a,joinedAt:Wt(r==null?void 0:r.joinedAt)})).sort((a,r)=>a.joinedAt!==r.joinedAt?a.joinedAt-r.joinedAt:a.id.localeCompare(r.id)),s=i.map(a=>{const r=a.id===S,l=qt(a.id)+(r?" (Du)":"");return`<li class="ts-member ${r?"me":""}" title="${q(a.id)}">${q(l)}</li>`}).join("");t&&(t.innerHTML=`
      <div class="muted">${i.length} Mitglied(er)</div>
      ${i.length>0?`<ul class="ts-member-list">${s}</ul>`:'<div class="muted">Noch keine Mitglieder</div>'}
    `),n&&(n.disabled=!Nn(o))}function mt(){const e=x("teamList"),t=x("teamsEmpty");if(!e)return;e.innerHTML="";const n=Object.entries(O||{}).filter(([,o])=>o&&typeof o=="object");if(n.length===0){t&&jt(t);return}t&&zt(t),n.sort((o,i)=>{const s=Fe(o[1]),a=Fe(i[1]);return s!==a?a-s:(o[1].name||"").localeCompare(i[1].name||"")});for(const[o,i]of n){const s=Object.entries(i.members||{}).map(([l,u])=>({id:l,joinedAt:Wt(u==null?void 0:u.joinedAt)})).sort((l,u)=>l.joinedAt!==u.joinedAt?l.joinedAt-u.joinedAt:l.id.localeCompare(u.id)),a=s.map(l=>{const u=l.id===S,h=qt(l.id)+(u?" (Du)":"");return`<li class="ts-member ${u?"me":""}" title="${q(l.id)}">${q(h)}</li>`}).join(""),r=document.createElement("div");r.className="ts-team",r.innerHTML=`
      <div>
        <div style="font-weight:600">${q(i.name||"(ohne Namen)")}</div>
        <div class="muted">${s.length} Mitglied(er)</div>
        <ul class="ts-member-list">
          ${a||""}
        </ul>
      </div>
      <div>
        ${k===o?'<button class="danger" onclick="leaveTeam()">Verlassen</button>':`<button onclick="joinTeam('${o}', this)">Beitreten</button>`}
      </div>
    `,e.appendChild(r)}}function ft(){const e=x("teamStatusName"),t=x("teamStatusCount"),n=k?O[k]:null;if(!n){e.textContent="Kein Team",t.textContent="-";return}e.textContent=n.name||"(ohne Namen)",t.textContent=`${Fe(n)} Mitglied(er)`}async function Wn(){const e=x("createTeamBtn"),t=x("createTeamInput");try{e.disabled=!0;const n=On(t.value);k&&await Ve(k);const i=J(f(p,"teams")).key,s={};s[`teams/${i}`]={name:n,createdAt:ie(),createdBy:S,members:{[S]:{joinedAt:ie()}}},s[`deviceTeams/${S}`]=i,await N(f(p),s),Ie(i),t.value=""}catch(n){alert((n==null?void 0:n.message)||"Team konnte nicht erstellt werden."),c(n)}finally{e.disabled=!1}}async function qn(e,t){if(!e)return;if(!O[e]){alert("Team existiert nicht (mehr).");return}t&&(t.disabled=!0);try{k&&k!==e&&await Ve(k);const o={};o[`teams/${e}/members/${S}`]={joinedAt:ie()},o[`deviceTeams/${S}`]=e,await N(f(p),o),Ie(e)}catch(o){alert((o==null?void 0:o.message)||"Beitritt nicht m√∂glich."),c(o)}finally{t&&(t.disabled=!1)}}async function Ve(e=null){const t=e||k;if(!t)return;const n=f(p,`teams/${t}`);await ke(n,o=>o&&(o.members&&o.members[S]&&(delete o.members[S],Object.keys(o.members).length===0)?null:o)),await P(f(p,`deviceTeams/${S}`),null),Ie("")}function Un(){const e=document.getElementById("map");e.style.display=""}function Re(e,t){var n,o;if(Un(),g)g.setView([e,t],15),g.invalidateSize(),$e(),Oe();else{if(g=L.map("map",{fullscreenControl:!0,fullscreenControlOptions:{position:"topleft"},maxBounds:[[-90,-180],[90,180]],doubleTouchDragZoom:!0}).setView([e,t],15),console.debug("createOrReuseMap: L.control.fullscreen=",typeof((n=L.control)==null?void 0:n.fullscreen),"map.options.fullscreenControl=",g&&g.options&&g.options.fullscreenControl),typeof((o=L.control)==null?void 0:o.fullscreen)=="function")try{g.fullscreenControl||(L.control.fullscreen({position:"topleft",title:"Vollbild",titleCancel:"Vollbild verlassen",forceSeparateButton:!0}).addTo(g),console.info("leaflet.fullscreen: control added programmatically"))}catch(d){console.warn("leaflet.fullscreen: failed to add control programmatically",d)}else console.warn("leaflet.fullscreen: factory not available (L.control.fullscreen undefined)");const i=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"¬© OpenStreetMap"}),s=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"¬© CartoDB"}),a=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles ¬© Esri"}),r=L.tileLayer("http://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web/default/WEBMERCATOR/{z}/{y}/{x}.png",{maxZoom:18,attribution:"TopPlus Open ¬© GeoBasis-DE / BKG"}),l=L.tileLayer("https://mapsneu.wien.gv.at/basemap/bmaporthofoto30cm/{type}/google3857/{z}/{y}/{x}.{format}",{maxZoom:20,attribution:'Datenquelle: <a href="https://www.basemap.at">basemap.at</a>',type:"normal",format:"jpeg",bounds:[[46.35877,8.782379],[49.037872,17.189532]]}),u=L.tileLayer("https://mapsneu.wien.gv.at/basemap/bmaphidpi/{type}/google3857/{z}/{y}/{x}.{format}",{maxZoom:19,attribution:'Datenquelle: <a href="https://www.basemap.at">basemap.at</a>',type:"normal",format:"jpeg",bounds:[[46.35877,8.782379],[49.037872,17.189532]]}),h={Standard:i,Reduziert:s,Satellit:a,"Satellit (AT)":l,Plan:r,"Plan (AT)":u};i.addTo(g),L.control.layers(h).addTo(g),setTimeout(()=>g.invalidateSize(),0),$e(),Oe()}Ke()}function $e(){g&&(g.getPane("maskPane")||(g.createPane("maskPane"),g.getPane("maskPane").style.zIndex=300),g.getPane("historyPane")||(g.createPane("historyPane"),g.getPane("historyPane").style.zIndex=410),g.getPane("postenPane")||(g.createPane("postenPane"),g.getPane("postenPane").style.zIndex=400),g.getPane("agentenPane")||(g.createPane("agentenPane"),g.getPane("agentenPane").style.zIndex=420),g.getPane("userPane")||(g.createPane("userPane"),g.getPane("userPane").style.zIndex=450))}function Oe(){E||(E=L.layerGroup()),z||(z=L.layerGroup()),ge||(ge=L.layerGroup()),g&&(g.hasLayer(E)||E.addTo(g),g.hasLayer(z)||z.addTo(g),g.hasLayer(ge)||ge.addTo(g))}function Hn(e){if(!g)return;Oe(),z.clearLayers();const t=new L.Icon.Default;t.options.shadowSize=[0,0],e.forEach(o=>{L.marker([o.lat,o.lon],{pane:"historyPane",icon:t}).addTo(z).bindPopup(`üìç ${new Date(o.timestamp).toLocaleTimeString()}`)});const n=e.map(o=>[o.lat,o.lon]);n.length>1&&L.polyline(n,{color:"blue",weight:3,opacity:.7,smoothFactor:1,pane:"historyPane"}).addTo(z)}function Ht(){G(f(p,"locations"),e=>{var a,r,l,u,h,d;const t=e.val()||null;let n=[],o=[],i=null;try{n=Object.values(t).sort((m,y)=>y.timestamp-m.timestamp),o=n.filter(m=>m.lat!=null&&m.lon!=null),i=o.length===0}catch{i=!0}if(i)Re(48.208672092667435,16.372477270381918),c("Keine Locations");else if(o.length>0){const{lat:m,lon:y}=o[0];Re(m,y)}if(Vn(),o.length>0?Hn(o):z&&z.clearLayers(),Ke(),Se({nonDestructive:!0}),console.log("map id",g==null?void 0:g._leaflet_id),console.log("postenPane exists?",!!(g!=null&&g.getPane("postenPane"))),console.log("postenPane zIndex",(r=(a=g==null?void 0:g.getPane("postenPane"))==null?void 0:a.style)==null?void 0:r.zIndex),console.log("historyPane zIndex",(u=(l=g==null?void 0:g.getPane("historyPane"))==null?void 0:l.style)==null?void 0:u.zIndex),console.log("userPane zIndex",(d=(h=g==null?void 0:g.getPane("userPane"))==null?void 0:h.style)==null?void 0:d.zIndex),console.log("postenLayer on map?",g==null?void 0:g.hasLayer(E)),console.log("postenMarkers count",Object.keys(F||{}).length),g&&Le&&typeof Le.addTo=="function")try{Le.addTo(g)}catch(m){c("Fehler beim Hinzuf√ºgen von mask:",m)}document.getElementById("map").style.display="block";const s=document.getElementById("locationFeed");s.innerHTML="",n.length>0&&n.forEach((m,y)=>{const b=m.title?m.title:"Automatischer Standort",w=m.timestamp?new Date(m.timestamp).toLocaleTimeString():"",v=m.photoURL?`<img src="${m.photoURL}" alt="Foto" class="zoomable-photo" style="max-width: 100%; max-height: 60vh; border: 1px solid #ccc; margin-top: 5px; cursor: zoom-in;" data-index="${y}">`:"",I=document.createElement("div");I.style.marginBottom="1em",I.innerHTML=`
          <strong class="location-title" data-lat="${m.lat}" data-lon="${m.lon}" style="cursor: pointer;">${b} (${w})</strong><br>
          ${m.description?`<em>üìç ${m.description}</em><br>`:""}
          ${v}
        `,s.appendChild(I)}),document.querySelectorAll(".location-title").forEach(m=>{m.addEventListener("click",()=>{const y=parseFloat(m.dataset.lat),b=parseFloat(m.dataset.lon);g&&!isNaN(y)&&!isNaN(b)&&g.setView([y,b],17)})}),document.querySelectorAll(".zoomable-photo").forEach(m=>{m.addEventListener("click",()=>{const y=document.createElement("div");y.style.position="fixed",y.style.top="0",y.style.left="0",y.style.width="100vw",y.style.height="100vh",y.style.backgroundColor="rgba(0,0,0,0.8)",y.style.display="flex",y.style.alignItems="center",y.style.justifyContent="center",y.style.zIndex="9999",y.innerHTML=`<img src="${m.src}" style="max-width: 90%; max-height: 90%; border: 2px solid white;">`,y.addEventListener("click",()=>{document.body.removeChild(y)}),document.body.appendChild(y)})})})}function Gn(){if(!navigator.geolocation){alert("‚ùå Geolocation wird nicht unterst√ºtzt.");return}le==null&&(le=navigator.geolocation.watchPosition(e=>{const{latitude:t,longitude:n,accuracy:o}=e.coords;if(!g)return;const i={radius:7,color:"#007AFF",fillColor:"#ffffffff",fillOpacity:.8,opacity:1,weight:2},s={radius:o,color:"#007AFF",fillColor:"#007AFF",interactive:!1,fillOpacity:.2,weight:1,opacity:.4};if(_?(_.setLatLng([t,n]),_.getPopup()&&_.getPopup().setContent(`<strong>Dein Standort</strong><br>Genauigkeit: ¬±${Math.round(o)} m`)):_=L.circleMarker([t,n],{markerStyle:i,pane:"userPane"}).bindPopup(`<strong>Dein Standort</strong><br>Genauigkeit: ¬±${Math.round(o)} m`).addTo(g),R?(R.setLatLng([t,n]),R.setRadius(o)):R=L.circle([t,n],{...s,pane:"historyPane"}).addTo(g),Ft){const a=Math.max(g.getZoom(),16);g.setView([t,n],a,{animate:!0})}},e=>{c("Geolocation-Fehler:",e),Gt(),alert("‚ö†Ô∏è Tracking gestoppt: "+e.message)},{enableHighAccuracy:!0,timeout:15e3,maximumAge:5e3}))}function Gt(){le!=null&&(navigator.geolocation.clearWatch(le),le=null),g&&_&&(g.removeLayer(_),_=null),g&&R&&(g.removeLayer(R),R=null)}function Vn(){g&&(_&&!g.hasLayer(_)&&_.addTo(g),R&&!g.hasLayer(R)&&R.addTo(g))}function Kn(){const e=document.getElementById("refreshBtn");e&&e.addEventListener("click",async()=>{e.classList.add("updating");try{await Xn({timeoutMs:2500})}catch(t){c("[Refresh] Fehler im Update-Flow:",t),window.location.reload()}})}async function Xn({timeoutMs:e=2500}={}){if(!("serviceWorker"in navigator)){window.location.reload();return}const t=await navigator.serviceWorker.getRegistration();if(!t){c("[Refresh] Keine SW-Registration gefunden -> normaler Reload"),window.location.reload();return}c("[Refresh] Vor Update:",Qn(t)),await t.update();let n=t.installing||t.waiting||null;n||(n=await Zn(t,800)),n?(await Jn(n),t.waiting&&(c("[Refresh] Sende SKIP_WAITING an Waiting-SW"),t.waiting.postMessage({type:"SKIP_WAITING"}))):c("[Refresh] Keine neue SW gefunden -> normaler Reload"),await Yn(e),window.location.reload()}function Zn(e,t){return new Promise(n=>{let o;const i=()=>{e.removeEventListener("updatefound",i),clearTimeout(o),n(e.installing||e.waiting||null)};e.addEventListener("updatefound",i),o=setTimeout(()=>{e.removeEventListener("updatefound",i),n(null)},t)})}function Jn(e){return new Promise(t=>{if(e.state==="installed"||e.state==="activated")return t();e.addEventListener("statechange",()=>{(e.state==="installed"||e.state==="activated")&&t()})})}function Yn(e){return new Promise(t=>{let n=!1;const o=()=>{n||(n=!0,navigator.serviceWorker.removeEventListener("controllerchange",i),t())},i=()=>{c("[Refresh] controllerchange empfangen"),o()};navigator.serviceWorker.addEventListener("controllerchange",i),setTimeout(()=>{c("[Refresh] controllerchange-Timeout, lade dennoch neu"),o()},e)})}function Qn(e){const t=n=>n?n.state:"‚Äî";return{scope:e.scope,active:t(e.active),installing:t(e.installing),waiting:t(e.waiting),controlled:!!navigator.serviceWorker.controller}}function eo(){let e=0;const t=15e3,n=async()=>{const o=Date.now();if(!(o-e<t)){e=o;try{const i=await navigator.serviceWorker.getRegistration();if(!i)return;await i.update(),i.waiting&&i.waiting.postMessage({type:"SKIP_WAITING"})}catch{}}};document.addEventListener("visibilitychange",()=>{document.hidden||n()}),window.addEventListener("focus",n)}function to(e,t,n){const o=wn[e]||"#666";return n?{radius:10,color:o,fillColor:o,fillOpacity:.9,opacity:1,weight:3}:t===!1?{radius:6,color:o,fillColor:o,fillOpacity:.25,opacity:.4,weight:1}:{radius:9,color:o,fillColor:o,fillOpacity:.7,opacity:.9,weight:2}}function gt(e,t,n,o){const i=n.title||t,s=!!n.visited,a=o?"aktiv":"inaktiv",r=s?"‚úÖ besucht":"üïí offen",l=n.imageUrl?`
      <div class="posten-preview" style="margin-top:6px">
        <img
          class="posten-preview-img"
          src="${Pe(n.imageUrl)}"
          data-fullsrc="${Pe(n.imageUrl)}"
          alt="${Pe(i)}"
          loading="lazy"
          style="width:100%;height:auto;max-height:120px;object-fit:contain;border-radius:8px;cursor:zoom-in;display:block"
          referrerpolicy="no-referrer"
        />
      </div>
    `:"";return`
    <div class="posten-popup" style="min-width:200px">
      <strong>${q(i)}</strong><br>
      <small>Farbe: ${q(e)} (${a})</small><br>
      <small>Status: ${r}</small>
      ${l}
    </div>
  `}function no(e){const t=e.lat??e.latitude??null,n=e.lon??e.lng??e.longitude??null;return{lat:t,lon:n}}async function oo(){const e=f(p,"posten"),t=await T(e);Y=t.exists()?t.val():null,Se(),G(e,n=>{Y=n.exists()?n.val():null,Se()})}function io(){const e=document.getElementById("img-lightbox"),t=document.getElementById("img-lightbox-close");if(!e||!t)return;const n=()=>e.style.display="none";t.addEventListener("click",n),e.addEventListener("click",o=>{o.target===e&&n()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&n()})}function so(){const e=t=>{const n=t.target.closest(".posten-preview-img");if(!n)return;t.preventDefault(),t.stopPropagation();const o=n.getAttribute("alt")||"Bild",i=n.getAttribute("data-fullsrc")||n.getAttribute("src");i&&ao(i,o)};document.addEventListener("click",e,{capture:!0})}function ao(e,t=""){const n=document.getElementById("img-lightbox"),o=document.getElementById("img-lightbox-img");!n||!o||(n.style.display="flex",o.onload=null,o.onerror=null,o.alt=t||"Bild",o.src===e&&(o.src=""),o.src=e)}function Ke(){E||(E=L.layerGroup()),g&&!g.hasLayer(E)&&E.addTo(g)}function Se(e={}){const{nonDestructive:t=!1}=e;if(!g||!Y)return;$e(),Ke();const n=new Set;let o=0;if(Object.entries(Y).forEach(([i,s])=>{if(!s||typeof s!="object")return;const a=!!s.active,r=Object.fromEntries(Object.entries(s).filter(([l])=>l!=="active"));Object.entries(r).forEach(([l,u])=>{var b,w;if(!u||typeof u!="object")return;const{lat:h,lon:d}=no(u);if(h==null||d==null)return;o++;const m=`${i}/${l}`;n.add(m);const y=to(i,a,!!u.visited);if(F[m]){const v=F[m];v.setLatLng([h,d]),v.setStyle(y),v._postenLoc=u,v._postenId=m,E&&!E.hasLayer(v)&&v.addTo(E),(b=v.bringToFront)==null||b.call(v),(w=v.getPopup())==null||w.setContent(gt(i,l,u,a))}else{const v=L.circleMarker([h,d],{...y,pane:"postenPane"}).bindPopup(gt(i,l,u,a));v._postenLoc=u,v._postenId=m,v.addTo(E),F[m]=v}})}),!t){if(o===0){c("[posten] Kein g√ºltiger Posten geparst - Cleanup √ºbersprungen.");return}Object.keys(F).forEach(i=>{n.has(i)||(E.removeLayer(F[i]),delete F[i])})}}Object.keys(F).forEach(e=>{seen.has(e)||(E.removeLayer(F[e]),delete F[e])});async function ro(e=!0){const t=f(p,"posten"),n=await T(t);if(!n.exists())return;const o=n.val(),i={};Object.entries(o).forEach(([s,a])=>{!a||typeof a!="object"||(i[`posten/${s}/active`]=e,Object.entries(a).forEach(([r,l])=>{r==="active"||!l||typeof l!="object"||(i[`posten/${s}/${r}/visited`]=!1)}))}),await N(f(p),i)}const pe=e=>e*Math.PI/180;function co(e,t,n,o){const s=pe(n-e),a=pe(o-t),r=Math.sin(s/2)**2+Math.cos(pe(e))*Math.cos(pe(n))*Math.sin(a/2)**2;return 2*6371e3*Math.asin(Math.sqrt(r))}function Xe(e={enableHighAccuracy:!0,timeout:8e3,maximumAge:0}){return new Promise((t,n)=>{if(!navigator.geolocation)return n(new Error("Geolocation nicht unterst√ºtzt"));navigator.geolocation.getCurrentPosition(t,n,e)})}function Vt({excludeVisited:e=!0}={}){const t=[];for(const[n,o]of Object.entries(Y))if(!(!o||o.active!==!0))for(const[i,s]of Object.entries(o.posts||{}))!s||typeof s!="object"||e&&s.visited===!0||t.push({color:n,postId:i,...s});return t}function be(e){const t=document.getElementById("postenSuggestions");if(!e||e.length===0){t.style.display="none",t.innerHTML="";return}t.innerHTML=e.map(n=>{const o=n.distance!=null?` - ${(n.distance/1).toFixed(0)} m`:"";return`<div class="item" data-color="${n.color}" data-postid="${n.postId}">
              ${n.title||"(ohne Titel)"}
              <span class="tag">${n.color}</span>${o}
            </div>`}).join(""),t.style.display="block",t.querySelectorAll(".item").forEach(n=>{n.addEventListener("click",()=>{var u,h;const o=n.getAttribute("data-color"),i=n.getAttribute("data-postid"),s=(h=(u=Y[o])==null?void 0:u.posts)==null?void 0:h[i];if(!s){c("Ausgew√§hlter Posten nicht im Cache gefunden:",{color:o,postId:i}),document.getElementById("status").innerText="Dieser Posten ist nicht mehr verf√ºgbar.",t.style.display="none";return}const a={color:o,postId:i,title:s.title||i,lat:s.lat??null,lon:s.lon??null};nn(a);const r=document.getElementById("postenSearch");r&&(r.value=`${a.title} [${o}]`),t.style.display="none";const l=document.getElementById("status");l&&(l.innerText=`‚úÖ Posten ausgew√§hlt: ${a.title} (${o})`)})})}function Kt(e){const t=(e||"").trim().toLowerCase(),n=Vt();return t?n.filter(o=>{const i=String(o.postId).toLowerCase(),s=String(o.title||"").toLowerCase(),a=String(o.color).toLowerCase();return i.includes(t)||s.includes(t)||a.includes(t)}).slice(0,25):[]}async function lo(e=5){try{const t=await Xe(),{latitude:n,longitude:o,accuracy:i}=t.coords;i>100&&(document.getElementById("status").innerText=`‚ö†Ô∏è Standort ungenau (¬±${Math.round(i)}‚ÄØm). Ergebnisse evtl. ungenau.`);const s=Vt().map(a=>({...a,distance:a.lat!=null&&a.lon!=null?co(n,o,a.lat,a.lon):Number.POSITIVE_INFINITY}));return s.sort((a,r)=>a.distance-r.distance),s.slice(0,e)}catch{return document.getElementById("status").innerText="üìç Konnte Standort nicht bestimmen. Du kannst trotzdem per Suche ausw√§hlen.",[]}}async function uo(){const e=f(p,"posten");G(e,t=>{const n=t.val()||{},o={};for(const[s,a]of Object.entries(n)){if(!a||typeof a!="object")continue;const{active:r,...l}=a,u={};for(const[h,d]of Object.entries(l))d&&typeof d=="object"&&(u[h]=d);o[s]={active:!!r,posts:u}}Y=o;const i=document.getElementById("postenSearch").value;i&&be(Kt(i))})}function mo(){const e=document.getElementById("postenSearch"),t=document.getElementById("nearbyBtn");let n;e.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=Kt(e.value);be(o)},150)}),t.addEventListener("click",async()=>{const o=await lo(20);if(o.length===0){be(o),document.getElementById("status").innerText="Keine nahegelegenen Posten gefunden (oder Standort unbekannt).";return}be(o)}),document.addEventListener("click",o=>{const i=document.getElementById("postenSuggestions");i.contains(o.target)||e.contains(o.target)||t.contains(o.target)||(i.style.display="none")})}const Q=document.getElementById("notifHeader"),ue=document.getElementById("notifHeaderToggle"),Me=document.getElementById("notifSummary"),fo=document.getElementById("notifDetails"),pt=document.getElementById("notifStatusDot"),ht=document.getElementById("notifTimeShort"),yt=document.getElementById("notifTitle"),bt=document.getElementById("notifBody"),wt=document.getElementById("notifSender"),vt=document.getElementById("notifTime"),St=document.getElementById("notifId"),Ce=document.getElementById("recipientList"),he=document.getElementById("notifCount"),re=document.getElementById("toggleNotifHeader");let Z=null;function _e(e){Q.style.display=e?"block":"none",!e&&typeof Z=="function"&&(Z(),Z=null)}function Ze(e){Q.classList.toggle("collapsed",e),Q.classList.toggle("expanded",!e),fo.hidden=e,ue.setAttribute("aria-expanded",String(!e)),ue.textContent=e?"‚ñæ":"‚ñ¥"}ue==null||ue.addEventListener("click",e=>{e.stopPropagation();const t=Q.classList.contains("collapsed");Ze(!t)});Me==null||Me.addEventListener("click",()=>{const e=Q.classList.contains("collapsed");Ze(!e)});function go(e){return new Date(e).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}function Ne(e){if(!e){yt.textContent="-",bt.textContent="-",wt.textContent="-",vt.textContent="-",ht.textContent="[--:--]",St.textContent="-",Ce.innerHTML="",pt.style.background="#bbb",he&&(he.textContent="-"),Q.classList.remove("sticky"),Q.style.position="";return}const t=typeof e.timestamp=="number"?e.timestamp:Date.now(),n=go(t);yt.textContent=e.title||"Ohne Titel",bt.textContent=e.body||"",wt.textContent=e.sender||"Unbekannt",vt.textContent=new Date(t).toLocaleString("de-DE"),ht.textContent=`[${n}]`,St.textContent=e.id??"-";const o=e.recipients||{},i=Object.keys(o),s=i.filter(d=>o[d]===!0).length,a=i.length,r={};i.forEach(d=>{const m=Ue(d);o[d]===!0?r[d]="green":e&&e.fallbackTargets&&e.fallbackTargets[m]?r[d]="orange":r[d]="red"});const l={};i.forEach(d=>{const m=(()=>{for(const[b,w]of Object.entries(O||{}))if(w.members&&w.members[d])return w;return null})();let y=r[d];y==="red"&&m&&Object.keys(m.members).filter(v=>v!==d).some(v=>r[v]==="green"||r[v]==="orange")&&(y="blue"),l[d]=y}),Ce.innerHTML="";const u=[];i.sort((d,m)=>d.localeCompare(m)).forEach(d=>{const m=l[d];u.push(m);const y=m==="green"?"ok":m==="orange"?"wait":m==="blue"?"teamblue":"red",b=m==="green"?"‚úÖ":m==="blue"?"üü¶":m==="orange"?"üì∞":"üî¥",w=document.createElement("div");w.className=`recipient-chip ${y}`,w.innerHTML=`<span class="dot"></span><span>${d}</span><span>${b}</span>`,Ce.appendChild(w)});let h="#FF5252";u.length>0&&(u.some(d=>d==="red")?h="#FF5252":u.some(d=>d==="blue")?h="#1E90FF":u.some(d=>d==="orange")?h="#FF8C00":h="#2ECC71"),pt.style.background=h,he&&(he.textContent=`${s}/${a} best√§tigt`)}function Tt(){typeof Z=="function"&&(Z(),Z=null);const e=_t(f(p,"notifications"),Dt("timestamp"),dn(1)),t=G(e,n=>{const o=n.val();if(!o){Ne(null);return}const[i,s]=Object.entries(o)[0];Ne({id:i,...s})});Z=()=>t()}function po(){const e=localStorage.getItem(xe)==="1";_e(e),e&&Tt(),re&&(re.checked=e),Ze(!0),re==null||re.addEventListener("change",t=>{t.target.checked?(localStorage.setItem(xe,"1"),_e(!0),Tt()):(localStorage.removeItem(xe),_e(!1),Ne(null))})}async function ho(){if(confirm("M√∂chtest du wirklich die Standorte der Agenten anfragen?"))try{let e=O;(!e||Object.keys(e).length===0)&&(e=(await T(f(p,"teams"))).val()||{});const t={};for(const[s,a]of Object.entries(e)){if(s===k)continue;(a!=null&&a.members?Object.keys(a.members).length:0)>0&&(t[s]=!0)}if(Object.keys(t).length===0){c==null||c("[triggerAgentLocationRequest] Abbruch: keine adressierbaren Teams gefunden."),alert("Keine Teams gefunden, die angefragt werden k√∂nnen.");return}const n=String(Date.now()),o={id:n,createdAt:ie(),createdBy:S,teamsAtRequest:t,responses:{}};await P(f(p,"agentLocationRequest"),o);const i=Object.keys(t);try{const{tokens:s,deviceNames:a,instantSMSDevices:r}=await Pn(i),l="Mister X hat deinen Standort angefragt",u="√ñffne die App, um deinen Standort freizugeben!";if(s&&s.length>0||r&&r.length>0){if(s&&s.length>0&&await qe(l,u,s,{recipientDeviceNames:a,link:"/Mister-X/",rtdbBase:W}),r&&r.length>0&&(!s||s.length===0)){const h=`${l}: ${u}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);await We(ne(),r,h,{rtdbBase:W})}}else c==null||c("[triggerAgentLocationRequest] Keine Empf√§nger in den ausgew√§hlten Teams gefunden.")}catch(s){c==null||c("[triggerAgentLocationRequest] Fehler beim Ermitteln der Empf√§nger",s)}return c==null||c("[triggerAgentLocationRequest] Anfrage ausgel√∂st",{reqId:n,totalTeams:Object.keys(t).length}),n}catch(e){throw c==null||c("[triggerAgentLocationRequest] Anfrage fehlgeschlagen",e),alert("Konnte die Anfrage nicht ausl√∂sen."),e}}async function yo(e){var r;if(!k){alert("Du bist in keinem Team. Standortfreigabe abgebrochen.");return}const t=f(p,`agentLocationRequest/responses/${k}`);if((await T(t)).exists()){try{localStorage.setItem(ot,e.id)}catch{}return}const o=await new Promise((l,u)=>{if(!navigator.geolocation)return u(new Error("Geolocation nicht verf√ºgbar"));navigator.geolocation.getCurrentPosition(l,u,{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})}),i=o.coords.latitude,s=o.coords.longitude,a=((r=O==null?void 0:O[k])==null?void 0:r.name)||"Team";alert("Dein Standort wird jetzt freigegeben"),await ke(t,l=>l||(c("Standort f√ºr AgentLocation ausgesendet"),{teamId:k,teamName:a,lat:i,lon:s,deviceId:S,timestamp:ie()}));try{localStorage.setItem(ot,e.id)}catch{}}function bo(){A(f(p,"agentLocationRequest")),vo(),je()}function je(){Array.isArray(ce)&&ce.length&&window.map&&ce.forEach(e=>g.removeLayer(e)),ce=[]}function wo(){const e=f(p,"agentLocationRequest");G(e,n=>{const o=n.exists()?n.val():null;$t=o,Xt(o),o&&o.createdBy!==S&&k&&So(o)})}function vo(){const e=document.getElementById("agentReqStatus");e&&(e.style.display="none")}async function So(e){try{await yo(e)}catch(t){c("Standortfreigabe fehlgeschlagen",t)}}function Xt(e=$t){const t=document.getElementById("agentReqStatus"),n=document.getElementById("agentReqProgress");if(!t||!n)return;if(!e){t.style.display="none",je();return}const o=typeof e.createdAt=="number"?new Date(e.createdAt).toLocaleTimeString():"Unbekannt",i=e.responses||{},s=Object.values(i),a=e.teamsAtRequest||{},r=Object.keys(a).length||s.length,l=s.length;if(n.textContent=`Standort von ${l}/${r} Teams ‚Äì ${o}`,t.style.display="block",je(),!(!ye||s.length===0)){To(s);for(const u of s){if(u.lat==null||u.lon==null)continue;const h=L.divIcon({className:`square-marker ${ko(u.teamId)}`,iconSize:[14,14]}),d=L.marker([u.lat,u.lon],{icon:h,pane:"agentenPane"}).addTo(g);d.bindPopup(`<strong>${q(u.teamName||"Team")}</strong>`),ce.push(d)}}}function To(e){if(!window.map){const t=e.find(n=>n.lat!=null&&n.lon!=null);t&&Re(t.lat,t.lon)}}function ko(e){const t=["","orange","green","purple","blue","red","yellow","cyan","pink","lime","teal","brown"],n=Math.abs(Io(String(e)))%t.length;return t[n]}function Io(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}function Eo(){T(f(p,"roles")).then(e=>{const t=e.val();for(const n in t)t[n].role==="misterx"&&P(f(p,"roles/"+n),{role:"start",timestamp:Date.now()});alert("Alle Mister X Rollen wurden zur√ºckgesetzt.")})}async function xo(){const e=await T(f(p,"settings/max_Team_X")),t=e.exists()?e.val():1,o=(await T(f(p,"roles"))).val();let i=0;for(const s in o)o[s].role==="misterx"&&i++;return i<t}async function Je(e){if(e!==localStorage.getItem("activeView")){if(e==="misterx"&&!await xo()){alert("Es ist bereits ein Ger√§t als Mister X angemeldet!"),we();return}if(e==="settings"&&prompt("Passwort eingeben!")!=="1001"){we();return}}if(e==="start")return we();document.getElementById("startView").style.display="none",document.getElementById("startView2").style.display="none",document.querySelectorAll(".view").forEach(n=>n.style.display="none"),e==="misterx"?document.getElementById("misterxView").style.display="block":e==="agent"?document.getElementById("agentView").style.display="block":e==="settings"&&(document.getElementById("settingsView").style.display="block",Oo()),localStorage.setItem("activeView",e),N(f(p,"roles/"+S),{role:e,timestamp:Date.now()});const t=e;await D.from("fcm_tokens").update({role:t}).eq("device_name",S),T(f(p,"timer")).then(n=>{const o=n.val();if(o){const{startTime:i,duration:s,durationInput:a,durationInput2:r}=o;s?(Zt(i,s),ee(!0)):ee(!1)}})}async function we(){document.querySelectorAll(".view").forEach(t=>t.style.display="none"),document.getElementById("startView").style.display="block",document.getElementById("startView2").style.display="block",clearInterval(U),localStorage.setItem("activeView","start"),N(f(p,"roles/"+S),{role:"start",timestamp:Date.now()}),await D.from("fcm_tokens").update({role:"start"}).eq("device_name",S)}async function te(e){await A(f(p,"timer/duration")),await A(f(p,"timer/startTime")),await A(f(p,"timerMessage")),typeof U<"u"&&clearInterval(U);const n=(await T(f(p,"timer"))).val();let o=25*60;typeof(n==null?void 0:n.durationInput)=="number"&&n.durationInput>0&&(o=n.durationInput,(isNaN(o)||o<1)&&(o=60)),typeof e=="number"&&e>0&&(o=e);const i=Date.now(),s=i+o*1e3,a={title:"Deine Zeit l√§uft gleich ab",body:"Bitte √∂ffne deine App!"};await P(f(p,"timer"),{startTime:i,duration:o,durationInput:n==null?void 0:n.durationInput,durationInput2:(n==null?void 0:n.durationInput2)||0});try{await D.rpc("cancel_and_unschedule")}catch(d){c("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",d)}const{tokens:r,deviceNames:l}=await Bn("misterx"),u=o-60,h=(ne==null?void 0:ne())??void 0;await D.functions.invoke("arm-timer-cron",{body:{title:a.title,body:a.body,dueInSec:u,messageId:h,link:"/Mister-X/",roles:["misterx"],resolveRecipientsAtSendTime:!0,rtdbBase:W}}),c(`üïí Timer gestartet: ${o}s, f√§llt um ${new Date(s).toLocaleTimeString()}.`)}function Lo(){nt||(nt=!0,G(f(p,"timer"),e=>{const t=e.val()||{},{startTime:n=null,duration:o=null,durationInput:i=null,durationInput2:s=null}=t;if(n===null||o===null){clearInterval(U),ee(!1);const a=document.getElementById("timer"),r=document.getElementById("agentTimer"),l=document.getElementById("settingsTimer");a&&(a.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--",a.style.color="",a.style.animation=""),r&&(r.innerText="‚è≥ Mister X Timer: --:--",r.style.color="",r.style.animation=""),l&&(l.innerText="‚è≥ Aktueller Timer: --:--",l.style.color="",l.style.animation="");return}Zt(n,o),ee(!0)}))}function Zt(e,t){clearInterval(U);let n=!1;U=setInterval(async()=>{if(!n){n=!0;try{let o=function(d){d&&(a<=300?(d.style.color="red",d.style.animation="blinker 1s linear infinite"):(d.style.color="",d.style.animation=""))};const i=Date.now(),s=Math.floor((i-e)/1e3),a=t-s;let r;if(a<0)r="abgelaufen";else{const d=Math.floor(a/60),m=a%60;r=`${String(d).padStart(2,"0")}:${String(m).padStart(2,"0")}`}const l=document.getElementById("timer"),u=document.getElementById("agentTimer"),h=document.getElementById("settingsTimer");if(h&&(h.innerText=`‚è≥ Aktueller Timer: ${r}`,o(h)),l&&(l.innerText=`‚è≥ Zeit bis zum n√§chsten Posten: ${r}`,o(l)),u&&(u.innerText=`‚è≥ Mister X Timer: ${r}`,o(u)),a<=0&&([l,u,h].forEach(d=>{d&&(d.style.color="",d.style.animation="")}),localStorage.getItem("activeView")==="misterx"))try{const m=(await T(f(p,"timer"))).val()||{},{startTime:y,duration:b,durationInput:w,durationInput2:v}=m||{};if(typeof y!="number"||typeof b!="number")return;const I=Jt(y,b);if(!Bo(I))return;if(b===w&&(v??0)>0){const K=await Ao("Zeit abgelaufen, dein Standort wird einmalig geteilt.");await kt(p,async C=>{const X=C==null?void 0:C.durationInput,me=C==null?void 0:C.durationInput2;if(b===X&&(me??0)>0)if(K==="desc"){const se=await _o();if(!se)return;try{const ae=await Xe(),{latitude:on,longitude:sn,accuracy:et}=ae.coords,tt=Date.now();et<=100?await J(f(p,"locations"),{title:"Automatischer Standort",lat:on,lon:sn,accuracy:et,description:se,timestamp:tt}):await J(f(p,"locations"),{description:se,timestamp:tt})}catch{await J(f(p,"locations"),{description:se,timestamp:Date.now()})}Ye(me)}else await Co()})||It()}else alert("Zeit abgelaufen, jetzt musst du deinen Live-Standort in der WhatsApp-Gruppe teilen."),await kt(p,async()=>{await Promise.all([A(f(p,"timer/duration")),A(f(p,"timer/startTime")),A(f(p,"timerMessage"))]),clearInterval(U),ee(!1),l&&(l.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--"),u&&(u.innerText="‚è≥ Mister X Timer: --:--"),h&&(h.innerText="‚è≥ Aktueller Timer: --:--"),oe("Zeit abgelaufen!","Mister X muss sich per Live-Standort zeigen","all")})||It()}catch(d){c("Fehler im Ablauf-Handling:",d)}}finally{n=!1}}},1e3)}async function Ao(e){return new Promise(t=>{const n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100vw",n.style.height="100vh",n.style.background="rgba(0,0,0,0.7)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="9999";const o=document.createElement("div");o.style.background="#fff",o.style.padding="2em",o.style.borderRadius="10px",o.style.maxWidth="90vw",o.style.textAlign="center",o.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>${e}</strong><br>
        Du kannst optional eine Beschreibung hinzuf√ºgen (z.B. falls GPS ungenau ist oder du dich in der U-Bahn befindest).
      </div>
      <button id="loc-ok-btn" style="margin:0 1em 0 0;">OK</button>
      <button id="loc-desc-btn">Standort-Beschreibung hinzuf√ºgen</button>
    `,n.appendChild(o),document.body.appendChild(n),document.getElementById("loc-ok-btn").onclick=()=>{document.body.removeChild(n),t("ok")},document.getElementById("loc-desc-btn").onclick=()=>{document.body.removeChild(n),t("desc")}})}function Jt(e,t){return`${e}_${t}`}function Bo(e){const t=`alertShown_${e}`;return sessionStorage.getItem(t)==="1"?!1:(sessionStorage.setItem(t,"1"),!0)}async function Po(e,t=48*60*60*1e3){let n=Date.now();try{const l=await T(f(e,".info/serverTimeOffset")),u=typeof l.val()=="number"?l.val():0;n+=u}catch{}const o=n-t,i=_t(f(e,"timerClaims"),Dt("at"),mn(o)),s=await T(i),a={};s.exists()&&s.forEach(l=>{const u=l.val();typeof(u==null?void 0:u.at)=="number"&&u.at<=o&&(a[`timerClaims/${l.key}`]=null)}),Object.keys(a).length&&await N(f(e),a)}async function kt(e,t){var y;const o=(await T(f(e,"timer"))).val()||{},{startTime:i,duration:s}=o;if(typeof i!="number"||typeof s!="number")return!1;const a=Jt(i,s),r=f(e,`timerClaims/${a}`),l=de(),u=await ke(r,b=>b&&b.claimed?b:{claimed:!0,by:l,at:ie()},{applyLocally:!1}),h=u.committed,d=(y=u.snapshot)==null?void 0:y.val();if(!(h&&d&&d.by===l))return!1;await t(o);try{await Po(e,5*60*1e3)}catch(b){c("GC timerClaims fehlgeschlagen:",b)}return!0}function It(){c("Bereits von anderem Ger√§t erledigt.")}function Mo(){T(f(p,"timer")).then(e=>{if(!e.exists())return;const t=e.val(),n=document.getElementById("timerDurationInput"),o=document.getElementById("timerDurationInput2");!n||!o||(t&&typeof t.durationInput=="number"?n.value=Math.floor(t.durationInput/60):n.value=25,t&&typeof t.durationInput2=="number"?o.value=Math.floor(t.durationInput2/60):o.value=5)})}const Yt=document.createElement("style");Yt.innerHTML=`
@keyframes blinker {
  50% { opacity: 0; }
}
`;document.head.appendChild(Yt);async function Qt(){return(await T(f(p,"timer"))).val()||{}}function en(e){const{startTime:t,duration:n}=e||{};return typeof t=="number"&&typeof n=="number"&&t+n*1e3>Date.now()}async function tn(){try{const e=await Qt();if(en(e))return c("Timer wurde in der Zwischenzeit verl√§ngert - Abbruch vor dem Schreiben."),!0}catch(e){return c("Zweiter Timer-Check fehlgeschlagen:",e),!0}return!1}function Ye(e){oe("Mister X hat sich gezeigt!","Automatische Standort-√úbermittlung",["agent","settings","start"]),Ht(),e!=null?te(e):c("durationInput2 war nicht vorhanden - Timer wird nicht neu gestartet.")}async function De(e){const n=(prompt("Bitte den Standort beschreiben (bzw. wenn U-Bahn, dann gem√§√ü Regelwerk angeben):")||"").trim();return!n||await tn()?!1:(await J(f(p,"locations"),{description:n,timestamp:Date.now()}),Ye(e),!0)}async function Co({autoRetry:e=!0,maxRetries:t=3,retryDelayMs:n=1e4}={}){let o;try{const h=await Qt();if(o=h.durationInput2,en(h)){c("Timer wurde verl√§ngert ‚Äì Abbruch.");return}}catch(h){c("Timer lesen fehlgeschlagen:",h);return}if(!("geolocation"in navigator)){document.getElementById("status").innerText="Geolocation wird nicht unterst√ºtzt.",await De(o);return}let i=Math.max(0,t),s=!1;const a={enableHighAccuracy:!0,maximumAge:0,timeout:15e3},r=async h=>{if(await tn())return;const{latitude:d,longitude:m,accuracy:y}=h.coords,b=Date.now();if(y>100){document.getElementById("status").innerText="‚ö†Ô∏è Standort ungenau (¬±"+Math.round(y)+" m). Bitte Standortbeschreibung manuell eingeben.",await De(o);return}await J(f(p,"locations"),{title:"Automatischer Standort",lat:d,lon:m,accuracy:y,timestamp:b}),Ye(o)},l=()=>{!e||i<=0||(i--,setTimeout(()=>{navigator.geolocation.getCurrentPosition(r,u,a)},n))},u=async h=>{let d="‚ùå Fehler beim Abrufen des Standorts.";switch(h.code){case h.PERMISSION_DENIED:d+=" Zugriff verweigert.";break;case h.POSITION_UNAVAILABLE:d+=" Standortinformationen nicht verf√ºgbar.";break;case h.TIMEOUT:d+=" Zeit√ºberschreitung bei der Standortabfrage.";break}d+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=d,s||(s=!0,await De(o)),(h.code===h.TIMEOUT||h.code===h.POSITION_UNAVAILABLE)&&l()};navigator.geolocation.getCurrentPosition(r,u,a)}async function _o(){return new Promise(e=>{const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0,0,0,0.7)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="9999";const n=document.createElement("div");n.style.background="#fff",n.style.padding="2em",n.style.borderRadius="10px",n.style.maxWidth="90vw",n.style.textAlign="center",n.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>Standort-Beschreibung hinzuf√ºgen</strong><br>
        Bitte gib eine Beschreibung deines Standorts ein.
      </div>
      <textarea id="desc-input" rows="3" style="width:90%;"></textarea><br>
      <button id="desc-cancel-btn" style="margin-top:1em;">Abbrechen</button>
      <button id="desc-ok-btn" style="margin-top:1em; margin-left:1em;">OK</button>
    `,t.appendChild(n),document.body.appendChild(t),document.getElementById("desc-ok-btn").onclick=()=>{const o=document.getElementById("desc-input").value.trim();document.body.removeChild(t),e(o||null)},document.getElementById("desc-cancel-btn").onclick=()=>{document.body.removeChild(t),e(null)}})}function ee(e){const t=document.getElementById("startTimerButton");t&&(t.disabled=e,t.style.opacity=e?"0.5":"1",t.style.pointerEvents=e?"none":"auto",t.style.cursor=e?"default":"pointer")}function Do(){localStorage.getItem("nachrichtAktiv")?(document.getElementById("permissionButton").style.display="none",document.getElementById("permissionButton2").style.display="block"):(document.getElementById("permissionButton").style.display="block",document.getElementById("permissionButton2").style.display="none")}async function Fo(){if(confirm("M√∂chtest du wirklich alle gespeicherten Standorte l√∂schen?"))try{await A(f(p,"locations")),alert("Alle Standorte wurden gel√∂scht."),hn=[];const e=document.getElementById("status");e&&(e.innerText=""),await ro(!0),Se()}catch(e){c(e),alert("Fehler beim L√∂schen der Standorte.")}}async function Ro(){await A(f(p,"timer/duration")),await A(f(p,"timer/startTime")),await A(f(p,"timerMessage")),clearInterval(U),ee(!1);try{await D.rpc("cancel_and_unschedule")}catch(o){c("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",o)}const e=document.getElementById("timer"),t=document.getElementById("agentTimer"),n=document.getElementById("settingsTimer");e&&(e.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--"),t&&(t.innerText="‚è≥ Mister X Timer: --:--"),n&&(n.innerText="‚è≥ Aktueller Timer: --:--"),oe("Timer zur√ºckgesetzt","Der Timer wurde zur√ºckgesetzt!","all")}function $o(){const e=document.getElementById("max_Team_X").value;A(f(p,"settings/max_Team_X")).then(()=>P(f(p,"settings/max_Team_X"),Number(e))).then(()=>{c("max_Team_X erfolgreich gespeichert:",e)}).catch(t=>{c("Fehler beim Speichern von max_Team_X:",t)})}function Oo(){const e=document.getElementById("max_Team_X");T(f(p,"settings/max_Team_X")).then(t=>{t.exists()?(e.value=t.val(),c("max_Team_X geladen:",t.val())):c("Kein max_Team_X-Wert gefunden.")}).catch(t=>{c("Fehler beim Laden von max_Team_X:",t)})}function No(){const t=document.getElementById("timerDurationInput").value*60;A(f(p,"timer/durationInput")).then(()=>P(f(p,"timer/durationInput"),Number(t))).then(()=>{c("Duration_input:",t)}).catch(n=>{c("Fehler beim Speichern von DurationInput:",n)})}function jo(){const t=document.getElementById("timerDurationInput2").value*60;A(f(p,"timer/durationInput2")).then(()=>P(f(p,"timer/durationInput2"),Number(t))).then(()=>{c("Duration_input2:",t)}).catch(n=>{c("Fehler beim Speichern von DurationInput2:",n)})}async function zo(){if(!("serviceWorker"in navigator))throw new Error("Service Worker wird vom Browser nicht unterst√ºtzt.");const e="/Mister-X/",t=await navigator.serviceWorker.getRegistration(e);if(t)return t;const n=`${e}firebase-messaging-sw.js`;return navigator.serviceWorker.register(n,{scope:e,type:"module"})}function Wo(){var e,t;return((e=window.matchMedia)==null?void 0:e.call(window,"(display-mode: standalone)").matches)||((t=window.navigator)==null?void 0:t.standalone)===!0}async function qo(){const e={notificationsAPI:"Notification"in window,serviceWorker:"serviceWorker"in navigator,pushManager:"PushManager"in window,standalone:Wo(),fcm:!1};try{e.fcm=await ze()}catch{e.fcm=!1}return e}async function Et(e){!e||!S||await P(f(p,`notifications/${e}/recipients/${S}`),!0)}function xt(e){try{const t=e&&e.messageId;if(t){if(ve.has(t))return;ve.add(t)}if(t&&typeof Et=="function"&&Et(t).catch(n=>c("Markieren fehlgeschlagen:",n)),document.visibilityState==="visible"){const n=e&&e.title?e.title:"Nachricht",o=e&&e.body?e.body:"";setTimeout(()=>{alert(`${n}
${o}`)},1e3)}}catch(t){c("handleInAppMessage error:",t)}}setInterval(()=>{ve.size>5e3&&ve.clear()},60*1e3);async function Uo(){if(!("serviceWorker"in navigator))return;const e=await navigator.serviceWorker.ready;if(!e.active)return;const t=5e3;return await new Promise(n=>{const o=new MessageChannel,i=setTimeout(()=>{o.port1.onmessage=null,c("[SW-Log] PING -> Timeout (wir versuchen GET_SW_LOGS trotzdem)"),n()},t);o.port1.onmessage=s=>{s.data&&s.data.type==="PONG"&&(clearTimeout(i),c("[SW-Log] PONG empfangen"),n())},e.active.postMessage({type:"PING"},[o.port2])}),new Promise(n=>{const o=new MessageChannel,i=setTimeout(()=>{n()},t);o.port1.onmessage=s=>{s.data&&s.data.type==="SW_LOGS"&&(clearTimeout(i),Array.isArray(s.data.logs)&&s.data.logs.forEach(a=>{a&&a.msg&&c("[SW-Log]",new Date(a.ts).toLocaleTimeString(),a.msg)}),e.active.postMessage({type:"CLEAR_SW_LOGS"}),n())},e.active.postMessage({type:"GET_SW_LOGS"},[o.port2])})}function Ho(){const e=document.getElementById("agentReqEnabledCheckbox");e&&(T(f(p,at)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,localStorage.setItem(it,n?"1":"0"),Lt(n)}),e.addEventListener("change",async()=>{const t=e.checked;await P(f(p,at),t),localStorage.setItem(it,t?"1":"0"),Lt(t)}))}function Lt(e){const t=document.getElementById("btnRequestAgents");t&&(t.style.display=e?"":"none")}function Go(){const e=document.getElementById("messageToggle");e&&(T(f(p,rt)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,localStorage.setItem(st,n?"1":"0")}),e.addEventListener("change",async()=>{const t=e.checked;await P(f(p,rt),t),localStorage.setItem(st,t?"1":"0")}))}async function Vo(){var e,t,n,o,i,s;xn();try{const a=await qo();if(a&&a.fcm){$||($=Te(V)),window.__swMsgListenerAdded||(navigator.serviceWorker.addEventListener("message",b=>{var w;if(b&&b.data&&b.data.type==="PUSH"){const v=b.data.payload||{};(w=navigator.serviceWorker.controller)==null||w.postMessage({type:"PUSH",payload:v,userAgent:navigator.userAgent}),xt(v),c("[Page] SW-Message empfangen",v)}}),window.__swMsgListenerAdded=!0);let y=null;un($,b=>{var v;const w=b&&b.data?b.data:{};w.messageId&&w.messageId===y||(y=w.messageId||null,(v=navigator.serviceWorker.controller)==null||v.postMessage({type:"PUSH",payload:b,userAgent:navigator.userAgent}),xt(w),c("[Page] FCM onMessage empfangen",b))})}navigator.serviceWorker.addEventListener("message",y=>{var b;((b=y==null?void 0:y.data)==null?void 0:b.type)==="PUSH_SUBSCRIPTION_CHANGED"&&Ae({force:!0}).catch(c)}),(async()=>await kn("pushSubscriptionChangedAt")&&(await Ae({force:!0}).catch(c),await In("pushSubscriptionChangedAt")))();const r=document.getElementById("enablePush"),l=document.getElementById("pushHint");r&&(!a.fcm&&/iPhone|iPad|iPod/i.test(navigator.userAgent)&&!a.standalone?(r.style.display="none",l&&(l.textContent="Installiere die App zum Home-Bildschirm, um Benachrichtigungen zu aktivieren.",l.style.display="block")):!a.fcm||!a.notificationsAPI||!a.serviceWorker||!a.pushManager?(r.style.display="none",l&&(l.textContent="Benachrichtigungen werden von diesem Browser/Modus nicht unterst√ºtzt.",l.style.display="block")):Notification.permission==="granted"?(r.textContent="Benachrichtigungen sind aktiv",r.disabled=!0):(r.addEventListener("click",enablePush,{once:!0}),r.style.display="inline-flex")),ee(!0),document.getElementById("btnRequestAgents").style.display="none";const u=localStorage.getItem("activeView")||"start";u!=="start"&&Je(u),Ht(),await oo(),Lo(),Mo(),Do(),Ae(),po(),Kn(),eo(),Ge(),wo(),await uo(),mo(),so(),io(),Uo().catch(()=>{}),Ho(),Go();const h=document.getElementById("toggleAgentLocations");h&&(h.checked=ye,h.addEventListener("change",()=>{ye=!!h.checked;try{localStorage.setItem(Ot,ye?"1":"0")}catch{}Xt()})),(e=document.getElementById("toggleTracking"))==null||e.addEventListener("change",y=>{y.target.checked?Gn():Gt()}),(t=document.getElementById("toggleFollow"))==null||t.addEventListener("change",y=>{Ft=y.target.checked});const d=document.getElementById("clearLocalStorageBtn");d&&d.addEventListener("click",()=>{confirm("M√∂chtest du wirklich alle gespeicherten Daten (localStorage) l√∂schen?")&&(localStorage.clear(),sessionStorage.clear(),alert("Alle lokalen Daten wurden gel√∂scht. Die Seite wird neu geladen."),location.reload())});const m=document.getElementById("photoInput");m&&m.addEventListener("change",function(){var b;if((b=this.files)==null?void 0:b[0]){window.fotoHochgeladen=!0;const w=document.getElementById("status");w&&(w.innerText="üì∏ Foto ausgew√§hlt!")}})}catch(a){alert("Fehler in startScript: "+((a==null?void 0:a.message)??String(a))),(o=(n=document.getElementById("startView"))==null?void 0:n.style)==null||o.setProperty("display","block"),(s=(i=document.getElementById("startView2"))==null?void 0:i.style)==null||s.setProperty("display","block")}}function c(...e){console.log(...e);const t=document.getElementById("settingsLog");if(!t)return;const n=new Date().toLocaleTimeString(),o=document.createElement("div");o.innerHTML=`<strong>[${n}]</strong>`,e.forEach(i=>{if(typeof i=="object"){const s=document.createElement("details"),a=document.createElement("summary");a.textContent="Objekt anzeigen",s.appendChild(a);const r=document.createElement("pre");r.textContent=JSON.stringify(i,null,2),s.appendChild(r),o.appendChild(s)}else o.innerHTML+=` ${i}`}),t.appendChild(o),t.scrollTop=t.scrollHeight}window.switchView=Je;window.requestPermission=Sn;window.sendLocationWithPhoto=Cn;window.startTimer=te;window.goBack=we;window.save_timer_duration=No;window.save_timer_duration2=jo;window.save_max_mister_x=$o;window.resetTimer=Ro;window.deleteAllLocations=Fo;window.resetAllMisterXRollen=Eo;window.removeNotificationSetup=Ln;window.mxState=window.mxState||{};window.mxState.selectedPost=null;window.openCloseTeamSettings=zn;window.closeTeamSettings=Ut;window.leaveTeam=Ve;window.createTeam=Wn;window.joinTeam=qn;window.triggerAgentLocationRequest=ho;window.resetAgentLocations=bo;function nn(e){window.mxState.selectedPost=e}function Ko(){return window.mxState.selectedPost}document.addEventListener("DOMContentLoaded",Vo);
