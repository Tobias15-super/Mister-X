import{i as Wt,g as gt,a as Ut,b as we,c as Ht,u as F,r as g,d as T,e as Ne,f as pt,s as O,h as be,p as V,j as x,k as qt,l as Y,o as Vt,m as H,q as ht,n as Kt,t as yt,v as Xt,R as Gt}from"./vendor_firebase-k7avh9Mj.js";import{c as Zt}from"./vendor-O8nsH46x.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();const Jt={apiKey:"AIzaSyC-jTMiDjHNTC6cvSKUU44mVbWwT-ToLxQ",authDomain:"mister-x-d6b59.firebaseapp.com",databaseURL:"https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app",projectId:"mister-x-d6b59",storageBucket:"mister-x-d6b59.firebasestorage.app",messagingSenderId:"616391598963",appId:"1:616391598963:web:da07882b0f481d3000db06",measurementId:"G-W66SK677NG"},q=Wt(Jt),p=gt(q);Ut(q);we(q);let U,Ze=!1,f,Yt=[],R;const D={};let Z=null;const he=new Set;let b=localStorage.getItem("deviceId")||null;const X="https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app";let oe=null,P=null,$=null,wt=!1;const ke="showNotifHeader",bt="currentTeamId";let k=null,N={},le={deviceTeam:null,teams:null},vt=null,ne=[];const St="showAgentLocations",Je="lastRespondedAgentReqId";let fe=(localStorage.getItem(St)??"1")==="1",E,z,ue;L.icon({iconUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});const Qt=[[48.21778257924239,16.37016154994435],[48.217247563322225,16.37076456217454],[48.21741142779978,16.371253762059183],[48.216865105563464,16.37191529883514],[48.21581506144457,16.37290646405736],[48.21417125610604,16.373948000332064],[48.21430769576697,16.3745721914746],[48.21333498613118,16.37539386682008],[48.2122964590416,16.377294652276152],[48.211699711347876,16.38092342451245],[48.211941642178076,16.38467493512273],[48.20913524997675,16.384032997995277],[48.20434428995476,16.380677464805487],[48.20267440663029,16.378771628716105],[48.202516949057625,16.378787036085683],[48.2021791301039,16.378713275337773],[48.20032081399359,16.37673193693543],[48.20046567888107,16.376081501249317],[48.19987161819025,16.37355423682974],[48.19981183801774,16.372899054744835],[48.200631534154375,16.369653382537916],[48.20071916193201,16.369103424638855],[48.200163223194544,16.368756078571426],[48.19948213275357,16.368406050294983],[48.19950721778074,16.3679406870309],[48.1998469538764,16.366987161726104],[48.19976119600531,16.366945587486374],[48.199786280895815,16.366662614435302],[48.199852484835134,16.36658080706035],[48.199605825841886,16.366136901468384],[48.199689907919776,16.365894161552536],[48.199997462783195,16.365407340616333],[48.20007450484762,16.36539258846675],[48.200780727683785,16.364471249670135],[48.20235733493688,16.36143133067089],[48.202316181915776,16.361391179971125],[48.20252539808658,16.36095263879719],[48.20263271531552,16.36073672097149],[48.20274853131339,16.36083590228765],[48.20475579365605,16.35819251441422],[48.20494354858451,16.357837121719747],[48.205074099582546,16.357685576910406],[48.20502589015989,16.357555489773183],[48.20506169808996,16.357492457861333],[48.205261965068914,16.357456248039632],[48.20626549207577,16.356030140071557],[48.20666774752276,16.35550308600013],[48.20697347295606,16.355354223399804],[48.20918910891197,16.354601648098285],[48.20921597664341,16.35491948986655],[48.20929110567211,16.354928877598102],[48.20938410911258,16.354983862882907],[48.212403444290665,16.35518085630021],[48.212634067324394,16.355560388875816],[48.214753862701514,16.35585677297196],[48.21482540908184,16.356370415998313],[48.21454632473899,16.35850592710254],[48.21435355993972,16.36025556372129],[48.21477999581608,16.361298310706765],[48.21461086605676,16.3615351876565],[48.214799725889385,16.361933238614775],[48.21476774885914,16.362013013827934],[48.214317217645544,16.362474541146735],[48.21554996828477,16.365200001058092],[48.21618181295601,16.36659154989541],[48.21691897070536,16.368248676490595],[48.21768157297474,16.36988155904141],[48.21778257924239,16.37016154994435]],en=[[-90,-180],[-90,180],[90,180],[90,-180]],Ie=L.polygon([en,Qt],{color:"red",weight:3,fillColor:"rgba(255, 0, 0, 0.3)",fillOpacity:.35,interactive:!1,pane:"maskPane",dashArray:"5, 5"}),tn={blau:"#1E90FF",gruen:"#2ECC71",rot:"#FF5252",gelb:"#F4D03F",orange:"#FF8C00",lila:"#8E44AD",schwarz:"#333333",grau:"#7F8C8D"};Ht(q,{provider:new Gt("6LcVXbQrAAAAAI5Wgi8DenjAM4cz-ubrfcwIRPVJ"),isTokenAutoRefreshEnabled:!0});window.onerror=function(e,t,n,o,i){alert("JS-Fehler: "+e+" in "+t+" Zeile "+n)};const M=Zt("https://axirbthvnznvhfagduyj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4aXJidGh2bnpudmhmYWdkdXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMDI2MTcsImV4cCI6MjA2ODg3ODYxN30.wfJm9e10_iNuYm_r3es_FmKuXBePsxSjIJcVqmSuYjc");async function nn(e){const t=localStorage.getItem("role")||"start";try{const{error:n}=await M.from("fcm_tokens").delete().eq("device_name",b);n?c("❌ Fehler beim Löschen aus Supabase:",n):c("✅ Alter Token aus Supabase gelöscht.");const{error:o}=await M.from("fcm_tokens").upsert({token:e,device_name:b,role:t});o?c("❌ Fehler beim Speichern des Tokens:",o):c("✅ Token erfolgreich gespeichert.")}catch(n){c("❌ Supabase Exception:",n)}}function Ce(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()==="";)e=prompt("Bitte gib deinen Namen ein"),e===null&&alert("Du musst einen Namen eingeben, um fortzufahren.");return localStorage.setItem("deviceId",e.trim()),e.trim()}try{localStorage.setItem("test","1")}catch{alert("⚠️ Dein Browser blockiert lokalen Speicher. Bitte verlasse den privaten Modus oder ändere die Einstellungen.")}async function on(){try{if(!await Ne()){alert("❌ Push-Benachrichtigungen werden in diesem Browser/Modus nicht unterstützt.");return}if(!("Notification"in window)){alert("❌ Notification API nicht verfügbar.");return}const t=await Notification.requestPermission();if(t!=="granted"){c("Benachrichtigungen nicht erlaubt:",t),alert("⚠️ Benachrichtigungen wurden abgelehnt.");return}const n=await xo();c("Service Worker registriert mit Scope:",n.scope),localStorage.setItem("serviceWorkerRegistered","true"),R||(R=we(q));const o=await pt(R,{serviceWorkerRegistration:n,vapidKey:"BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE"});if(!o){c("Kein Token erhalten."),alert("⚠️ Kein Token erhalten. Bitte erneut versuchen.");return}localStorage.setItem("fcmToken",o),c("Token:",o),await O(g(p,`tokens/${b}`),o),await F(g(p,`roles/${b}`),{role:"start"}),await nn(o),localStorage.setItem("nachrichtAktiv","true");const i=document.getElementById("permissionButton");i&&(i.style.display="none"),an(b).then(()=>{alert("✅ Benachrichtigungen aktiviert!")})}catch(e){c("Fehler bei Berechtigung/Registrierung/Token:",e),alert("❌ Fehler: "+((e==null?void 0:e.message)??String(e)))}}async function an(e){const t=await cn("app-db","settings");return new Promise((n,o)=>{const i=t.transaction("settings","readwrite");i.objectStore("settings").put(e,"deviceName"),i.oncomplete=()=>{t.close(),n(!0)},i.onerror=()=>{t.close(),o(i.error)}})}async function sn(e){const t=await new Promise((n,o)=>{const i=indexedDB.open("app-db");i.onupgradeneeded=()=>{const a=i.result;a.objectStoreNames.contains("sw-flags")||a.createObjectStore("sw-flags")},i.onsuccess=()=>n(i.result),i.onerror=()=>o(i.error)});try{return await new Promise(n=>{const a=t.transaction("sw-flags","readonly").objectStore("sw-flags").get(e);a.onsuccess=()=>{t.close(),n(a.result||null)},a.onerror=()=>{t.close(),n(null)}})}catch{return null}}async function rn(e){const t=await new Promise((n,o)=>{const i=indexedDB.open("app-db");i.onupgradeneeded=()=>{const a=i.result;a.objectStoreNames.contains("sw-flags")||a.createObjectStore("sw-flags")},i.onsuccess=()=>n(i.result),i.onerror=()=>o(i.error)});await new Promise(n=>{const o=t.transaction("sw-flags","readwrite");o.objectStore("sw-flags").delete(e),o.oncomplete=()=>{t.close(),n()},o.onerror=()=>{t.close(),n()}})}async function Ee(e={}){const{force:t=!1,vapidKey:n="BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE",touchWhenUnchanged:o=!0}=e;if(typeof Notification>"u"||Notification.permission!=="granted"||localStorage.getItem("serviceWorkerRegistered")!=="true")return c("🔕 Token-Refresh übersprungen: Keine Berechtigung oder kein SW."),null;try{const i=await navigator.serviceWorker.ready;let a=null;try{a=await pt(R,{serviceWorkerRegistration:i,vapidKey:n})}catch(r){return c("❌ Fehler bei getToken:",r),null}if(!a)return c("⚠️ Kein Token beim Refresh erhalten."),null;const s=localStorage.getItem("fcmToken");if(t||a!==s){c("🔄 Token aktualisiert:",a),await O(g(p,"tokens/"+b),a);try{const{error:r}=await M.from("fcm_tokens").upsert({token:a,device_name:b},{onConflict:"device_name"});r?c("❌ Fehler beim Upsert in Supabase:",r):c("✅ Token in Supabase upserted.")}catch(r){c("❌ Supabase Upsert Exception:",r)}return localStorage.setItem("fcmToken",a),localStorage.setItem("nachrichtAktiv","true"),a}else return c("ℹ️ Token ist unverändert."),a}catch(i){return c("❌ Fehler beim Token-Refresh:",i),null}}async function cn(e,t){return new Promise((n,o)=>{const i=indexedDB.open(e);i.onupgradeneeded=()=>{const a=i.result;a.objectStoreNames.contains(t)||a.createObjectStore(t)},i.onsuccess=()=>{const a=i.result;if(a.objectStoreNames.contains(t))return n(a);const s=a.version+1;a.close();const r=indexedDB.open(e,s);r.onupgradeneeded=()=>{const l=r.result;l.objectStoreNames.contains(t)||l.createObjectStore(t)},r.onsuccess=()=>n(r.result),r.onerror=()=>o(r.error)},i.onerror=()=>o(i.error)})}async function ln(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()==="";)e=prompt("Bitte gib deinen Namen ein"),e===null&&alert("Du musst einen Namen eingeben, um fortzufahren.");e=e.trim(),localStorage.setItem("deviceId",e),b=e;let t=xt(),n=t.tel||null,o=!!t.noTel,i;try{i=await yn(e)}catch(r){c("[askForDeviceIdAndPhone] Konnte Remote-Status nicht laden:",r),i={exists:!1,allowSmsFallback:null,tel:null}}let a=!1;if(i.allowSmsFallback===null?(a=!0,o=!1):i.allowSmsFallback===!1?a=!1:i.allowSmsFallback===!0&&!i.tel&&(a=!0),i.allowSmsFallback===!0&&i.tel){Ye({tel:i.tel,allowSmsFallback:!0,noTel:!1}),await Qe(e,i.tel,!0);return}if(a&&!o||a&&i.allowSmsFallback===null)for(;!n||!pn(n);){let r=prompt(`Bitte gib deine Telefonnummer für SMS-Fallback ein (+43… oder 0664…)
Du kannst auch leer lassen, wenn du keine SMS möchtest.`);if(r===null||r.trim()===""){n=null,o=!0;break}n=wn(r.trim()),n||alert("Ungültige Nummer. Bitte im Format +43… oder 0664… eingeben.")}const s=!!n;Ye({tel:n,allowSmsFallback:s,noTel:o}),await Qe(e,n,s)}async function un(){try{const e=await Ne().catch(()=>!1);R||(R=we(q));const t=localStorage.getItem("fcmToken");if(e)try{await qt(R),c("✅ deleteToken: lokaler FCM-Token invalidiert")}catch(n){c("⚠️ deleteToken fehlgeschlagen:",n)}try{await x(g(p,`tokens/${b}`)),c("✅ RTDB-Token entfernt für",b)}catch(n){c("⚠️ RTDB-Remove fehlgeschlagen:",n)}try{const{error:n}=await M.from("fcm_tokens").delete().or(`device_name.eq.${b}${t?`,token.eq.${t}`:""}`);n?c("⚠️ Supabase-Delete Fehler:",n):c("✅ Supabase-Einträge entfernt")}catch(n){c("⚠️ Supabase-Delete (catch):",n)}if("serviceWorker"in navigator){const n=await navigator.serviceWorker.getRegistrations();for(const o of n)try{const i=await o.pushManager.getSubscription();i&&(await i.unsubscribe(),c("✅ Push-Subscription gekündigt für",o.scope))}catch(i){c("⚠️ unsubscribe warn:",i)}await Promise.all(n.map(o=>o.unregister())),c("✅ Alle Service Worker unregistriert")}try{if(window.caches){const n=await caches.keys();await Promise.all(n.map(o=>caches.delete(o))),c("✅ Alle Caches gelöscht:",n)}}catch(n){c("⚠️ Cache cleanup warn:",n)}try{indexedDB.deleteDatabase("app-db"),c('✅ IndexedDB "app-db" gelöscht')}catch(n){c("⚠️ IndexedDB delete warn:",n)}localStorage.removeItem("fcmToken"),localStorage.removeItem("nachrichtAktiv"),localStorage.removeItem("serviceWorkerRegistered");try{const n=document.getElementById("permissionButton"),o=document.getElementById("permissionButton2");n&&(n.style.display=""),o&&(o.style.display="none")}catch{}setTimeout(()=>{alert("🔕 Benachrichtigungen deaktiviert. Die Seite wird neu geladen…"),location.reload()},150)}catch(e){c(e),alert("❌ Deaktivieren fehlgeschlagen: "+((e==null?void 0:e.message)??String(e)))}}function dn(e,t=[],n,o=15,{rtdbBase:i=X,rolesPath:a="roles",recipientsPath:s="notifications",idempotencyFlag:r="smsTriggered",secret:l=typeof SMS_FALLBACK_SECRET<"u"?SMS_FALLBACK_SECRET:"",rtdbAuth:d}={}){if(!e)throw new Error("[Fallback] messageId fehlt");if(!Array.isArray(t)||t.length===0)return c("[Fallback] keine Empfänger - Fallback nicht geplant"),Promise.resolve({ok:!0,skipped:"no_recipients"});if(!i)throw new Error("[Fallback] rtdbBase fehlt");const w={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),waitSec:o,rtdbBase:i,rolesPath:a,recipientsPath:s,idempotencyFlag:r,...d?{rtdbAuth:d}:{}},m={};return l&&(m["x-sms-secret"]=l),M.functions.invoke("sms-fallback",{body:w,headers:m}).then(({data:u,error:h})=>h?(c("[Fallback] Edge call failed",h),{ok:!1,error:h.message||"invoke failed"}):(c("[Fallback] scheduled:",u),u)).catch(u=>(c("[Fallback] Konnte SMS-Fallback nicht planen:",u),{ok:!1,error:(u==null?void 0:u.message)||String(u)}))}function Tt(e,t=[],n,{rtdbBase:o=X,rolesPath:i="roles",recipientsPath:a="notifications",rtdbAuth:s,requireConsent:r=!0,maxRecipientsPerCall:l,writeDeliveredTimestamp:d=!0}={}){if(!e)return Promise.resolve({ok:!1,error:"Missing messageId"});if(!Array.isArray(t)||t.length===0)return c==null||c("[sms-direct] keine Empfänger - nichts zu senden"),Promise.resolve({ok:!0,skipped:"no_recipients"});const w={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),...o?{rtdbBase:o}:{},rolesPath:i,recipientsPath:a,...s?{rtdbAuth:s}:{},requireConsent:r,...Number.isFinite(l)?{maxRecipientsPerCall:l}:{},writeDeliveredTimestamp:d};return M.functions.invoke("sms-direct",{body:w}).then(({data:m,error:u})=>u?(c==null||c("[sms-direct] Edge call failed",u),{ok:!1,error:u.message||"invoke failed"}):(c==null||c("[sms-direct] sent:",m),m)).catch(m=>(c==null||c("[sms-direct] Fehler beim Senden:",m),{ok:!1,error:(m==null?void 0:m.message)||String(m)}))}function ie(){try{const e=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:void 0,t=e&&e.crypto;if(t&&typeof t.randomUUID=="function")return t.randomUUID();if(t&&typeof t.getRandomValues=="function"){const n=new Uint8Array(16);t.getRandomValues(n),n[6]=n[6]&15|64,n[8]=n[8]&63|128;const o=a=>a.toString(16).padStart(2,"0"),i=Array.from(n,o).join("");return`${i.slice(0,8)}-${i.slice(8,12)}-${i.slice(12,16)}-${i.slice(16,20)}-${i.slice(20)}`}}catch{}return`${Date.now()}-${Math.random().toString(36).slice(2,10)}`}async function kt(e,t,n=[],o={}){const{recipientDeviceNames:i=[],link:a="/Mister-X/",attempt:s=1,maxAttempts:r=5,waitSec:l=15,sendEndpoint:d="https://axirbthvnznvhfagduyj.supabase.co/functions/v1/send-to-all",rtdbBase:w=X,messageId:m,instantSMSDevices:u=[]}=o,h=m??ie(),y=(typeof Ce=="function"?Ce():null)||"unknown",S=s===1,B=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,body:t,tokens:n,senderName:y,link:a,messageId:h,rtdbBase:w,recipientDeviceNames:S?i:[],setRecipientsMode:S?"set_once":"none",attempt:s})});let A={};try{A=await B.json()}catch{}c(`📦 Versuch ${s}: status=${B.status}`,A);const W=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);S&&i.length>0&&dn(h,i,W,15,{rtdbBase:X}),S&&u.length>0&&Tt(h,u,W,{rtdbBase:X});const C=Array.isArray(A==null?void 0:A.failedTokens)?A.failedTokens:[];return C.length>0&&s<r?(c(`🔁 Wiederhole für ${C.length} fehlgeschlagene Tokens in 10s...`),setTimeout(()=>{kt(e,t,C,{recipientDeviceNames:i,link:a,attempt:s+1,maxAttempts:r,waitSec:l,sendEndpoint:d,rtdbBase:w,messageId:h}).catch(c)},1e4)):s>=r?c("⏱️ Max. Anzahl an Versuchen erreicht."):c("✅ Alle Benachrichtigungen verarbeitet."),A}async function G(e,t,n,o={}){const[i,a]=await Promise.all([T(g(p,"roles")),T(g(p,"tokens"))]),s=i.exists()?i.val():{},r=a.exists()?a.val():{},l=Array.isArray(n)?n:[n],d=l.length===1&&l[0]==="all",w=[],m=[],u=[],h=Array.from(new Set([...Object.keys(s||{}),...Object.keys(r||{})]));for(const C of h){const _=s[C]||{},ce=_.role,Se=_.notification!==!1,Xe=_.instantSMS===!0;if(!(d||ce&&l.includes(ce))||!Se)continue;if(Xe){u.push(C),m.push(C);continue}const ee=Et(r[C]);ee.length>0&&(w.push(...ee),m.push(C))}const y=ae(w),S=ae(m),v=ae(u),B=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280),A=o.rtdbBase??X,W=o.messageId??ie();return console.log("[sendNotificationToRoles] instantSMS:",v),console.log("[sendNotificationToRoles] tokens:",y.length),y.length>0?kt(e,t,y,{recipientDeviceNames:S,link:o.link||"/Mister-X/",waitSec:typeof o.waitSec=="number"?o.waitSec:45,sendEndpoint:o.sendEndpoint,rtdbBase:A,messageId:W,instantSMSDevices:v}):v.length>0?(console.log("[sendNotificationToRoles] Nur Instant-SMS, keine Push-Tokens."),await Tt(W,v,B,{rtdbBase:A}),{ok:!0,onlySms:!0,smsCount:v.length,messageId:W}):(console.warn(`⚠️ Keine passenden Empfänger für Rollen "${Array.isArray(n)?n.join(","):n}".`),{ok:!0,skipped:"no_recipients"})}async function mn(e){const t=Array.isArray(e)?e:[e],[n,o]=await Promise.all([T(g(p,"roles")),T(g(p,"tokens"))]),i=n.exists()?n.val():{},a=o.exists()?o.val():{},s=t.length===1&&t[0]==="all",r=[],l=[];for(const d in a){if(!Object.prototype.hasOwnProperty.call(a,d))continue;const w=i[d]||{},m=w.role,u=w.notification!==!1;if(!(s||m&&t.includes(m))||!u)continue;const y=Et(a[d]);y.length!==0&&(r.push(...y),l.push(d))}return{tokens:ae(r),deviceNames:ae(l)}}function fn(e,t){const n="Misterx-upload",o=new FormData;o.append("file",e),o.append("upload_preset",n),fetch("https://api.cloudinary.com/v1_1/ddvf141hb/image/upload",{method:"POST",body:o}).then(i=>i.json()).then(i=>{i.secure_url&&i.public_id?t({url:i.secure_url}):alert("Fehler beim Hochladen zu Cloudinary.")}).catch(i=>{c("Upload-Fehler:",i),alert("Fehler beim Hochladen zu Cloudinary.")})}async function gn(){const e=document.getElementById("photoInput").files[0],t=document.getElementById("manualLocationDescription").value.trim(),n=document.getElementById("manualLocationContainer"),o=document.getElementById("status"),i=Mo();if(!i){alert("Bitte zuerst einen Posten auswählen.");return}if(!e){alert("Bitte ein Foto auswählen.");return}const a=Date.now();let s={lat:null,lon:null,accuracy:null};if(!(n&&n.style.display!=="none"&&t!==""))if(navigator.geolocation)try{const y=await Ve(),{latitude:S,longitude:v,accuracy:B}=y.coords;if(B>100){o.innerText=`⚠️ Standort ungenau (±${Math.round(B)} m). Bitte erneut versuchen oder Standortbeschreibung eingeben.`,n.style.display="block";return}s={lat:S,lon:v,accuracy:B}}catch(y){xe==null||xe(y),n.style.display="block"}else o.innerText="Geolocation wird nicht unterstützt.",n.style.display="block";const{color:r,postId:l,title:d}=i,w=g(p,`posten/${r}/active`);o.innerText="⏳ Reserviere Farbe…";try{const y=await be(w,S=>S===!0?!1:S);if(!y.committed||y.snapshot.val()!==!1){o.innerText="❌ Diese Farbe ist bereits inaktiv. Liste wird aktualisiert.";return}}catch(y){o.innerText="❌ Konnte Farbe nicht reservieren.",c(y);return}try{await F(g(p),{[`posten/${r}/${l}/visited`]:!0})}catch(y){o.innerText="❌ Konnte Posten nicht auf 'visited' setzen.",c(y);return}const m={color:r,postId:l,title:d,timestamp:a,description:t||null,lat:s.lat,lon:s.lon},u=V(g(p,"locations"),m),h=`${d} (${r.toUpperCase()})`;G==null||G("Mister X hat sich gezeigt!",h,["agent","settings","start"]),J(),fn(e,async({url:y})=>{try{await F(u,{photoURL:y})}catch(S){c("Foto-URL konnte nicht gesetzt werden",S)}}),document.getElementById("photoInput").value="",document.getElementById("manualLocationDescription").value="",n.style.display="none",document.getElementById("postenSearch").value="",jt(null),o.innerText="✅ Posten/Farbe gemeldet & Foto wird hochgeladen.",J==null||J()}function xe(e){let t="❌ Fehler beim Abrufen des Standorts.";switch(e.code){case e.PERMISSION_DENIED:t+=" Zugriff verweigert.";break;case e.POSITION_UNAVAILABLE:t+=" Standortinformationen nicht verfügbar.";break;case e.TIMEOUT:t+=" Zeitüberschreitung bei der Standortabfrage.";break}t+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=t}function pn(e){return typeof e=="string"&&/^\+43\d{4,13}$/.test(e)}function It(e){return e.replace(/[.#$/\[\]\/]/g,"_")}function ae(e){return Array.from(new Set(e))}function Et(e){return e?typeof e=="string"?[e]:Array.isArray(e)?e.filter(Boolean):typeof e=="object"?Object.keys(e).filter(Boolean):[]:[]}function hn(e){const t=String(e).trim();return t.startsWith("+")?"+"+t.slice(1).replace(/\D/g,""):t.replace(/\D/g,"")}function xt(){try{return JSON.parse(localStorage.getItem("mrx_sms_prefs_v1"))??{allowSmsFallback:!1,tel:null,noTel:!1,lastUpdated:0}}catch{return{allowSmsFallback:!1,tel:null,noTel:!1,lastUpdated:0}}}function Ye(e){const t=xt(),n={allowSmsFallback:!!(e.allowSmsFallback??t.allowSmsFallback),tel:e.tel===void 0?t.tel:e.tel,noTel:e.noTel===void 0?t.noTel:e.noTel,lastUpdated:Date.now()};return localStorage.setItem("mrx_sms_prefs_v1",JSON.stringify(n)),n}async function yn(e){const t=It(e),n=await T(g(p,`roles/${t}`));if(!n.exists())return{exists:!1,allowSmsFallback:null,tel:null};const o=n.val()||{};return{exists:!0,allowSmsFallback:o.allowSmsFallback!==void 0?!!o.allowSmsFallback:null,tel:o.tel??null}}function wn(e){if(!e)return null;let t=hn(e);if(t.startsWith("+43"))return/^\+43\d{4,13}$/.test(t)?t:null;if(t.startsWith("0")){const n="+43"+t.slice(1);return/^\+43\d{4,13}$/.test(n)?n:null}if(t.startsWith("43")){const n="+"+t;return/^\+43\d{4,13}$/.test(n)?n:null}if(/^\d{5,}$/.test(t)&&t[0]!=="0"){const n="+43"+t;return/^\+43\d{4,13}$/.test(n)?n:null}return null}async function Qe(e,t,n){const o=It(e);gt(q);const i={tel:t??null,allowSmsFallback:!!n,...t?{telUpdatedAt:Date.now()}:{}};await F(g(p,`roles/${o}`),i)}const I=e=>document.getElementById(e),je=e=>e&&(e.style.display=""),We=e=>e&&(e.style.display="none"),ve=e=>{try{localStorage.setItem(bt,e||"")}catch{}},bn=()=>{try{return localStorage.getItem(bt)||""}catch{return""}};function Lt(e){return typeof e=="number"?e:e&&typeof e=="object"&&typeof e.seconds=="number"?e.seconds*1e3:0}function Bt(e){return e?`${String(e)}`:"Unbekannt"}function vn(e){const t=(e||"").trim();if(t.length<2)throw new Error("Der Teamname muss mindestens 2 Zeichen lang sein.");if(t.length>24)throw new Error("Der Teamname darf maximal 24 Zeichen lang sein.");return t}function j(e){return(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Le(e=""){return j(e).replace(/`/g,"&#096;")}function _e(e){const t=(e==null?void 0:e.members)||{};return Object.keys(t).length}function Sn(e,t=b){return!!(e!=null&&e.members)&&!!e.members[t]}function Tn(){bn()?(I("teamStatusName").textContent="(lädt…)",I("teamStatusCount").textContent="-"):(I("teamStatusName").textContent="Kein Team",I("teamStatusCount").textContent="-"),Ue()}document.addEventListener("DOMContentLoaded",Tn);function kn(){je(I("teamSettings")),We(I("startView")),Ue()}function In(){je(I("startView")),We(I("teamSettings"))}function Ue(){if(!le.deviceTeam){const e=g(p,`deviceTeams/${b}`),t=n=>{k=n.val()||null,ve(k||""),et(),tt(),nt()};H(e,t),le.deviceTeam={ref:e,handler:t}}if(!le.teams){const e=g(p,"teams"),t=n=>{N=n.val()||{},et(),tt(),nt()};H(e,t),le.teams={ref:e,handler:t}}}function et(){const e=I("currentTeamName"),t=I("currentTeamMembers"),n=I("leaveTeamBtn"),o=k?N[k]:null;if(!o){e.textContent="Kein Team",t&&(t.innerHTML="— Mitglieder"),n&&(n.disabled=!0);return}e.textContent=o.name||"(ohne Namen)";const i=Object.entries(o.members||{}).map(([s,r])=>({id:s,joinedAt:Lt(r==null?void 0:r.joinedAt)})).sort((s,r)=>s.joinedAt!==r.joinedAt?s.joinedAt-r.joinedAt:s.id.localeCompare(r.id)),a=i.map(s=>{const r=s.id===b,l=Bt(s.id)+(r?" (Du)":"");return`<li class="ts-member ${r?"me":""}" title="${j(s.id)}">${j(l)}</li>`}).join("");t&&(t.innerHTML=`
      <div class="muted">${i.length} Mitglied(er)</div>
      ${i.length>0?`<ul class="ts-member-list">${a}</ul>`:'<div class="muted">Noch keine Mitglieder</div>'}
    `),n&&(n.disabled=!Sn(o))}function tt(){const e=I("teamList"),t=I("teamsEmpty");if(!e)return;e.innerHTML="";const n=Object.entries(N||{}).filter(([,o])=>o&&typeof o=="object");if(n.length===0){t&&je(t);return}t&&We(t),n.sort((o,i)=>{const a=_e(o[1]),s=_e(i[1]);return a!==s?s-a:(o[1].name||"").localeCompare(i[1].name||"")});for(const[o,i]of n){const a=Object.entries(i.members||{}).map(([l,d])=>({id:l,joinedAt:Lt(d==null?void 0:d.joinedAt)})).sort((l,d)=>l.joinedAt!==d.joinedAt?l.joinedAt-d.joinedAt:l.id.localeCompare(d.id)),s=a.map(l=>{const d=l.id===b,w=Bt(l.id)+(d?" (Du)":"");return`<li class="ts-member ${d?"me":""}" title="${j(l.id)}">${j(w)}</li>`}).join(""),r=document.createElement("div");r.className="ts-team",r.innerHTML=`
      <div>
        <div style="font-weight:600">${j(i.name||"(ohne Namen)")}</div>
        <div class="muted">${a.length} Mitglied(er)</div>
        <ul class="ts-member-list">
          ${s||""}
        </ul>
      </div>
      <div>
        ${k===o?'<button class="danger" onclick="leaveTeam()">Verlassen</button>':`<button onclick="joinTeam('${o}', this)">Beitreten</button>`}
      </div>
    `,e.appendChild(r)}}function nt(){const e=I("teamStatusName"),t=I("teamStatusCount"),n=k?N[k]:null;if(!n){e.textContent="Kein Team",t.textContent="-";return}e.textContent=n.name||"(ohne Namen)",t.textContent=`${_e(n)} Mitglied(er)`}async function En(){const e=I("createTeamBtn"),t=I("createTeamInput");try{e.disabled=!0;const n=vn(t.value);k&&await He(k);const i=V(g(p,"teams")).key,a={};a[`teams/${i}`]={name:n,createdAt:Y(),createdBy:b,members:{[b]:{joinedAt:Y()}}},a[`deviceTeams/${b}`]=i,await F(g(p),a),ve(i),t.value=""}catch(n){alert((n==null?void 0:n.message)||"Team konnte nicht erstellt werden."),c(n)}finally{e.disabled=!1}}async function xn(e,t){if(!e)return;if(!N[e]){alert("Team existiert nicht (mehr).");return}t&&(t.disabled=!0);try{k&&k!==e&&await He(k);const o={};o[`teams/${e}/members/${b}`]={joinedAt:Y()},o[`deviceTeams/${b}`]=e,await F(g(p),o),ve(e)}catch(o){alert((o==null?void 0:o.message)||"Beitritt nicht möglich."),c(o)}finally{t&&(t.disabled=!1)}}async function He(e=null){const t=e||k;if(!t)return;const n=g(p,`teams/${t}`);await be(n,o=>o&&(o.members&&o.members[b]&&(delete o.members[b],Object.keys(o.members).length===0)?null:o)),await O(g(p,`deviceTeams/${b}`),null),ve("")}function Ln(){const e=document.getElementById("map");e.style.display=""}function De(e,t){if(Ln(),f)f.setView([e,t],15),f.invalidateSize(),$e(),Re();else{f=L.map("map").setView([e,t],15);const n=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}),o=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"© CartoDB"}),i=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles © Esri"}),a=L.tileLayer("http://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web/default/WEBMERCATOR/{z}/{y}/{x}.png",{maxZoom:18,attribution:"TopPlus Open © GeoBasis-DE / BKG"}),s=L.tileLayer("https://tile.jawg.io/jawg-streets/{z}/{x}/{y}{r}.png?access-token=sxLNDIsEdS0kt8fQKhSLB1Z7wVp3ZkV78F5HhvIElZWKDuahhvgWnCZkOceLTzYS",{attribution:"© Jawg"}),r={Standard:n,"Jawg Street":s,Reduziert:o,Satellit:i,Plan:a};n.addTo(f),L.control.layers(r).addTo(f),setTimeout(()=>f.invalidateSize(),0),$e(),Re()}qe()}function $e(){f&&(f.getPane("maskPane")||(f.createPane("maskPane"),f.getPane("maskPane").style.zIndex=300),f.getPane("historyPane")||(f.createPane("historyPane"),f.getPane("historyPane").style.zIndex=410),f.getPane("postenPane")||(f.createPane("postenPane"),f.getPane("postenPane").style.zIndex=400),f.getPane("agentenPane")||(f.createPane("agentenPane"),f.getPane("agentenPane").style.zIndex=420),f.getPane("userPane")||(f.createPane("userPane"),f.getPane("userPane").style.zIndex=450))}function Re(){E||(E=L.layerGroup()),z||(z=L.layerGroup()),ue||(ue=L.layerGroup()),f&&(f.hasLayer(E)||E.addTo(f),f.hasLayer(z)||z.addTo(f),f.hasLayer(ue)||ue.addTo(f))}function Bn(e){if(!f)return;Re(),z.clearLayers();const t=new L.Icon.Default;t.options.shadowSize=[0,0],e.forEach(o=>{L.marker([o.lat,o.lon],{pane:"historyPane",icon:t}).addTo(z).bindPopup(`📍 ${new Date(o.timestamp).toLocaleTimeString()}`)});const n=e.map(o=>[o.lat,o.lon]);n.length>1&&L.polyline(n,{color:"blue",weight:3,opacity:.7,smoothFactor:1,pane:"historyPane"}).addTo(z)}function At(){H(g(p,"locations"),e=>{var s,r,l,d,w,m;const t=e.val()||null;let n=[],o=[],i=null;try{n=Object.values(t).sort((u,h)=>h.timestamp-u.timestamp),o=n.filter(u=>u.lat!=null&&u.lon!=null),i=o.length===0}catch{i=!0}if(i)De(48.208672092667435,16.372477270381918),c("Keine Locations");else if(o.length>0){const{lat:u,lon:h}=o[0];De(u,h)}if(Pn(),o.length>0?Bn(o):z&&z.clearLayers(),qe(),ye({nonDestructive:!0}),console.log("map id",f==null?void 0:f._leaflet_id),console.log("postenPane exists?",!!(f!=null&&f.getPane("postenPane"))),console.log("postenPane zIndex",(r=(s=f==null?void 0:f.getPane("postenPane"))==null?void 0:s.style)==null?void 0:r.zIndex),console.log("historyPane zIndex",(d=(l=f==null?void 0:f.getPane("historyPane"))==null?void 0:l.style)==null?void 0:d.zIndex),console.log("userPane zIndex",(m=(w=f==null?void 0:f.getPane("userPane"))==null?void 0:w.style)==null?void 0:m.zIndex),console.log("postenLayer on map?",f==null?void 0:f.hasLayer(E)),console.log("postenMarkers count",Object.keys(D||{}).length),f&&Ie&&typeof Ie.addTo=="function")try{Ie.addTo(f)}catch(u){c("Fehler beim Hinzufügen von mask:",u)}document.getElementById("map").style.display="block";const a=document.getElementById("locationFeed");a.innerHTML="",n.length>0&&n.forEach((u,h)=>{const y=u.title?u.title:"Automatischer Standort",S=u.timestamp?new Date(u.timestamp).toLocaleTimeString():"",v=u.photoURL?`<img src="${u.photoURL}" alt="Foto" class="zoomable-photo" style="max-width: 100%; max-height: 60vh; border: 1px solid #ccc; margin-top: 5px; cursor: zoom-in;" data-index="${h}">`:"",B=document.createElement("div");B.style.marginBottom="1em",B.innerHTML=`
          <strong class="location-title" data-lat="${u.lat}" data-lon="${u.lon}" style="cursor: pointer;">${y} (${S})</strong><br>
          ${u.description?`<em>📍 ${u.description}</em><br>`:""}
          ${v}
        `,a.appendChild(B)}),document.querySelectorAll(".location-title").forEach(u=>{u.addEventListener("click",()=>{const h=parseFloat(u.dataset.lat),y=parseFloat(u.dataset.lon);f&&!isNaN(h)&&!isNaN(y)&&f.setView([h,y],17)})}),document.querySelectorAll(".zoomable-photo").forEach(u=>{u.addEventListener("click",()=>{const h=document.createElement("div");h.style.position="fixed",h.style.top="0",h.style.left="0",h.style.width="100vw",h.style.height="100vh",h.style.backgroundColor="rgba(0,0,0,0.8)",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center",h.style.zIndex="9999",h.innerHTML=`<img src="${u.src}" style="max-width: 90%; max-height: 90%; border: 2px solid white;">`,h.addEventListener("click",()=>{document.body.removeChild(h)}),document.body.appendChild(h)})})})}function An(){if(!navigator.geolocation){alert("❌ Geolocation wird nicht unterstützt.");return}oe==null&&(oe=navigator.geolocation.watchPosition(e=>{const{latitude:t,longitude:n,accuracy:o}=e.coords;if(!f)return;const i={radius:7,color:"#007AFF",fillColor:"#ffffffff",fillOpacity:.8,opacity:1,weight:2},a={radius:o,color:"#007AFF",fillColor:"#007AFF",interactive:!1,fillOpacity:.2,weight:1,opacity:.4};if(P?(P.setLatLng([t,n]),P.getPopup()&&P.getPopup().setContent(`<strong>Dein Standort</strong><br>Genauigkeit: ±${Math.round(o)} m`)):P=L.circleMarker([t,n],{markerStyle:i,pane:"userPane"}).bindPopup(`<strong>Dein Standort</strong><br>Genauigkeit: ±${Math.round(o)} m`).addTo(f),$?($.setLatLng([t,n]),$.setRadius(o)):$=L.circle([t,n],{...a,pane:"historyPane"}).addTo(f),wt){const s=Math.max(f.getZoom(),16);f.setView([t,n],s,{animate:!0})}},e=>{c("Geolocation-Fehler:",e),Pt(),alert("⚠️ Tracking gestoppt: "+e.message)},{enableHighAccuracy:!0,timeout:15e3,maximumAge:5e3}))}function Pt(){oe!=null&&(navigator.geolocation.clearWatch(oe),oe=null),f&&P&&(f.removeLayer(P),P=null),f&&$&&(f.removeLayer($),$=null)}function Pn(){f&&(P&&!f.hasLayer(P)&&P.addTo(f),$&&!f.hasLayer($)&&$.addTo(f))}function Mn(){const e=document.getElementById("refreshBtn");e&&e.addEventListener("click",async()=>{e.classList.add("updating");try{await Cn({timeoutMs:2500})}catch(t){c("[Refresh] Fehler im Update-Flow:",t),window.location.reload()}})}async function Cn({timeoutMs:e=2500}={}){if(!("serviceWorker"in navigator)){window.location.reload();return}const t=await navigator.serviceWorker.getRegistration();if(!t){c("[Refresh] Keine SW-Registration gefunden -> normaler Reload"),window.location.reload();return}c("[Refresh] Vor Update:",Rn(t)),await t.update();let n=t.installing||t.waiting||null;n||(n=await _n(t,800)),n?(await Dn(n),t.waiting&&(c("[Refresh] Sende SKIP_WAITING an Waiting-SW"),t.waiting.postMessage({type:"SKIP_WAITING"}))):c("[Refresh] Keine neue SW gefunden -> normaler Reload"),await $n(e),window.location.reload()}function _n(e,t){return new Promise(n=>{let o;const i=()=>{e.removeEventListener("updatefound",i),clearTimeout(o),n(e.installing||e.waiting||null)};e.addEventListener("updatefound",i),o=setTimeout(()=>{e.removeEventListener("updatefound",i),n(null)},t)})}function Dn(e){return new Promise(t=>{if(e.state==="installed"||e.state==="activated")return t();e.addEventListener("statechange",()=>{(e.state==="installed"||e.state==="activated")&&t()})})}function $n(e){return new Promise(t=>{let n=!1;const o=()=>{n||(n=!0,navigator.serviceWorker.removeEventListener("controllerchange",i),t())},i=()=>{c("[Refresh] controllerchange empfangen"),o()};navigator.serviceWorker.addEventListener("controllerchange",i),setTimeout(()=>{c("[Refresh] controllerchange-Timeout, lade dennoch neu"),o()},e)})}function Rn(e){const t=n=>n?n.state:"—";return{scope:e.scope,active:t(e.active),installing:t(e.installing),waiting:t(e.waiting),controlled:!!navigator.serviceWorker.controller}}function Fn(){let e=0;const t=15e3,n=async()=>{const o=Date.now();if(!(o-e<t)){e=o;try{const i=await navigator.serviceWorker.getRegistration();if(!i)return;await i.update(),i.waiting&&i.waiting.postMessage({type:"SKIP_WAITING"})}catch{}}};document.addEventListener("visibilitychange",()=>{document.hidden||n()}),window.addEventListener("focus",n)}function On(e,t,n){const o=tn[e]||"#666";return n?{radius:10,color:o,fillColor:o,fillOpacity:.9,opacity:1,weight:3}:t===!1?{radius:6,color:o,fillColor:o,fillOpacity:.25,opacity:.4,weight:1}:{radius:9,color:o,fillColor:o,fillOpacity:.7,opacity:.9,weight:2}}function ot(e,t,n,o){const i=n.title||t,a=!!n.visited,s=o?"aktiv":"inaktiv",r=a?"✅ besucht":"🕒 offen",l=n.imageUrl?`
      <div class="posten-preview" style="margin-top:6px">
        <img
          class="posten-preview-img"
          src="${Le(n.imageUrl)}"
          data-fullsrc="${Le(n.imageUrl)}"
          alt="${Le(i)}"
          loading="lazy"
          style="width:100%;height:auto;max-height:120px;object-fit:contain;border-radius:8px;cursor:zoom-in;display:block"
          referrerpolicy="no-referrer"
        />
      </div>
    `:"";return`
    <div class="posten-popup" style="min-width:200px">
      <strong>${j(i)}</strong><br>
      <small>Farbe: ${j(e)} (${s})</small><br>
      <small>Status: ${r}</small>
      ${l}
    </div>
  `}function zn(e){const t=e.lat??e.latitude??null,n=e.lon??e.lng??e.longitude??null;return{lat:t,lon:n}}async function Nn(){const e=g(p,"posten"),t=await T(e);Z=t.exists()?t.val():null,ye(),H(e,n=>{Z=n.exists()?n.val():null,ye()})}function jn(){const e=document.getElementById("img-lightbox"),t=document.getElementById("img-lightbox-close");if(!e||!t)return;const n=()=>e.style.display="none";t.addEventListener("click",n),e.addEventListener("click",o=>{o.target===e&&n()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&n()})}function Wn(){const e=t=>{const n=t.target.closest(".posten-preview-img");if(!n)return;t.preventDefault(),t.stopPropagation();const o=n.getAttribute("alt")||"Bild",i=n.getAttribute("data-fullsrc")||n.getAttribute("src");i&&Un(i,o)};document.addEventListener("click",e,{capture:!0})}function Un(e,t=""){const n=document.getElementById("img-lightbox"),o=document.getElementById("img-lightbox-img");!n||!o||(n.style.display="flex",o.onload=null,o.onerror=null,o.alt=t||"Bild",o.src===e&&(o.src=""),o.src=e)}function qe(){E||(E=L.layerGroup()),f&&!f.hasLayer(E)&&E.addTo(f)}function ye(e={}){const{nonDestructive:t=!1}=e;if(!f||!Z)return;$e(),qe();const n=new Set;let o=0;if(Object.entries(Z).forEach(([i,a])=>{if(!a||typeof a!="object")return;const s=!!a.active,r=Object.fromEntries(Object.entries(a).filter(([l])=>l!=="active"));Object.entries(r).forEach(([l,d])=>{var y,S;if(!d||typeof d!="object")return;const{lat:w,lon:m}=zn(d);if(w==null||m==null)return;o++;const u=`${i}/${l}`;n.add(u);const h=On(i,s,!!d.visited);if(D[u]){const v=D[u];v.setLatLng([w,m]),v.setStyle(h),v._postenLoc=d,v._postenId=u,E&&!E.hasLayer(v)&&v.addTo(E),(y=v.bringToFront)==null||y.call(v),(S=v.getPopup())==null||S.setContent(ot(i,l,d,s))}else{const v=L.circleMarker([w,m],{...h,pane:"postenPane"}).bindPopup(ot(i,l,d,s));v._postenLoc=d,v._postenId=u,v.addTo(E),D[u]=v}})}),!t){if(o===0){c("[posten] Kein gültiger Posten geparst - Cleanup übersprungen.");return}Object.keys(D).forEach(i=>{n.has(i)||(E.removeLayer(D[i]),delete D[i])})}}Object.keys(D).forEach(e=>{seen.has(e)||(E.removeLayer(D[e]),delete D[e])});async function Hn(e=!0){const t=g(p,"posten"),n=await T(t);if(!n.exists())return;const o=n.val(),i={};Object.entries(o).forEach(([a,s])=>{!s||typeof s!="object"||(i[`posten/${a}/active`]=e,Object.entries(s).forEach(([r,l])=>{r==="active"||!l||typeof l!="object"||(i[`posten/${a}/${r}/visited`]=!1)}))}),await F(g(p),i)}const de=e=>e*Math.PI/180;function qn(e,t,n,o){const a=de(n-e),s=de(o-t),r=Math.sin(a/2)**2+Math.cos(de(e))*Math.cos(de(n))*Math.sin(s/2)**2;return 2*6371e3*Math.asin(Math.sqrt(r))}function Ve(e={enableHighAccuracy:!0,timeout:8e3,maximumAge:0}){return new Promise((t,n)=>{if(!navigator.geolocation)return n(new Error("Geolocation nicht unterstützt"));navigator.geolocation.getCurrentPosition(t,n,e)})}function Mt({excludeVisited:e=!0}={}){const t=[];for(const[n,o]of Object.entries(Z))if(!(!o||o.active!==!0))for(const[i,a]of Object.entries(o.posts||{}))!a||typeof a!="object"||e&&a.visited===!0||t.push({color:n,postId:i,...a});return t}function ge(e){const t=document.getElementById("postenSuggestions");if(!e||e.length===0){t.style.display="none",t.innerHTML="";return}t.innerHTML=e.map(n=>{const o=n.distance!=null?` - ${(n.distance/1).toFixed(0)} m`:"";return`<div class="item" data-color="${n.color}" data-postid="${n.postId}">
              ${n.title||"(ohne Titel)"}
              <span class="tag">${n.color}</span>${o}
            </div>`}).join(""),t.style.display="block",t.querySelectorAll(".item").forEach(n=>{n.addEventListener("click",()=>{var d,w;const o=n.getAttribute("data-color"),i=n.getAttribute("data-postid"),a=(w=(d=Z[o])==null?void 0:d.posts)==null?void 0:w[i];if(!a){c("Ausgewählter Posten nicht im Cache gefunden:",{color:o,postId:i}),document.getElementById("status").innerText="Dieser Posten ist nicht mehr verfügbar.",t.style.display="none";return}const s={color:o,postId:i,title:a.title||i,lat:a.lat??null,lon:a.lon??null};jt(s);const r=document.getElementById("postenSearch");r&&(r.value=`${s.title} [${o}]`),t.style.display="none";const l=document.getElementById("status");l&&(l.innerText=`✅ Posten ausgewählt: ${s.title} (${o})`)})})}function Ct(e){const t=(e||"").trim().toLowerCase(),n=Mt();return t?n.filter(o=>{const i=String(o.postId).toLowerCase(),a=String(o.title||"").toLowerCase(),s=String(o.color).toLowerCase();return i.includes(t)||a.includes(t)||s.includes(t)}).slice(0,25):[]}async function Vn(e=5){try{const t=await Ve(),{latitude:n,longitude:o,accuracy:i}=t.coords;i>100&&(document.getElementById("status").innerText=`⚠️ Standort ungenau (±${Math.round(i)} m). Ergebnisse evtl. ungenau.`);const a=Mt().map(s=>({...s,distance:s.lat!=null&&s.lon!=null?qn(n,o,s.lat,s.lon):Number.POSITIVE_INFINITY}));return a.sort((s,r)=>s.distance-r.distance),a.slice(0,e)}catch{return document.getElementById("status").innerText="📍 Konnte Standort nicht bestimmen. Du kannst trotzdem per Suche auswählen.",[]}}async function Kn(){const e=g(p,"posten");H(e,t=>{const n=t.val()||{},o={};for(const[a,s]of Object.entries(n)){if(!s||typeof s!="object")continue;const{active:r,...l}=s,d={};for(const[w,m]of Object.entries(l))m&&typeof m=="object"&&(d[w]=m);o[a]={active:!!r,posts:d}}Z=o;const i=document.getElementById("postenSearch").value;i&&ge(Ct(i))})}function Xn(){const e=document.getElementById("postenSearch"),t=document.getElementById("nearbyBtn");let n;e.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=Ct(e.value);ge(o)},150)}),t.addEventListener("click",async()=>{const o=await Vn(20);if(o.length===0){ge(o),document.getElementById("status").innerText="Keine nahegelegenen Posten gefunden (oder Standort unbekannt).";return}ge(o)}),document.addEventListener("click",o=>{const i=document.getElementById("postenSuggestions");i.contains(o.target)||e.contains(o.target)||t.contains(o.target)||(i.style.display="none")})}const re=document.getElementById("notifHeader"),se=document.getElementById("notifHeaderToggle"),Be=document.getElementById("notifSummary"),Gn=document.getElementById("notifDetails"),it=document.getElementById("notifStatusDot"),at=document.getElementById("notifTimeShort"),st=document.getElementById("notifTitle"),rt=document.getElementById("notifBody"),ct=document.getElementById("notifSender"),lt=document.getElementById("notifTime"),ut=document.getElementById("notifId"),Ae=document.getElementById("recipientList"),me=document.getElementById("notifCount"),te=document.getElementById("toggleNotifHeader");let K=null;function Pe(e){re.style.display=e?"block":"none",!e&&typeof K=="function"&&(K(),K=null)}function Ke(e){re.classList.toggle("collapsed",e),re.classList.toggle("expanded",!e),Gn.hidden=e,se.setAttribute("aria-expanded",String(!e)),se.textContent=e?"▾":"▴"}se==null||se.addEventListener("click",e=>{e.stopPropagation();const t=re.classList.contains("collapsed");Ke(!t)});Be==null||Be.addEventListener("click",()=>{const e=re.classList.contains("collapsed");Ke(!e)});function Zn(e){return new Date(e).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}function Fe(e){if(!e){st.textContent="-",rt.textContent="-",ct.textContent="-",lt.textContent="-",at.textContent="[--:--]",ut.textContent="-",Ae.innerHTML="",it.style.background="#bbb",me&&(me.textContent="-");return}const t=typeof e.timestamp=="number"?e.timestamp:Date.now(),n=Zn(t);st.textContent=e.title||"Ohne Titel",rt.textContent=e.body||"",ct.textContent=e.sender||"Unbekannt",lt.textContent=new Date(t).toLocaleString("de-DE"),at.textContent=`[${n}]`,ut.textContent=e.id??"-";const o=e.recipients||{},i=Object.keys(o),a=i.filter(r=>o[r]===!0).length,s=i.length;it.style.background=s>0&&a===s?"#4caf50":"#ff9800",me&&(me.textContent=`${a}/${s} bestätigt`),Ae.innerHTML="",i.sort((r,l)=>r.localeCompare(l)).forEach(r=>{const l=o[r]===!0,d=document.createElement("div");d.className=`recipient-chip ${l?"ok":"wait"}`,d.innerHTML=`<span class="dot"></span><span>${r}</span><span>${l?"✅":"⏳"}</span>`,Ae.appendChild(d)})}function dt(){typeof K=="function"&&(K(),K=null);const e=ht(g(p,"notifications"),yt("timestamp"),Kt(1)),t=H(e,n=>{const o=n.val();if(!o){Fe(null);return}const[i,a]=Object.entries(o)[0];Fe({id:i,...a})});K=()=>t()}function Jn(){const e=localStorage.getItem(ke)==="1";Pe(e),e&&dt(),te&&(te.checked=e),Ke(!0),te==null||te.addEventListener("change",t=>{t.target.checked?(localStorage.setItem(ke,"1"),Pe(!0),dt()):(localStorage.removeItem(ke),Pe(!1),Fe(null))})}async function Yn(){try{let e=N;(!e||Object.keys(e).length===0)&&(e=(await T(g(p,"teams"))).val()||{});const t={};for(const[i,a]of Object.entries(e)){if(i===k)continue;(a!=null&&a.members?Object.keys(a.members).length:0)>0&&(t[i]=!0)}if(Object.keys(t).length===0){c==null||c("[triggerAgentLocationRequest] Abbruch: keine adressierbaren Teams gefunden."),alert("Keine Teams gefunden, die angefragt werden können.");return}const n=String(Date.now()),o={id:n,createdAt:Y(),createdBy:b,teamsAtRequest:t,responses:{}};return await O(g(p,"agentLocationRequest"),o),G("Mister X hat deinen Standort angefragt","Öffne die App, um deinen Standort freizugeben!",["agent","settings","start"]),c==null||c("[triggerAgentLocationRequest] Anfrage ausgelöst",{reqId:n,totalTeams:Object.keys(t).length}),n}catch(e){throw c==null||c("[triggerAgentLocationRequest] Anfrage fehlgeschlagen",e),alert("Konnte die Anfrage nicht auslösen."),e}}async function Qn(e){var r;if(!k){alert("Du bist in keinem Team. Standortfreigabe abgebrochen.");return}const t=g(p,`agentLocationRequest/responses/${k}`);if((await T(t)).exists()){try{localStorage.setItem(Je,e.id)}catch{}return}const o=await new Promise((l,d)=>{if(!navigator.geolocation)return d(new Error("Geolocation nicht verfügbar"));navigator.geolocation.getCurrentPosition(l,d,{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})}),i=o.coords.latitude,a=o.coords.longitude,s=((r=N==null?void 0:N[k])==null?void 0:r.name)||"Team";alert("Dein Standort wird jetzt freigegeben"),await be(t,l=>l||(c("Standort für AgentLocation ausgesendet"),{teamId:k,teamName:s,lat:i,lon:a,deviceId:b,timestamp:Y()}));try{localStorage.setItem(Je,e.id)}catch{}}function eo(){x(g(p,"agentLocationRequest")),no(),Oe()}function Oe(){Array.isArray(ne)&&ne.length&&window.map&&ne.forEach(e=>f.removeLayer(e)),ne=[]}function to(){const e=g(p,"agentLocationRequest");H(e,n=>{const o=n.exists()?n.val():null;vt=o,_t(o),o&&o.createdBy!==b&&k&&oo(o)})}function no(){const e=document.getElementById("agentReqStatus");e&&(e.style.display="none")}async function oo(e){try{await Qn(e)}catch(t){c("Standortfreigabe fehlgeschlagen",t)}}function _t(e=vt){const t=document.getElementById("agentReqStatus"),n=document.getElementById("agentReqProgress");if(!t||!n)return;if(!e){t.style.display="none",Oe();return}const o=typeof e.createdAt=="number"?new Date(e.createdAt).toLocaleTimeString():"Unbekannt",i=e.responses||{},a=Object.values(i),s=e.teamsAtRequest||{},r=Object.keys(s).length||a.length,l=a.length;if(n.textContent=`Standort von ${l}/${r} Teams – ${o}`,t.style.display="block",Oe(),!(!fe||a.length===0)){io(a);for(const d of a){if(d.lat==null||d.lon==null)continue;const w=L.divIcon({className:`square-marker ${ao(d.teamId)}`,iconSize:[14,14]}),m=L.marker([d.lat,d.lon],{icon:w,pane:"agentenPane"}).addTo(f);m.bindPopup(`<strong>${j(d.teamName||"Team")}</strong>`),ne.push(m)}}}function io(e){if(!window.map){const t=e.find(n=>n.lat!=null&&n.lon!=null);t&&De(t.lat,t.lon)}}function ao(e){const t=["","orange","green","purple","blue","red","yellow","cyan","pink","lime","teal","brown"],n=Math.abs(so(String(e)))%t.length;return t[n]}function so(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}function ro(){T(g(p,"roles")).then(e=>{const t=e.val();for(const n in t)t[n].role==="misterx"&&O(g(p,"roles/"+n),{role:"start",timestamp:Date.now()});alert("Alle Mister X Rollen wurden zurückgesetzt.")})}async function co(){const e=await T(g(p,"settings/max_Team_X")),t=e.exists()?e.val():1,o=(await T(g(p,"roles"))).val();let i=0;for(const a in o)o[a].role==="misterx"&&i++;return i<t}async function Dt(e){if(e!==localStorage.getItem("activeView")){if(e==="misterx"&&!await co()){alert("Es ist bereits ein Gerät als Mister X angemeldet!"),ze();return}if(e==="settings"&&prompt("Passwort eingeben!")!=="1001"){ze();return}}document.getElementById("startView").style.display="none",document.getElementById("startView2").style.display="none",document.querySelectorAll(".view").forEach(n=>n.style.display="none"),e==="misterx"?document.getElementById("misterxView").style.display="block":e==="agent"?document.getElementById("agentView").style.display="block":e==="settings"&&(document.getElementById("settingsView").style.display="block",ko()),localStorage.setItem("activeView",e),F(g(p,"roles/"+b),{role:e,timestamp:Date.now()});const t=e;await M.from("fcm_tokens").update({role:t}).eq("device_name",b),T(g(p,"timer")).then(n=>{const o=n.val();if(o){const{startTime:i,duration:a,durationInput:s,durationInput2:r}=o;a?($t(i,a),Q(!0)):Q(!1)}})}async function ze(){document.querySelectorAll(".view").forEach(t=>t.style.display="none"),document.getElementById("startView").style.display="block",document.getElementById("startView2").style.display="block",clearInterval(U),localStorage.setItem("activeView","start"),F(g(p,"roles/"+b),{role:"start",timestamp:Date.now()}),await M.from("fcm_tokens").update({role:"start"}).eq("device_name",b)}async function J(e){await x(g(p,"timer/duration")),await x(g(p,"timer/startTime")),await x(g(p,"timerMessage")),typeof U<"u"&&clearInterval(U);const n=(await T(g(p,"timer"))).val();let o=25*60;typeof(n==null?void 0:n.durationInput)=="number"&&n.durationInput>0&&(o=n.durationInput,(isNaN(o)||o<1)&&(o=60)),typeof e=="number"&&e>0&&(o=e);const i=Date.now(),a=i+o*1e3,s={title:"Deine Zeit läuft gleich ab",body:"Bitte öffne deine App!"};await O(g(p,"timer"),{startTime:i,duration:o,durationInput:n==null?void 0:n.durationInput,durationInput2:(n==null?void 0:n.durationInput2)||0});try{await M.rpc("cancel_and_unschedule")}catch(m){c("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",m)}const{tokens:r,deviceNames:l}=await mn("misterx"),d=o-60,w=(ie==null?void 0:ie())??void 0;await M.functions.invoke("arm-timer-cron",{body:{title:s.title,body:s.body,dueInSec:d,messageId:w,link:"/Mister-X/",recipientDeviceNames:l,tokens:r,rtdbBase:X}}),c(`🕒 Timer gestartet: ${o}s, fällt um ${new Date(a).toLocaleTimeString()}.`)}function lo(){Ze||(Ze=!0,H(g(p,"timer"),e=>{const t=e.val()||{},{startTime:n=null,duration:o=null,durationInput:i=null,durationInput2:a=null}=t;if(n===null||o===null){clearInterval(U),Q(!1);const s=document.getElementById("timer"),r=document.getElementById("agentTimer"),l=document.getElementById("settingsTimer");s&&(s.innerText="⏳ Zeit bis zum nächsten Posten: --:--"),r&&(r.innerText="⏳ Mister X Timer: --:--"),l&&(l.innerText="⏳ Aktueller Timer: --:--");return}$t(n,o),Q(!0)}))}function $t(e,t){clearInterval(U);let n=!1;U=setInterval(async()=>{if(!n){n=!0;try{let o=function(m){m&&(s<=300&&s>1?(m.style.color="red",m.style.animation="blinker 1s linear infinite"):(m.style.color="",m.style.animation=""))};const i=Date.now(),a=Math.floor((i-e)/1e3),s=t-a;let r;if(s<0)r="abgelaufen";else{const m=Math.floor(s/60),u=s%60;r=`${String(m).padStart(2,"0")}:${String(u).padStart(2,"0")}`}const l=document.getElementById("timer"),d=document.getElementById("agentTimer"),w=document.getElementById("settingsTimer");if(w&&(w.innerText=`⏳ Aktueller Timer: ${r}`,o(w)),l&&(l.innerText=`⏳ Zeit bis zum nächsten Posten: ${r}`,o(l)),d&&(d.innerText=`⏳ Mister X Timer: ${r}`,o(d)),s<=0&&([l,d,w].forEach(m=>{m&&(m.style.color="",m.style.animation="")}),localStorage.getItem("activeView")==="misterx"))try{const u=(await T(g(p,"timer"))).val()||{},{startTime:h,duration:y,durationInput:S,durationInput2:v}=u||{};if(typeof h!="number"||typeof y!="number")return;const B=Rt(h,y);if(!uo(B))return;const W=y===S&&(v??0)>0?`Zeit abgelaufen, dein Standort wird einmalig geteilt.
Tippe auf OK, um fortzufahren.`:`Zeit abgelaufen, jetzt musst du deinen Live-Standort in der WhatsApp-Gruppe teilen.
(Der Timer bleibt bis zu deinem nächsten Posten deaktiviert)`;alert(W),await fo(p,async _=>{const ce=_==null?void 0:_.durationInput,Se=_==null?void 0:_.durationInput2;if(y===ce&&(Se??0)>0)await ho();else{await Promise.all([x(g(p,"timer/duration")),x(g(p,"timer/startTime")),x(g(p,"timerMessage"))]),clearInterval(U),Q(!1);const Te=document.getElementById("timer"),ee=document.getElementById("agentTimer"),Ge=document.getElementById("settingsTimer");Te&&(Te.innerText="⏳ Zeit bis zum nächsten Posten: --:--"),ee&&(ee.innerText="⏳ Mister X Timer: --:--"),Ge&&(Ge.innerText="⏳ Aktueller Timer: --:--"),G("Zeit abgelaufen!","Mister X muss sich per Live-Standort zeigen","all")}})||go()}catch(m){c("Fehler im Ablauf-Handling:",m)}}finally{n=!1}}},1e3)}function Rt(e,t){return`${e}_${t}`}function uo(e){const t=`alertShown_${e}`;return sessionStorage.getItem(t)==="1"?!1:(sessionStorage.setItem(t,"1"),!0)}async function mo(e,t=48*60*60*1e3){let n=Date.now();try{const l=await T(g(e,".info/serverTimeOffset")),d=typeof l.val()=="number"?l.val():0;n+=d}catch{}const o=n-t,i=ht(g(e,"timerClaims"),yt("at"),Xt(o)),a=await T(i),s={};a.exists()&&a.forEach(l=>{const d=l.val();typeof(d==null?void 0:d.at)=="number"&&d.at<=o&&(s[`timerClaims/${l.key}`]=null)}),Object.keys(s).length&&await F(g(e),s)}async function fo(e,t){var h;const o=(await T(g(e,"timer"))).val()||{},{startTime:i,duration:a}=o;if(typeof i!="number"||typeof a!="number")return!1;const s=Rt(i,a),r=g(e,`timerClaims/${s}`),l=Ce(),d=await be(r,y=>y&&y.claimed?y:{claimed:!0,by:l,at:Y()},{applyLocally:!1}),w=d.committed,m=(h=d.snapshot)==null?void 0:h.val();if(!(w&&m&&m.by===l))return!1;await t(o);try{await mo(e,5*60*1e3)}catch(y){c("GC timerClaims fehlgeschlagen:",y)}return!0}function go(){c("Bereits von anderem Gerät erledigt.")}function po(){T(g(p,"timer")).then(e=>{if(!e.exists())return;const t=e.val(),n=document.getElementById("timerDurationInput"),o=document.getElementById("timerDurationInput2");!n||!o||(t&&typeof t.durationInput=="number"?n.value=Math.floor(t.durationInput/60):n.value=25,t&&typeof t.durationInput2=="number"?o.value=Math.floor(t.durationInput2/60):o.value=5)})}const Ft=document.createElement("style");Ft.innerHTML=`
@keyframes blinker {
  50% { opacity: 0; }
}
`;document.head.appendChild(Ft);async function Ot(){return(await T(g(p,"timer"))).val()||{}}function zt(e){const{startTime:t,duration:n}=e||{};return typeof t=="number"&&typeof n=="number"&&t+n*1e3>Date.now()}async function Nt(){try{const e=await Ot();if(zt(e))return c("Timer wurde in der Zwischenzeit verlängert - Abbruch vor dem Schreiben."),!0}catch(e){return c("Zweiter Timer-Check fehlgeschlagen:",e),!0}return!1}function pe(e){G("Mister X hat sich gezeigt!","Automatische Standort-Übermittlung",["agent","settings","start"]),At(),e!=null?J(e):c("durationInput2 war nicht vorhanden - Timer wird nicht neu gestartet.")}async function Me(e){const n=(prompt("Bitte den Standort beschreiben (bzw. wenn U-Bahn, dann gemäß Regelwerk angeben):")||"").trim();return!n||await Nt()?!1:(await V(g(p,"locations"),{description:n,timestamp:Date.now()}),pe(e),!0)}async function ho({autoRetry:e=!0,maxRetries:t=3,retryDelayMs:n=1e4}={}){let o;try{const m=await Ot();if(o=m.durationInput2,zt(m)){c("Timer wurde verlängert – Abbruch.");return}}catch(m){c("Timer lesen fehlgeschlagen:",m);return}if(!("geolocation"in navigator)){document.getElementById("status").innerText="Geolocation wird nicht unterstützt.",await Me(o);return}if(await yo()==="desc"){const m=await wo();if(!m)return;try{const u=await Ve(),{latitude:h,longitude:y,accuracy:S}=u.coords,v=Date.now();S<=100?await V(g(p,"locations"),{title:"Automatischer Standort",lat:h,lon:y,accuracy:S,description:m,timestamp:v}):await V(g(p,"locations"),{description:m,timestamp:v}),pe(o)}catch{await V(g(p,"locations"),{description:m,timestamp:Date.now()}),pe(o)}return}let a=Math.max(0,t),s=!1;const r={enableHighAccuracy:!0,maximumAge:0,timeout:15e3},l=async m=>{if(await Nt())return;const{latitude:u,longitude:h,accuracy:y}=m.coords,S=Date.now();if(y>100){document.getElementById("status").innerText="⚠️ Standort ungenau (±"+Math.round(y)+" m). Bitte Standortbeschreibung manuell eingeben.",await Me(o);return}await V(g(p,"locations"),{title:"Automatischer Standort",lat:u,lon:h,accuracy:y,timestamp:S}),pe(o)},d=()=>{!e||a<=0||(a--,setTimeout(()=>{navigator.geolocation.getCurrentPosition(l,w,r)},n))},w=async m=>{let u="❌ Fehler beim Abrufen des Standorts.";switch(m.code){case m.PERMISSION_DENIED:u+=" Zugriff verweigert.";break;case m.POSITION_UNAVAILABLE:u+=" Standortinformationen nicht verfügbar.";break;case m.TIMEOUT:u+=" Zeitüberschreitung bei der Standortabfrage.";break}u+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=u,s||(s=!0,await Me(o)),(m.code===m.TIMEOUT||m.code===m.POSITION_UNAVAILABLE)&&d()};navigator.geolocation.getCurrentPosition(l,w,r)}async function yo(){return new Promise(e=>{const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0,0,0,0.7)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="9999";const n=document.createElement("div");n.style.background="#fff",n.style.padding="2em",n.style.borderRadius="10px",n.style.maxWidth="90vw",n.style.textAlign="center",n.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>Dein Standort wird jetzt freigegeben.</strong><br>
        Du kannst optional eine Beschreibung hinzufügen (z.B. falls GPS ungenau ist oder du dich in der U-Bahn befindest).
      </div>
      <button id="loc-ok-btn" style="margin:0 1em 0 0;">OK</button>
      <button id="loc-desc-btn">Standort-Beschreibung hinzufügen</button>
    `,t.appendChild(n),document.body.appendChild(t),document.getElementById("loc-ok-btn").onclick=()=>{document.body.removeChild(t),e("ok")},document.getElementById("loc-desc-btn").onclick=()=>{document.body.removeChild(t),e("desc")}})}async function wo(){return new Promise(e=>{const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0,0,0,0.7)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="9999";const n=document.createElement("div");n.style.background="#fff",n.style.padding="2em",n.style.borderRadius="10px",n.style.maxWidth="90vw",n.style.textAlign="center",n.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>Standort-Beschreibung hinzufügen</strong><br>
        Bitte gib eine Beschreibung deines Standorts ein.
      </div>
      <textarea id="desc-input" rows="3" style="width:90%;"></textarea><br>
      <button id="desc-ok-btn" style="margin-top:1em;">Speichern</button>
      <button id="desc-cancel-btn" style="margin-top:1em; margin-left:1em;">Abbrechen</button>
    `,t.appendChild(n),document.body.appendChild(t),document.getElementById("desc-ok-btn").onclick=()=>{const o=document.getElementById("desc-input").value.trim();document.body.removeChild(t),e(o||null)},document.getElementById("desc-cancel-btn").onclick=()=>{document.body.removeChild(t),e(null)}})}function Q(e){const t=document.getElementById("startTimerButton");t&&(t.disabled=e,t.style.opacity=e?"0.5":"1",t.style.pointerEvents=e?"none":"auto",t.style.cursor=e?"default":"pointer")}function bo(){localStorage.getItem("nachrichtAktiv")?(document.getElementById("permissionButton").style.display="none",document.getElementById("permissionButton2").style.display="block"):(document.getElementById("permissionButton").style.display="block",document.getElementById("permissionButton2").style.display="none")}async function vo(){if(confirm("Möchtest du wirklich alle gespeicherten Standorte löschen?"))try{await x(g(p,"locations")),alert("Alle Standorte wurden gelöscht."),Yt=[];const e=document.getElementById("status");e&&(e.innerText=""),await Hn(!0),ye()}catch(e){c(e),alert("Fehler beim Löschen der Standorte.")}}async function So(){await x(g(p,"timer/duration")),await x(g(p,"timer/startTime")),await x(g(p,"timerMessage")),clearInterval(U),Q(!1);try{await M.rpc("cancel_and_unschedule")}catch(o){c("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",o)}const e=document.getElementById("timer"),t=document.getElementById("agentTimer"),n=document.getElementById("settingsTimer");e&&(e.innerText="⏳ Zeit bis zum nächsten Posten: --:--"),t&&(t.innerText="⏳ Mister X Timer: --:--"),n&&(n.innerText="⏳ Aktueller Timer: --:--"),G("Timer zurückgesetzt","Der Timer wurde zurückgesetzt!","all")}function To(){const e=document.getElementById("max_Team_X").value;x(g(p,"settings/max_Team_X")).then(()=>O(g(p,"settings/max_Team_X"),Number(e))).then(()=>{c("max_Team_X erfolgreich gespeichert:",e)}).catch(t=>{c("Fehler beim Speichern von max_Team_X:",t)})}function ko(){const e=document.getElementById("max_Team_X");T(g(p,"settings/max_Team_X")).then(t=>{t.exists()?(e.value=t.val(),c("max_Team_X geladen:",t.val())):c("Kein max_Team_X-Wert gefunden.")}).catch(t=>{c("Fehler beim Laden von max_Team_X:",t)})}function Io(){const t=document.getElementById("timerDurationInput").value*60;x(g(p,"timer/durationInput")).then(()=>O(g(p,"timer/durationInput"),Number(t))).then(()=>{c("Duration_input:",t)}).catch(n=>{c("Fehler beim Speichern von DurationInput:",n)})}function Eo(){const t=document.getElementById("timerDurationInput2").value*60;x(g(p,"timer/durationInput2")).then(()=>O(g(p,"timer/durationInput2"),Number(t))).then(()=>{c("Duration_input2:",t)}).catch(n=>{c("Fehler beim Speichern von DurationInput2:",n)})}async function xo(){if(!("serviceWorker"in navigator))throw new Error("Service Worker wird vom Browser nicht unterstützt.");const e="/Mister-X/",t=await navigator.serviceWorker.getRegistration(e);if(t)return t;const n=`${e}firebase-messaging-sw.js`;return navigator.serviceWorker.register(n,{scope:e,type:"module"})}function Lo(){var e,t;return((e=window.matchMedia)==null?void 0:e.call(window,"(display-mode: standalone)").matches)||((t=window.navigator)==null?void 0:t.standalone)===!0}async function Bo(){const e={notificationsAPI:"Notification"in window,serviceWorker:"serviceWorker"in navigator,pushManager:"PushManager"in window,standalone:Lo(),fcm:!1};try{e.fcm=await Ne()}catch{e.fcm=!1}return e}async function mt(e){!e||!b||await O(g(p,`notifications/${e}/recipients/${b}`),!0)}function ft(e){try{const t=e&&e.messageId;if(t){if(he.has(t))return;he.add(t)}if(t&&typeof mt=="function"&&mt(t).catch(n=>c("Markieren fehlgeschlagen:",n)),document.visibilityState==="visible"){const n=e&&e.title?e.title:"Nachricht",o=e&&e.body?e.body:"";alert(`${n}
${o}`)}}catch(t){c("handleInAppMessage error:",t)}}setInterval(()=>{he.size>5e3&&he.clear()},60*1e3);async function Ao(){if(!("serviceWorker"in navigator))return;const e=await navigator.serviceWorker.ready;if(!e.active)return;const t=5e3;return await new Promise(n=>{const o=new MessageChannel,i=setTimeout(()=>{o.port1.onmessage=null,c("[SW-Log] PING -> Timeout (wir versuchen GET_SW_LOGS trotzdem)"),n()},t);o.port1.onmessage=a=>{a.data&&a.data.type==="PONG"&&(clearTimeout(i),c("[SW-Log] PONG empfangen"),n())},e.active.postMessage({type:"PING"},[o.port2])}),new Promise(n=>{const o=new MessageChannel,i=setTimeout(()=>{n()},t);o.port1.onmessage=a=>{a.data&&a.data.type==="SW_LOGS"&&(clearTimeout(i),Array.isArray(a.data.logs)&&a.data.logs.forEach(s=>{s&&s.msg&&c("[SW-Log]",new Date(s.ts).toLocaleTimeString(),s.msg)}),e.active.postMessage({type:"CLEAR_SW_LOGS"}),n())},e.active.postMessage({type:"GET_SW_LOGS"},[o.port2])})}async function Po(){var e,t,n,o,i,a;ln();try{const s=await Bo();if(s&&s.fcm){R||(R=we(q)),window.__swMsgListenerAdded||(navigator.serviceWorker.addEventListener("message",h=>{if(h&&h.data&&h.data.type==="PUSH"){const y=h.data.payload||{};ft(y),c("[Page] SW-Message empfangen",y)}}),window.__swMsgListenerAdded=!0);let u=null;Vt(R,h=>{const y=h&&h.data?h.data:{};y.messageId&&y.messageId===u||(u=y.messageId||null,ft(y),c("[Page] FCM onMessage empfangen",h))})}navigator.serviceWorker.addEventListener("message",u=>{var h;((h=u==null?void 0:u.data)==null?void 0:h.type)==="PUSH_SUBSCRIPTION_CHANGED"&&Ee({force:!0}).catch(c)}),(async()=>await sn("pushSubscriptionChangedAt")&&(await Ee({force:!0}).catch(c),await rn("pushSubscriptionChangedAt")))();const r=document.getElementById("enablePush"),l=document.getElementById("pushHint");r&&(!s.fcm&&/iPhone|iPad|iPod/i.test(navigator.userAgent)&&!s.standalone?(r.style.display="none",l&&(l.textContent="Installiere die App zum Home-Bildschirm, um Benachrichtigungen zu aktivieren.",l.style.display="block")):!s.fcm||!s.notificationsAPI||!s.serviceWorker||!s.pushManager?(r.style.display="none",l&&(l.textContent="Benachrichtigungen werden von diesem Browser/Modus nicht unterstützt.",l.style.display="block")):Notification.permission==="granted"?(r.textContent="Benachrichtigungen sind aktiv",r.disabled=!0):(r.addEventListener("click",enablePush,{once:!0}),r.style.display="inline-flex"));const d=localStorage.getItem("activeView")||"start";d!=="start"&&Dt(d),At(),await Nn(),lo(),po(),bo(),Ee(),Jn(),Mn(),Fn(),Ue(),to(),await Kn(),Xn(),Wn(),jn(),Ao().catch(()=>{});const w=document.getElementById("toggleAgentLocations");w&&(w.checked=fe,w.addEventListener("change",()=>{fe=!!w.checked;try{localStorage.setItem(St,fe?"1":"0")}catch{}_t()})),(e=document.getElementById("toggleTracking"))==null||e.addEventListener("change",u=>{u.target.checked?An():Pt()}),(t=document.getElementById("toggleFollow"))==null||t.addEventListener("change",u=>{wt=u.target.checked});const m=document.getElementById("photoInput");m&&m.addEventListener("change",function(){var h;if((h=this.files)==null?void 0:h[0]){window.fotoHochgeladen=!0;const y=document.getElementById("status");y&&(y.innerText="📸 Foto ausgewählt!")}})}catch(s){alert("Fehler in startScript: "+((s==null?void 0:s.message)??String(s))),(o=(n=document.getElementById("startView"))==null?void 0:n.style)==null||o.setProperty("display","block"),(a=(i=document.getElementById("startView2"))==null?void 0:i.style)==null||a.setProperty("display","block")}}function c(...e){console.log(...e);const t=document.getElementById("settingsLog");if(!t)return;const n=new Date().toLocaleTimeString(),o=document.createElement("div");o.innerHTML=`<strong>[${n}]</strong>`,e.forEach(i=>{if(typeof i=="object"){const a=document.createElement("details"),s=document.createElement("summary");s.textContent="Objekt anzeigen",a.appendChild(s);const r=document.createElement("pre");r.textContent=JSON.stringify(i,null,2),a.appendChild(r),o.appendChild(a)}else o.innerHTML+=` ${i}`}),t.appendChild(o),t.scrollTop=t.scrollHeight}window.switchView=Dt;window.requestPermission=on;window.sendLocationWithPhoto=gn;window.startTimer=J;window.goBack=ze;window.save_timer_duration=Io;window.save_timer_duration2=Eo;window.save_max_mister_x=To;window.resetTimer=So;window.deleteAllLocations=vo;window.resetAllMisterXRollen=ro;window.removeNotificationSetup=un;window.mxState=window.mxState||{};window.mxState.selectedPost=null;window.openTeamSettings=kn;window.closeTeamSettings=In;window.leaveTeam=He;window.createTeam=En;window.joinTeam=xn;window.triggerAgentLocationRequest=Yn;window.resetAgentLocations=eo;function jt(e){window.mxState.selectedPost=e}function Mo(){return window.mxState.selectedPost}document.addEventListener("DOMContentLoaded",Po);
