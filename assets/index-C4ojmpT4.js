import{F as ze}from"./vendor_leaflet-CAQ_TIzs.js";import{i as vn,g as Kt,a as Sn,b as _e,c as Tn,u as j,r as p,d as k,e as it,f as Vt,s as $,h as pe,p as at,j as D,k as kn,l as Q,o as In,m as G,q as st,n as xn,t as rt,v as we,w as Xt,R as En}from"./vendor_firebase-Drpl5kvo.js";import{a as Ln}from"./vendor-Cj_BHRrm.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();const An={apiKey:"AIzaSyC-jTMiDjHNTC6cvSKUU44mVbWwT-ToLxQ",authDomain:"mister-x-d6b59.firebaseapp.com",databaseURL:"https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app",projectId:"mister-x-d6b59",storageBucket:"mister-x-d6b59.firebasestorage.app",messagingSenderId:"616391598963",appId:"1:616391598963:web:da07882b0f481d3000db06",measurementId:"G-W66SK677NG"},ee=vn(An),y=Kt(ee);Sn(ee);_e(ee);var qt,Ut,Gt;typeof L<"u"&&ze&&((qt=L.Control)!=null&&qt.FullScreen||(L.Control.FullScreen=ze),(Ut=L.control)!=null&&Ut.fullscreen||(L.control.fullscreen=function(e){return new ze(e)}),console.debug("leaflet.fullscreen registered:",!!((Gt=L.control)!=null&&Gt.fullscreen)));let J,vt=!1,Oe=!1,w,Pn=[],U;const H={};let se=null;const Be=new Set;let I=localStorage.getItem("deviceId")||null;const X="https://mister-x-d6b59-default-rtdb.europe-west1.firebasedatabase.app";let be=null,N=null,q=null,Zt=!1;const Ne="showNotifHeader",Jt="currentTeamId";let x=null,M={},ke={deviceTeam:null,teams:null},Yt=null,de=[];const Qt="showAgentLocations",je="lastPromptedAgentReqId",O="lastRespondedAgentReqId";let Le=(localStorage.getItem(Qt)??"1")==="1";const We=new Set;let F,V,Ie;const St="agentReqEnabled";let Tt="messageToggleEnabled";const kt="settings/agentReqEnabled",It="settings/messages";L.icon({iconUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});typeof L<"u"&&L.Icon&&L.Icon.Default&&typeof L.Icon.Default.mergeOptions=="function"&&L.Icon.Default.mergeOptions({imagePath:"https://unpkg.com/leaflet@1/dist/images/",iconUrl:"marker-icon.png",iconRetinaUrl:"marker-icon-2x.png",shadowUrl:"marker-shadow.png"});const Bn=[[48.21778257924239,16.37016154994435],[48.217247563322225,16.37076456217454],[48.21741142779978,16.371253762059183],[48.216865105563464,16.37191529883514],[48.21581506144457,16.37290646405736],[48.21417125610604,16.373948000332064],[48.21430769576697,16.3745721914746],[48.21333498613118,16.37539386682008],[48.2122964590416,16.377294652276152],[48.211699711347876,16.38092342451245],[48.211941642178076,16.38467493512273],[48.20913524997675,16.384032997995277],[48.20434428995476,16.380677464805487],[48.20267440663029,16.378771628716105],[48.202516949057625,16.378787036085683],[48.2021791301039,16.378713275337773],[48.20032081399359,16.37673193693543],[48.20046567888107,16.376081501249317],[48.19987161819025,16.37355423682974],[48.19981183801774,16.372899054744835],[48.200631534154375,16.369653382537916],[48.20071916193201,16.369103424638855],[48.200163223194544,16.368756078571426],[48.19948213275357,16.368406050294983],[48.19950721778074,16.3679406870309],[48.1998469538764,16.366987161726104],[48.19976119600531,16.366945587486374],[48.199786280895815,16.366662614435302],[48.199852484835134,16.36658080706035],[48.199605825841886,16.366136901468384],[48.199689907919776,16.365894161552536],[48.199997462783195,16.365407340616333],[48.20007450484762,16.36539258846675],[48.200780727683785,16.364471249670135],[48.20235733493688,16.36143133067089],[48.202316181915776,16.361391179971125],[48.20252539808658,16.36095263879719],[48.20263271531552,16.36073672097149],[48.20274853131339,16.36083590228765],[48.20475579365605,16.35819251441422],[48.20494354858451,16.357837121719747],[48.205074099582546,16.357685576910406],[48.20502589015989,16.357555489773183],[48.20506169808996,16.357492457861333],[48.205261965068914,16.357456248039632],[48.20626549207577,16.356030140071557],[48.20666774752276,16.35550308600013],[48.20697347295606,16.355354223399804],[48.20918910891197,16.354601648098285],[48.20921597664341,16.35491948986655],[48.20929110567211,16.354928877598102],[48.20938410911258,16.354983862882907],[48.212403444290665,16.35518085630021],[48.212634067324394,16.355560388875816],[48.214753862701514,16.35585677297196],[48.21482540908184,16.356370415998313],[48.21454632473899,16.35850592710254],[48.21435355993972,16.36025556372129],[48.21477999581608,16.361298310706765],[48.21461086605676,16.3615351876565],[48.214799725889385,16.361933238614775],[48.21476774885914,16.362013013827934],[48.214317217645544,16.362474541146735],[48.21554996828477,16.365200001058092],[48.21618181295601,16.36659154989541],[48.21691897070536,16.368248676490595],[48.21768157297474,16.36988155904141],[48.21778257924239,16.37016154994435]],Cn=[[-90,-180],[-90,180],[90,180],[90,-180]],He=L.polygon([Cn,Bn],{color:"red",weight:3,fillColor:"rgba(255, 0, 0, 0.3)",fillOpacity:.35,interactive:!1,pane:"maskPane",dashArray:"5, 5"}),Mn={blau:"#1E90FF",gruen:"#2ECC71",rot:"#FF5252",gelb:"#F4D03F",orange:"#FF8C00",lila:"#8E44AD",schwarz:"#333333",grau:"#7F8C8D"};Tn(ee,{provider:new En("6LcVXbQrAAAAAI5Wgi8DenjAM4cz-ubrfcwIRPVJ"),isTokenAutoRefreshEnabled:!0});window.onerror=function(e,t,n,o,i){alert("JS-Fehler: "+e+" in "+t+" Zeile "+n)};const W=Ln("https://axirbthvnznvhfagduyj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4aXJidGh2bnpudmhmYWdkdXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMDI2MTcsImV4cCI6MjA2ODg3ODYxN30.wfJm9e10_iNuYm_r3es_FmKuXBePsxSjIJcVqmSuYjc");async function Rn(e){const t=localStorage.getItem("role")||"start";try{const{error:n}=await W.from("fcm_tokens").delete().eq("device_name",I);n?r("‚ùå Fehler beim L√∂schen aus Supabase:",n):r("‚úÖ Alter Token aus Supabase gel√∂scht.");const{error:o}=await W.from("fcm_tokens").upsert({token:e,device_name:I,role:t});o?r("‚ùå Fehler beim Speichern des Tokens:",o):r("‚úÖ Token erfolgreich gespeichert.")}catch(n){r("‚ùå Supabase Exception:",n)}}function ge(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()==="";)e=prompt("Bitte gib deinen Namen ein"),e===null&&alert("Du musst einen Namen eingeben, um fortzufahren.");return localStorage.setItem("deviceId",e.trim()),e.trim()}try{localStorage.setItem("test","1")}catch{alert("‚ö†Ô∏è Dein Browser blockiert lokalen Speicher. Bitte verlasse den privaten Modus oder √§ndere die Einstellungen.")}async function Fn(){try{if(!await it()){alert("‚ùå Push-Benachrichtigungen werden in diesem Browser/Modus nicht unterst√ºtzt.");return}if(!("Notification"in window)){alert("‚ùå Notification API nicht verf√ºgbar.");return}const t=await Notification.requestPermission();if(t!=="granted"){r("Benachrichtigungen nicht erlaubt:",t),alert("‚ö†Ô∏è Benachrichtigungen wurden abgelehnt.");return}const n=await ti();r("Service Worker registriert mit Scope:",n.scope),localStorage.setItem("serviceWorkerRegistered","true"),U||(U=_e(ee));const o=await Vt(U,{serviceWorkerRegistration:n,vapidKey:"BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE"});if(!o){r("Kein Token erhalten."),alert("‚ö†Ô∏è Kein Token erhalten. Bitte erneut versuchen.");return}localStorage.setItem("fcmToken",o),r("Token:",o),await $(p(y,`tokens/${I}`),o),await j(p(y,`roles/${I}`),{role:"start"}),await Rn(o),localStorage.setItem("nachrichtAktiv","true");const i=document.getElementById("permissionButton");i&&(i.style.display="none"),_n(I).then(()=>{alert("‚úÖ Benachrichtigungen aktiviert!")})}catch(e){r("Fehler bei Berechtigung/Registrierung/Token:",e),alert("‚ùå Fehler: "+((e==null?void 0:e.message)??String(e)))}}async function _n(e){const t=await zn("app-db","settings");return new Promise((n,o)=>{const i=t.transaction("settings","readwrite");i.objectStore("settings").put(e,"deviceName"),i.oncomplete=()=>{t.close(),n(!0)},i.onerror=()=>{t.close(),o(i.error)}})}async function Dn(e){const t=await new Promise((n,o)=>{const i=indexedDB.open("app-db");i.onupgradeneeded=()=>{const a=i.result;a.objectStoreNames.contains("sw-flags")||a.createObjectStore("sw-flags")},i.onsuccess=()=>n(i.result),i.onerror=()=>o(i.error)});try{return await new Promise(n=>{const a=t.transaction("sw-flags","readonly").objectStore("sw-flags").get(e);a.onsuccess=()=>{t.close(),n(a.result||null)},a.onerror=()=>{t.close(),n(null)}})}catch{return null}}async function $n(e){const t=await new Promise((n,o)=>{const i=indexedDB.open("app-db");i.onupgradeneeded=()=>{const a=i.result;a.objectStoreNames.contains("sw-flags")||a.createObjectStore("sw-flags")},i.onsuccess=()=>n(i.result),i.onerror=()=>o(i.error)});await new Promise(n=>{const o=t.transaction("sw-flags","readwrite");o.objectStore("sw-flags").delete(e),o.oncomplete=()=>{t.close(),n()},o.onerror=()=>{t.close(),n()}})}async function qe(e={}){const{force:t=!1,vapidKey:n="BPxoiPhAH4gXMrR7PhhrAUolApYTK93-MZ48-BHWF0rksFtkvBwE9zYUS2pfiEw6_PXzPYyaQZdNwM6LL4QdeOE",touchWhenUnchanged:o=!0}=e;if(typeof Notification>"u"||Notification.permission!=="granted"||localStorage.getItem("serviceWorkerRegistered")!=="true")return r("üîï Token-Refresh √ºbersprungen: Keine Berechtigung oder kein SW."),null;try{const i=await navigator.serviceWorker.ready;let a=null;try{a=await Vt(U,{serviceWorkerRegistration:i,vapidKey:n})}catch(c){return r("‚ùå Fehler bei getToken:",c),null}if(!a)return r("‚ö†Ô∏è Kein Token beim Refresh erhalten."),null;const s=localStorage.getItem("fcmToken");if(t||a!==s){r("üîÑ Token aktualisiert:",a),await $(p(y,"tokens/"+I),a);try{const{error:c}=await W.from("fcm_tokens").upsert({token:a,device_name:I},{onConflict:"device_name"});c?r("‚ùå Fehler beim Upsert in Supabase:",c):r("‚úÖ Token in Supabase upserted.")}catch(c){r("‚ùå Supabase Upsert Exception:",c)}return localStorage.setItem("fcmToken",a),localStorage.setItem("nachrichtAktiv","true"),a}else return r("‚ÑπÔ∏è Token ist unver√§ndert."),a}catch(i){return r("‚ùå Fehler beim Token-Refresh:",i),null}}async function zn(e,t){return new Promise((n,o)=>{const i=indexedDB.open(e);i.onupgradeneeded=()=>{const a=i.result;a.objectStoreNames.contains(t)||a.createObjectStore(t)},i.onsuccess=()=>{const a=i.result;if(a.objectStoreNames.contains(t))return n(a);const s=a.version+1;a.close();const c=indexedDB.open(e,s);c.onupgradeneeded=()=>{const d=c.result;d.objectStoreNames.contains(t)||d.createObjectStore(t)},c.onsuccess=()=>n(c.result),c.onerror=()=>o(c.error)},i.onerror=()=>o(i.error)})}async function On(){let e=localStorage.getItem("deviceId");for(;!e||e.trim()===""||!xt(e.trim());)e=prompt("Bitte gib deinen Namen ein (mind. 2 Zeichen, keine Sonderzeichen wie . # $ [ ] /)"),e===null&&alert("Du musst einen g√ºltigen Namen eingeben, um fortzufahren."),e&&!xt(e.trim())&&(alert("Ung√ºltiger Name. Bitte verwende mindestens 2 Zeichen und keine . # $ [ ] /"),e="");e=e.trim(),localStorage.setItem("deviceId",e),I=e;let t=en(),n=t.tel||null,o=!!t.noTel,i;try{i=await Vn(e)}catch(c){r("[askForDeviceIdAndPhone] Konnte Remote-Status nicht laden:",c),i={exists:!1,allowSmsFallback:null,tel:null}}let a=!1;if(i.allowSmsFallback===null?(a=!0,o=!1):i.allowSmsFallback===!1?a=!1:i.allowSmsFallback===!0&&!i.tel&&(a=!0),i.allowSmsFallback===!0&&i.tel){Et({tel:i.tel,allowSmsFallback:!0,noTel:!1}),await Lt(e,i.tel,!0);return}if(a&&!o||a&&i.allowSmsFallback===null)for(;!n||!Gn(n);){let c=prompt(`Bitte gib deine Telefonnummer f√ºr SMS-Fallback ein (+43‚Ä¶ oder 0664‚Ä¶)
Du kannst auch leer lassen, wenn du keine SMS m√∂chtest.`);if(c===null||c.trim()===""){n=null,o=!0;break}n=Xn(c.trim()),n||alert("Ung√ºltige Nummer. Bitte im Format +43‚Ä¶ oder 0664‚Ä¶ eingeben.")}const s=!!n;Et({tel:n,allowSmsFallback:s,noTel:o}),await Lt(e,n,s)}function xt(e){return typeof e=="string"&&e.length>=2&&!/[.#$/\[\]/]/.test(e)}async function Nn(){try{const e=await it().catch(()=>!1);U||(U=_e(ee));const t=localStorage.getItem("fcmToken");if(e)try{await kn(U),r("‚úÖ deleteToken: lokaler FCM-Token invalidiert")}catch(n){r("‚ö†Ô∏è deleteToken fehlgeschlagen:",n)}try{await D(p(y,`tokens/${I}`)),r("‚úÖ RTDB-Token entfernt f√ºr",I)}catch(n){r("‚ö†Ô∏è RTDB-Remove fehlgeschlagen:",n)}try{const{error:n}=await W.from("fcm_tokens").delete().or(`device_name.eq.${I}${t?`,token.eq.${t}`:""}`);n?r("‚ö†Ô∏è Supabase-Delete Fehler:",n):r("‚úÖ Supabase-Eintr√§ge entfernt")}catch(n){r("‚ö†Ô∏è Supabase-Delete (catch):",n)}if("serviceWorker"in navigator){const n=await navigator.serviceWorker.getRegistrations();for(const o of n)try{const i=await o.pushManager.getSubscription();i&&(await i.unsubscribe(),r("‚úÖ Push-Subscription gek√ºndigt f√ºr",o.scope))}catch(i){r("‚ö†Ô∏è unsubscribe warn:",i)}await Promise.all(n.map(o=>o.unregister())),r("‚úÖ Alle Service Worker unregistriert")}try{if(window.caches){const n=await caches.keys();await Promise.all(n.map(o=>caches.delete(o))),r("‚úÖ Alle Caches gel√∂scht:",n)}}catch(n){r("‚ö†Ô∏è Cache cleanup warn:",n)}try{indexedDB.deleteDatabase("app-db"),r('‚úÖ IndexedDB "app-db" gel√∂scht')}catch(n){r("‚ö†Ô∏è IndexedDB delete warn:",n)}localStorage.removeItem("fcmToken"),localStorage.removeItem("nachrichtAktiv"),localStorage.removeItem("serviceWorkerRegistered");try{const n=document.getElementById("permissionButton"),o=document.getElementById("permissionButton2");n&&(n.style.display=""),o&&(o.style.display="none")}catch{}setTimeout(()=>{alert("üîï Benachrichtigungen deaktiviert. Die Seite wird neu geladen‚Ä¶"),location.reload()},150)}catch(e){r(e),alert("‚ùå Deaktivieren fehlgeschlagen: "+((e==null?void 0:e.message)??String(e)))}}function jn(e,t=[],n,o=15,{rtdbBase:i=X,rolesPath:a="roles",recipientsPath:s="notifications",idempotencyFlag:c="smsTriggered",secret:d=typeof SMS_FALLBACK_SECRET<"u"?SMS_FALLBACK_SECRET:"",rtdbAuth:l}={}){if(!e)throw new Error("[Fallback] messageId fehlt");if(!Array.isArray(t)||t.length===0)return r("[Fallback] keine Empf√§nger - Fallback nicht geplant"),Promise.resolve({ok:!0,skipped:"no_recipients"});if(!i)throw new Error("[Fallback] rtdbBase fehlt");const h={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),waitSec:o,rtdbBase:i,rolesPath:a,recipientsPath:s,idempotencyFlag:c,...l?{rtdbAuth:l}:{}},u={};return d&&(u["x-sms-secret"]=d),W.functions.invoke("sms-fallback",{body:h,headers:u}).then(({data:m,error:f})=>f?(r("[Fallback] Edge call failed",f),{ok:!1,error:f.message||"invoke failed"}):(r("[Fallback] scheduled:",m),m)).catch(m=>(r("[Fallback] Konnte SMS-Fallback nicht planen:",m),{ok:!1,error:(m==null?void 0:m.message)||String(m)}))}function ct(e,t=[],n,{rtdbBase:o=X,rolesPath:i="roles",recipientsPath:a="notifications",rtdbAuth:s,requireConsent:c=!0,maxRecipientsPerCall:d,writeDeliveredTimestamp:l=!0}={}){if(!e)return Promise.resolve({ok:!1,error:"Missing messageId"});if(!Array.isArray(t)||t.length===0)return r==null||r("[sms-direct] keine Empf√§nger - nichts zu senden"),Promise.resolve({ok:!0,skipped:"no_recipients"});const h={messageId:e,recipientDeviceNames:t,smsText:String(n??"").slice(0,280),...o?{rtdbBase:o}:{},rolesPath:i,recipientsPath:a,...s?{rtdbAuth:s}:{},requireConsent:c,...Number.isFinite(d)?{maxRecipientsPerCall:d}:{},writeDeliveredTimestamp:l};return W.functions.invoke("sms-direct",{body:h}).then(({data:u,error:m})=>m?(r==null||r("[sms-direct] Edge call failed",m),{ok:!1,error:m.message||"invoke failed"}):(r==null||r("[sms-direct] sent:",u),u)).catch(u=>(r==null||r("[sms-direct] Fehler beim Senden:",u),{ok:!1,error:(u==null?void 0:u.message)||String(u)}))}function me(){try{const e=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:void 0,t=e&&e.crypto;if(t&&typeof t.randomUUID=="function")return t.randomUUID();if(t&&typeof t.getRandomValues=="function"){const n=new Uint8Array(16);t.getRandomValues(n),n[6]=n[6]&15|64,n[8]=n[8]&63|128;const o=a=>a.toString(16).padStart(2,"0"),i=Array.from(n,o).join("");return`${i.slice(0,8)}-${i.slice(8,12)}-${i.slice(12,16)}-${i.slice(16,20)}-${i.slice(20)}`}}catch{}return`${Date.now()}-${Math.random().toString(36).slice(2,10)}`}async function lt(e,t,n=[],o={}){const{recipientDeviceNames:i=[],link:a="/Mister-X/",attempt:s=1,maxAttempts:c=1,waitSec:d=15,sendEndpoint:l="https://axirbthvnznvhfagduyj.supabase.co/functions/v1/send-to-all",rtdbBase:h=X,messageId:u,instantSMSDevices:m=[]}=o,f=u??me(),g=(typeof ge=="function"?ge():null)||"unknown",b=s===1,T=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,body:t,tokens:n,senderName:g,link:a,messageId:f,rtdbBase:h,recipientDeviceNames:b?i:[],setRecipientsMode:b?"set_once":"none",attempt:s})});let B={};try{B=await T.json()}catch{}r(`üì¶ Versuch ${s}: status=${T.status}`,B);const E=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);b&&i.length>0&&jn(f,i,E,15,{rtdbBase:X}),b&&m.length>0&&ct(f,m,E,{rtdbBase:X});const z=Array.isArray(B==null?void 0:B.failedTokens)?B.failedTokens:[];return z.length>0&&s<c?(r(`üîÅ Wiederhole f√ºr ${z.length} fehlgeschlagene Tokens in 10s...`),setTimeout(()=>{lt(e,t,z,{recipientDeviceNames:i,link:a,attempt:s+1,maxAttempts:c,waitSec:d,sendEndpoint:l,rtdbBase:h,messageId:f}).catch(r)},1e4)):s>=c?r("‚è±Ô∏è Max. Anzahl an Versuchen erreicht."):r("‚úÖ Alle Benachrichtigungen verarbeitet."),B}async function fe(e,t,n,o={}){const i=o.rtdbBase??X,a=o.messageId??me(),s=(typeof ge=="function"?ge():null)||"unknown";try{const C=await k(p(y,"settings/messages"));if(!(C.exists()?!!C.val():!0)){const R={title:String(e??""),body:String(t??""),link:o.link||"/Mister-X/",sender:s,timestamp:Date.now(),messageId:a,recipients:{}};return await $(p(y,`notifications/${a}`),R),r('[sendNotificationToRoles] Global setting "settings/messages" = false, wrote notification without recipients',R),{ok:!0,skipped:"messages_disabled",messageId:a}}}catch(C){r("[sendNotificationToRoles] Could not read settings/messages, proceeding as enabled:",C)}const[c,d]=await Promise.all([k(p(y,"roles")),k(p(y,"tokens"))]),l=c.exists()?c.val():{},h=d.exists()?d.val():{},u=Array.isArray(n)?n:[n],m=u.length===1&&u[0]==="all",f=[],g=[],b=[],v=Array.from(new Set([...Object.keys(l||{}),...Object.keys(h||{})]));for(const C of v){const K=l[C]||{},R=K.role,te=K.notification!==!1,le=K.instantSMS===!0;if(!(m||R&&u.includes(R))||!te)continue;if(le){b.push(C),g.push(C);continue}const S=ut(h[C]);S.length>0&&(f.push(...S),g.push(C))}const T=Y(f),B=Y(g),E=Y(b),z=`${e}: ${t}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);return T.length>0?lt(e,t,T,{recipientDeviceNames:B,link:o.link||"/Mister-X/",waitSec:typeof o.waitSec=="number"?o.waitSec:45,sendEndpoint:o.sendEndpoint,rtdbBase:i,messageId:a,instantSMSDevices:E}):E.length>0?(await ct(a,E,z,{rtdbBase:i}),{ok:!0,onlySms:!0,smsCount:E.length,messageId:a}):(r(`‚ö†Ô∏è Keine passenden Empf√§nger f√ºr Rollen "${Array.isArray(n)?n.join(","):n}".`),{ok:!0,skipped:"no_recipients"})}async function Wn(e){const t=Array.isArray(e)?e:[e],[n,o]=await Promise.all([k(p(y,"roles")),k(p(y,"tokens"))]),i=n.exists()?n.val():{},a=o.exists()?o.val():{},s=t.length===1&&t[0]==="all",c=[],d=[];for(const l in a){if(!Object.prototype.hasOwnProperty.call(a,l))continue;const h=i[l]||{},u=h.role,m=h.notification!==!1;if(!(s||u&&t.includes(u))||!m)continue;const g=ut(a[l]);g.length!==0&&(c.push(...g),d.push(l))}return{tokens:Y(c),deviceNames:Y(d)}}async function Hn(e){const t=Array.isArray(e)?e:[e],[n,o,i]=await Promise.all([k(p(y,"teams")),k(p(y,"roles")),k(p(y,"tokens"))]),a=n.exists()?n.val():{},s=o.exists()?o.val():{},c=i.exists()?i.val():{},d=[],l=[],h=[],u=new Set;for(const m of t){const f=a==null?void 0:a[m];if(!(!f||!f.members))for(const g of Object.keys(f.members||{})){if(u.has(g))continue;u.add(g);const b=s[g]||{},v=b.notification!==!1,T=b.instantSMS===!0;if(!v)continue;const B=ut(c[g]);if(B.length>0){d.push(...B),l.push(g);continue}T&&(h.push(g),l.push(g))}}return{tokens:Y(d),deviceNames:Y(l),instantSMSDevices:Y(h)}}function qn(e,t,n){const o="Misterx-upload",i=new FormData;i.append("file",e),i.append("upload_preset",o),fetch("https://api.cloudinary.com/v1_1/ddvf141hb/image/upload",{method:"POST",body:i}).then(a=>a.json()).then(a=>{a.secure_url&&a.public_id?t({url:a.secure_url}):typeof n=="function"&&n(new Error("Fehler beim Hochladen zu Cloudinary."))}).catch(a=>{r("Upload-Fehler:",a),typeof n=="function"&&n(a)})}async function Un(){const e=document.getElementById("photoInput").files[0],t=document.getElementById("manualLocationDescription").value.trim(),n=document.getElementById("manualLocationContainer"),o=document.getElementById("status"),i=ci();if(!i){A("Bitte zuerst einen Posten ausw√§hlen.",{type:"error"});return}if(!e){A("Bitte ein Foto ausw√§hlen.",{type:"error"});return}const a=Date.now();let s={lat:null,lon:null,accuracy:null};if(!(n&&n.style.display!=="none"&&t!==""))if(navigator.geolocation)try{const g=await pt(),{latitude:b,longitude:v,accuracy:T}=g.coords;if(T>100){o.innerText=`‚ö†Ô∏è Standort ungenau (¬±${Math.round(T)} m). Bitte erneut versuchen oder Standortbeschreibung eingeben.`,n.style.display="block";return}s={lat:b,lon:v,accuracy:T}}catch(g){Ue==null||Ue(g),n.style.display="block"}else o.innerText="Geolocation wird nicht unterst√ºtzt.",n.style.display="block";const{color:c,postId:d,title:l}=i,h=p(y,`posten/${c}/active`);o.innerText="‚è≥ Reserviere Farbe‚Ä¶";try{const g=await pe(h,b=>b===!0?!1:b);if(!g.committed||g.snapshot.val()!==!1){o.innerText="‚ùå Diese Farbe ist bereits inaktiv. Liste wird aktualisiert.";return}}catch(g){o.innerText="‚ùå Konnte Farbe nicht reservieren.",r(g);return}try{await j(p(y),{[`posten/${c}/${d}/visited`]:!0})}catch(g){o.innerText="‚ùå Konnte Posten nicht auf 'visited' setzen.",r(g);return}const u={color:c,postId:d,title:l,timestamp:a,description:t||null,lat:s.lat,lon:s.lon},m=at(p(y,"locations"),u),f=`${l} (${c.toUpperCase()})`;fe==null||fe("Mister X hat sich gezeigt!",f,["agent","settings","start"]),ue(),qn(e,async({url:g})=>{try{await j(m,{photoURL:g}),o.innerText="‚úÖ Foto hochgeladen"}catch(b){o.innerText="‚ùå Foto-URL konnte nicht gesetzt werden",r("Foto-URL konnte nicht gesetzt werden",b)}},g=>{o.innerText="‚ùå Foto konnte nicht hochgeladen werden",r("Upload-Fehler:",g)}),document.getElementById("photoInput").value="",document.getElementById("manualLocationDescription").value="",n.style.display="none",document.getElementById("postenSearch").value="",hn(null),o.innerText="üîÑÔ∏è Posten/Farbe gemeldet & Foto wird hochgeladen.",ue==null||ue()}function Ue(e){let t="‚ùå Fehler beim Abrufen des Standorts.";switch(e.code){case e.PERMISSION_DENIED:t+=" Zugriff verweigert.";break;case e.POSITION_UNAVAILABLE:t+=" Standortinformationen nicht verf√ºgbar.";break;case e.TIMEOUT:t+=" Zeit√ºberschreitung bei der Standortabfrage.";break}t+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=t}function Gn(e){return typeof e=="string"&&/^\+43\d{4,13}$/.test(e)}function dt(e){return e.replace(/[.#$/\[\]\/]/g,"_")}function Y(e){return Array.from(new Set(e))}function ut(e){return e?typeof e=="string"?[e]:Array.isArray(e)?e.filter(Boolean):typeof e=="object"?Object.keys(e).filter(Boolean):[]:[]}function Kn(e){const t=String(e).trim();return t.startsWith("+")?"+"+t.slice(1).replace(/\D/g,""):t.replace(/\D/g,"")}function en(){try{return JSON.parse(localStorage.getItem("mrx_sms_prefs_v1"))??{allowSmsFallback:!1,tel:null,noTel:!1,lastUpdated:0}}catch{return{allowSmsFallback:!1,tel:null,noTel:!1,lastUpdated:0}}}function Et(e){const t=en(),n={allowSmsFallback:!!(e.allowSmsFallback??t.allowSmsFallback),tel:e.tel===void 0?t.tel:e.tel,noTel:e.noTel===void 0?t.noTel:e.noTel,lastUpdated:Date.now()};return localStorage.setItem("mrx_sms_prefs_v1",JSON.stringify(n)),n}async function Vn(e){const t=dt(e),n=await k(p(y,`roles/${t}`));if(!n.exists())return{exists:!1,allowSmsFallback:null,tel:null};const o=n.val()||{};return{exists:!0,allowSmsFallback:o.allowSmsFallback!==void 0?!!o.allowSmsFallback:null,tel:o.tel??null}}function Xn(e){if(!e)return null;let t=Kn(e);if(t.startsWith("+43"))return/^\+43\d{4,13}$/.test(t)?t:null;if(t.startsWith("0")){const n="+43"+t.slice(1);return/^\+43\d{4,13}$/.test(n)?n:null}if(t.startsWith("43")){const n="+"+t;return/^\+43\d{4,13}$/.test(n)?n:null}if(/^\d{5,}$/.test(t)&&t[0]!=="0"){const n="+43"+t;return/^\+43\d{4,13}$/.test(n)?n:null}return null}async function Lt(e,t,n){const o=dt(e);Kt(ee);const i={tel:t??null,allowSmsFallback:!!n,...t?{telUpdatedAt:Date.now()}:{}};await j(p(y,`roles/${o}`),i)}const _=e=>document.getElementById(e),tn=e=>e&&(e.style.display=""),nn=e=>e&&(e.style.display="none"),De=e=>{try{localStorage.setItem(Jt,e||"")}catch{}},Zn=()=>{try{return localStorage.getItem(Jt)||""}catch{return""}};function Jn(){let e=document.getElementById("toastContainer");if(e)return e;e=document.createElement("div"),e.id="toastContainer",e.setAttribute("aria-live","polite"),e.style.position="fixed",e.style.left="16px",e.style.bottom="16px",e.style.zIndex=2147483647,e.style.display="flex",e.style.flexDirection="column",e.style.gap="8px",e.style.maxWidth="calc(100vw - 32px)",document.body.appendChild(e);const t=document.createElement("style");return t.innerHTML=`#toastContainer .toast{background:#222;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.2);opacity:0;transform:translateY(6px);transition:opacity .22s,transform .22s;font-size:15px;max-width:380px;word-break:break-word}
#toastContainer .toast.show{opacity:1;transform:translateY(0)}
#toastContainer .toast.info{background:#333}
#toastContainer .toast.success{background:#2ECC71}
#toastContainer .toast.warn{background:#FF8C00}
#toastContainer .toast.error{background:#FF5252}
`,document.head.appendChild(t),e}function A(e,{timeout:t=6500,type:n="info"}={}){try{const o=Jn(),i=document.createElement("div");i.className=`toast ${n}`,i.textContent=e,o.appendChild(i),requestAnimationFrame(()=>i.classList.add("show"));const a=setTimeout(()=>{i.classList.remove("show"),i.addEventListener("transitionend",()=>{try{i.remove()}catch{}})},t);return i.addEventListener("click",()=>{clearTimeout(a),i.classList.remove("show"),i.addEventListener("transitionend",()=>{try{i.remove()}catch{}})}),i}catch{try{alert(e)}catch{}}}function on(e){return typeof e=="number"?e:e&&typeof e=="object"&&typeof e.seconds=="number"?e.seconds*1e3:0}function an(e){return e?`${String(e)}`:"Unbekannt"}function Yn(e){const t=(e||"").trim();if(t.length<2)throw new Error("Der Teamname muss mindestens 2 Zeichen lang sein.");if(t.length>24)throw new Error("Der Teamname darf maximal 24 Zeichen lang sein.");return t}function Z(e){return(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Ge(e=""){return Z(e).replace(/`/g,"&#096;")}function Je(e){const t=(e==null?void 0:e.members)||{};return Object.keys(t).length}function Qn(e,t=I){return!!(e!=null&&e.members)&&!!e.members[t]}function eo(){Zn()?(_("teamStatusName").textContent="(l√§dt‚Ä¶)",_("teamStatusCount").textContent="-"):(_("teamStatusName").textContent="Kein Team",_("teamStatusCount").textContent="-"),mt()}document.addEventListener("DOMContentLoaded",eo);function to(){if(document.getElementById("teamSettings").style.display!=="none")return sn();document.getElementById("startView").style.display="none",document.getElementById("startView2").style.display="none",document.querySelectorAll(".view").forEach(e=>e.style.display="none"),tn(_("teamSettings")),mt()}function sn(){let e=localStorage.getItem("activeView")||"start";nn(_("teamSettings")),ht(e)}function mt(){if(!ke.deviceTeam){const e=p(y,`deviceTeams/${I}`),t=n=>{x=n.val()||null,De(x||""),At(),Pt(),Bt()};G(e,t),ke.deviceTeam={ref:e,handler:t}}if(!ke.teams){const e=p(y,"teams"),t=n=>{M=n.val()||{},At(),Pt(),Bt()};G(e,t),ke.teams={ref:e,handler:t}}}function At(){const e=_("currentTeamName"),t=_("currentTeamMembers"),n=_("leaveTeamBtn"),o=x?M[x]:null;if(!o){e.textContent="Kein Team",t&&(t.innerHTML="‚Äî Mitglieder"),n&&(n.disabled=!0);return}e.textContent=o.name||"(ohne Namen)";const i=Object.entries(o.members||{}).map(([s,c])=>({id:s,joinedAt:on(c==null?void 0:c.joinedAt)})).sort((s,c)=>s.joinedAt!==c.joinedAt?s.joinedAt-c.joinedAt:s.id.localeCompare(c.id)),a=i.map(s=>{const c=s.id===I,d=an(s.id)+(c?" (Du)":"");return`<li class="ts-member ${c?"me":""}" title="${Z(s.id)}">${Z(d)}</li>`}).join("");t&&(t.innerHTML=`
      <div class="muted">${i.length} Mitglied(er)</div>
      ${i.length>0?`<ul class="ts-member-list">${a}</ul>`:'<div class="muted">Noch keine Mitglieder</div>'}
    `),n&&(n.disabled=!Qn(o))}function Pt(){const e=_("teamList"),t=_("teamsEmpty");if(!e)return;e.innerHTML="";const n=Object.entries(M||{}).filter(([,o])=>o&&typeof o=="object");if(n.length===0){t&&tn(t);return}t&&nn(t),n.sort((o,i)=>{const a=Je(o[1]),s=Je(i[1]);return a!==s?s-a:(o[1].name||"").localeCompare(i[1].name||"")});for(const[o,i]of n){const a=Object.entries(i.members||{}).map(([d,l])=>({id:d,joinedAt:on(l==null?void 0:l.joinedAt)})).sort((d,l)=>d.joinedAt!==l.joinedAt?d.joinedAt-l.joinedAt:d.id.localeCompare(l.id)),s=a.map(d=>{const l=d.id===I,h=an(d.id)+(l?" (Du)":"");return`<li class="ts-member ${l?"me":""}" title="${Z(d.id)}">${Z(h)}</li>`}).join(""),c=document.createElement("div");c.className="ts-team",c.innerHTML=`
      <div>
        <div style="font-weight:600">${Z(i.name||"(ohne Namen)")}</div>
        <div class="muted">${a.length} Mitglied(er)</div>
        <ul class="ts-member-list">
          ${s||""}
        </ul>
      </div>
      <div>
        ${x===o?'<button class="danger" onclick="leaveTeam()">Verlassen</button>':`<button onclick="joinTeam('${o}', this)">Beitreten</button>`}
      </div>
    `,e.appendChild(c)}}function Bt(){const e=_("teamStatusName"),t=_("teamStatusCount"),n=x?M[x]:null;if(!n){e.textContent="Kein Team",t.textContent="-";return}e.textContent=n.name||"(ohne Namen)",t.textContent=`${Je(n)} Mitglied(er)`}async function no(){const e=_("createTeamBtn"),t=_("createTeamInput");try{e.disabled=!0;const n=Yn(t.value);x&&await ft(x);const i=at(p(y,"teams")).key,a={};a[`teams/${i}`]={name:n,createdAt:Q(),createdBy:I,members:{[I]:{joinedAt:Q()}}},a[`deviceTeams/${I}`]=i,await j(p(y),a),De(i),t.value=""}catch(n){alert((n==null?void 0:n.message)||"Team konnte nicht erstellt werden."),r(n)}finally{e.disabled=!1}}async function oo(e,t){if(!e)return;if(!M[e]){A("Team existiert nicht (mehr).",{type:"error"});return}t&&(t.disabled=!0);try{x&&x!==e&&await ft(x);const o={};o[`teams/${e}/members/${I}`]={joinedAt:Q()},o[`deviceTeams/${I}`]=e,await j(p(y),o),De(e)}catch(o){A((o==null?void 0:o.message)||"Beitritt nicht m√∂glich.",{type:"error"}),r(o)}finally{t&&(t.disabled=!1)}}async function ft(e=null){const t=e||x;if(!t)return;const n=p(y,`teams/${t}`);await pe(n,o=>o&&(o.members&&o.members[I]&&(delete o.members[I],Object.keys(o.members).length===0)?null:o)),await $(p(y,`deviceTeams/${I}`),null),De("")}function io(){const e=document.getElementById("map");e.style.display=""}function Ye(e,t){var n,o;if(io(),w)w.setView([e,t],15),w.invalidateSize(),Qe(),et();else{if(w=L.map("map",{fullscreenControl:!0,fullscreenControlOptions:{position:"topleft"},maxBounds:[[-90,-180],[90,180]],doubleTouchDragZoom:!0}).setView([e,t],15),console.debug("createOrReuseMap: L.control.fullscreen=",typeof((n=L.control)==null?void 0:n.fullscreen),"map.options.fullscreenControl=",w&&w.options&&w.options.fullscreenControl),typeof((o=L.control)==null?void 0:o.fullscreen)=="function")try{w.fullscreenControl||L.control.fullscreen({position:"topleft",title:"Vollbild",titleCancel:"Vollbild verlassen",forceSeparateButton:!0}).addTo(w)}catch(u){r("leaflet.fullscreen: failed to add control programmatically",u)}try{window.__map=w}catch{}const i=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"¬© OpenStreetMap"}),a=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"¬© CartoDB"}),s=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles ¬© Esri"}),c=L.tileLayer("http://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web/default/WEBMERCATOR/{z}/{y}/{x}.png",{maxZoom:18,attribution:"TopPlus Open ¬© GeoBasis-DE / BKG"}),d=L.tileLayer("https://mapsneu.wien.gv.at/basemap/bmaporthofoto30cm/{type}/google3857/{z}/{y}/{x}.{format}",{maxZoom:20,attribution:'Datenquelle: <a href="https://www.basemap.at">basemap.at</a>',type:"normal",format:"jpeg",bounds:[[46.35877,8.782379],[49.037872,17.189532]]}),l=L.tileLayer("https://mapsneu.wien.gv.at/basemap/bmaphidpi/{type}/google3857/{z}/{y}/{x}.{format}",{maxZoom:19,attribution:'Datenquelle: <a href="https://www.basemap.at">basemap.at</a>',type:"normal",format:"jpeg",bounds:[[46.35877,8.782379],[49.037872,17.189532]]}),h={Standard:i,Reduziert:a,Satellit:s,"Satellit (AT)":d,Plan:c,"Plan (AT)":l};i.addTo(w),L.control.layers(h).addTo(w),setTimeout(()=>w.invalidateSize(),0),Qe(),et()}gt()}function Qe(){w&&(w.getPane("maskPane")||(w.createPane("maskPane"),w.getPane("maskPane").style.zIndex=300),w.getPane("historyPane")||(w.createPane("historyPane"),w.getPane("historyPane").style.zIndex=410),w.getPane("postenPane")||(w.createPane("postenPane"),w.getPane("postenPane").style.zIndex=400),w.getPane("agentenPane")||(w.createPane("agentenPane"),w.getPane("agentenPane").style.zIndex=420),w.getPane("userPane")||(w.createPane("userPane"),w.getPane("userPane").style.zIndex=450))}function et(){F||(F=L.layerGroup()),V||(V=L.layerGroup()),Ie||(Ie=L.layerGroup()),w&&(w.hasLayer(F)||F.addTo(w),w.hasLayer(V)||V.addTo(w),w.hasLayer(Ie)||Ie.addTo(w))}function ao(e){if(!w)return;et(),V.clearLayers();const t=new L.Icon.Default;t.options.shadowSize=[0,0],e.forEach(o=>{L.marker([o.lat,o.lon],{pane:"historyPane",icon:t}).addTo(V).bindPopup(`üìç ${new Date(o.timestamp).toLocaleTimeString()}`)});const n=e.map(o=>[o.lat,o.lon]);n.length>1&&L.polyline(n,{color:"blue",weight:3,opacity:.7,smoothFactor:1,pane:"historyPane"}).addTo(V)}function rn(){G(p(y,"locations"),e=>{var s,c,d,l,h,u;const t=e.val()||null;let n=[],o=[],i=null;try{n=Object.values(t).sort((m,f)=>f.timestamp-m.timestamp),o=n.filter(m=>m.lat!=null&&m.lon!=null),i=o.length===0}catch{i=!0}if(i)Ye(48.208672092667435,16.372477270381918),r("Keine Locations");else if(o.length>0){const{lat:m,lon:f}=o[0];Ye(m,f)}if(ro(),o.length>0?ao(o):V&&V.clearLayers(),gt(),Ce({nonDestructive:!0}),console.log("map id",w==null?void 0:w._leaflet_id),console.log("postenPane exists?",!!(w!=null&&w.getPane("postenPane"))),console.log("postenPane zIndex",(c=(s=w==null?void 0:w.getPane("postenPane"))==null?void 0:s.style)==null?void 0:c.zIndex),console.log("historyPane zIndex",(l=(d=w==null?void 0:w.getPane("historyPane"))==null?void 0:d.style)==null?void 0:l.zIndex),console.log("userPane zIndex",(u=(h=w==null?void 0:w.getPane("userPane"))==null?void 0:h.style)==null?void 0:u.zIndex),console.log("postenLayer on map?",w==null?void 0:w.hasLayer(F)),console.log("postenMarkers count",Object.keys(H||{}).length),w&&He&&typeof He.addTo=="function")try{He.addTo(w)}catch(m){r("Fehler beim Hinzuf√ºgen von mask:",m)}document.getElementById("map").style.display="block";const a=document.getElementById("locationFeed");a.innerHTML="",n.length>0&&n.forEach((m,f)=>{const g=m.title?m.title:"Automatischer Standort",b=m.timestamp?new Date(m.timestamp).toLocaleTimeString():"",v=m.photoURL?`<img src="${m.photoURL}" alt="Foto" class="zoomable-photo" style="max-width: 100%; max-height: 60vh; border: 1px solid #ccc; margin-top: 5px; cursor: zoom-in;" data-index="${f}">`:"",T=document.createElement("div");T.style.marginBottom="1em",T.innerHTML=`
          <strong class="location-title" data-lat="${m.lat}" data-lon="${m.lon}" style="cursor: pointer;">${g} (${b})</strong><br>
          ${m.description?`<em>üìç ${m.description}</em><br>`:""}
          ${v}
        `,a.appendChild(T)}),document.querySelectorAll(".location-title").forEach(m=>{m.addEventListener("click",()=>{const f=parseFloat(m.dataset.lat),g=parseFloat(m.dataset.lon);w&&!isNaN(f)&&!isNaN(g)&&w.setView([f,g],17)})}),document.querySelectorAll(".zoomable-photo").forEach(m=>{m.addEventListener("click",()=>{const f=document.createElement("div");f.style.position="fixed",f.style.top="0",f.style.left="0",f.style.width="100vw",f.style.height="100vh",f.style.backgroundColor="rgba(0,0,0,0.8)",f.style.display="flex",f.style.alignItems="center",f.style.justifyContent="center",f.style.zIndex="9999",f.innerHTML=`<img src="${m.src}" style="max-width: 90%; max-height: 90%; border: 2px solid white;">`,f.addEventListener("click",()=>{document.body.removeChild(f)}),document.body.appendChild(f)})})})}function so(){if(!navigator.geolocation){alert("‚ùå Geolocation wird nicht unterst√ºtzt.");return}be==null&&(be=navigator.geolocation.watchPosition(e=>{const{latitude:t,longitude:n,accuracy:o}=e.coords;if(!w)return;const i={radius:7,color:"#007AFF",fillColor:"#ffffffff",fillOpacity:.8,opacity:1,weight:2},a={radius:o,color:"#007AFF",fillColor:"#007AFF",interactive:!1,fillOpacity:.2,weight:1,opacity:.4};if(N?(N.setLatLng([t,n]),N.getPopup()&&N.getPopup().setContent(`<strong>Dein Standort</strong><br>Genauigkeit: ¬±${Math.round(o)} m`)):N=L.circleMarker([t,n],{markerStyle:i,pane:"userPane"}).bindPopup(`<strong>Dein Standort</strong><br>Genauigkeit: ¬±${Math.round(o)} m`).addTo(w),q?(q.setLatLng([t,n]),q.setRadius(o)):q=L.circle([t,n],{...a,pane:"historyPane"}).addTo(w),Zt){const s=Math.max(w.getZoom(),16);w.setView([t,n],s,{animate:!0})}},e=>{r("Geolocation-Fehler:",e),cn(),alert("‚ö†Ô∏è Tracking gestoppt: "+e.message)},{enableHighAccuracy:!0,timeout:15e3,maximumAge:5e3}))}function cn(){be!=null&&(navigator.geolocation.clearWatch(be),be=null),w&&N&&(w.removeLayer(N),N=null),w&&q&&(w.removeLayer(q),q=null)}function ro(){w&&(N&&!w.hasLayer(N)&&N.addTo(w),q&&!w.hasLayer(q)&&q.addTo(w))}function co(){const e=document.getElementById("refreshBtn");e&&e.addEventListener("click",async()=>{e.classList.add("updating");try{await lo({timeoutMs:2500})}catch(t){r("[Refresh] Fehler im Update-Flow:",t),window.location.reload()}})}async function lo({timeoutMs:e=2500}={}){if(!("serviceWorker"in navigator)){window.location.reload();return}const t=await navigator.serviceWorker.getRegistration();if(!t){r("[Refresh] Keine SW-Registration gefunden -> normaler Reload"),window.location.reload();return}r("[Refresh] Vor Update:",go(t)),await t.update();let n=t.installing||t.waiting||null;n||(n=await uo(t,800)),n?(await mo(n),t.waiting&&(r("[Refresh] Sende SKIP_WAITING an Waiting-SW"),t.waiting.postMessage({type:"SKIP_WAITING"}))):r("[Refresh] Keine neue SW gefunden -> normaler Reload"),await fo(e),window.location.reload()}function uo(e,t){return new Promise(n=>{let o;const i=()=>{e.removeEventListener("updatefound",i),clearTimeout(o),n(e.installing||e.waiting||null)};e.addEventListener("updatefound",i),o=setTimeout(()=>{e.removeEventListener("updatefound",i),n(null)},t)})}function mo(e){return new Promise(t=>{if(e.state==="installed"||e.state==="activated")return t();e.addEventListener("statechange",()=>{(e.state==="installed"||e.state==="activated")&&t()})})}function fo(e){return new Promise(t=>{let n=!1;const o=()=>{n||(n=!0,navigator.serviceWorker.removeEventListener("controllerchange",i),t())},i=()=>{r("[Refresh] controllerchange empfangen"),o()};navigator.serviceWorker.addEventListener("controllerchange",i),setTimeout(()=>{r("[Refresh] controllerchange-Timeout, lade dennoch neu"),o()},e)})}function go(e){const t=n=>n?n.state:"‚Äî";return{scope:e.scope,active:t(e.active),installing:t(e.installing),waiting:t(e.waiting),controlled:!!navigator.serviceWorker.controller}}function po(){let e=0;const t=15e3,n=async()=>{const o=Date.now();if(!(o-e<t)){e=o;try{const i=await navigator.serviceWorker.getRegistration();if(!i)return;await i.update(),i.waiting&&i.waiting.postMessage({type:"SKIP_WAITING"})}catch{}}};document.addEventListener("visibilitychange",()=>{document.hidden||n()}),window.addEventListener("focus",n)}function yo(e,t,n){const o=Mn[e]||"#666";return n?{radius:10,color:o,fillColor:o,fillOpacity:.9,opacity:1,weight:3}:t===!1?{radius:6,color:o,fillColor:o,fillOpacity:.25,opacity:.4,weight:1}:{radius:9,color:o,fillColor:o,fillOpacity:.7,opacity:.9,weight:2}}function Ct(e,t,n,o){const i=n.title||t,a=!!n.visited,s=o?"aktiv":"inaktiv",c=a?"‚úÖ besucht":"üïí offen",d=n.imageUrl?`
      <div class="posten-preview" style="margin-top:6px">
        <img
          class="posten-preview-img"
          src="${Ge(n.imageUrl)}"
          data-fullsrc="${Ge(n.imageUrl)}"
          alt="${Ge(i)}"
          loading="lazy"
          style="width:100%;height:auto;max-height:120px;object-fit:contain;border-radius:8px;cursor:zoom-in;display:block"
          referrerpolicy="no-referrer"
        />
      </div>
    `:"";return`
    <div class="posten-popup" style="min-width:200px">
      <strong>${Z(i)}</strong><br>
      <small>Farbe: ${Z(e)} (${s})</small><br>
      <small>Status: ${c}</small>
      ${d}
    </div>
  `}function ho(e){const t=e.lat??e.latitude??null,n=e.lon??e.lng??e.longitude??null;return{lat:t,lon:n}}async function wo(){const e=p(y,"posten"),t=await k(e);se=t.exists()?t.val():null,Ce(),G(e,n=>{se=n.exists()?n.val():null,Ce()})}function bo(){const e=document.getElementById("img-lightbox"),t=document.getElementById("img-lightbox-close");if(!e||!t)return;const n=()=>e.style.display="none";t.addEventListener("click",n),e.addEventListener("click",o=>{o.target===e&&n()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&n()})}function vo(){const e=t=>{const n=t.target.closest(".posten-preview-img");if(!n)return;t.preventDefault(),t.stopPropagation();const o=n.getAttribute("alt")||"Bild",i=n.getAttribute("data-fullsrc")||n.getAttribute("src");i&&So(i,o)};document.addEventListener("click",e,{capture:!0})}function So(e,t=""){const n=document.getElementById("img-lightbox"),o=document.getElementById("img-lightbox-img");!n||!o||(n.style.display="flex",o.onload=null,o.onerror=null,o.alt=t||"Bild",o.src===e&&(o.src=""),o.src=e)}function gt(){F||(F=L.layerGroup()),w&&!w.hasLayer(F)&&F.addTo(w)}function Ce(e={}){const{nonDestructive:t=!1}=e;if(!w||!se)return;Qe(),gt();const n=new Set;let o=0;if(Object.entries(se).forEach(([i,a])=>{if(!a||typeof a!="object")return;const s=!!a.active,c=Object.fromEntries(Object.entries(a).filter(([d])=>d!=="active"));Object.entries(c).forEach(([d,l])=>{var g,b;if(!l||typeof l!="object")return;const{lat:h,lon:u}=ho(l);if(h==null||u==null)return;o++;const m=`${i}/${d}`;n.add(m);const f=yo(i,s,!!l.visited);if(H[m]){const v=H[m];v.setLatLng([h,u]),v.setStyle(f),v._postenLoc=l,v._postenId=m,F&&!F.hasLayer(v)&&v.addTo(F),(g=v.bringToFront)==null||g.call(v),(b=v.getPopup())==null||b.setContent(Ct(i,d,l,s))}else{const v=L.circleMarker([h,u],{...f,pane:"postenPane"}).bindPopup(Ct(i,d,l,s));v._postenLoc=l,v._postenId=m,v.addTo(F),H[m]=v}})}),!t){if(o===0){r("[posten] Kein g√ºltiger Posten geparst - Cleanup √ºbersprungen.");return}Object.keys(H).forEach(i=>{n.has(i)||(F.removeLayer(H[i]),delete H[i])})}}Object.keys(H).forEach(e=>{seen.has(e)||(F.removeLayer(H[e]),delete H[e])});async function To(e=!0){const t=p(y,"posten"),n=await k(t);if(!n.exists())return;const o=n.val(),i={};Object.entries(o).forEach(([a,s])=>{!s||typeof s!="object"||(i[`posten/${a}/active`]=e,Object.entries(s).forEach(([c,d])=>{c==="active"||!d||typeof d!="object"||(i[`posten/${a}/${c}/visited`]=!1)}))}),await j(p(y),i)}const xe=e=>e*Math.PI/180;function ko(e,t,n,o){const a=xe(n-e),s=xe(o-t),c=Math.sin(a/2)**2+Math.cos(xe(e))*Math.cos(xe(n))*Math.sin(s/2)**2;return 2*6371e3*Math.asin(Math.sqrt(c))}function pt(e={enableHighAccuracy:!0,timeout:8e3,maximumAge:0}){return new Promise((t,n)=>{if(!navigator.geolocation)return n(new Error("Geolocation nicht unterst√ºtzt"));navigator.geolocation.getCurrentPosition(t,n,e)})}function ln({excludeVisited:e=!0}={}){const t=[];for(const[n,o]of Object.entries(se))if(!(!o||o.active!==!0))for(const[i,a]of Object.entries(o.posts||{}))!a||typeof a!="object"||e&&a.visited===!0||t.push({color:n,postId:i,...a});return t}function Ae(e){const t=document.getElementById("postenSuggestions");if(!e||e.length===0){t.style.display="none",t.innerHTML="";return}t.innerHTML=e.map(n=>{const o=n.distance!=null?` - ${(n.distance/1).toFixed(0)} m`:"";return`<div class="item" data-color="${n.color}" data-postid="${n.postId}">
              ${n.title||"(ohne Titel)"}
              <span class="tag">${n.color}</span>${o}
            </div>`}).join(""),t.style.display="block",t.querySelectorAll(".item").forEach(n=>{n.addEventListener("click",()=>{var l,h;const o=n.getAttribute("data-color"),i=n.getAttribute("data-postid"),a=(h=(l=se[o])==null?void 0:l.posts)==null?void 0:h[i];if(!a){r("Ausgew√§hlter Posten nicht im Cache gefunden:",{color:o,postId:i}),document.getElementById("status").innerText="Dieser Posten ist nicht mehr verf√ºgbar.",t.style.display="none";return}const s={color:o,postId:i,title:a.title||i,lat:a.lat??null,lon:a.lon??null};hn(s);const c=document.getElementById("postenSearch");c&&(c.value=`${s.title} [${o}]`),t.style.display="none";const d=document.getElementById("status");d&&(d.innerText=`‚úÖ Posten ausgew√§hlt: ${s.title} (${o})`)})})}function dn(e){const t=(e||"").trim().toLowerCase(),n=ln();return t?n.filter(o=>{const i=String(o.postId).toLowerCase(),a=String(o.title||"").toLowerCase(),s=String(o.color).toLowerCase();return i.includes(t)||a.includes(t)||s.includes(t)}).slice(0,25):[]}async function Io(e=5){try{const t=await pt(),{latitude:n,longitude:o,accuracy:i}=t.coords;i>100&&(document.getElementById("status").innerText=`‚ö†Ô∏è Standort ungenau (¬±${Math.round(i)}‚ÄØm). Ergebnisse evtl. ungenau.`);const a=ln().map(s=>({...s,distance:s.lat!=null&&s.lon!=null?ko(n,o,s.lat,s.lon):Number.POSITIVE_INFINITY}));return a.sort((s,c)=>s.distance-c.distance),a.slice(0,e)}catch{return document.getElementById("status").innerText="üìç Konnte Standort nicht bestimmen. Du kannst trotzdem per Suche ausw√§hlen.",[]}}async function xo(){const e=p(y,"posten");G(e,t=>{const n=t.val()||{},o={};for(const[a,s]of Object.entries(n)){if(!s||typeof s!="object")continue;const{active:c,...d}=s,l={};for(const[h,u]of Object.entries(d))u&&typeof u=="object"&&(l[h]=u);o[a]={active:!!c,posts:l}}se=o;const i=document.getElementById("postenSearch").value;i&&Ae(dn(i))})}function Eo(){const e=document.getElementById("postenSearch"),t=document.getElementById("nearbyBtn");let n;e.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=dn(e.value);Ae(o)},150)}),t.addEventListener("click",async()=>{const o=await Io(20);if(o.length===0){Ae(o),document.getElementById("status").innerText="Keine nahegelegenen Posten gefunden (oder Standort unbekannt).";return}Ae(o)}),document.addEventListener("click",o=>{const i=document.getElementById("postenSuggestions");i.contains(o.target)||e.contains(o.target)||t.contains(o.target)||(i.style.display="none")})}const re=document.getElementById("notifHeader"),ve=document.getElementById("notifHeaderToggle"),Ke=document.getElementById("notifSummary"),Lo=document.getElementById("notifDetails"),Mt=document.getElementById("notifStatusDot"),Rt=document.getElementById("notifTimeShort"),Ft=document.getElementById("notifTitle"),_t=document.getElementById("notifBody"),Dt=document.getElementById("notifSender"),$t=document.getElementById("notifTime"),zt=document.getElementById("notifId"),Ve=document.getElementById("recipientList"),Ee=document.getElementById("notifCount"),he=document.getElementById("toggleNotifHeader");let ie=null;function Xe(e){re.style.display=e?"block":"none",!e&&typeof ie=="function"&&(ie(),ie=null)}function yt(e){re.classList.toggle("collapsed",e),re.classList.toggle("expanded",!e),Lo.hidden=e,ve.setAttribute("aria-expanded",String(!e)),ve.textContent=e?"‚ñæ":"‚ñ¥"}ve==null||ve.addEventListener("click",e=>{e.stopPropagation();const t=re.classList.contains("collapsed");yt(!t)});Ke==null||Ke.addEventListener("click",()=>{const e=re.classList.contains("collapsed");yt(!e)});function Ao(e){return new Date(e).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}function tt(e){if(!e){Ft.textContent="-",_t.textContent="-",Dt.textContent="-",$t.textContent="-",Rt.textContent="[--:--]",zt.textContent="-",Ve.innerHTML="",Mt.style.background="#bbb",Ee&&(Ee.textContent="-"),re.classList.remove("sticky"),re.style.position="";return}const t=typeof e.timestamp=="number"?e.timestamp:Date.now(),n=Ao(t);Ft.textContent=e.title||"Ohne Titel",_t.textContent=e.body||"",Dt.textContent=e.sender||"Unbekannt",$t.textContent=new Date(t).toLocaleString("de-DE"),Rt.textContent=`[${n}]`,zt.textContent=e.id??"-";const o=e.recipients||{},i=Object.keys(o),a=i.filter(u=>o[u]===!0).length,s=i.length,c={};i.forEach(u=>{const m=dt(u);o[u]===!0?c[u]="green":e&&e.fallbackTargets&&e.fallbackTargets[m]?c[u]="orange":c[u]="red"});const d={};i.forEach(u=>{const m=(()=>{for(const[g,b]of Object.entries(M||{}))if(b.members&&b.members[u])return b;return null})();let f=c[u];f==="red"&&m&&Object.keys(m.members).filter(v=>v!==u).some(v=>c[v]==="green"||c[v]==="orange")&&(f="blue"),d[u]=f}),Ve.innerHTML="";const l=[];i.sort((u,m)=>u.localeCompare(m)).forEach(u=>{const m=d[u];l.push(m);const f=m==="green"?"ok":m==="orange"?"wait":m==="blue"?"teamblue":"red",g=m==="green"?"‚úÖ":m==="blue"?"üü¶":m==="orange"?"üì∞":"üî¥",b=document.createElement("div");b.className=`recipient-chip ${f}`,b.innerHTML=`<span class="dot"></span><span>${u}</span><span>${g}</span>`,Ve.appendChild(b)});let h="#FF5252";l.length>0&&(l.some(u=>u==="red")?h="#FF5252":l.some(u=>u==="blue")?h="#1E90FF":l.some(u=>u==="orange")?h="#FF8C00":h="#2ECC71"),Mt.style.background=h,Ee&&(Ee.textContent=`${a}/${s} best√§tigt`)}function Ot(){typeof ie=="function"&&(ie(),ie=null);const e=st(p(y,"notifications"),rt("timestamp"),xn(1)),t=G(e,n=>{const o=n.val();if(!o){tt(null);return}const[i,a]=Object.entries(o)[0];tt({id:i,...a})});ie=()=>t()}function Po(){const e=localStorage.getItem(Ne)==="1";Xe(e),e&&Ot(),he&&(he.checked=e),yt(!0),he==null||he.addEventListener("change",t=>{t.target.checked?(localStorage.setItem(Ne,"1"),Xe(!0),Ot()):(localStorage.removeItem(Ne),Xe(!1),tt(null))})}async function Bo(){if(confirm("M√∂chtest du wirklich die Standorte der Agenten anfragen?"))try{let e=M;(!e||Object.keys(e).length===0)&&(e=(await k(p(y,"teams"))).val()||{});const t={};for(const[a,s]of Object.entries(e)){if(a===x)continue;(s!=null&&s.members?Object.keys(s.members).length:0)>0&&(t[a]=!0)}if(Object.keys(t).length===0){r==null||r("[triggerAgentLocationRequest] Abbruch: keine adressierbaren Teams gefunden."),A("Keine Teams gefunden, die angefragt werden k√∂nnen.",{type:"error"});return}const n=String(Date.now()),o={id:n,createdAt:Q(),createdBy:I,teamsAtRequest:t,responses:{}};await $(p(y,"agentLocationRequest"),o);const i=Object.keys(t);try{const{tokens:a,deviceNames:s,instantSMSDevices:c}=await Hn(i),d="Mister X hat deinen Standort angefragt",l="√ñffne die App, um deinen Standort freizugeben!";if(a&&a.length>0||c&&c.length>0){if(a&&a.length>0&&await lt(d,l,a,{recipientDeviceNames:s,link:"/Mister-X/",rtdbBase:X}),c&&c.length>0&&(!a||a.length===0)){const h=`${d}: ${l}
Diese Nachricht wurde automatisch gesendet`.slice(0,280);await ct(me(),c,h,{rtdbBase:X})}}else r==null||r("[triggerAgentLocationRequest] Keine Empf√§nger in den ausgew√§hlten Teams gefunden.")}catch(a){r==null||r("[triggerAgentLocationRequest] Fehler beim Ermitteln der Empf√§nger",a)}return r==null||r("[triggerAgentLocationRequest] Anfrage ausgel√∂st",{reqId:n,totalTeams:Object.keys(t).length}),n}catch(e){throw r==null||r("[triggerAgentLocationRequest] Anfrage fehlgeschlagen",e),A("Konnte die Anfrage nicht ausl√∂sen.",{type:"error"}),e}}async function un(e){var t,n;if(!(!e||!e.id)){if(We.has(e.id)){r("shareTeamLocationForRequest: already in flight for "+e.id);return}try{if(localStorage.getItem(je)===e.id){r("shareTeamLocationForRequest: already prompted (LS) for "+e.id);return}}catch{}We.add(e.id);try{if(!x){A("Du bist in keinem Team. Standortfreigabe abgebrochen.",{type:"warn"});return}try{if(localStorage.getItem(O)===e.id){r("shareTeamLocationForRequest: already responded (LS) for "+e.id);return}}catch{}const o=p(y,`agentLocationRequest/responses/${x}`);if((await k(o)).exists()){try{localStorage.setItem(O,e.id)}catch{}return}const a=p(y,"agentLocationRequest"),s=await k(a);if(!s.exists()){A("Die Anfrage wurde zur√ºckgezogen ‚Äî Standort wird nicht gesendet.",{type:"warn"});try{localStorage.setItem(O,e.id)}catch{}return}const c=s.val();if(c!=null&&c.id&&c.id!==e.id){A("Es gibt inzwischen eine andere Anfrage ‚Äî Standort wird nicht gesendet.",{type:"warn"});try{localStorage.setItem(O,e.id)}catch{}return}try{localStorage.setItem(je,e.id)}catch{}const d=await jo("Dein Standort wird jetzt f√ºr Mister X freigegeben",e.id,{maxWaitMs:1e4,desiredAccuracy:30});if(d===null){r("shareTeamLocationForRequest: confirm dialog auto-closed");try{localStorage.setItem(O,e.id)}catch{}try{localStorage.removeItem("pendingAgentResponse")}catch{}return}if(d==="cancel"){A("Standortfreigabe abgebrochen.",{type:"info"});try{localStorage.setItem(O,e.id)}catch{}try{localStorage.removeItem("pendingAgentResponse")}catch{}return}const l=d.position,h=l.coords.latitude,u=l.coords.longitude,m=typeof l.coords.accuracy=="number"?Math.round(l.coords.accuracy):null,f=((t=M==null?void 0:M[x])==null?void 0:t.name)||"Team";A("Standort freigegeben",{type:"success"});const g=await k(a);if(!g.exists()||(n=g.val())!=null&&n.id&&g.val().id!==e.id){A("Die Anfrage wurde zur√ºckgezogen oder ersetzt ‚Äî Standort wird nicht gesendet.",{type:"warn"});try{localStorage.setItem(O,e.id)}catch{}return}const b=await pe(a,T=>{if(!T||T.id!==e.id)return;const B=T.responses||{};return B[x]||(B[x]={teamId:x,teamName:f,lat:h,lon:u,accuracy:typeof m=="number"?m:null,deviceId:I,timestamp:Q()},T.responses=B),T},{applyLocally:!1});if(!!!(b!=null&&b.committed)){A("Standort nicht gesendet: die Anfrage wurde zur√ºckgezogen oder bereits beantwortet.",{type:"warn"});try{localStorage.setItem(O,e.id)}catch{}return}try{localStorage.setItem(O,e.id)}catch{}try{localStorage.removeItem("pendingAgentResponse")}catch{}r("Standortantwort erfolgreich gesetzt (agentLocationRequest.responses/"+x+")")}finally{try{We.delete(e.id)}catch{}try{localStorage.removeItem(je)}catch{}}}}async function mn(e){if(!e||!e.reqId||!e.teamId)return!1;const t=p(y,"agentLocationRequest");try{const n=await pe(t,i=>{var s;if(!i||i.id!==e.reqId)return;const a=i.responses||{};return a[e.teamId]||(a[e.teamId]={teamId:e.teamId,teamName:e.teamName||((s=M==null?void 0:M[e.teamId])==null?void 0:s.name)||"Team",lat:e.lat,lon:e.lon,accuracy:typeof e.accuracy=="number"?e.accuracy:null,deviceId:I,timestamp:Q()},i.responses=a),i},{applyLocally:!1});if(!!(n!=null&&n.committed)){try{localStorage.removeItem("pendingAgentResponse"),localStorage.setItem(O,e.reqId)}catch{}return A("Standort wurde im Hintergrund gesendet.",{type:"success"}),r("sendPendingAgentResponse: committed for "+e.reqId),!0}return r("sendPendingAgentResponse: transaction not committed"),!1}catch(n){return r("sendPendingAgentResponse error",n),!1}}async function Nt(e){try{const t=localStorage.getItem("pendingAgentResponse");if(!t)return;const n=JSON.parse(t);if(!n||!n.reqId||!e||!e.id||e.id!==n.reqId||!x||n.teamId!==x)return;const o=p(y,`agentLocationRequest/responses/${x}`);if((await k(o)).exists()){try{localStorage.removeItem("pendingAgentResponse"),localStorage.setItem(O,n.reqId)}catch{}return}if(await mn(n))return;A("Dein Standort konnte nicht automatisch gesendet werden. Bitte best√§tige erneut.",{type:"warn"});try{await un(e)}catch(s){r("checkAndDeliverPendingResponse share prompt failed",s)}}catch(t){r("checkAndDeliverPendingResponse error",t)}}function Co(){D(p(y,"agentLocationRequest")),Ro(),nt()}function nt(){Array.isArray(de)&&de.length&&window.map&&de.forEach(e=>w.removeLayer(e)),de=[]}function Mo(){const e=p(y,"agentLocationRequest");G(e,n=>{const o=n.exists()?n.val():null;if(Yt=o,fn(o),o&&o.createdBy!==I&&x){try{if(o.responses&&o.responses[x])return}catch{}try{Nt(o).catch(i=>r("checkAndDeliverPendingResponse error",i))}catch{}Fo(o)}}),(async()=>{try{const n=await k(e);n&&n.exists()&&await Nt(n.val())}catch{}})()}function Ro(){const e=document.getElementById("agentReqStatus");e&&(e.style.display="none")}async function Fo(e){try{await un(e)}catch(t){r("Standortfreigabe fehlgeschlagen",t)}}function fn(e=Yt){const t=document.getElementById("agentReqStatus"),n=document.getElementById("agentReqProgress");if(!t||!n)return;if(!e){t.style.display="none",nt();return}const o=typeof e.createdAt=="number"?new Date(e.createdAt).toLocaleTimeString():"Unbekannt",i=e.responses||{},a=Object.values(i),s=e.teamsAtRequest||{},c=Object.keys(s).length||a.length,d=a.length;if(n.textContent=`Standort von ${d}/${c} Teams ‚Äì ${o}`,t.style.display="block",nt(),!(!Le||a.length===0)){_o(a);for(const l of a){if(l.lat==null||l.lon==null)continue;const h=L.divIcon({className:`square-marker ${Do(l.teamId)}`,iconSize:[14,14]}),u=L.marker([l.lat,l.lon],{icon:h,pane:"agentenPane"}).addTo(w),m=typeof l.accuracy=="number"?` (¬±${Math.round(l.accuracy)} m)`:"";if(u.bindPopup(`<strong>${Z(l.teamName||"Team")}${m}</strong>`),de.push(u),typeof l.accuracy=="number")try{const f=L.circle([l.lat,l.lon],{radius:l.accuracy,color:"#888",weight:1,fillColor:"#888",fillOpacity:.08,pane:"agentenPane",interactive:!1}).addTo(w);de.push(f)}catch(f){r("Konnte Genauigkeitskreis von Agentenstandort nicht erzeugen",f)}}}}function _o(e){if(!window.map){const t=e.find(n=>n.lat!=null&&n.lon!=null);t&&Ye(t.lat,t.lon)}}function Do(e){const t=["","orange","green","purple","blue","red","yellow","cyan","pink","lime","teal","brown"],n=Math.abs($o(String(e)))%t.length;return t[n]}function $o(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}function zo(){k(p(y,"roles")).then(e=>{const t=e.val();for(const n in t)t[n].role==="misterx"&&$(p(y,"roles/"+n),{role:"start",timestamp:Date.now()});A("Alle Mister X Rollen wurden zur√ºckgesetzt.",{type:"info"})})}async function Oo(){const e=await k(p(y,"settings/max_Team_X")),t=e.exists()?e.val():1,o=(await k(p(y,"roles"))).val();let i=0;for(const a in o)o[a].role==="misterx"&&i++;return i<t}async function ht(e){if(e!==localStorage.getItem("activeView")){if(e==="misterx"&&!await Oo()){A("Es sind bereits die maximal erlaubten Mister X Spieler aktiv.",{type:"error"}),Pe();return}if(e==="settings"&&prompt("Passwort eingeben!")!=="1001"){Pe();return}}if(e==="start")return Pe();document.getElementById("startView").style.display="none",document.getElementById("startView2").style.display="none",document.querySelectorAll(".view").forEach(n=>n.style.display="none"),e==="misterx"?document.getElementById("misterxView").style.display="block":e==="agent"?document.getElementById("agentView").style.display="block":e==="settings"&&(document.getElementById("settingsView").style.display="block",Yo()),localStorage.setItem("activeView",e),j(p(y,"roles/"+I),{role:e,timestamp:Date.now()});const t=e;await W.from("fcm_tokens").update({role:t}).eq("device_name",I),k(p(y,"timer")).then(n=>{const o=n.val();if(o){const{startTime:i,duration:a,durationInput:s,durationInput2:c}=o;a?(gn(i,a),ce(!0)):ce(!1)}})}async function Pe(){document.querySelectorAll(".view").forEach(t=>t.style.display="none"),document.getElementById("startView").style.display="block",document.getElementById("startView2").style.display="block",clearInterval(J),localStorage.setItem("activeView","start"),j(p(y,"roles/"+I),{role:"start",timestamp:Date.now()}),await W.from("fcm_tokens").update({role:"start"}).eq("device_name",I)}async function ue(e){await D(p(y,"timer/duration")),await D(p(y,"timer/startTime")),await D(p(y,"timerMessage")),typeof J<"u"&&clearInterval(J);const n=(await k(p(y,"timer"))).val();let o=25*60;typeof(n==null?void 0:n.durationInput)=="number"&&n.durationInput>0&&(o=n.durationInput,(isNaN(o)||o<1)&&(o=60)),typeof e=="number"&&e>0&&(o=e);const i=Date.now(),a=i+o*1e3,s={title:"Deine Zeit l√§uft gleich ab",body:"Bitte √∂ffne deine App!"};await $(p(y,"timer"),{startTime:i,duration:o,durationInput:n==null?void 0:n.durationInput,durationInput2:(n==null?void 0:n.durationInput2)||0});try{await W.rpc("cancel_and_unschedule")}catch(u){r("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",u)}const{tokens:c,deviceNames:d}=await Wn("misterx"),l=o-60,h=(me==null?void 0:me())??void 0;await W.functions.invoke("arm-timer-cron",{body:{title:s.title,body:s.body,dueInSec:l,messageId:h,link:"/Mister-X/",roles:["misterx"],resolveRecipientsAtSendTime:!0,rtdbBase:X}}),r(`üïí Timer gestartet: ${o}s, f√§llt um ${new Date(a).toLocaleTimeString()}.`)}function No(){vt||(vt=!0,G(p(y,"timer"),e=>{const t=e.val()||{},{startTime:n=null,duration:o=null,durationInput:i=null,durationInput2:a=null}=t;if(n===null||o===null){clearInterval(J),ce(!1);const s=document.getElementById("timer"),c=document.getElementById("agentTimer"),d=document.getElementById("settingsTimer");s&&(s.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--",s.style.color="",s.style.animation=""),c&&(c.innerText="‚è≥ Mister X Timer: --:--",c.style.color="",c.style.animation=""),d&&(d.innerText="‚è≥ Aktueller Timer: --:--",d.style.color="",d.style.animation="");return}gn(n,o),ce(!0)}))}function gn(e,t){clearInterval(J);let n=!1;J=setInterval(async()=>{if(!n){n=!0;try{let o=function(u){u&&(s<=300?(u.style.color="red",u.style.animation="blinker 1s linear infinite"):(u.style.color="",u.style.animation=""))};const i=Date.now(),a=Math.floor((i-e)/1e3),s=t-a;let c;if(s<0)c="abgelaufen";else{const u=Math.floor(s/60),m=s%60;c=`${String(u).padStart(2,"0")}:${String(m).padStart(2,"0")}`}const d=document.getElementById("timer"),l=document.getElementById("agentTimer"),h=document.getElementById("settingsTimer");if(h&&(h.innerText=`‚è≥ Aktueller Timer: ${c}`,o(h)),d&&(d.innerText=`‚è≥ Zeit bis zum n√§chsten Posten: ${c}`,o(d)),l&&(l.innerText=`‚è≥ Mister X Timer: ${c}`,o(l)),s<=0&&([d,l,h].forEach(u=>{u&&(u.style.color="",u.style.animation="")}),localStorage.getItem("activeView")==="misterx"))try{const m=(await k(p(y,"timer"))).val()||{},{startTime:f,duration:g,durationInput:b,durationInput2:v}=m||{};if(typeof f!="number"||typeof g!="number")return;const T=Se(f,g);if(Ho(T)||Oe)return;if(g===b&&(v??0)>0){const E="Zeit abgelaufen, dein Standort wird einmalig geteilt.";Oe=!0;const z=await Wo(E,{startTime:f,duration:g});if(Oe=!1,z===null){A("Dialog geschlossen: Timer wurde verl√§ngert oder zur√ºckgesetzt",{type:"info"}),r("showLocationDialog: automatisch geschlossen, Timer wurde verl√§ngert, ersetzt oder zur√ºckgesetzt.");return}if(z==="desc"){const C=await Ko();if(C){const K=await Re(y,async R=>{const te=R==null?void 0:R.durationInput,le=R==null?void 0:R.durationInput2;if(g===te&&(le??0)>0){try{const S=await pt(),{latitude:P,longitude:ne,accuracy:ye}=S.coords,bt=Date.now();try{if(await $e()){r("showLocationDialog: timer no longer expired - abort write"),oe();return}}catch(bn){r("showLocationDialog: secondLookAbort failed - proceeding with write attempt",bn)}const wn=ye<=100?{title:"Automatischer Standort",lat:P,lon:ne,accuracy:ye,description:C,timestamp:bt}:{description:C,timestamp:bt};await Me(R,wn)||(r("showLocationDialog: write skipped because existing entry detected or claim lost"),oe())}catch{const P={description:C,timestamp:Date.now()};await Me(R,P)||(r("showLocationDialog: write skipped (exception path)"),oe())}wt(le)}});ae(T),K||oe()}}else{const C=await Go();ae(T),C||oe()}}else alert("Zeit abgelaufen, jetzt musst du deinen Live-Standort in der WhatsApp-Gruppe teilen."),await Re(y,async()=>{await Promise.all([D(p(y,"timer/duration")),D(p(y,"timer/startTime")),D(p(y,"timerMessage"))]),clearInterval(J),ce(!1),d&&(d.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--"),l&&(l.innerText="‚è≥ Mister X Timer: --:--"),h&&(h.innerText="‚è≥ Aktueller Timer: --:--"),fe("Zeit abgelaufen!","Mister X muss sich per Live-Standort zeigen","all")})||oe()}catch(u){r("Fehler im Ablauf-Handling:",u)}}finally{n=!1}}},1e3)}async function jo(e,t,{maxWaitMs:n=1e4,desiredAccuracy:o=30}={}){return new Promise(i=>{var Te;const a=document.createElement("div");a.style.position="fixed",a.style.top="0",a.style.left="0",a.style.width="100vw",a.style.height="100vh",a.style.background="rgba(0,0,0,0.6)",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.zIndex="99999";const s=document.createElement("div");s.style.background="#fff",s.style.padding="1.2em",s.style.borderRadius="8px",s.style.width="min(520px, 92vw)",s.style.maxWidth="520px",s.style.textAlign="center",s.style.position="relative";const c=document.createElement("div");c.style.fontWeight="600",c.style.marginBottom="0.4em",c.textContent=e;const d=document.createElement("div");d.style.fontSize="14px",d.style.color="#333",d.style.marginBottom="0.6em";const l=((Te=M==null?void 0:M[x])==null?void 0:Te.name)||"";d.textContent=l?"Team: "+l:"Team: -";const h=document.createElement("div");h.style.position="absolute",h.style.top="8px",h.style.right="10px",h.style.fontSize="11px",h.style.color="#666",h.textContent="¬± ‚Äì m";const u=document.createElement("div");u.style.display="flex",u.style.justifyContent="center";const m=document.createElement("button");m.textContent="Standort teilen",m.className="small-button",m.disabled=!0,u.appendChild(m),s.appendChild(c),s.appendChild(d),s.appendChild(u),s.appendChild(h),m.style.padding="12px 22px",m.style.fontSize="16px",m.style.minWidth="200px",m.style.borderRadius="8px",a.appendChild(s),document.body.appendChild(a);let f=null,g=null;const b=p(y,"agentLocationRequest");let v=null;const T=async()=>{var S;try{if(!f)return;const P=f,ne=typeof P.coords.accuracy=="number"?Math.round(P.coords.accuracy):null,ye={reqId:t,teamId:x||null,teamName:((S=M==null?void 0:M[x])==null?void 0:S.name)||null,lat:P.coords.latitude,lon:P.coords.longitude,accuracy:ne,timestamp:Date.now()};localStorage.setItem("pendingAgentResponse",JSON.stringify(ye)),await mn(ye)}catch(P){r("onPageHide: error trying to send pending response",P)}},B=()=>{document.hidden&&T()};window.addEventListener("pagehide",T),window.addEventListener("visibilitychange",B),window.addEventListener("beforeunload",T);const E=()=>{try{g!=null&&navigator.geolocation.clearWatch(g)}catch{}try{we(b,"value",te)}catch{}try{a&&document.body.contains(a)&&document.body.removeChild(a)}catch{}try{v&&clearTimeout(v)}catch{}try{window.removeEventListener("pagehide",T)}catch{}try{window.removeEventListener("visibilitychange",B)}catch{}try{window.removeEventListener("beforeunload",T)}catch{}},z=S=>{if(!S)return;if(!f){f=S;return}const P=typeof S.coords.accuracy=="number"?S.coords.accuracy:1/0,ne=typeof f.coords.accuracy=="number"?f.coords.accuracy:1/0;P<ne&&(f=S)},C=S=>{if(!S)return;const P=typeof S.coords.accuracy=="number"?Math.round(S.coords.accuracy):null;h.textContent=P!=null?`Genauigkeit: ¬±${P} m`:"Genauigkeit: -",m.disabled=!1},K=S=>{z(S),C(S)},R=S=>{S&&S.code===S.PERMISSION_DENIED?(A("Standortzugriff verweigert. Freigabe nicht m√∂glich.",{type:"error"}),E(),i("cancel")):A("Fehler beim Ermitteln des Standorts.",{type:"warn"})};if(!("geolocation"in navigator)){A("Geolocation wird nicht unterst√ºtzt.",{type:"error"}),E(),i("cancel");return}try{g=navigator.geolocation.watchPosition(K,R,{enableHighAccuracy:!0,maximumAge:0,timeout:1e4})}catch{A("Fehler beim Starten der Standortabfrage.",{type:"error"}),E(),i("cancel");return}v=setTimeout(()=>{try{m.disabled=!1}catch{}try{g!=null&&navigator.geolocation.clearWatch(g)}catch{}g=null},n);const te=S=>{const P=S.exists()?S.val():null;try{if(!P||P.id&&P.id!==t){E(),i(null);return}if(P.responses&&x&&P.responses[x]){E(),A("Standort wurde bereits von einem Ger√§t deines Teams geteilt.",{type:"info"}),i(null);return}}catch{}};G(b,te);const le=()=>{if(E(),f)return i({action:"confirm",position:f});navigator.geolocation.getCurrentPosition(S=>i({action:"confirm",position:S}),S=>{A("Kein Standort verf√ºgbar.",{type:"warn"}),i("cancel")},{enableHighAccuracy:!0,timeout:8e3})};m.onclick=()=>{le()},(async()=>{try{const S=await k(b),P=S.exists()?S.val():null;if(!P||P.id&&P.id!==t){E(),i(null);return}typeof l<"u"&&d&&(d.textContent=l)}catch{}})()})}async function Wo(e,t=null){return new Promise(n=>{const o=document.createElement("div");o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100vw",o.style.height="100vh",o.style.background="rgba(0,0,0,0.7)",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.zIndex="9999";const i=document.createElement("div");i.style.background="#fff",i.style.padding="2em",i.style.borderRadius="10px",i.style.maxWidth="90vw",i.style.textAlign="center",i.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>${e}</strong><br>
        Du kannst optional eine Beschreibung hinzuf√ºgen (z.B. falls GPS ungenau ist oder du dich in der U-Bahn befindest).
      </div>
      <button id="loc-ok-btn" style="margin:0 1em 0 0;">OK</button>
      <button id="loc-desc-btn">Standort-Beschreibung hinzuf√ºgen</button>
    `,o.appendChild(i),document.body.appendChild(o);const a=p(y,"timer"),s=d=>{const l=d.exists()?d.val():null;try{if(l===null){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{we(a,"value",s)}catch{}n(null);return}if(t&&(l.startTime!==t.startTime||l.duration!==t.duration)){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{we(a,"value",s)}catch{}n(null);return}if(Fe(l)){if(document.body.contains(o))try{document.body.removeChild(o)}catch{}try{we(a,"value",s)}catch{}n(null)}}catch{}};G(a,s);const c=d=>{try{we(a,"value",s)}catch{}if(document.body.contains(o))try{document.body.removeChild(o)}catch{}n(d)};document.getElementById("loc-ok-btn").onclick=()=>c("ok"),document.getElementById("loc-desc-btn").onclick=()=>c("desc"),(async()=>{try{const d=await k(a),l=d.exists()?d.val():null;if(l===null){c(null);return}if(t&&(l.startTime!==t.startTime||l.duration!==t.duration)){c(null);return}Fe(l)&&c(null)}catch{}})()})}function Se(e,t){return`${e}_${t}`}function Ho(e){const t=`alertHandled_${e}`;return sessionStorage.getItem(t)==="1"}function ae(e){const t=`alertHandled_${e}`;sessionStorage.setItem(t,"1")}async function ot(e,t,n=6e4){try{const o=e+t*1e3,i=st(p(y,"locations"),rt("timestamp"),startAt(Math.max(0,e-5e3)),Xt(o+n)),a=await k(i);if(!a.exists())return!1;const s=a.val();return Object.keys(s||{}).length>0}catch(o){return r("existingLocationForTimer failed",o),!1}}async function Me(e,t){var d;const{startTime:n,duration:o}=e||{};if(typeof n!="number"||typeof o!="number")return r("safePushLocationForExpiration: invalid timerData",e),!1;const i=Se(n,o);if(await ot(n,o))return r("safePushLocationForExpiration: detected existing location for expKey",i),!1;const s=p(y,`locationClaims/${i}`),c=ge();try{const l=await pe(s,v=>v&&v.claimed?v:{claimed:!0,by:c,at:Q()},{applyLocally:!1}),h=l==null?void 0:l.committed,u=(d=l==null?void 0:l.snapshot)==null?void 0:d.val();if(!(h&&u&&u.by===c))return r("safePushLocationForExpiration: lost claim for expKey",i),!1;if(await ot(n,o))return r("safePushLocationForExpiration: someone wrote meanwhile for expKey",i),!1;const g=t.timestamp||Date.now(),b={...t,expKey:i,claimedBy:c,timestamp:g};await at(p(y,"locations"),b);try{await j(p(y,"timer"),{lastLocationFor:i})}catch{}return!0}catch(l){return r("safePushLocationForExpiration failed",l),!1}}async function qo(e,t=48*60*60*1e3){let n=Date.now();try{const d=await k(p(e,".info/serverTimeOffset")),l=typeof d.val()=="number"?d.val():0;n+=l}catch{}const o=n-t,i=st(p(e,"timerClaims"),rt("at"),Xt(o)),a=await k(i),s={};a.exists()&&a.forEach(d=>{const l=d.val();typeof(l==null?void 0:l.at)=="number"&&l.at<=o&&(s[`timerClaims/${d.key}`]=null)}),Object.keys(s).length&&await j(p(e),s)}async function Re(e,t){var f;const o=(await k(p(e,"timer"))).val()||{},{startTime:i,duration:a}=o;if(typeof i!="number"||typeof a!="number")return!1;const s=Se(i,a),c=p(e,`timerClaims/${s}`),d=ge(),l=await pe(c,g=>g&&g.claimed?g:{claimed:!0,by:d,at:Q()},{applyLocally:!1}),h=l.committed,u=(f=l.snapshot)==null?void 0:f.val();if(!(h&&u&&u.by===d))return!1;try{if(await ot(i,a))return r("doOncePerExpiration: existing location detected for",s),!1}catch(g){r("doOncePerExpiration: existing-location check failed, proceeding with action",g)}try{if(await $e())return r("doOncePerExpiration: timer no longer expired - aborting action for",s),!1}catch(g){r("doOncePerExpiration: secondLookAbort failed - proceeding with action",g)}await t(o);try{await qo(e,5*60*1e3)}catch(g){r("GC timerClaims fehlgeschlagen:",g)}return!0}function oe(){r("Bereits von anderem Ger√§t erledigt.");try{const e=document.getElementById("status");e&&(e.innerText="‚ÑπÔ∏è Der Standort wurde bereits von einem anderen Ger√§t geteilt.")}catch{}try{A("‚ÑπÔ∏è Jemand anderes hat bereits den Standort geteilt. Dein Eintrag wurde nicht hinzugef√ºgt.",{type:"info"})}catch{}}function Uo(){k(p(y,"timer")).then(e=>{if(!e.exists())return;const t=e.val(),n=document.getElementById("timerDurationInput"),o=document.getElementById("timerDurationInput2");!n||!o||(t&&typeof t.durationInput=="number"?n.value=Math.floor(t.durationInput/60):n.value=25,t&&typeof t.durationInput2=="number"?o.value=Math.floor(t.durationInput2/60):o.value=5)})}const pn=document.createElement("style");pn.innerHTML=`
@keyframes blinker {
  50% { opacity: 0; }
}
`;document.head.appendChild(pn);async function yn(){return(await k(p(y,"timer"))).val()||{}}function Fe(e){const{startTime:t,duration:n}=e||{};return typeof t=="number"&&typeof n=="number"&&t+n*1e3>Date.now()}async function $e(){try{const e=await yn();if(Fe(e))return r("Timer wurde in der Zwischenzeit verl√§ngert - Abbruch vor dem Schreiben."),!0}catch(e){return r("Zweiter Timer-Check fehlgeschlagen:",e),!0}return!1}function wt(e){fe("Mister X hat sich gezeigt!","Automatische Standort-√úbermittlung",["agent","settings","start"]),rn(),e!=null?ue(e):r("durationInput2 war nicht vorhanden - Timer wird nicht neu gestartet.")}async function Ze(e){const n=(prompt("Bitte den Standort beschreiben (bzw. wenn U-Bahn, dann gem√§√ü Regelwerk angeben):")||"").trim();if(!n)return!1;const i=(await k(p(y,"timer"))).val()||{},a=Se(i.startTime,i.duration),s=await Re(y,async c=>{const d=c==null?void 0:c.durationInput2;if(!((i==null?void 0:i.duration)===(c==null?void 0:c.durationInput)&&(d??0)>0)||await $e())return;await Me(i,{description:n,timestamp:Date.now()})||r("askManualAndWrite: write skipped because existing entry detected or claim lost"),wt(d)});return ae(a),s||oe(),s}async function Go({autoRetry:e=!0,maxRetries:t=3,retryDelayMs:n=1e4}={}){let o,i;try{if(i=await yn(),o=i.durationInput2,Fe(i))return r("Timer wurde verl√§ngert ‚Äì Abbruch."),!1}catch(l){return r("Timer lesen fehlgeschlagen:",l),!1}const a=Se(i.startTime,i.duration);if(!("geolocation"in navigator)){document.getElementById("status").innerText="Geolocation wird nicht unterst√ºtzt.";const l=await Ze();return ae(a),!!l}let s=Math.max(0,t),c=!1;const d={enableHighAccuracy:!0,maximumAge:0,timeout:15e3};return await new Promise(l=>{const h=async f=>{if(await $e())return l(!1);const{latitude:g,longitude:b,accuracy:v}=f.coords,T=Date.now();if(v>100){document.getElementById("status").innerText="‚ö†Ô∏è Standort ungenau (¬±"+Math.round(v)+" m). Bitte Standortbeschreibung manuell eingeben.";const E=await Ze();return ae(a),l(!!E)}const B=await Re(y,async E=>{const z=E==null?void 0:E.durationInput,C=E==null?void 0:E.durationInput2;if(!(i.duration===z&&(C??0)>0))return;await Me(E,{title:"Automatischer Standort",lat:g,lon:b,accuracy:v,timestamp:T})||r("getLocation: write skipped because existing entry detected or claim lost"),wt(C)});ae(a),l(!!B)},u=()=>{!e||s<=0||(s--,setTimeout(()=>{navigator.geolocation.getCurrentPosition(h,m,d)},n))},m=async f=>{let g="‚ùå Fehler beim Abrufen des Standorts.";switch(f.code){case f.PERMISSION_DENIED:g+=" Zugriff verweigert.";break;case f.POSITION_UNAVAILABLE:g+=" Standortinformationen nicht verf√ºgbar.";break;case f.TIMEOUT:g+=" Zeit√ºberschreitung bei der Standortabfrage.";break}if(g+=" Bitte erneut versuchen oder Standortbeschreibung manuell eingeben.",document.getElementById("status").innerText=g,!c){c=!0;const b=await Ze();return ae(a),l(!!b)}f.code===f.TIMEOUT||f.code===f.POSITION_UNAVAILABLE?u():l(!1)};navigator.geolocation.getCurrentPosition(h,m,d)})}async function Ko(){return new Promise(e=>{const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0,0,0,0.7)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="9999";const n=document.createElement("div");n.style.background="#fff",n.style.padding="2em",n.style.borderRadius="10px",n.style.maxWidth="90vw",n.style.textAlign="center",n.innerHTML=`
      <div style="margin-bottom:1em;">
        <strong>Standort-Beschreibung hinzuf√ºgen</strong><br>
        Bitte gib eine Beschreibung deines Standorts ein.
      </div>
      <textarea id="desc-input" rows="3" style="width:90%;"></textarea><br>
      <button id="desc-cancel-btn" style="margin-top:1em;">Abbrechen</button>
      <button id="desc-ok-btn" style="margin-top:1em; margin-left:1em;">OK</button>
    `,t.appendChild(n),document.body.appendChild(t),document.getElementById("desc-ok-btn").onclick=()=>{const o=document.getElementById("desc-input").value.trim();document.body.removeChild(t),e(o||null)},document.getElementById("desc-cancel-btn").onclick=()=>{document.body.removeChild(t),e(null)}})}function ce(e){const t=document.getElementById("startTimerButton");t&&(t.disabled=e,t.style.opacity=e?"0.5":"1",t.style.pointerEvents=e?"none":"auto",t.style.cursor=e?"default":"pointer")}function Vo(){localStorage.getItem("nachrichtAktiv")?(document.getElementById("permissionButton").style.display="none",document.getElementById("permissionButton2").style.display="block"):(document.getElementById("permissionButton").style.display="block",document.getElementById("permissionButton2").style.display="none")}async function Xo(){if(confirm("M√∂chtest du wirklich alle gespeicherten Standorte l√∂schen?"))try{await D(p(y,"locations")),A("Alle Standorte wurden gel√∂scht.",{type:"info"}),Pn=[];const e=document.getElementById("status");e&&(e.innerText=""),await To(!0),Ce()}catch(e){r(e),A("Fehler beim L√∂schen der Standorte.",{type:"error"})}}async function Zo(){await D(p(y,"timer/duration")),await D(p(y,"timer/startTime")),await D(p(y,"timerMessage")),clearInterval(J),ce(!1);try{await W.rpc("cancel_and_unschedule")}catch(o){r("[Timer] cancel_and_unschedule fehlgeschlagen (ignoriere und fahre fort):",o)}const e=document.getElementById("timer"),t=document.getElementById("agentTimer"),n=document.getElementById("settingsTimer");e&&(e.innerText="‚è≥ Zeit bis zum n√§chsten Posten: --:--"),t&&(t.innerText="‚è≥ Mister X Timer: --:--"),n&&(n.innerText="‚è≥ Aktueller Timer: --:--"),fe("Timer zur√ºckgesetzt","Der Timer wurde zur√ºckgesetzt!","all")}function Jo(){const e=document.getElementById("max_Team_X").value;D(p(y,"settings/max_Team_X")).then(()=>$(p(y,"settings/max_Team_X"),Number(e))).then(()=>{r("max_Team_X erfolgreich gespeichert:",e)}).catch(t=>{r("Fehler beim Speichern von max_Team_X:",t)})}function Yo(){const e=document.getElementById("max_Team_X");k(p(y,"settings/max_Team_X")).then(t=>{t.exists()?(e.value=t.val(),r("max_Team_X geladen:",t.val())):r("Kein max_Team_X-Wert gefunden.")}).catch(t=>{r("Fehler beim Laden von max_Team_X:",t)})}function Qo(){const t=document.getElementById("timerDurationInput").value*60;D(p(y,"timer/durationInput")).then(()=>$(p(y,"timer/durationInput"),Number(t))).then(()=>{r("Duration_input:",t)}).catch(n=>{r("Fehler beim Speichern von DurationInput:",n)})}function ei(){const t=document.getElementById("timerDurationInput2").value*60;D(p(y,"timer/durationInput2")).then(()=>$(p(y,"timer/durationInput2"),Number(t))).then(()=>{r("Duration_input2:",t)}).catch(n=>{r("Fehler beim Speichern von DurationInput2:",n)})}async function ti(){if(!("serviceWorker"in navigator))throw new Error("Service Worker wird vom Browser nicht unterst√ºtzt.");const e="/Mister-X/",t=await navigator.serviceWorker.getRegistration(e);if(t)return t;const n=`${e}firebase-messaging-sw.js`;return navigator.serviceWorker.register(n,{scope:e,type:"module"})}function ni(){var e,t;return((e=window.matchMedia)==null?void 0:e.call(window,"(display-mode: standalone)").matches)||((t=window.navigator)==null?void 0:t.standalone)===!0}async function oi(){const e={notificationsAPI:"Notification"in window,serviceWorker:"serviceWorker"in navigator,pushManager:"PushManager"in window,standalone:ni(),fcm:!1};try{e.fcm=await it()}catch{e.fcm=!1}return e}async function jt(e){!e||!I||await $(p(y,`notifications/${e}/recipients/${I}`),!0)}function Wt(e){try{const t=e&&e.messageId;if(t){if(Be.has(t))return;Be.add(t)}if(t&&typeof jt=="function"&&jt(t).catch(n=>r("Markieren fehlgeschlagen:",n)),document.visibilityState==="visible"){const n=e&&e.title?e.title:"Nachricht",o=e&&e.body?e.body:"";setTimeout(()=>{alert(`${n}
${o}`)},1e3)}}catch(t){r("handleInAppMessage error:",t)}}setInterval(()=>{Be.size>5e3&&Be.clear()},60*1e3);async function ii(){if(!("serviceWorker"in navigator))return;const e=await navigator.serviceWorker.ready;if(!e.active)return;const t=5e3;return await new Promise(n=>{const o=new MessageChannel,i=setTimeout(()=>{o.port1.onmessage=null,r("[SW-Log] PING -> Timeout (wir versuchen GET_SW_LOGS trotzdem)"),n()},t);o.port1.onmessage=a=>{a.data&&a.data.type==="PONG"&&(clearTimeout(i),r("[SW-Log] PONG empfangen"),n())},e.active.postMessage({type:"PING"},[o.port2])}),new Promise(n=>{const o=new MessageChannel,i=setTimeout(()=>{n()},t);o.port1.onmessage=a=>{a.data&&a.data.type==="SW_LOGS"&&(clearTimeout(i),Array.isArray(a.data.logs)&&a.data.logs.forEach(s=>{s&&s.msg&&r("[SW-Log]",new Date(s.ts).toLocaleTimeString(),s.msg)}),e.active.postMessage({type:"CLEAR_SW_LOGS"}),n())},e.active.postMessage({type:"GET_SW_LOGS"},[o.port2])})}function ai(){const e=document.getElementById("agentReqEnabledCheckbox");e&&(k(p(y,kt)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,localStorage.setItem(St,n?"1":"0"),Ht(n)}),e.addEventListener("change",async()=>{const t=e.checked;await $(p(y,kt),t),localStorage.setItem(St,t?"1":"0"),Ht(t)}))}function Ht(e){const t=document.getElementById("btnRequestAgents");t&&(t.style.display=e?"":"none")}function si(){const e=document.getElementById("messageToggle");e&&(k(p(y,It)).then(t=>{const n=t.exists()?!!t.val():!1;e.checked=n,localStorage.setItem(Tt,n?"1":"0")}),e.addEventListener("change",async()=>{const t=e.checked;await $(p(y,It),t),localStorage.setItem(Tt,t?"1":"0")}))}async function ri(){var e,t,n,o,i,a;On();try{const s=await oi();if(s&&s.fcm){U||(U=_e(ee)),window.__swMsgListenerAdded||(navigator.serviceWorker.addEventListener("message",g=>{var b;if(g&&g.data&&g.data.type==="PUSH"){const v=g.data.payload||{};(b=navigator.serviceWorker.controller)==null||b.postMessage({type:"PUSH",payload:v,userAgent:navigator.userAgent}),Wt(v),r("[Page] SW-Message empfangen",v)}}),window.__swMsgListenerAdded=!0);let f=null;In(U,g=>{var v;const b=g&&g.data?g.data:{};b.messageId&&b.messageId===f||(f=b.messageId||null,(v=navigator.serviceWorker.controller)==null||v.postMessage({type:"PUSH",payload:g,userAgent:navigator.userAgent}),Wt(b),r("[Page] FCM onMessage empfangen",g))})}navigator.serviceWorker.addEventListener("message",f=>{var g;((g=f==null?void 0:f.data)==null?void 0:g.type)==="PUSH_SUBSCRIPTION_CHANGED"&&qe({force:!0}).catch(r)}),(async()=>await Dn("pushSubscriptionChangedAt")&&(await qe({force:!0}).catch(r),await $n("pushSubscriptionChangedAt")))();const c=document.getElementById("enablePush"),d=document.getElementById("pushHint");c&&(!s.fcm&&/iPhone|iPad|iPod/i.test(navigator.userAgent)&&!s.standalone?(c.style.display="none",d&&(d.textContent="Installiere die App zum Home-Bildschirm, um Benachrichtigungen zu aktivieren.",d.style.display="block")):!s.fcm||!s.notificationsAPI||!s.serviceWorker||!s.pushManager?(c.style.display="none",d&&(d.textContent="Benachrichtigungen werden von diesem Browser/Modus nicht unterst√ºtzt.",d.style.display="block")):Notification.permission==="granted"?(c.textContent="Benachrichtigungen sind aktiv",c.disabled=!0):(c.addEventListener("click",enablePush,{once:!0}),c.style.display="inline-flex")),ce(!0),document.getElementById("btnRequestAgents").style.display="none";const l=localStorage.getItem("activeView")||"start";l!=="start"&&ht(l),rn(),await wo(),No(),Uo(),Vo(),qe(),Po(),co(),po(),mt(),Mo(),await xo(),Eo(),vo(),bo(),ii().catch(()=>{}),ai(),si();const h=document.getElementById("toggleAgentLocations");h&&(h.checked=Le,h.addEventListener("change",()=>{Le=!!h.checked;try{localStorage.setItem(Qt,Le?"1":"0")}catch{}fn()})),(e=document.getElementById("toggleTracking"))==null||e.addEventListener("change",f=>{f.target.checked?so():cn()}),(t=document.getElementById("toggleFollow"))==null||t.addEventListener("change",f=>{Zt=f.target.checked});const u=document.getElementById("clearLocalStorageBtn");u&&u.addEventListener("click",()=>{confirm("M√∂chtest du wirklich alle gespeicherten Daten (localStorage) l√∂schen?")&&(localStorage.clear(),sessionStorage.clear(),alert("Alle lokalen Daten wurden gel√∂scht. Die Seite wird neu geladen."),location.reload())});const m=document.getElementById("photoInput");m&&m.addEventListener("change",function(){var g;if((g=this.files)==null?void 0:g[0]){window.fotoHochgeladen=!0;const b=document.getElementById("status");b&&(b.innerText="üì∏ Foto ausgew√§hlt!")}})}catch(s){alert("Fehler in startScript: "+((s==null?void 0:s.message)??String(s))),(o=(n=document.getElementById("startView"))==null?void 0:n.style)==null||o.setProperty("display","block"),(a=(i=document.getElementById("startView2"))==null?void 0:i.style)==null||a.setProperty("display","block")}}function r(...e){console.log(...e);const t=document.getElementById("settingsLog");if(!t)return;const n=new Date().toLocaleTimeString(),o=document.createElement("div");o.innerHTML=`<strong>[${n}]</strong>`,e.forEach(i=>{if(typeof i=="object"){const a=document.createElement("details"),s=document.createElement("summary");s.textContent="Objekt anzeigen",a.appendChild(s);const c=document.createElement("pre");c.textContent=JSON.stringify(i,null,2),a.appendChild(c),o.appendChild(a)}else o.innerHTML+=` ${i}`}),t.appendChild(o),t.scrollTop=t.scrollHeight}window.switchView=ht;window.requestPermission=Fn;window.sendLocationWithPhoto=Un;window.startTimer=ue;window.goBack=Pe;window.save_timer_duration=Qo;window.save_timer_duration2=ei;window.save_max_mister_x=Jo;window.resetTimer=Zo;window.deleteAllLocations=Xo;window.resetAllMisterXRollen=zo;window.removeNotificationSetup=Nn;window.mxState=window.mxState||{};window.mxState.selectedPost=null;window.openCloseTeamSettings=to;window.closeTeamSettings=sn;window.leaveTeam=ft;window.createTeam=no;window.joinTeam=oo;window.triggerAgentLocationRequest=Bo;window.resetAgentLocations=Co;function hn(e){window.mxState.selectedPost=e}function ci(){return window.mxState.selectedPost}document.addEventListener("DOMContentLoaded",ri);
